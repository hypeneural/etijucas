import{b as p,u as w,c as d}from"./vendor-query-2Fnzm2h0.js";import{r as g}from"./vendor-radix-BOMdSbHx.js";import{t as c,s as f}from"./localDatabase-D108UKjx.js";import{t as m}from"./formatTimeAgo-CK5tiOWV.js";import{h as y,i as u}from"./index-C7gvV03_.js";const s=["offline","topics"];function A(r){const{isOnline:n}=y(),e=p(),i=w({queryKey:[...s,r],queryFn:async()=>{let o=await c.getAll();if(n)try{const t=await m.getAll({categoria:r?.categoria!=="all"?r?.categoria:void 0,search:r?.search});t.data&&t.data.length>0&&(await c.saveMany(t.data),o=t.data)}catch(t){console.warn("[useOfflineTopics] API failed, using cache:",t)}if(r?.categoria&&r.categoria!=="all"&&(o=o.filter(t=>t.categoria===r.categoria)),r?.search){const t=r.search.toLowerCase();o=o.filter(a=>a.titulo.toLowerCase().includes(t)||a.texto.toLowerCase().includes(t))}return o.sort((t,a)=>new Date(a.createdAt).getTime()-new Date(t.createdAt).getTime())},staleTime:1e3*60*2,gcTime:1e3*60*60*24});return g.useEffect(()=>{n&&e.invalidateQueries({queryKey:s})},[n,e]),i}function I(){const r=p(),{isOnline:n}=y();return d({mutationFn:async e=>{if(console.log("[useCreateOfflineTopic] Creating topic, online:",n,"bairroId:",e.bairroId),!n){const i={id:`temp-${Date.now()}-${Math.random().toString(36).slice(2)}`,titulo:e.titulo,texto:e.texto,categoria:e.categoria,bairroId:e.bairroId,fotoUrl:e.fotoUrl,isAnon:e.isAnon??!1,autorNome:e.isAnon?"AnÃ´nimo":"VocÃª",likesCount:0,commentsCount:0,liked:!1,createdAt:new Date};return await c.save(i),await f.add({type:"topic",data:e,idempotencyKey:`topic-${i.id}`}),u.info("ðŸ“´ TÃ³pico salvo offline. SerÃ¡ enviado quando voltar online."),i}try{const i=await m.create(e);return u.success("âœ… TÃ³pico publicado com sucesso!"),i}catch(i){const o=i instanceof Error?i.message:"Erro desconhecido";return console.error("[useCreateOfflineTopic] Failed:",o),u.error(`âŒ Falha ao publicar: ${o}. TÃ³pico salvo localmente.`),{id:`temp-${Date.now()}`,titulo:e.titulo,texto:e.texto,categoria:e.categoria,bairroId:e.bairroId,fotoUrl:e.fotoUrl,isAnon:e.isAnon??!1,autorNome:e.isAnon?"AnÃ´nimo":"VocÃª",likesCount:0,commentsCount:0,liked:!1,createdAt:new Date,syncStatus:"pending"}}},onSuccess:()=>{r.invalidateQueries({queryKey:s})}})}function b(){const r=p(),{isOnline:n}=y();return d({onMutate:async({id:e,currentlyLiked:i})=>{await r.cancelQueries({queryKey:s});const o=r.getQueryData(s);r.setQueryData(s,a=>a&&a.map(l=>l.id===e?{...l,liked:!i,likesCount:i?Math.max(0,l.likesCount-1):l.likesCount+1}:l));const t=await c.getById(e);if(t){const a={...t,liked:!i,likesCount:i?Math.max(0,t.likesCount-1):t.likesCount+1};await c.save(a)}return{previousTopics:o,topicId:e}},mutationFn:async({id:e,currentlyLiked:i})=>{if(n)try{const o=await m.toggleLike(e),t=await c.getById(e);return t&&await c.save({...t,liked:o.liked,likesCount:o.likesCount}),{id:e,newLiked:o.liked,likesCount:o.likesCount}}catch(o){console.error("[useLikeOfflineTopic] API failed:",o),await f.add({type:"like",data:{topicId:e},idempotencyKey:`like-${e}-${Date.now()}`})}else await f.add({type:"like",data:{topicId:e},idempotencyKey:`like-${e}-${Date.now()}`});return{id:e,newLiked:!i}},onError:(e,i,o)=>{o?.previousTopics&&r.setQueryData(s,o.previousTopics)},onSettled:()=>{setTimeout(()=>{r.invalidateQueries({queryKey:s})},500)}})}export{b as a,I as b,A as u};
