import{j as e,r as m}from"./vendor-radix-Dq3xRYQM.js";import{B as v}from"./button-BA0fLKQy.js";import{b as R,c as A,X as be,R as H,T as _,C as L,k as ie,i as $,f as Ge,H as He,u as _e}from"./index-BDgQM_Ao.js";import{M as K}from"./map-pin-DihpCRfF.js";import{C as F}from"./camera-DruRnvH_.js";import{m as f,A as ae}from"./vendor-motion-CBZKS1Mr.js";import{C as We}from"./check-C-msW-qG.js";import{C as w}from"./card-BsYcWPME.js";import{I as W}from"./info-D4wZk5kp.js";import{u as Qe}from"./vendor-query-DJ0Mukyd.js";import{r as me}from"./report.service-CothQ4LP.js";import{L as q}from"./loader-circle-CzqZLt3R.js";import{C as Ye}from"./circle-alert-exha86UO.js";import{C as ue}from"./chevron-right-C2qH22XP.js";import{L as Je}from"./lightbulb-BUjqmeK4.js";import{C as Xe}from"./circle-help-B1BJdZMt.js";import{I as Ee}from"./input-DUdZj2br.js";import{L as Ze}from"./LocationMap-Bktc_vYp.js";import{S as Q}from"./search-DlLOQTnA.js";import{P as je,I as ye}from"./pen-line-C1p-jE-B.js";import{N as Ne}from"./navigation-DGMFsLJ_.js";import{B as ea}from"./badge-BXzRTedQ.js";import{C as aa}from"./checkbox-DG2NMwfu.js";import{T as ta,S as sa}from"./textarea-CSyxjCVk.js";import{F as ra}from"./file-text-7LP6T8sU.js";import{c as Y,P as ve}from"./confetti.module-BBsYU7ig.js";import{S as ia}from"./sparkles-ByeLWnDa.js";import{C as na}from"./copy-DpPLpt7u.js";import{S as oa}from"./share-2-CQWUdrXn.js";import{L as ca}from"./LoginRequired-BQf0ff3E.js";import{u as la}from"./useMyReports-D0eY9pm9.js";import{u as da}from"./useAuthStore-ClSYYYQQ.js";import{A as ma}from"./arrow-left-DfVgNrA1.js";import"./vendor-utils-DHocNF0y.js";import"./client-BTgelhMB.js";import"./localDatabase-YxUov2-Y.js";import"./log-in-DqM5OFK2.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=R("FileCheck",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ua=R("FileSearch",[["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M4.268 21a2 2 0 0 0 1.727 1H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3",key:"ms7g94"}],["path",{d:"m9 18-1.5-1.5",key:"1j6qii"}],["circle",{cx:"5",cy:"14",r:"3",key:"ufru5t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xa=R("ImageOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M10.41 10.41a2 2 0 1 1-2.83-2.83",key:"1bzlo9"}],["line",{x1:"13.5",x2:"6",y1:"13.5",y2:"21",key:"1q0aeu"}],["line",{x1:"18",x2:"21",y1:"12",y2:"15",key:"5mozeu"}],["path",{d:"M3.59 3.59A1.99 1.99 0 0 0 3 5v14a2 2 0 0 0 2 2h14c.55 0 1.052-.22 1.41-.59",key:"mmje98"}],["path",{d:"M21 15V5a2 2 0 0 0-2-2H9",key:"43el77"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pa=R("List",[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=R("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=R("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=R("ShieldAlert",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ha=R("SwitchCamera",[["path",{d:"M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5",key:"mtk2lu"}],["path",{d:"M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5",key:"120jsl"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"m18 22-3-3 3-3",key:"kgdoj7"}],["path",{d:"m6 2 3 3-3 3",key:"1fnbkv"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ga=R("Target",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]),fa=[{icon:pa,label:"Categoria"},{icon:K,label:"Localização"},{icon:F,label:"Fotos"},{icon:ua,label:"Revisão"}];function ba({currentStep:a,totalSteps:t,labels:s}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:fa.slice(0,t).map((i,r)=>{const l=r+1,c=l<a,o=l===a,d=i.icon;return e.jsxs("div",{className:"flex flex-col items-center flex-1",children:[r>0&&e.jsx("div",{className:A("absolute h-0.5 -translate-y-4",c||o?"bg-primary":"bg-muted"),style:{width:`calc(100% / ${t} - 2rem)`,left:`calc((100% / ${t}) * ${r} + 1rem)`}}),e.jsx(f.div,{initial:{scale:.8},animate:{scale:o?1.1:1},className:A("relative z-10 h-10 w-10 rounded-full flex items-center justify-center transition-all",c&&"bg-primary text-primary-foreground",o&&"bg-primary text-primary-foreground ring-4 ring-primary/20",!c&&!o&&"bg-muted text-muted-foreground"),children:c?e.jsx(We,{className:"h-5 w-5"}):e.jsx(d,{className:"h-5 w-5"})}),e.jsx("span",{className:A("text-xs mt-1.5 font-medium text-center",o&&"text-primary",c&&"text-foreground",!c&&!o&&"text-muted-foreground"),children:s?.[r]||i.label})]},l)})}),e.jsx("div",{className:"relative -mt-[3.2rem] mx-5 h-0.5 bg-muted rounded-full",children:e.jsx(f.div,{className:"h-full bg-primary rounded-full",initial:{width:0},animate:{width:`${(a-1)/(t-1)*100}%`},transition:{type:"spring",stiffness:300,damping:30}})}),e.jsx("div",{className:"h-4"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsxs("span",{className:"font-semibold text-primary",children:["Etapa ",a]}),e.jsxs("span",{className:"text-muted-foreground",children:["de ",t]})]})]})}function ja({title:a,content:t,className:s}){const[i,r]=m.useState(!1),l=Array.isArray(t)?t:[t];return e.jsxs("div",{className:A("inline-flex items-center gap-1",s),children:[e.jsx(f.button,{type:"button",whileTap:{scale:.9},onClick:()=>r(!0),className:"flex h-5 w-5 items-center justify-center rounded-full bg-muted hover:bg-muted/80 transition-colors","aria-label":`Ajuda sobre ${a}`,children:e.jsx(W,{className:"h-3 w-3 text-muted-foreground"})}),e.jsx(ae,{children:i&&e.jsxs(e.Fragment,{children:[e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>r(!1)}),e.jsxs(f.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 safe-bottom",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"flex items-start justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(W,{className:"h-4 w-4 text-primary"})}),e.jsx("h3",{className:"font-semibold text-lg",children:a})]}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full",onClick:()=>r(!1),children:e.jsx(be,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-4 space-y-2",children:l.map((c,o)=>e.jsxs("p",{className:"text-sm text-muted-foreground flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"•"}),e.jsx("span",{children:c})]},o))}),e.jsx(v,{className:"w-full mt-6",onClick:()=>r(!1),children:"Entendi"})]})]})})]})}function te({title:a,subtitle:t,helpTitle:s,helpContent:i}){return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-2xl font-bold",children:a}),i&&e.jsx(ja,{title:s||a,content:i})]}),t&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t})]})}const ya={categories:["report","categories"]};function Re(){const a=Qe({queryKey:ya.categories,queryFn:()=>me.getCategories(),staleTime:18e5,gcTime:36e5});return{categories:a.data??[],isLoading:a.isLoading,error:a.error,refetch:a.refetch}}function Na({draft:a,onUpdate:t,onNext:s}){const{categories:i,isLoading:r,error:l,refetch:c}=Re(),o=i.find(b=>b.id===a.categoryId),d=b=>{t({categoryId:b.id,category:b})},p=!!a.categoryId;return r?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(q,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando categorias..."})]}):l?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(Ye,{className:"h-12 w-12 text-destructive"}),e.jsx("p",{className:"text-muted-foreground text-center",children:"Erro ao carregar categorias."}),e.jsx(v,{onClick:()=>c(),variant:"outline",children:"Tentar novamente"})]}):e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(te,{title:"O que aconteceu?",subtitle:"Escolha a categoria que melhor descreve o problema",helpTitle:"Como escolher a categoria",helpContent:["Escolha a categoria que mais combina com o problema que você quer reportar.","Se tiver dúvida, escolha 'Outros' e descreva com suas palavras.","Não se preocupe em acertar perfeitamente, nossa equipe vai analisar."]}),e.jsx(w,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsx("div",{children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("span",{className:"font-medium",children:"Toque em uma categoria"})," para selecioná-la. Depois você pode detalhar melhor o problema."]})})]})}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:i.map((b,g)=>{const j=a.categoryId===b.id;return e.jsxs(f.button,{type:"button",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:g*.03},whileTap:{scale:.95},onClick:()=>d(b),className:A("relative flex flex-col items-center gap-2 rounded-2xl border-2 p-4 text-center transition-all",j?"border-primary bg-primary/10 shadow-lg":"border-border bg-card hover:bg-muted/50 hover:border-muted-foreground/30"),children:[e.jsx("div",{className:A("text-3xl p-2 rounded-xl transition-colors",j?"bg-primary/20":"bg-muted"),style:{backgroundColor:j?`${b.color}20`:void 0},children:b.icon}),e.jsx("span",{className:A("text-sm font-medium leading-tight",j&&"text-primary"),style:{color:j?b.color:void 0},children:b.name}),j&&e.jsx(f.div,{initial:{scale:0},animate:{scale:1},className:"absolute -top-1 -right-1 h-5 w-5 rounded-full bg-primary flex items-center justify-center",style:{backgroundColor:b.color},children:e.jsx(ue,{className:"h-3 w-3 text-white"})})]},b.id)})}),o&&o.tips.length>0&&e.jsx(f.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"space-y-3",children:e.jsx(w,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-amber-100 dark:bg-amber-900/50",children:e.jsx(Je,{className:"h-4 w-4 text-amber-600 dark:text-amber-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-medium text-amber-800 dark:text-amber-300",children:['Dicas para "',o.name,'"']}),e.jsx("ul",{className:"mt-2 space-y-1",children:o.tips.map((b,g)=>e.jsxs("li",{className:"text-sm text-amber-700 dark:text-amber-400 flex gap-2",children:[e.jsx("span",{className:"shrink-0",children:"•"}),e.jsx("span",{children:b})]},g))})]})]})})}),!a.categoryId&&e.jsx(w,{className:"p-4 border-muted bg-muted/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-muted",children:e.jsx(Xe,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione uma categoria acima para continuar"})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx(v,{size:"lg",className:A("w-full h-14 text-base font-semibold rounded-2xl transition-all",!p&&"opacity-50"),disabled:!p,onClick:s,children:p?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(ue,{className:"h-5 w-5 ml-2"})]}):"Selecione uma categoria"})})})]})}function va({draft:a,onUpdate:t,onNext:s,onBack:i}){const[r,l]=m.useState({status:"idle"}),[c,o]=m.useState(!1),[d,p]=m.useState(""),[b,g]=m.useState([]),[j,k]=m.useState(!1),[S,u]=m.useState(!1),y=m.useCallback(async(n,h)=>{try{u(!0);const C=await me.geocodeReverse(n,h);return C?.address||C?.displayName}catch(C){console.warn("[StepLocation] Reverse geocode failed:",C);return}finally{u(!1)}},[]),N=m.useCallback(async()=>{if(!navigator.geolocation){l({status:"error",errorMessage:"Seu navegador não suporta geolocalização. Tente usar Chrome, Safari ou Firefox."});return}l({status:"requesting"}),navigator.geolocation.getCurrentPosition(async n=>{const h=n.coords.latitude,C=n.coords.longitude,M=await y(h,C),P={latitude:h,longitude:C,accuracy:n.coords.accuracy,address:M||"Tijucas, SC",source:"gps",quality:n.coords.accuracy<=50?"precisa":"aproximada"};t({location:P}),l({status:"success"})},n=>{let h="Não conseguimos acessar sua localização.";n.code===n.PERMISSION_DENIED?(h="Você não permitiu o acesso à sua localização.",l({status:"denied",errorMessage:h})):n.code===n.POSITION_UNAVAILABLE?(h="Não foi possível determinar sua localização. Verifique se o GPS está ativado.",l({status:"error",errorMessage:h})):n.code===n.TIMEOUT&&(h="Demorou muito para obter sua localização. Verifique sua conexão e tente novamente.",l({status:"error",errorMessage:h}))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4})},[t,y]),D=m.useRef(null),z=m.useCallback(async n=>{if(n.length<3){g([]);return}D.current&&D.current.abort(),D.current=new AbortController,k(!0);try{const h=a.location?.latitude,C=a.location?.longitude,M=await me.geocodeAutocomplete(n,h,C);g(M)}catch(h){h.name!=="AbortError"&&console.warn("[StepLocation] Search failed:",h),g([])}finally{k(!1)}},[a.location?.latitude,a.location?.longitude]);m.useEffect(()=>{const n=setTimeout(()=>{d&&z(d)},300);return()=>{clearTimeout(n),D.current&&D.current.abort()}},[d,z]);const G=n=>{const h={latitude:n.latitude,longitude:n.longitude,accuracy:100,address:n.address||n.displayName,source:"manual",quality:"manual"};t({location:h}),l({status:"success"}),p(""),g([]),o(!1)};m.useEffect(()=>{!a.location&&r.status==="idle"&&N()},[a.location,r.status,N]);const I=!!a.location,x=({quality:n})=>{const h={precisa:{color:"text-green-600 bg-green-100",icon:ga,label:"Precisa"},aproximada:{color:"text-amber-600 bg-amber-100",icon:K,label:"Aproximada"},manual:{color:"text-blue-600 bg-blue-100",icon:je,label:"Informada"}}[n]||{color:"text-gray-600 bg-gray-100",icon:K,label:"Desconhecida"},C=h.icon;return e.jsxs("span",{className:A("inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",h.color),children:[e.jsx(C,{className:"h-3 w-3"}),h.label]})};return e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(te,{title:"Onde foi?",subtitle:"Precisamos saber o local do problema",helpTitle:"Por que precisamos da localização?",helpContent:["A localização ajuda nossa equipe a encontrar o problema rapidamente.","Usamos o GPS do seu celular para maior precisão.","Sua localização não é compartilhada publicamente, apenas com a equipe responsável."]}),e.jsx(w,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"Como funciona:"}),e.jsx("p",{children:"Usamos o GPS para marcar o local, ou você pode buscar o endereço manualmente."})]})]})}),e.jsxs("div",{className:"space-y-4",children:[r.status==="requesting"&&e.jsxs(f.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(q,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:S?"Buscando endereço...":"Buscando sua localização..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),r.status==="denied"&&e.jsx(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(K,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Localização bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:r.errorMessage}),e.jsxs(w,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700 text-left",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Localização" para "Permitir"'})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4 w-full",children:[e.jsxs(v,{variant:"outline",className:"flex-1",onClick:N,children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(v,{variant:"secondary",className:"flex-1",onClick:()=>o(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),r.status==="error"&&e.jsx(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(_,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Erro ao obter localização"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:r.errorMessage}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(v,{variant:"outline",className:"flex-1",onClick:N,children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(v,{variant:"secondary",className:"flex-1",onClick:()=>o(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),a.location&&e.jsxs(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-4",children:[e.jsx(w,{className:"p-4 bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100 dark:bg-green-900/50",children:e.jsx(L,{className:"h-5 w-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-green-800 dark:text-green-300",children:"Localização capturada!"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(x,{quality:a.location.quality}),a.location.accuracy&&a.location.source==="gps"&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["±",Math.round(a.location.accuracy),"m"]})]})]})]})}),e.jsx(Ze,{latitude:a.location.latitude,longitude:a.location.longitude,hasGPS:a.location.source==="gps",onLocationChange:async(n,h)=>{const C=await y(n,h);t({location:{...a.location,latitude:n,longitude:h,address:C||a.location.address,source:"mapa",quality:"precisa"}})},onCenterGPS:a.location.source==="gps"?N:void 0}),e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.location.address||"Localização capturada"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Coordenadas: ",a.location.latitude.toFixed(4),", ",a.location.longitude.toFixed(4)]})]}),e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>o(!0),children:[e.jsx(je,{className:"h-3.5 w-3.5 mr-1"}),"Buscar"]})]})})]}),r.status==="idle"&&!a.location&&e.jsxs(f.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center py-8 gap-4",children:[e.jsxs(v,{size:"lg",onClick:N,className:"h-14 px-8 rounded-2xl",children:[e.jsx(Ne,{className:"h-5 w-5 mr-2"}),"Usar minha localização"]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"ou"}),e.jsxs(v,{variant:"outline",onClick:()=>o(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço manualmente"]})]})]}),e.jsx(ae,{children:c&&e.jsxs(e.Fragment,{children:[e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>o(!1)}),e.jsxs(f.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 pb-8 max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsx("h3",{className:"font-semibold text-lg mt-4",children:"Buscar endereço"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Digite o nome da rua ou local"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Ee,{placeholder:"Ex: Rua Principal, Centro, Tijucas",value:d,onChange:n=>p(n.target.value),className:"pl-10 h-12 rounded-xl",autoFocus:!0}),j&&e.jsx(q,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground"})]}),b.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:b.map((n,h)=>e.jsx(f.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:h*.05},onClick:()=>G(n),className:"w-full text-left p-3 rounded-xl border hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(K,{className:"h-5 w-5 text-primary shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:n.address}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:n.displayName})]})]})},n.placeId||h))}),d.length>=3&&b.length===0&&!j&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Nenhum resultado encontrado. Tente outro endereço."}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(v,{variant:"outline",className:"flex-1",onClick:()=>o(!1),children:"Cancelar"}),e.jsxs(v,{className:"flex-1",onClick:N,children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Usar GPS"]})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(v,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:i,children:"Voltar"}),e.jsx(v,{size:"lg",className:A("h-14 rounded-2xl flex-[2] text-base font-semibold",!I&&"opacity-50"),disabled:!I,onClick:s,children:I?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(ue,{className:"h-5 w-5 ml-2"})]}):"Aguardando localização..."})]})})]})}function we(a){if(a===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],i=Math.floor(Math.log(a)/Math.log(t));return`${parseFloat((a/Math.pow(t,i)).toFixed(1))} ${s[i]}`}async function wa(a,t={}){const{maxWidth:s=1200,maxHeight:i=1200,quality:r=.8,format:l="image/webp"}=t;return new Promise((c,o)=>{const d=new Image,p=document.createElement("canvas"),b=p.getContext("2d");if(!b){o(new Error("Canvas context not available"));return}d.onload=()=>{let{width:j,height:k}=d;j>s&&(k=k*s/j,j=s),k>i&&(j=j*i/k,k=i),j=Math.round(j),k=Math.round(k),p.width=j,p.height=k,b.imageSmoothingEnabled=!0,b.imageSmoothingQuality="high",b.drawImage(d,0,0,j,k);const S=p.toDataURL(l).startsWith("data:"+l)?l:"image/jpeg";p.toBlob(u=>{if(!u){o(new Error("Failed to compress image"));return}const y=p.toDataURL(S,r);c({blob:u,dataUrl:y,originalSize:a.size,compressedSize:u.size,compressionRatio:u.size/a.size,width:j,height:k})},S,r)},d.onerror=()=>{o(new Error("Failed to load image"))};const g=new FileReader;g.onload=j=>{d.src=j.target?.result},g.onerror=()=>{o(new Error("Failed to read file"))},g.readAsDataURL(a)})}const E=3;function ka({draft:a,onUpdate:t,onNext:s,onBack:i}){const r=m.useRef(null),l=m.useRef(null),c=m.useRef(null),[o,d]=m.useState({status:"idle",facingMode:"environment",stream:null}),[p,b]=m.useState(!1),[g,j]=m.useState(null),k=typeof window<"u"&&window.isSecureContext,S=m.useCallback(async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){d(x=>({...x,status:"error",errorMessage:"Seu navegador não suporta acesso à câmera. Tente usar Chrome, Safari ou Firefox."}));return}d(x=>({...x,status:"requesting"}));try{const x=await navigator.mediaDevices.getUserMedia({video:{facingMode:o.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:!1});r.current&&(r.current.srcObject=x,await r.current.play()),d(n=>({...n,status:"active",stream:x,errorMessage:void 0}))}catch(x){if(console.error("Camera error:",x),x instanceof DOMException)if(x.name==="NotAllowedError")d(n=>({...n,status:"denied",errorMessage:"Você não permitiu o acesso à câmera."}));else if(x.name==="NotFoundError")d(n=>({...n,status:"error",errorMessage:"Nenhuma câmera foi encontrada no seu dispositivo."}));else if(x.name==="NotReadableError")d(n=>({...n,status:"error",errorMessage:"A câmera está sendo usada por outro aplicativo. Feche outros apps e tente novamente."}));else if(x.name==="OverconstrainedError"){d(n=>({...n,status:"error",errorMessage:"Sua câmera não atende aos requisitos. Tentando configuração alternativa..."}));try{const n=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});r.current&&(r.current.srcObject=n,await r.current.play()),d(h=>({...h,status:"active",stream:n,errorMessage:void 0}))}catch{d(n=>({...n,status:"error",errorMessage:"Não foi possível acessar sua câmera."}))}}else d(n=>({...n,status:"error",errorMessage:"Ocorreu um erro ao acessar a câmera. Tente novamente."}));else d(n=>({...n,status:"error",errorMessage:"Erro desconhecido ao acessar a câmera."}))}},[o.facingMode]),u=m.useCallback(()=>{o.stream&&o.stream.getTracks().forEach(x=>x.stop()),r.current&&(r.current.srcObject=null),d(x=>({...x,status:"idle",stream:null}))},[o.stream]);m.useEffect(()=>((async()=>{if(!navigator.mediaDevices?.enumerateDevices){j(!1);return}try{const h=(await navigator.mediaDevices.enumerateDevices()).some(C=>C.kind==="videoinput");j(h)}catch{j(!1)}})(),()=>{o.stream&&o.stream.getTracks().forEach(n=>n.stop())}),[]);const y=m.useCallback(async()=>{u(),d(x=>({...x,facingMode:x.facingMode==="environment"?"user":"environment"})),setTimeout(()=>S(),100)},[S,u]),N=m.useCallback(async()=>{if(!r.current||!l.current||a.images.length>=E)return;b(!0);const x=r.current,n=l.current,h=n.getContext("2d");if(!h){b(!1);return}n.width=x.videoWidth,n.height=x.videoHeight,h.drawImage(x,0,0),n.toBlob(C=>{if(!C){b(!1);return}const M=new File([C],`photo_${Date.now()}.jpg`,{type:"image/jpeg",lastModified:Date.now()}),P={id:ie(),file:M,previewUrl:URL.createObjectURL(C),capturedAt:new Date};t({images:[...a.images,P]}),b(!1),a.images.length+1>=E&&u()},"image/jpeg",.85)},[a.images,t,u]),D=m.useCallback(x=>{const n=a.images.find(h=>h.id===x);n&&URL.revokeObjectURL(n.previewUrl),t({images:a.images.filter(h=>h.id!==x)}),o.status==="idle"&&a.images.length<=E&&S()},[a.images,o.status,t,S]),z=m.useCallback(x=>{D(x),o.status!=="active"&&S()},[D,o.status,S]),G=m.useCallback(async x=>{const n=x.target.files;if(!n||n.length===0)return;const h=E-a.images.length,C=Array.from(n).slice(0,h);let M=0,P=0;for(const O of C)if(O.type.startsWith("image/"))try{const B=await wa(O,{maxWidth:1920,maxHeight:1920,quality:.75});M+=B.originalSize,P+=B.compressedSize;const re=new File([B.blob],O.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()}),Ke={id:ie(),file:re,previewUrl:URL.createObjectURL(B.blob),capturedAt:new Date};t({images:[...a.images,Ke]})}catch(B){console.error("Failed to compress image:",B);const re={id:ie(),file:O,previewUrl:URL.createObjectURL(O),capturedAt:new Date};t({images:[...a.images,re]})}if(M>0&&P<M){const O=M-P,B=Math.round(O/M*100);$.success(`Imagem otimizada: ${we(M)} → ${we(P)} (-${B}%)`)}c.current&&(c.current.value="")},[a.images,t]),I=m.useCallback(()=>{c.current?.click()},[]);return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(te,{title:"Adicione até 3 fotos",subtitle:"Tire fotos agora ou escolha da galeria",helpTitle:"Dicas para boas fotos",helpContent:["Fotografe de perto para mostrar detalhes do problema.","Inclua uma foto do contexto (rua, número, ponto de referência).","Evite fotos muito escuras ou desfocadas."]}),e.jsx("input",{ref:c,type:"file",accept:"image/*",multiple:!0,onChange:G,className:"hidden"}),e.jsx(w,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-2 text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium",children:"Dicas para boas fotos:"}),e.jsxs("ul",{className:"space-y-1 text-blue-600 dark:text-blue-400",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto de perto do problema"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(xa,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto mostrando o contexto da rua"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Evite se colocar em risco"})]})]})]})]})}),e.jsxs("div",{className:"relative",children:[o.status==="idle"&&a.images.length<E&&e.jsx(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10",children:e.jsx(F,{className:"h-10 w-10 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Adicione fotos do problema"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Fotos ajudam a identificar e resolver o problema mais rápido"})]}),!k&&e.jsx("div",{className:"w-full p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-400",children:[e.jsx(oe,{className:"h-4 w-4 shrink-0"}),e.jsx("p",{className:"text-xs text-left",children:"Câmera exige HTTPS. Use a galeria para adicionar fotos."})]})}),e.jsxs("div",{className:"w-full space-y-2",children:[k&&g!==!1&&e.jsxs(v,{onClick:S,className:"w-full",size:"lg",disabled:g===null,children:[g===null?e.jsx(q,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(F,{className:"h-4 w-4 mr-2"}),"Ativar Câmera"]}),e.jsxs(v,{variant:k&&g!==!1?"outline":"default",onClick:I,className:"w-full",size:"lg",children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Escolher da Galeria"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Você pode pular e continuar sem fotos"})]})})}),o.status==="active"&&a.images.length<E&&e.jsxs(f.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative rounded-2xl overflow-hidden bg-muted aspect-[4/3]",children:[e.jsx("video",{ref:r,autoPlay:!0,playsInline:!0,muted:!0,"webkit-playsinline":"true","x-webkit-airplay":"allow",style:{backgroundColor:"transparent"},className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-4 left-0 right-0 flex items-center justify-center gap-4",children:[e.jsx(f.button,{whileTap:{scale:.9},onClick:y,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Trocar câmera",children:e.jsx(ha,{className:"h-5 w-5"})}),e.jsx(f.button,{whileTap:{scale:.9},onClick:N,disabled:p,className:A("p-1 rounded-full bg-white",p&&"opacity-50"),"aria-label":"Capturar foto",children:e.jsx("div",{className:"h-16 w-16 rounded-full border-4 border-primary flex items-center justify-center",children:p?e.jsx(q,{className:"h-6 w-6 text-primary animate-spin"}):e.jsx(F,{className:"h-6 w-6 text-primary"})})}),e.jsx(f.button,{whileTap:{scale:.9},onClick:I,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Escolher da galeria",children:e.jsx(ye,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"absolute top-4 right-4 px-3 py-1.5 rounded-full bg-black/50 text-white text-sm backdrop-blur-sm flex items-center gap-1",children:[e.jsx(F,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[a.images.length,"/",E]})]})]}),o.status==="requesting"&&e.jsxs(f.div,{initial:{opacity:0},animate:{opacity:1},className:"rounded-2xl bg-muted aspect-[4/3] flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(q,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:"Iniciando câmera..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),o.status==="denied"&&e.jsx(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(oe,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Câmera bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(w,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado ou câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Câmera" para "Permitir"'})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"4."}),e.jsx("span",{children:"Recarregue a página ou toque no botão abaixo"})]})]})]}),e.jsxs(v,{variant:"outline",className:"mt-4 w-full",onClick:S,children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),o.status==="error"&&e.jsx(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(_,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Problema com a câmera"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(w,{className:"w-full p-4 bg-white dark:bg-background border-red-200 dark:border-red-700",children:[e.jsx("p",{className:"font-medium text-sm mb-3",children:"O que você pode fazer:"}),e.jsxs("ul",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Verifique se seu dispositivo tem câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Feche outros aplicativos que usam a câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Tente acessar pelo celular em vez do computador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Você pode continuar sem foto (opcional)"})]})]})]}),e.jsxs(v,{variant:"outline",className:"mt-4 w-full",onClick:S,children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),e.jsx("canvas",{ref:l,className:"hidden"})]}),a.images.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500"}),"Fotos capturadas (",a.images.length,"/",E,")"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(ae,{mode:"popLayout",children:a.images.map((x,n)=>e.jsxs(f.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},layout:!0,className:"relative aspect-square rounded-xl overflow-hidden bg-muted",children:[e.jsx("img",{src:x.previewUrl,alt:`Foto ${n+1}`,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/70 to-transparent",children:e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsxs(f.button,{whileTap:{scale:.9},onClick:()=>z(x.id),className:"px-2 py-1 text-xs bg-white/20 text-white rounded-md backdrop-blur-sm flex items-center gap-1",children:[e.jsx(H,{className:"h-3 w-3"}),"Refazer"]}),e.jsxs(f.button,{whileTap:{scale:.9},onClick:()=>D(x.id),className:"px-2 py-1 text-xs bg-red-500/80 text-white rounded-md flex items-center gap-1",children:[e.jsx(be,{className:"h-3 w-3"}),"Remover"]})]})}),e.jsx("div",{className:"absolute top-2 left-2 h-6 w-6 rounded-full bg-primary text-primary-foreground text-xs font-bold flex items-center justify-center",children:n+1})]},x.id))}),Array.from({length:E-a.images.length}).map((x,n)=>e.jsxs("div",{className:"aspect-square rounded-xl border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-1",children:[e.jsx(F,{className:"h-5 w-5 text-muted-foreground/30"}),e.jsx("span",{className:"text-xs text-muted-foreground/50",children:"Vazio"})]},`empty-${n}`))]})]}),a.images.length>=E&&e.jsx(w,{className:"p-4 text-center bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(L,{className:"h-5 w-5"}),e.jsxs("span",{className:"font-medium",children:["Você tirou ",E," fotos. Pronto para continuar!"]})]})}),a.images.length===0&&(o.status==="error"||o.status==="denied")&&e.jsx(w,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(_,{className:"h-5 w-5 text-amber-600 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800 dark:text-amber-300",children:"Continuar sem foto?"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-1",children:"Fotos ajudam muito a identificar o problema, mas você pode continuar sem elas."})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(v,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:()=>{u(),i()},children:"Voltar"}),e.jsxs(v,{size:"lg",className:"h-14 rounded-2xl flex-[2] text-base font-semibold",onClick:()=>{u(),s()},children:["Continuar",a.images.length===0&&e.jsx("span",{className:"text-xs ml-2 opacity-70",children:"(sem foto)"})]})]})})]})}function Ca({draft:a,onUpdate:t,onBack:s,onGoToStep:i,onSubmit:r}){const[l,c]=m.useState(!1),{categories:o}=Re(),d=o.find(g=>g.id===a.categoryId),p=!!a.categoryId&&!!a.location&&a.confirmed&&!!a.title?.trim(),b=async()=>{if(p){c(!0);try{await r()}catch(g){console.error("Submit error:",g)}finally{c(!1)}}};return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(te,{title:"Revisar e enviar",subtitle:"Adicione um título e confira as informações",helpTitle:"Última etapa!",helpContent:["Adicione um título curto que descreva o problema.","Revise todas as informações antes de enviar.","Após enviar, você receberá um número de protocolo."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(ra,{className:"h-4 w-4 text-muted-foreground"}),"Título da denúncia *"]}),e.jsx(Ee,{placeholder:"Ex: Buraco grande na Rua Principal",value:a.title||"",onChange:g=>t({title:g.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Descreva o problema em poucas palavras (obrigatório)"})]}),e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl text-2xl",style:{backgroundColor:d?.color+"20"},children:d?.icon||"❓"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Categoria"}),e.jsx("p",{className:"font-semibold",children:d?.name||"Não selecionada"})]})]}),e.jsxs(v,{variant:"ghost",size:"sm",onClick:()=>i(1),className:"text-primary",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(K,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-semibold",children:a.location?.address||"Localização capturada"}),a.location?.quality&&e.jsx(ea,{variant:"secondary",className:"mt-1 text-xs capitalize",children:a.location.quality})]})]}),e.jsxs(v,{variant:"ghost",size:"sm",onClick:()=>i(2),className:"text-primary",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsxs(w,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(F,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Fotos"}),e.jsxs("p",{className:"font-semibold",children:[a.images.length," ",a.images.length===1?"foto anexada":"fotos anexadas"]})]})]}),e.jsxs(v,{variant:"ghost",size:"sm",onClick:()=>i(3),className:"text-primary",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Editar"]})]}),a.images.length>0?e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:a.images.map((g,j)=>e.jsx("img",{src:g.previewUrl,alt:`Foto ${j+1}`,className:"h-20 w-20 rounded-lg object-cover shrink-0"},g.id))}):e.jsxs("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx("p",{className:"text-sm",children:"Nenhuma foto anexada (opcional)"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"}),"Descrição adicional (opcional)"]}),e.jsx(ta,{placeholder:"Algum detalhe importante? (máx. 500 caracteres)",maxLength:500,value:a.description,onChange:g=>t({description:g.target.value}),className:"min-h-[100px] rounded-xl resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[a.description.length,"/500"]})]}),e.jsx(w,{className:A("p-4 transition-all border-2",a.confirmed?"border-green-400 bg-green-50 dark:bg-green-950/20 dark:border-green-700":"border-amber-400 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-700"),children:e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[e.jsx(aa,{checked:a.confirmed,onCheckedChange:g=>t({confirmed:!!g}),className:"mt-0.5 h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:A("font-medium",a.confirmed?"text-green-700 dark:text-green-300":"text-amber-700 dark:text-amber-300"),children:a.confirmed?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"Confirmado!"]}):"Confirmo que as informações são verdadeiras"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:a.confirmed?"Você confirmou que as informações são verdadeiras":"Marque para poder enviar a denúncia"})]})]})}),!p&&e.jsx(w,{className:"p-4 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(_,{className:"h-5 w-5 text-red-600 dark:text-red-400 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 dark:text-red-300",children:"Não é possível enviar ainda"}),e.jsxs("ul",{className:"text-sm text-red-700 dark:text-red-400 mt-1 space-y-1",children:[!a.title?.trim()&&e.jsx("li",{children:"• Adicione um título"}),!a.categoryId&&e.jsx("li",{children:"• Selecione uma categoria"}),!a.location&&e.jsx("li",{children:"• Capture sua localização"}),!a.confirmed&&e.jsx("li",{children:"• Confirme que as informações são verdadeiras"})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(v,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:s,disabled:l,children:"Voltar"}),e.jsx(v,{size:"lg",className:A("h-14 rounded-2xl flex-[2] text-base font-semibold",p?"bg-green-600 hover:bg-green-700":"opacity-50"),disabled:!p||l,onClick:b,children:l?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"h-5 w-5 mr-2 animate-spin"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(sa,{className:"h-5 w-5 mr-2"}),"Enviar denúncia"]})})]})})]})}function Sa({protocolNumber:a,onClose:t}){const{toast:s}=Ge(),i=m.useCallback(()=>{const o=Date.now()+3e3,d={startVelocity:30,spread:360,ticks:60,zIndex:100},p=(g,j)=>Math.random()*(j-g)+g,b=setInterval(()=>{const g=o-Date.now();if(g<=0)return clearInterval(b);const j=50*(g/3e3);Y({...d,particleCount:j,origin:{x:p(.1,.3),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),Y({...d,particleCount:j,origin:{x:p(.7,.9),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]})},250);return Y({particleCount:100,spread:70,origin:{y:.6},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),()=>clearInterval(b)},[]);m.useEffect(()=>i(),[i]);const r=async()=>{try{await navigator.clipboard.writeText(a),s({title:"Protocolo copiado!",description:"Cole onde quiser para guardar."})}catch{s({title:"Erro ao copiar",description:"Tente copiar manualmente.",variant:"destructive"})}},l=async()=>{if(navigator.share)try{await navigator.share({title:"Denúncia Enviada - eTijucas",text:`Minha denúncia foi registrada com sucesso! Protocolo: ${a}`})}catch{console.log("Share cancelled")}else r()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-gradient-to-b from-green-50 to-background dark:from-green-950/30 dark:to-background flex flex-col items-center justify-center p-6 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(6)].map((c,o)=>e.jsx(f.div,{initial:{opacity:0,scale:0},animate:{opacity:[0,.3,0],scale:[0,1.5,2],x:Math.random()*100-50,y:Math.random()*100-50},transition:{duration:3,delay:o*.3,repeat:1/0,repeatDelay:2},className:"absolute rounded-full bg-green-400/20",style:{width:100+o*30,height:100+o*30,left:`${20+o*10}%`,top:`${15+o*12}%`}},o))}),e.jsxs(f.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},transition:{duration:.5},className:"relative z-10 w-full max-w-sm flex flex-col items-center text-center",children:[e.jsxs(f.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},className:"relative mb-6",children:[e.jsx("div",{className:"p-6 rounded-full bg-green-100 dark:bg-green-900/50 shadow-lg shadow-green-500/20",children:e.jsx(L,{className:"h-20 w-20 text-green-600 dark:text-green-400"})}),e.jsx(f.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(ia,{className:"h-8 w-8 text-yellow-500"})}),e.jsx(f.div,{animate:{rotate:-360},transition:{duration:4,repeat:1/0,ease:"linear"},className:"absolute -bottom-1 -left-3",children:e.jsx(ve,{className:"h-7 w-7 text-pink-500"})})]}),e.jsx(f.h1,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-3xl font-bold text-green-700 dark:text-green-400 mb-2",children:"Denúncia Enviada!"}),e.jsx(f.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"text-muted-foreground mb-6",children:"Obrigado por ajudar a melhorar nossa cidade!"}),e.jsx(f.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"w-full",children:e.jsxs(w,{className:"p-6 bg-white dark:bg-card border-green-200 dark:border-green-800 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-3",children:[e.jsx(Te,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground font-medium",children:"Número do Protocolo"})]}),e.jsx(f.p,{className:"text-2xl font-bold font-mono text-primary mb-4",animate:{scale:[1,1.02,1]},transition:{duration:2,repeat:1/0},children:a}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{variant:"outline",size:"sm",className:"flex-1",onClick:r,children:[e.jsx(na,{className:"h-4 w-4 mr-2"}),"Copiar"]}),e.jsxs(v,{variant:"outline",size:"sm",className:"flex-1",onClick:l,children:[e.jsx(oa,{className:"h-4 w-4 mr-2"}),"Compartilhar"]})]})]})}),e.jsx(f.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.7},className:"text-xs text-muted-foreground mt-4 max-w-xs",children:"Guarde este número para acompanhar o andamento da sua denúncia. Nossa equipe irá analisar e tomar as providências necessárias."}),e.jsxs(f.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.8},className:"w-full mt-8 space-y-3",children:[e.jsxs(v,{size:"lg",className:"w-full h-14 rounded-2xl text-base font-semibold bg-green-600 hover:bg-green-700",onClick:t,children:[e.jsx(He,{className:"h-5 w-5 mr-2"}),"Voltar para o início"]}),e.jsxs(v,{variant:"ghost",size:"lg",className:"w-full h-12 rounded-2xl text-base",onClick:()=>{Y({particleCount:100,spread:70,origin:{y:.6},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]})},children:[e.jsx(ve,{className:"h-5 w-5 mr-2"}),"Celebrar mais! 🎉"]})]})]})]})}const xe=(a,t)=>t.some(s=>a instanceof s);let ke,Ce;function Da(){return ke||(ke=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ia(){return Ce||(Ce=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const pe=new WeakMap,ce=new WeakMap,se=new WeakMap;function Aa(a){const t=new Promise((s,i)=>{const r=()=>{a.removeEventListener("success",l),a.removeEventListener("error",c)},l=()=>{s(U(a.result)),r()},c=()=>{i(a.error),r()};a.addEventListener("success",l),a.addEventListener("error",c)});return se.set(t,a),t}function Ma(a){if(pe.has(a))return;const t=new Promise((s,i)=>{const r=()=>{a.removeEventListener("complete",l),a.removeEventListener("error",c),a.removeEventListener("abort",c)},l=()=>{s(),r()},c=()=>{i(a.error||new DOMException("AbortError","AbortError")),r()};a.addEventListener("complete",l),a.addEventListener("error",c),a.addEventListener("abort",c)});pe.set(a,t)}let he={get(a,t,s){if(a instanceof IDBTransaction){if(t==="done")return pe.get(a);if(t==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return U(a[t])},set(a,t,s){return a[t]=s,!0},has(a,t){return a instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in a}};function Pe(a){he=a(he)}function za(a){return Ia().includes(a)?function(...t){return a.apply(ge(this),t),U(this.request)}:function(...t){return U(a.apply(ge(this),t))}}function Ea(a){return typeof a=="function"?za(a):(a instanceof IDBTransaction&&Ma(a),xe(a,Da())?new Proxy(a,he):a)}function U(a){if(a instanceof IDBRequest)return Aa(a);if(ce.has(a))return ce.get(a);const t=Ea(a);return t!==a&&(ce.set(a,t),se.set(t,a)),t}const ge=a=>se.get(a);function Ta(a,t,{blocked:s,upgrade:i,blocking:r,terminated:l}={}){const c=indexedDB.open(a,t),o=U(c);return i&&c.addEventListener("upgradeneeded",d=>{i(U(c.result),d.oldVersion,d.newVersion,U(c.transaction),d)}),s&&c.addEventListener("blocked",d=>s(d.oldVersion,d.newVersion,d)),o.then(d=>{l&&d.addEventListener("close",()=>l()),r&&d.addEventListener("versionchange",p=>r(p.oldVersion,p.newVersion,p))}).catch(()=>{}),o}const La=["get","getKey","getAll","getAllKeys","count"],Ra=["put","add","delete","clear"],le=new Map;function Se(a,t){if(!(a instanceof IDBDatabase&&!(t in a)&&typeof t=="string"))return;if(le.get(t))return le.get(t);const s=t.replace(/FromIndex$/,""),i=t!==s,r=Ra.includes(s);if(!(s in(i?IDBIndex:IDBObjectStore).prototype)||!(r||La.includes(s)))return;const l=async function(c,...o){const d=this.transaction(c,r?"readwrite":"readonly");let p=d.store;return i&&(p=p.index(o.shift())),(await Promise.all([p[s](...o),r&&d.done]))[0]};return le.set(t,l),l}Pe(a=>({...a,get:(t,s,i)=>Se(t,s)||a.get(t,s,i),has:(t,s)=>!!Se(t,s)||a.has(t,s)}));const Pa=["continue","continuePrimaryKey","advance"],De={},fe=new WeakMap,Be=new WeakMap,Ba={get(a,t){if(!Pa.includes(t))return a[t];let s=De[t];return s||(s=De[t]=function(...i){fe.set(this,Be.get(this)[t](...i))}),s}};async function*Fa(...a){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...a)),!t)return;t=t;const s=new Proxy(t,Ba);for(Be.set(s,t),se.set(s,ge(t));t;)yield s,t=await(fe.get(s)||t.continue()),fe.delete(s)}function Ie(a,t){return t===Symbol.asyncIterator&&xe(a,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&xe(a,[IDBIndex,IDBObjectStore])}Pe(a=>({...a,get(t,s,i){return Ie(t,s)?Fa:a.get(t,s,i)},has(t,s){return Ie(t,s)||a.has(t,s)}}));const Ae="etijucas-reports",qa=2;let T=null,J=!1;async function V(){if(T&&J)return T;try{return T=await Ta(Ae,qa,{upgrade(a,t,s){if(console.log(`[reportDraftDB] Upgrading from v${t} to v${s}`),!a.objectStoreNames.contains("drafts")){const i=a.createObjectStore("drafts",{keyPath:"id"});i.createIndex("by-status","syncStatus"),i.createIndex("by-updated","updatedAt")}a.objectStoreNames.contains("images")||a.createObjectStore("images",{keyPath:"id"}).createIndex("by-draft","draftId")},blocked(){console.warn("[reportDraftDB] Database blocked - close other tabs")},blocking(){T?.close(),T=null,J=!1}}),J=!0,T}catch(a){if(console.error("[reportDraftDB] Failed to open database:",a),a instanceof Error&&a.name==="NotFoundError"){console.warn("[reportDraftDB] Corrupted database, deleting and recreating...");try{return T&&(T.close(),T=null),await new Promise((t,s)=>{const i=indexedDB.deleteDatabase(Ae);i.onsuccess=()=>t(),i.onerror=()=>s(i.error),i.onblocked=()=>{console.warn("[reportDraftDB] Delete blocked"),t()}}),console.log("[reportDraftDB] Database deleted, recreating..."),J=!1,V()}catch(t){throw console.error("[reportDraftDB] Failed to delete database:",t),t}}throw a}}function Fe(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async function qe(a,t="draft"){const s=await V(),i=a.idempotencyKey||Fe(),r=Date.now(),l={categoryId:a.categoryId,category:a.category,location:a.location,title:a.title,description:a.description,confirmed:a.confirmed,currentStep:a.currentStep,createdAt:a.createdAt.getTime(),updatedAt:r,idempotencyKey:a.idempotencyKey};await s.put("drafts",{id:i,draft:l,syncStatus:t,createdAt:r,updatedAt:r});const c=s.transaction("images","readwrite"),o=await s.getAllFromIndex("images","by-draft",i);for(const d of o)await c.store.delete(d.id);for(const d of a.images){const p=d.file;await c.store.put({id:d.id,draftId:i,blob:p,filename:d.file.name,capturedAt:d.capturedAt.getTime()})}return await c.done,i}async function Oa(a){const t=await V(),s=await t.get("drafts",a);if(!s)return null;const r=(await t.getAllFromIndex("images","by-draft",a)).map(c=>{const o=new File([c.blob],c.filename,{type:c.blob.type});return{id:c.id,file:o,previewUrl:URL.createObjectURL(c.blob),capturedAt:new Date(c.capturedAt)}}),l=s.draft;return{categoryId:l.categoryId,category:l.category,location:l.location,title:l.title,description:l.description,confirmed:l.confirmed,currentStep:l.currentStep,createdAt:new Date(l.createdAt),updatedAt:new Date(l.updatedAt),idempotencyKey:l.idempotencyKey,images:r}}async function Ua(){const a=await V(),t=await a.getAll("drafts");return(await Promise.all(t.map(async i=>{const r=await a.getAllFromIndex("images","by-draft",i.id);return{id:i.id,draft:i.draft,syncStatus:i.syncStatus,imageCount:r.length,updatedAt:i.updatedAt}}))).sort((i,r)=>r.updatedAt-i.updatedAt)}async function Oe(a){return(await(await V()).getAllFromIndex("drafts","by-status",a)).map(i=>i.id)}async function Va(a,t){const s=await V(),i=await s.get("drafts",a);i&&await s.put("drafts",{...i,syncStatus:t,updatedAt:Date.now()})}async function Ue(a){const t=await V(),s=await t.getAllFromIndex("images","by-draft",a),i=t.transaction("images","readwrite");for(const r of s)await i.store.delete(r.id);await i.done,await t.delete("drafts",a)}async function $a(){const a=await Oe("sent");let t=0;for(const s of a)await Ue(s),t++;return t}function Ve(a){for(const t of a)t.previewUrl?.startsWith("blob:")&&URL.revokeObjectURL(t.previewUrl)}const Me="report_draft";async function $e(){try{const a=localStorage.getItem(Me);if(!a)return!1;const t=JSON.parse(a);if(!t)return!1;const s={categoryId:t.categoryId||null,category:t.category||null,location:t.location||null,title:t.title||"",description:t.description||"",confirmed:!1,currentStep:t.currentStep||1,createdAt:new Date,updatedAt:new Date,idempotencyKey:Fe(),images:[]};return await qe(s,"draft"),localStorage.removeItem(Me),console.log("[reportDraftDB] Migrated draft from localStorage to IndexedDB"),!0}catch(a){return console.error("[reportDraftDB] Migration failed:",a),!1}}const X={saveDraft:qe,getDraft:Oa,getAllDrafts:Ua,getDraftsByStatus:Oe,updateDraftStatus:Va,deleteDraft:Ue,clearSentDrafts:$a,revokeImageURLs:Ve,migrateFromLocalStorage:$e},ee=()=>`report-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,de={categoryId:null,category:null,location:null,images:[],title:"",description:"",confirmed:!1,currentStep:1,createdAt:new Date,updatedAt:new Date,idempotencyKey:ee()},ze="etijucas-report-draft",Z="active-report-draft";function Ka(){const[a,t]=m.useState(()=>({...de,idempotencyKey:ee()})),[s,i]=m.useState(!0),r=m.useRef(null),l=m.useRef(!0);m.useEffect(()=>{l.current=!0;async function u(){try{await $e();const y=await X.getDraft(Z);y&&l.current&&t(y)}catch(y){console.error("[useReportDraft] Error loading draft:",y);try{const N=localStorage.getItem(ze);if(N){const D=JSON.parse(N);l.current&&t({...de,...D,createdAt:new Date(D.createdAt||Date.now()),updatedAt:new Date(D.updatedAt||Date.now()),images:[],idempotencyKey:D.idempotencyKey||ee()})}}catch(N){console.error("[useReportDraft] localStorage fallback failed:",N)}}finally{l.current&&i(!1)}}return u(),()=>{l.current=!1,r.current&&clearTimeout(r.current)}},[]);const c=m.useCallback(async u=>{r.current&&clearTimeout(r.current),r.current=setTimeout(async()=>{try{const y={...u,idempotencyKey:Z};await X.saveDraft(y,"draft")}catch(y){console.error("[useReportDraft] Error saving draft:",y)}},500)},[]),o=m.useCallback(u=>{t(y=>{const N={...y,...u,updatedAt:new Date};return c(N),N})},[c]),d=m.useCallback(u=>{t(y=>{if(y.images.length>=3)return y;const N={...y,images:[...y.images,u],updatedAt:new Date};return c(N),N})},[c]),p=m.useCallback(u=>{t(y=>{const N=y.images.find(z=>z.id===u);N&&URL.revokeObjectURL(N.previewUrl);const D={...y,images:y.images.filter(z=>z.id!==u),updatedAt:new Date};return c(D),D})},[c]),b=m.useCallback(u=>{o({currentStep:u})},[o]),g=m.useCallback(()=>{t(u=>{if(u.currentStep<4){const y=u.currentStep+1,N={...u,currentStep:y,updatedAt:new Date};return c(N),N}return u})},[c]),j=m.useCallback(()=>{t(u=>{if(u.currentStep>1){const y=u.currentStep-1,N={...u,currentStep:y,updatedAt:new Date};return c(N),N}return u})},[c]),k=m.useCallback(async()=>{Ve(a.images);try{await X.deleteDraft(Z)}catch(u){console.error("[useReportDraft] Error deleting draft:",u)}localStorage.removeItem(ze),t({...de,idempotencyKey:ee()})},[a.images]),S=m.useCallback(async()=>{r.current&&clearTimeout(r.current);try{const u={...a,idempotencyKey:Z};await X.saveDraft(u,"draft")}catch(u){console.error("[useReportDraft] Error saving draft:",u)}},[a]);return{draft:a,isLoading:s,updateDraft:o,addImage:d,removeImage:p,goToStep:b,nextStep:g,prevStep:j,clearDraft:k,saveDraft:S}}const Ga=["Categoria","Localização","Fotos","Revisão"],Ha={enter:a=>({x:a>0?"100%":"-100%",opacity:0}),center:{x:0,opacity:1},exit:a=>({x:a<0?"100%":"-100%",opacity:0})};function Mt(){const a=_e(),{isAuthenticated:t}=da();if(!t)return e.jsx(ca,{title:"Cadastre-se ou entre",message:"Para enviar uma denúncia, você precisa estar cadastrado no aplicativo.",returnUrl:"/denuncia/nova"});const{draft:s,isLoading:i,updateDraft:r,nextStep:l,prevStep:c,clearDraft:o}=Ka(),[d,p]=m.useState(0),[b,g]=m.useState(!1),[j,k]=m.useState(null),{createReport:S}=la(),u=m.useCallback(I=>{p(I>s.currentStep?1:-1),r({currentStep:I})},[s.currentStep,r]),y=m.useCallback(()=>{p(1),l()},[l]),N=m.useCallback(()=>{p(-1),c()},[c]),D=m.useCallback(async()=>{if(!s.categoryId){$.error("Selecione uma categoria para a denúncia");return}if(!s.title||s.title.trim().length<5){$.error("O título deve ter pelo menos 5 caracteres");return}if(!s.description||s.description.trim().length<10){$.error("A descrição deve ter pelo menos 10 caracteres");return}try{const I={categoryId:s.categoryId,title:s.title.trim(),description:s.description.trim(),images:s.images.map(n=>n.file)};s.location&&(I.addressText=s.location.address,I.addressSource=s.location.source,I.locationQuality=s.location.quality,I.latitude=s.location.latitude,I.longitude=s.location.longitude,I.locationAccuracyM=s.location.accuracy?Math.min(Math.round(s.location.accuracy),1e4):void 0);const x=await S({payload:I,idempotencyKey:s.idempotencyKey});k(x.protocol),g(!0),o(),$.success("Denúncia enviada com sucesso!")}catch(I){console.error("Error submitting report:",I),$.error("Erro ao enviar denúncia. Tente novamente.")}},[s,S,o]),z=()=>{s.categoryId||s.location||s.images.length>0?window.confirm("Tem certeza que deseja sair? Seu rascunho será salvo.")&&a(-1):a(-1)},G=()=>{a("/")};return i?e.jsx("div",{className:"fixed inset-0 z-50 bg-background flex items-center justify-center",children:e.jsx(q,{className:"h-8 w-8 animate-spin text-primary"})}):b&&j?e.jsx(Sa,{protocolNumber:j,onClose:G}):e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"shrink-0 bg-background/95 backdrop-blur-lg border-b safe-top",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsx(v,{variant:"ghost",size:"icon",onClick:z,className:"rounded-full",children:e.jsx(ma,{className:"h-5 w-5"})}),e.jsx("h1",{className:"font-semibold text-lg",children:"Enviar Denúncia"}),e.jsx(v,{variant:"ghost",size:"icon",onClick:z,className:"rounded-full",children:e.jsx(be,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"px-4 pb-4",children:e.jsx(ba,{currentStep:s.currentStep,totalSteps:4,labels:Ga})})]}),e.jsx("main",{className:"flex-1 overflow-hidden",children:e.jsx(ae,{mode:"wait",custom:d,children:e.jsxs(f.div,{custom:d,variants:Ha,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},className:"h-full overflow-y-auto px-4 pt-4",children:[s.currentStep===1&&e.jsx(Na,{draft:s,onUpdate:r,onNext:y}),s.currentStep===2&&e.jsx(va,{draft:s,onUpdate:r,onNext:y,onBack:N}),s.currentStep===3&&e.jsx(ka,{draft:s,onUpdate:r,onNext:y,onBack:N}),s.currentStep===4&&e.jsx(Ca,{draft:s,onUpdate:r,onBack:N,onGoToStep:u,onSubmit:D})]},s.currentStep)})})]})}export{Mt as default};
