import{aQ as K,aR as F,aS as M,r as w,j as e,m,aj as Z,a as J,l as z,X as ee,aT as te,z as se,aU as ae,aV as re,M as B,a8 as ne,aW as oe,aX as ie,aE as le,K as ce,w as de,ay as ue,x as me,ax as xe,O as pe,aY as he,a3 as fe,U as ge}from"./vendor-app-B8nTTOoa.js";import{Q as u,f as I,u as V,a as be,B as E}from"./index-BAqHRbEy.js";import{b as je}from"./bairros-Cf5Z_oCw.js";import{t as k}from"./useUploadImage-8EfOUnsk.js";import{B as ye}from"./badge-BzHzSyuX.js";import{S as d}from"./skeleton-XkZreYS5.js";import{f as ve,a as Ne}from"./formatTimeAgo-EjzWxCyI.js";import{C as we,a as ke}from"./CommentComposer-DjclqBIj.js";import{D as Ce,a as Te,b as Se,c as j,d as Ae}from"./dropdown-menu-BMpsHFIy.js";import"./textarea-CVBamwVG.js";function De(t){return K({queryKey:u.topics.detail(t),queryFn:()=>k.getById(t),enabled:!!t,retry:(r,n)=>n?.status===404?!1:r<3})}function Le(t){return K({queryKey:u.topics.comments(t),queryFn:()=>k.getComments(t),enabled:!!t})}function Pe(){const t=F();return M({mutationFn:async({id:r})=>k.toggleLike(r),onSuccess:(r,{id:n})=>{t.invalidateQueries({queryKey:u.topics.all}),t.invalidateQueries({queryKey:u.topics.detail(n)})}})}function qe(t){const r=F();return M({mutationFn:n=>k.addComment(t,n),onSuccess:()=>{r.invalidateQueries({queryKey:u.topics.comments(t)}),r.invalidateQueries({queryKey:u.topics.detail(t)})}})}function Ee(t){const r=F();return M({onMutate:async({commentId:n,liked:a})=>{await r.cancelQueries({queryKey:u.topics.comments(t)});const l=r.getQueryData(u.topics.comments(t));return r.setQueryData(u.topics.comments(t),s=>s&&{...s,data:_(s.data,n,!a)}),{previousComments:l}},mutationFn:async({commentId:n})=>k.toggleCommentLike(n),onError:(n,a,l)=>{l?.previousComments&&r.setQueryData(u.topics.comments(t),l.previousComments)},onSettled:()=>{setTimeout(()=>{r.invalidateQueries({queryKey:u.topics.comments(t)})},500)}})}function _(t,r,n){return t.map(a=>a.id===r?{...a,liked:n,likesCount:n?(a.likesCount??0)+1:Math.max(0,(a.likesCount??0)-1)}:a.replies&&a.replies.length>0?{...a,replies:_(a.replies,r,n)}:a)}function Fe({images:t,alt:r=""}){const[n,a]=w.useState(null),[l,s]=w.useState(0);if(t.length===0)return null;const h=o=>{a(o),s(o),document.body.style.overflow="hidden"},f=()=>{a(null),document.body.style.overflow=""},y=()=>{s(o=>(o+1)%t.length)},g=()=>{s(o=>(o-1+t.length)%t.length)};return e.jsxs(e.Fragment,{children:[t.length===1?e.jsxs(m.button,{whileTap:{scale:.98},onClick:()=>h(0),className:"relative w-full aspect-video rounded-xl overflow-hidden bg-muted group",children:[e.jsx("img",{src:t[0],alt:r,loading:"lazy",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center",children:e.jsx(Z,{className:"w-8 h-8 text-white opacity-0 group-hover:opacity-80 transition-opacity drop-shadow-lg"})})]}):e.jsx("div",{className:"flex gap-2 overflow-x-auto scrollbar-hide -mx-4 px-4",children:t.map((o,i)=>e.jsxs(m.button,{whileTap:{scale:.95},onClick:()=>h(i),className:"relative flex-shrink-0 w-32 h-32 rounded-xl overflow-hidden bg-muted group",children:[e.jsx("img",{src:o,alt:`${r} ${i+1}`,loading:"lazy",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"})]},i))}),n!==null&&J.createPortal(e.jsx(z,{children:e.jsxs(m.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black flex flex-col",onClick:f,children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 safe-top",children:[e.jsxs("span",{className:"text-white/70 text-sm",children:[l+1," / ",t.length]}),e.jsx("button",{onClick:f,className:"p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center","aria-label":"Fechar",children:e.jsx(ee,{className:"w-6 h-6 text-white"})})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center px-4",onClick:o=>o.stopPropagation(),children:e.jsx(m.img,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},src:t[l],alt:`${r} ${l+1}`,className:"max-w-full max-h-full object-contain rounded-lg",draggable:!1},l)}),t.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:o=>{o.stopPropagation(),g()},className:"absolute left-2 top-1/2 -translate-y-1/2 p-3 rounded-full bg-white/10 hover:bg-white/20 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center","aria-label":"Imagem anterior",children:e.jsx(te,{className:"w-6 h-6 text-white"})}),e.jsx("button",{onClick:o=>{o.stopPropagation(),y()},className:"absolute right-2 top-1/2 -translate-y-1/2 p-3 rounded-full bg-white/10 hover:bg-white/20 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center","aria-label":"Pr√≥xima imagem",children:e.jsx(se,{className:"w-6 h-6 text-white"})})]}),t.length>1&&e.jsx("div",{className:"flex justify-center gap-2 py-4 safe-bottom",children:t.map((o,i)=>e.jsx("button",{onClick:v=>{v.stopPropagation(),s(i)},className:`w-2 h-2 rounded-full transition-colors ${i===l?"bg-white":"bg-white/30"}`,"aria-label":`Ir para imagem ${i+1}`},i))})]})}),document.body)]})}function Me({topicId:t,topicTitle:r,topicText:n,bairroId:a,isAnonymous:l,children:s,onSave:h,onHide:f,onReport:y,onBlock:g,onConvertToObservation:o}){const{toast:i}=I(),[v,x]=w.useState(!1),D=async()=>{const q=`${window.location.origin}/topico/${t}`;await navigator.clipboard.writeText(q),i({title:"Link copiado!",description:"O link foi copiado para a √°rea de transfer√™ncia."}),x(!1)},L=()=>{h?.(),i({title:"Observa√ß√£o salva",description:"Voc√™ pode encontr√°-la nos salvos."}),x(!1)},p=()=>{f?.(),i({title:"Observa√ß√£o oculta",description:"Voc√™ n√£o ver√° mais esta observa√ß√£o."}),x(!1)},C=()=>{y?.(),i({title:"Den√∫ncia enviada",description:"Obrigado por ajudar a manter a comunidade segura."}),x(!1)},P=()=>{g?.(),i({title:"Usu√°rio bloqueado",description:"Voc√™ n√£o ver√° mais publica√ß√µes desta pessoa."}),x(!1)},N=()=>{o?.(),x(!1)};return e.jsxs(Ce,{open:v,onOpenChange:x,children:[e.jsx(Te,{asChild:!0,children:s}),e.jsxs(Se,{align:"end",className:"w-56 rounded-xl",children:[e.jsxs(j,{onClick:L,className:"flex items-center gap-3 py-3 cursor-pointer",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{children:"Salvar"})]}),e.jsxs(j,{onClick:D,className:"flex items-center gap-3 py-3 cursor-pointer",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{children:"Copiar link"})]}),e.jsxs(j,{onClick:N,className:"flex items-center gap-3 py-3 cursor-pointer text-primary",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsx("span",{children:"Virar Observa√ß√£o no Mapa"})]}),e.jsx(Ae,{}),e.jsxs(j,{onClick:p,className:"flex items-center gap-3 py-3 cursor-pointer",children:[e.jsx(ne,{className:"w-4 h-4"}),e.jsx("span",{children:"Ocultar este assunto"})]}),e.jsxs(j,{onClick:C,className:"flex items-center gap-3 py-3 cursor-pointer text-orange-600",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Denunciar"})]}),!l&&e.jsxs(j,{onClick:P,className:"flex items-center gap-3 py-3 cursor-pointer text-red-600",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{children:"Bloquear usu√°rio"})]})]})]})}const U={reclamacao:{label:"Reclama√ß√£o",color:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"},sugestao:{label:"Sugest√£o",color:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400"},duvida:{label:"D√∫vida",color:"bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400"},alerta:{label:"Alerta",color:"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400"},elogio:{label:"Elogio",color:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"},outros:{label:"Outros",color:"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400"}};function Oe(){return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"sticky top-0 z-20 bg-background/95 backdrop-blur-md border-b border-border safe-top",children:e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(d,{className:"w-10 h-10 rounded-full"}),e.jsx(d,{className:"w-24 h-6"})]}),e.jsx(d,{className:"w-10 h-10 rounded-full"})]})}),e.jsxs("article",{className:"px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{className:"w-24 h-6 rounded-full"}),e.jsx(d,{className:"w-20 h-6 rounded-full"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(d,{className:"w-10 h-10 rounded-full"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(d,{className:"w-32 h-4"}),e.jsx(d,{className:"w-16 h-3"})]})]}),e.jsx(d,{className:"w-full h-8"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{className:"w-full h-4"}),e.jsx(d,{className:"w-full h-4"}),e.jsx(d,{className:"w-3/4 h-4"})]})]})]})}function Qe(){const t=V();return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"w-20 h-20 mx-auto rounded-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-3xl",children:"üîç"})}),e.jsx("h2",{className:"text-xl font-semibold",children:"T√≥pico n√£o encontrado"}),e.jsx("p",{className:"text-muted-foreground max-w-sm",children:"Este t√≥pico pode ter sido removido ou o link est√° incorreto."}),e.jsx(E,{onClick:()=>t(-1),variant:"outline",children:"Voltar"})]})})}function He(){const{id:t}=le(),[r]=ce(),n=V(),{toast:a}=I(),{isAuthenticated:l}=be(),{data:s,isLoading:h,isError:f}=De(t||""),{data:y}=Le(t||""),g=y?.data||[],o=Pe(),i=qe(t||""),v=Ee(t||""),[x,D]=w.useState(),L=r.get("comment")==="true",p=w.useCallback(c=>l?!0:(a({title:"Login necess√°rio",description:`Para ${c}, voc√™ precisa estar logado.`,action:e.jsx(E,{variant:"outline",size:"sm",onClick:()=>n(`/login?redirect=${encodeURIComponent(window.location.pathname)}`),children:"Entrar"})}),!1),[l,a,n]);if(h)return e.jsx(Oe,{});if(f||!s)return e.jsx(Qe,{});const C=U[s.categoria]||U.outros,P=s.bairro?.nome||je.find(c=>c.id===s.bairroId)?.nome||"Tijucas",N=s.autor?.nome||(s.isAnon?"An√¥nimo":"Usu√°rio"),q=async()=>{const c={title:s.titulo,text:s.texto,url:window.location.href};if(navigator.share)try{await navigator.share(c)}catch{}else await navigator.clipboard.writeText(c.url),a({title:"Link copiado!",description:"O link foi copiado para a √°rea de transfer√™ncia."})},Y=()=>{p("curtir")&&(navigator.vibrate&&navigator.vibrate(10),o.mutate({id:s.id,liked:s.liked||!1}))},H=async(c,b,T)=>{if(p("comentar"))try{await i.mutateAsync({texto:c,isAnon:b,imageUrl:T}),a({title:"Coment√°rio enviado!",description:"Seu coment√°rio foi publicado."}),D(void 0)}catch{a({title:"Erro ao enviar coment√°rio",description:"Tente novamente.",variant:"destructive"})}},X=async(c,b,T,S)=>{if(p("responder"))try{await i.mutateAsync({texto:b,parentId:c,isAnon:T,imageUrl:S}),a({title:"Resposta enviada!"})}catch{a({title:"Erro ao enviar resposta",description:"Tente novamente.",variant:"destructive"})}},G=c=>{if(!p("curtir"))return;const b=(Q,$)=>{for(const A of Q){if(A.id===$)return A;if(A.replies){const R=b(A.replies,$);if(R)return R}}},S=b(g,c)?.liked??!1;navigator.vibrate&&navigator.vibrate(10),v.mutate({commentId:c,liked:S})},W=()=>{l||p("comentar")},O=s.fotoUrl?[s.fotoUrl]:[];return e.jsxs("div",{className:"min-h-screen bg-background pb-32",children:[e.jsx("header",{className:"sticky top-0 z-20 bg-background/95 backdrop-blur-md border-b border-border safe-top",children:e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(m.button,{whileTap:{scale:.9},onClick:()=>n(-1),className:"p-2 -ml-2 rounded-full hover:bg-muted transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center","aria-label":"Voltar",children:e.jsx(de,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-lg font-semibold",children:"T√≥pico"})]}),e.jsx(m.button,{whileTap:{scale:.9},onClick:q,className:"p-2 rounded-full hover:bg-muted transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center","aria-label":"Compartilhar",children:e.jsx(ue,{className:"w-5 h-5"})})]})}),e.jsxs("article",{className:"px-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(ye,{className:`${C.color} border-0`,children:C.label}),e.jsxs("span",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[e.jsx(B,{className:"w-3 h-3"}),P]})]}),e.jsx("time",{dateTime:new Date(s.createdAt).toISOString(),title:Ne(s.createdAt),className:"text-sm text-muted-foreground",children:ve(s.createdAt)})]}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-muted flex items-center justify-center text-sm font-medium text-muted-foreground overflow-hidden",children:s.autor?.avatarUrl?e.jsx("img",{src:s.autor.avatarUrl,alt:N,className:"w-full h-full object-cover"}):s.isAnon?"?":N[0]?.toUpperCase()}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:N}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Autor"})]})]}),e.jsx("h2",{className:"text-xl font-bold text-foreground leading-tight mb-3",children:s.titulo}),e.jsx("p",{className:"text-base text-foreground leading-relaxed whitespace-pre-wrap mb-4",children:s.texto}),O.length>0&&e.jsx("div",{className:"mb-4",children:e.jsx(Fe,{images:O,alt:s.titulo})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-border/50",children:[e.jsxs(m.button,{whileTap:{scale:.9},onClick:Y,disabled:o.isPending,className:"flex items-center gap-2 py-2 px-4 rounded-full hover:bg-muted/50 transition-colors min-h-[44px] disabled:opacity-50",children:[e.jsx(m.div,{animate:s.liked?{scale:[1,1.3,1]}:{},transition:{duration:.3},children:o.isPending?e.jsx(me,{className:"w-6 h-6 animate-spin text-muted-foreground"}):e.jsx(xe,{className:`w-6 h-6 ${s.liked?"fill-red-500 text-red-500":"text-muted-foreground"}`})}),e.jsxs("span",{className:`font-medium ${s.liked?"text-red-500":"text-muted-foreground"}`,children:[s.likesCount," Curtidas"]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(pe,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:s.commentsCount})]}),e.jsx(Me,{topicId:s.id,isAnonymous:s.isAnon,children:e.jsx(m.button,{whileTap:{scale:.9},className:"p-2 rounded-full hover:bg-muted/50 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center",children:e.jsx(he,{className:"w-5 h-5 text-muted-foreground"})})})]})]}),e.jsx("section",{className:"border-t border-border pb-24",children:e.jsx(we,{comments:g,onLike:G,onReply:X})}),e.jsx(z,{mode:"wait",children:l?e.jsx(ke,{onSubmit:H,autoFocus:L,replyTo:x,isSubmitting:i.isPending}):e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"fixed bottom-0 left-0 right-0 bg-background border-t border-border p-4 safe-bottom z-40",children:e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-xl bg-muted cursor-pointer hover:bg-muted/80 transition-colors",onClick:W,children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(fe,{className:"w-4 h-4 text-primary"})}),e.jsx("p",{className:"text-muted-foreground text-sm flex-1",children:"Fa√ßa login para comentar..."}),e.jsx(E,{size:"sm",asChild:!0,children:e.jsx(ge,{to:`/login?redirect=${encodeURIComponent(window.location.pathname)}`,children:"Entrar"})})]})})})]})}export{He as default};
