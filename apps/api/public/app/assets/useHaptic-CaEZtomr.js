import{a as T}from"./client-CwV3tjc_.js";import{aS as N,r as p,aR as I}from"./vendor-app-L90565EI.js";import{f as m}from"./index-C4Iad8d5.js";const j="etijucas-weather-cache",F=1,S="weather-data",P={home:30*60*1e3,forecast:60*60*1e3,marine:60*60*1e3,insights:30*60*1e3};let w=null;function g(e){return e.trim().toLowerCase().replace(/\s+/g,"-")}function x(e){if(!e||e.length===0)return"none";const t=e.map(g).filter(Boolean);return t.sort(),t.join(",")}function C(e){const t=["weather",g(e.scope),g(e.tenantKey||"global")];if(typeof e.days=="number"&&t.push("days",String(e.days)),e.units&&t.push("units",g(e.units)),e.presetType&&t.push("preset",g(e.presetType)),e.sections&&e.sections.length>0&&t.push("sections",x(e.sections)),e.params){const n=Object.entries(e.params).filter(([,r])=>r!=null).map(([r,s])=>`${g(r)}=${g(String(s))}`).sort();n.length>0&&t.push("params",n.join("&"))}return t.push("v1"),t.join(":")}function _(){return w||(w=new Promise((e,t)=>{const n=indexedDB.open(j,F);n.onerror=()=>{console.error("IndexedDB open error:",n.error),t(n.error)},n.onsuccess=()=>{e(n.result)},n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(S)||s.createObjectStore(S,{keyPath:"key"}).createIndex("expiresAt","expiresAt",{unique:!1})}}),w)}async function k(e){try{const t=await _();return new Promise(n=>{const o=t.transaction(S,"readonly").objectStore(S).get(e);o.onsuccess=()=>{const i=o.result;if(!i){n(null);return}const c=Date.now()>i.expiresAt;n({...i,isStale:c})},o.onerror=()=>{console.error("Cache read error:",o.error),n(null)}})}catch(t){return console.error("getCached error:",t),null}}async function q(e,t,n="forecast"){try{const r=await _(),s=Date.now(),o=P[n],i={key:e,data:t,cachedAt:s,expiresAt:s+o,isStale:!1};return new Promise((l,c)=>{const a=r.transaction(S,"readwrite").objectStore(S).put(i);a.onsuccess=()=>l(),a.onerror=()=>{console.error("Cache write error:",a.error),c(a.error)}})}catch(r){console.error("setCached error:",r)}}function A(e,t,n){const{cacheKey:r,ttlType:s="forecast",...o}=n,i=N(),[l,c]=p.useState({isFromCache:!1,isStale:!1,cachedAt:null,isUpdating:!1});p.useEffect(()=>{(async()=>{try{const d=await k(r);d&&(i.setQueryData(e,d.data),c({isFromCache:!0,isStale:d.isStale,cachedAt:new Date(d.cachedAt),isUpdating:d.isStale}))}catch(d){console.error("[useOfflineQuery] Cache load error:",d)}})()},[r,e,i]);const u=I({queryKey:e,queryFn:async()=>{c(a=>({...a,isUpdating:!0}));try{const a=await t();return await q(r,a,s),c({isFromCache:!1,isStale:!1,cachedAt:new Date,isUpdating:!1}),a}catch(a){throw c(d=>({...d,isUpdating:!1})),a}},staleTime:1e3*60*5,gcTime:1e3*60*60,retry:2,retryDelay:1e3,...o}),y=p.useCallback(async()=>{c(a=>({...a,isUpdating:!0})),await u.refetch()},[u]);return{data:u.data,isLoading:u.isLoading&&!l.isFromCache,isError:u.isError,error:u.error,isFetching:u.isFetching,refetch:y,cacheStatus:l}}function ee(){const[e,t]=p.useState(typeof navigator<"u"?navigator.onLine:!0);return p.useEffect(()=>{const n=()=>t(!0),r=()=>t(!1);return window.addEventListener("online",n),window.addEventListener("offline",r),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",r)}},[]),{isOnline:e,isOffline:!e}}function te(e){if(!e)return"";const n=new Date().getTime()-e.getTime(),r=Math.floor(n/6e4);if(r<1)return"agora mesmo";if(r===1)return"há 1 minuto";if(r<60)return`há ${r} minutos`;const s=Math.floor(r/60);return s===1?"há 1 hora":s<24?`há ${s} horas`:"há mais de um dia"}const D="/weather",$=7,L="metric",z=["current","hourly","daily","insights"],b={current:1,hourly:2,daily:3,marine:4,insights:5};function U(e,t){return e??t??"global"}function R(e){if(!e||e.length===0)return;const t=e.map(n=>n.trim()).filter(n=>n.length>0);if(t.length!==0)return Array.from(new Set(t)).sort()}function E(e){return R(e)?.join(",")??"default"}function v(e){const t=e&&e.length>0?e:z,n=Array.from(new Set(t)).filter(r=>r in b);return n.sort((r,s)=>b[r]-b[s]),n}function H(e){return v(e).join(",")}function W(e,t){const n=t.toString();return n?`${e}?${n}`:e}async function M(){return T.get(`${D}/insights`)}async function Q(e){return T.get(`${D}/preset/${e}`)}async function V(e){const t=new URLSearchParams,n=v(e?.sections),r=e?.days??$,s=e?.units??L;return t.append("sections",n.join(",")),t.append("days",String(r)),t.append("units",s),T.get(W(`${D}/bundle`,t))}const f={all:["weather"],home:(e,t)=>[...f.all,"home",e,`hours:${t?.hours??"default"}`,`include:${E(t?.include)}`],forecast:(e,t)=>[...f.all,"forecast",e,`days:${t?.days??"default"}`,`hours:${t?.hours??"default"}`,`include:${E(t?.include)}`],marine:(e,t)=>[...f.all,"marine",e,`days:${t?.days??"default"}`,`hours:${t?.hours??"default"}`,`include:${E(t?.include)}`],insights:e=>[...f.all,"insights",e],preset:(e,t)=>[...f.all,"preset",e,t],bundle:(e,t)=>[...f.all,"bundle",e,`days:${t?.days??$}`,`units:${t?.units??L}`,`sections:${H(t?.sections)}`]};function ne(e){const t=m(o=>o.tenantKey),n=m(o=>o.city?.slug??null),r=U(t,n),s=C({scope:"insights",tenantKey:r});return A([...f.insights(r)],()=>M(),{cacheKey:s,ttlType:"insights",enabled:e?.enabled})}function re(e){const t=m(o=>o.tenantKey),n=m(o=>o.city?.slug??null),r=U(t,n),s=C({scope:"preset",tenantKey:r,presetType:e});return A([...f.preset(r,e)],()=>Q(e),{cacheKey:s,ttlType:"insights"})}function se(e,t){const n=m(y=>y.tenantKey),r=m(y=>y.city?.slug??null),s=U(n,r),o=v(e?.sections),i=e?.days??$,l=e?.units??L,c=C({scope:"bundle",tenantKey:s,days:i,units:l,sections:o}),u=o.includes("marine")?"marine":o.length===1&&o[0]==="insights"?"insights":"forecast";return A([...f.bundle(s,{...e,sections:o,days:i,units:l})],()=>V({...e,sections:o,days:i,units:l}),{cacheKey:c,ttlType:u,enabled:t?.enabled})}const Y={light:10,medium:20,heavy:40,success:[10,50,20],warning:[30,50,30],error:[50,100,50,100,50],selection:5},B="haptic-enabled";function K(){return typeof navigator<"u"&&"vibrate"in navigator}function O(){return typeof localStorage>"u"?!0:localStorage.getItem(B)!=="false"}function G(e){localStorage.setItem(B,String(e))}function h(e="light"){if(!K()||!O())return;const t=Y[e];try{navigator.vibrate(t)}catch{}}function oe(){return{trigger:h,light:()=>h("light"),medium:()=>h("medium"),heavy:()=>h("heavy"),success:()=>h("success"),warning:()=>h("warning"),error:()=>h("error"),selection:()=>h("selection"),isSupported:K(),isEnabled:O,setEnabled:G}}export{re as a,ee as b,se as c,oe as d,te as f,h,ne as u};
