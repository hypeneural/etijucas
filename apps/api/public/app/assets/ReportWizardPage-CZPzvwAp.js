import{j as e,r as u}from"./vendor-radix-BZtfFPPo.js";import{B as N}from"./button-DL0hcLZK.js";import{b as B,c as A,X as ve,R as _,T as W,C as L,k as ne,i as H,f as He,H as _e,u as We,B as Qe}from"./index-DnCE2Tlu.js";import{M as K}from"./map-pin-DZCwGZRC.js";import{C as q}from"./camera-DtQA19tU.js";import{m as j,A as te}from"./vendor-motion-CE4DlxSe.js";import{C as Ye}from"./check-B0_LBnR8.js";import{C as w}from"./card-CLYrPklM.js";import{I as Q}from"./info-Dx0glkmo.js";import{C as Xe}from"./CategoryIcon-CbVpM4D7.js";import{u as Je}from"./vendor-query-C2Ikq0eY.js";import{r as pe}from"./report.service-D6D64Kuv.js";import{L as R}from"./loader-circle-DSYCalJ0.js";import{C as Ze}from"./circle-alert-Dm8vc_zP.js";import{C as he}from"./chevron-right-CFR23pmZ.js";import{L as ea}from"./lightbulb-D8ELr-UN.js";import{C as aa}from"./circle-help-ByKQ-rL_.js";import{I as fe}from"./input-_xedrIsW.js";import{L as ta}from"./LocationMap-D9TjHAWa.js";import{S as Y}from"./search-Dibk46Rf.js";import{P as oe,I as ce}from"./pen-line-CTKkvvO7.js";import{N as we}from"./navigation-CKljQ-e2.js";import{B as sa}from"./badge-BE9PC5BY.js";import{C as ra}from"./checkbox-CjdVK1oR.js";import{T as ia,S as na}from"./textarea-BEM8g0uO.js";import{F as oa}from"./file-text-CraH0Ohy.js";import{c as X,P as ke}from"./confetti.module-CqKmvJBn.js";import{S as ca}from"./sparkles-B92IdpHd.js";import{C as la}from"./copy-BCwINZSi.js";import{S as da}from"./share-2-DeMGayTQ.js";import{L as ma}from"./LoginRequired-Bk2QbMqZ.js";import{u as ua}from"./useMyReports-DMXci0d5.js";import{u as xa}from"./useAuthStore-DDIzRUgP.js";import{A as pa}from"./arrow-left-CmI72DRd.js";import"./vendor-utils-BtzxroqU.js";import"./client-BTgelhMB.js";import"./localDatabase-CsFe4LOc.js";import"./TileLayer-DnC2MtsY.js";import"./log-in-DXzLKGk3.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=B("FileCheck",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ha=B("FileSearch",[["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M4.268 21a2 2 0 0 0 1.727 1H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3",key:"ms7g94"}],["path",{d:"m9 18-1.5-1.5",key:"1j6qii"}],["circle",{cx:"5",cy:"14",r:"3",key:"ufru5t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fa=B("ImageOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M10.41 10.41a2 2 0 1 1-2.83-2.83",key:"1bzlo9"}],["line",{x1:"13.5",x2:"6",y1:"13.5",y2:"21",key:"1q0aeu"}],["line",{x1:"18",x2:"21",y1:"12",y2:"15",key:"5mozeu"}],["path",{d:"M3.59 3.59A1.99 1.99 0 0 0 3 5v14a2 2 0 0 0 2 2h14c.55 0 1.052-.22 1.41-.59",key:"mmje98"}],["path",{d:"M21 15V5a2 2 0 0 0-2-2H9",key:"43el77"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ga=B("List",[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=B("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=B("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=B("ShieldAlert",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ba=B("SwitchCamera",[["path",{d:"M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5",key:"mtk2lu"}],["path",{d:"M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5",key:"120jsl"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"m18 22-3-3 3-3",key:"kgdoj7"}],["path",{d:"m6 2 3 3-3 3",key:"1fnbkv"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ja=B("Target",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]),ya=[{icon:ga,label:"Categoria"},{icon:K,label:"Localização"},{icon:q,label:"Fotos"},{icon:ha,label:"Revisão"}];function Na({currentStep:a,totalSteps:t,labels:s}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:ya.slice(0,t).map((i,r)=>{const d=r+1,c=d<a,m=d===a,o=i.icon;return e.jsxs("div",{className:"flex flex-col items-center flex-1",children:[r>0&&e.jsx("div",{className:A("absolute h-0.5 -translate-y-4",c||m?"bg-primary":"bg-muted"),style:{width:`calc(100% / ${t} - 2rem)`,left:`calc((100% / ${t}) * ${r} + 1rem)`}}),e.jsx(j.div,{initial:{scale:.8},animate:{scale:m?1.1:1},className:A("relative z-10 h-10 w-10 rounded-full flex items-center justify-center transition-all",c&&"bg-primary text-primary-foreground",m&&"bg-primary text-primary-foreground ring-4 ring-primary/20",!c&&!m&&"bg-muted text-muted-foreground"),children:c?e.jsx(Ye,{className:"h-5 w-5"}):e.jsx(o,{className:"h-5 w-5"})}),e.jsx("span",{className:A("text-xs mt-1.5 font-medium text-center",m&&"text-primary",c&&"text-foreground",!c&&!m&&"text-muted-foreground"),children:s?.[r]||i.label})]},d)})}),e.jsx("div",{className:"relative -mt-[3.2rem] mx-5 h-0.5 bg-muted rounded-full",children:e.jsx(j.div,{className:"h-full bg-primary rounded-full",initial:{width:0},animate:{width:`${(a-1)/(t-1)*100}%`},transition:{type:"spring",stiffness:300,damping:30}})}),e.jsx("div",{className:"h-4"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsxs("span",{className:"font-semibold text-primary",children:["Etapa ",a]}),e.jsxs("span",{className:"text-muted-foreground",children:["de ",t]})]})]})}function va({title:a,content:t,className:s}){const[i,r]=u.useState(!1),d=Array.isArray(t)?t:[t];return e.jsxs("div",{className:A("inline-flex items-center gap-1",s),children:[e.jsx(j.button,{type:"button",whileTap:{scale:.9},onClick:()=>r(!0),className:"flex h-5 w-5 items-center justify-center rounded-full bg-muted hover:bg-muted/80 transition-colors","aria-label":`Ajuda sobre ${a}`,children:e.jsx(Q,{className:"h-3 w-3 text-muted-foreground"})}),e.jsx(te,{children:i&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>r(!1)}),e.jsxs(j.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 safe-bottom",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"flex items-start justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(Q,{className:"h-4 w-4 text-primary"})}),e.jsx("h3",{className:"font-semibold text-lg",children:a})]}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full",onClick:()=>r(!1),children:e.jsx(ve,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-4 space-y-2",children:d.map((c,m)=>e.jsxs("p",{className:"text-sm text-muted-foreground flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"•"}),e.jsx("span",{children:c})]},m))}),e.jsx(N,{className:"w-full mt-6",onClick:()=>r(!1),children:"Entendi"})]})]})})]})}function se({title:a,subtitle:t,helpTitle:s,helpContent:i}){return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-2xl font-bold",children:a}),i&&e.jsx(va,{title:s||a,content:i})]}),t&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t})]})}const wa={categories:["report","categories"]};function Be(){const a=Je({queryKey:wa.categories,queryFn:()=>pe.getCategories(),staleTime:18e5,gcTime:36e5});return{categories:a.data??[],isLoading:a.isLoading,error:a.error,refetch:a.refetch}}function ka({draft:a,onUpdate:t,onNext:s}){const{categories:i,isLoading:r,error:d,refetch:c}=Be(),m=i.find(g=>g.id===a.categoryId),o=g=>{t({categoryId:g.id,category:g})},x=!!a.categoryId;return r?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(R,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando categorias..."})]}):d?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(Ze,{className:"h-12 w-12 text-destructive"}),e.jsx("p",{className:"text-muted-foreground text-center",children:"Erro ao carregar categorias."}),e.jsx(N,{onClick:()=>c(),variant:"outline",children:"Tentar novamente"})]}):e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(se,{title:"O que aconteceu?",subtitle:"Escolha a categoria que melhor descreve o problema",helpTitle:"Como escolher a categoria",helpContent:["Escolha a categoria que mais combina com o problema que você quer reportar.","Se tiver dúvida, escolha 'Outros' e descreva com suas palavras.","Não se preocupe em acertar perfeitamente, nossa equipe vai analisar."]}),e.jsx(w,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(Q,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsx("div",{children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("span",{className:"font-medium",children:"Toque em uma categoria"})," para selecioná-la. Depois você pode detalhar melhor o problema."]})})]})}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:i.map((g,h)=>{const b=a.categoryId===g.id;return e.jsxs(j.button,{type:"button",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:h*.03},whileTap:{scale:.95},onClick:()=>o(g),className:A("relative flex flex-col items-center gap-2 rounded-2xl border-2 p-3 text-center transition-all",b?"border-primary bg-primary/10 shadow-lg":"border-border bg-card hover:bg-muted/50 hover:border-muted-foreground/30"),style:{borderColor:b?g.color:void 0,backgroundColor:b?`${g.color}10`:void 0},children:[e.jsx(Xe,{icon:g.icon,color:g.color,size:"lg",withBackground:!0}),e.jsx("span",{className:A("text-[11px] leading-tight font-semibold line-clamp-2",b?"text-primary":"text-slate-700 dark:text-slate-300"),style:{color:b?g.color:void 0},children:g.name}),b&&e.jsx(j.div,{initial:{scale:0},animate:{scale:1},className:"absolute -top-1 -right-1 h-5 w-5 rounded-full flex items-center justify-center",style:{backgroundColor:g.color},children:e.jsx(he,{className:"h-3 w-3 text-white"})})]},g.id)})}),m&&m.tips.length>0&&e.jsx(j.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"space-y-3",children:e.jsx(w,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-amber-100 dark:bg-amber-900/50",children:e.jsx(ea,{className:"h-4 w-4 text-amber-600 dark:text-amber-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-medium text-amber-800 dark:text-amber-300",children:['Dicas para "',m.name,'"']}),e.jsx("ul",{className:"mt-2 space-y-1",children:m.tips.map((g,h)=>e.jsxs("li",{className:"text-sm text-amber-700 dark:text-amber-400 flex gap-2",children:[e.jsx("span",{className:"shrink-0",children:"•"}),e.jsx("span",{children:g})]},h))})]})]})})}),!a.categoryId&&e.jsx(w,{className:"p-4 border-muted bg-muted/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-muted",children:e.jsx(aa,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione uma categoria acima para continuar"})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx(N,{size:"lg",className:A("w-full h-14 text-base font-semibold rounded-2xl transition-all",!x&&"opacity-50"),disabled:!x,onClick:s,children:x?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(he,{className:"h-5 w-5 ml-2"})]}):"Selecione uma categoria"})})})]})}function Ca({draft:a,onUpdate:t,onNext:s,onBack:i}){const[r,d]=u.useState({status:"idle"}),[c,m]=u.useState(!1),[o,x]=u.useState(""),[g,h]=u.useState([]),[b,k]=u.useState(!1),[D,p]=u.useState(!1),f=u.useCallback(async(n,l)=>{try{p(!0);const v=await pe.geocodeReverse(n,l);return v?.address||v?.displayName}catch(v){console.warn("[StepLocation] Reverse geocode failed:",v);return}finally{p(!1)}},[]),y=u.useCallback(async()=>{if(!navigator.geolocation){d({status:"error",errorMessage:"Seu navegador não suporta geolocalização. Tente usar Chrome, Safari ou Firefox."});return}d({status:"requesting"}),navigator.geolocation.getCurrentPosition(async n=>{const l=n.coords.latitude,v=n.coords.longitude,M=await f(l,v),E={latitude:l,longitude:v,accuracy:n.coords.accuracy,address:M||"Tijucas, SC",source:"gps",quality:n.coords.accuracy<=50?"precisa":"aproximada"};t({location:E}),d({status:"success"})},n=>{let l="Não conseguimos acessar sua localização.";n.code===n.PERMISSION_DENIED?(l="Você não permitiu o acesso à sua localização.",d({status:"denied",errorMessage:l})):n.code===n.POSITION_UNAVAILABLE?(l="Não foi possível determinar sua localização. Verifique se o GPS está ativado.",d({status:"error",errorMessage:l})):n.code===n.TIMEOUT&&(l="Demorou muito para obter sua localização. Verifique sua conexão e tente novamente.",d({status:"error",errorMessage:l}))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4})},[t,f]),S=u.useRef(null),I=u.useCallback(async n=>{if(n.length<3){h([]);return}S.current&&S.current.abort(),S.current=new AbortController,k(!0);try{const l=a.location?.latitude,v=a.location?.longitude,M=await pe.geocodeAutocomplete(n,l,v);h(M)}catch(l){l.name!=="AbortError"&&console.warn("[StepLocation] Search failed:",l),h([])}finally{k(!1)}},[a.location?.latitude,a.location?.longitude]);u.useEffect(()=>{const n=setTimeout(()=>{o&&I(o)},300);return()=>{clearTimeout(n),S.current&&S.current.abort()}},[o,I]);const G=n=>{const l={latitude:n.latitude,longitude:n.longitude,accuracy:100,address:n.address||n.displayName,source:"manual",quality:"manual"};t({location:l}),d({status:"success"}),x(""),h([]),m(!1)};u.useEffect(()=>{!a.location&&r.status==="idle"&&y()},[a.location,r.status,y]);const C=!!a.location,V=({quality:n})=>{const l={precisa:{color:"text-green-600 bg-green-100",icon:ja,label:"Precisa"},aproximada:{color:"text-amber-600 bg-amber-100",icon:K,label:"Aproximada"},manual:{color:"text-blue-600 bg-blue-100",icon:oe,label:"Informada"}}[n]||{color:"text-gray-600 bg-gray-100",icon:K,label:"Desconhecida"},v=l.icon;return e.jsxs("span",{className:A("inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",l.color),children:[e.jsx(v,{className:"h-3 w-3"}),l.label]})};return e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(se,{title:"Onde foi?",subtitle:"Precisamos saber o local do problema",helpTitle:"Por que precisamos da localização?",helpContent:["A localização ajuda nossa equipe a encontrar o problema rapidamente.","Usamos o GPS do seu celular para maior precisão.","Sua localização não é compartilhada publicamente, apenas com a equipe responsável."]}),e.jsx(w,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(Q,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"Como funciona:"}),e.jsx("p",{children:"Usamos o GPS para marcar o local, ou você pode buscar o endereço manualmente."})]})]})}),e.jsxs("div",{className:"space-y-4",children:[r.status==="requesting"&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(R,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:D?"Buscando endereço...":"Buscando sua localização..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),r.status==="denied"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(K,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Localização bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:r.errorMessage}),e.jsxs(w,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700 text-left",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Localização" para "Permitir"'})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4 w-full",children:[e.jsxs(N,{variant:"outline",className:"flex-1",onClick:y,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(N,{variant:"secondary",className:"flex-1",onClick:()=>m(!0),children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),r.status==="error"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(W,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Erro ao obter localização"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:r.errorMessage}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(N,{variant:"outline",className:"flex-1",onClick:y,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(N,{variant:"secondary",className:"flex-1",onClick:()=>m(!0),children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),a.location&&e.jsxs(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-4",children:[e.jsx(w,{className:"p-4 bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100 dark:bg-green-900/50",children:e.jsx(L,{className:"h-5 w-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-green-800 dark:text-green-300",children:"Localização capturada!"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(V,{quality:a.location.quality}),a.location.accuracy&&a.location.source==="gps"&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["±",Math.round(a.location.accuracy),"m"]})]})]})]})}),e.jsx(ta,{latitude:a.location.latitude,longitude:a.location.longitude,hasGPS:a.location.source==="gps",onLocationChange:async(n,l)=>{const v=await f(n,l);t({location:{...a.location,latitude:n,longitude:l,address:v||a.location.address,source:"mapa",quality:"precisa"}})},onCenterGPS:a.location.source==="gps"?y:void 0}),e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[D?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 animate-spin text-primary"}),e.jsx("span",{className:"text-muted-foreground",children:"Buscando endereço..."})]}):e.jsx("p",{className:"font-medium",children:a.location.address||"Localização capturada"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Coordenadas: ",a.location.latitude.toFixed(4),", ",a.location.longitude.toFixed(4)]})]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>m(!0),children:[e.jsx(oe,{className:"h-3.5 w-3.5 mr-1"}),"Buscar"]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),"Ponto de referência (opcional)"]}),e.jsx(fe,{placeholder:"Ex: Próximo ao Supermercado X",value:a.locationNote||"",onChange:n=>t({locationNote:n.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ajude a localizar o problema com uma referência"})]})]}),r.status==="idle"&&!a.location&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center py-8 gap-4",children:[e.jsxs(N,{size:"lg",onClick:y,className:"h-14 px-8 rounded-2xl",children:[e.jsx(we,{className:"h-5 w-5 mr-2"}),"Usar minha localização"]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"ou"}),e.jsxs(N,{variant:"outline",onClick:()=>m(!0),children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Buscar endereço manualmente"]})]})]}),e.jsx(te,{children:c&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>m(!1)}),e.jsxs(j.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 pb-8 max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsx("h3",{className:"font-semibold text-lg mt-4",children:"Buscar endereço"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Digite o nome da rua ou local"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(Y,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(fe,{placeholder:"Ex: Rua Principal, Centro, Tijucas",value:o,onChange:n=>x(n.target.value),className:"pl-10 h-12 rounded-xl",autoFocus:!0}),b&&e.jsx(R,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground"})]}),g.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:g.map((n,l)=>e.jsx(j.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:l*.05},onClick:()=>G(n),className:"w-full text-left p-3 rounded-xl border hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(K,{className:"h-5 w-5 text-primary shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:n.address}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:n.displayName})]})]})},n.placeId||l))}),o.length>=3&&g.length===0&&!b&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Nenhum resultado encontrado. Tente outro endereço."}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(N,{variant:"outline",className:"flex-1",onClick:()=>m(!1),children:"Cancelar"}),e.jsxs(N,{className:"flex-1",onClick:y,children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Usar GPS"]})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(N,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:i,children:"Voltar"}),e.jsx(N,{size:"lg",className:A("h-14 rounded-2xl flex-[2] text-base font-semibold",!C&&"opacity-50"),disabled:!C,onClick:s,children:C?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(he,{className:"h-5 w-5 ml-2"})]}):"Aguardando localização..."})]})})]})}function Ce(a){if(a===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],i=Math.floor(Math.log(a)/Math.log(t));return`${parseFloat((a/Math.pow(t,i)).toFixed(1))} ${s[i]}`}async function Sa(a,t={}){const{maxWidth:s=1200,maxHeight:i=1200,quality:r=.8,format:d="image/webp"}=t;return new Promise((c,m)=>{const o=new Image,x=document.createElement("canvas"),g=x.getContext("2d");if(!g){m(new Error("Canvas context not available"));return}o.onload=()=>{let{width:b,height:k}=o;b>s&&(k=k*s/b,b=s),k>i&&(b=b*i/k,k=i),b=Math.round(b),k=Math.round(k),x.width=b,x.height=k,g.imageSmoothingEnabled=!0,g.imageSmoothingQuality="high",g.drawImage(o,0,0,b,k);const D=x.toDataURL(d).startsWith("data:"+d)?d:"image/jpeg";x.toBlob(p=>{if(!p){m(new Error("Failed to compress image"));return}const f=x.toDataURL(D,r);c({blob:p,dataUrl:f,originalSize:a.size,compressedSize:p.size,compressionRatio:p.size/a.size,width:b,height:k})},D,r)},o.onerror=()=>{m(new Error("Failed to load image"))};const h=new FileReader;h.onload=b=>{o.src=b.target?.result},h.onerror=()=>{m(new Error("Failed to read file"))},h.readAsDataURL(a)})}const z=3;function Da({draft:a,onUpdate:t,onNext:s,onBack:i}){const r=u.useRef(null),d=u.useRef(null),c=u.useRef(null),m=u.useRef(null),[o,x]=u.useState({status:"idle",facingMode:"environment",stream:null}),[g,h]=u.useState(!1),[b,k]=u.useState(null),D=typeof window<"u"&&window.isSecureContext,p=u.useCallback(async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){x(n=>({...n,status:"error",errorMessage:"Seu navegador não suporta acesso à câmera. Tente usar Chrome, Safari ou Firefox."}));return}x(n=>({...n,status:"requesting"}));try{const n=await navigator.mediaDevices.getUserMedia({video:{facingMode:o.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:!1});r.current&&(r.current.srcObject=n,await r.current.play()),x(l=>({...l,status:"active",stream:n,errorMessage:void 0}))}catch(n){if(console.error("Camera error:",n),n instanceof DOMException)if(n.name==="NotAllowedError")x(l=>({...l,status:"denied",errorMessage:"Você não permitiu o acesso à câmera."}));else if(n.name==="NotFoundError")x(l=>({...l,status:"error",errorMessage:"Nenhuma câmera foi encontrada no seu dispositivo."}));else if(n.name==="NotReadableError")x(l=>({...l,status:"error",errorMessage:"A câmera está sendo usada por outro aplicativo. Feche outros apps e tente novamente."}));else if(n.name==="OverconstrainedError"){x(l=>({...l,status:"error",errorMessage:"Sua câmera não atende aos requisitos. Tentando configuração alternativa..."}));try{const l=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});r.current&&(r.current.srcObject=l,await r.current.play()),x(v=>({...v,status:"active",stream:l,errorMessage:void 0}))}catch{x(l=>({...l,status:"error",errorMessage:"Não foi possível acessar sua câmera."}))}}else x(l=>({...l,status:"error",errorMessage:"Ocorreu um erro ao acessar a câmera. Tente novamente."}));else x(l=>({...l,status:"error",errorMessage:"Erro desconhecido ao acessar a câmera."}))}},[o.facingMode]),f=u.useCallback(()=>{o.stream&&o.stream.getTracks().forEach(n=>n.stop()),r.current&&(r.current.srcObject=null),x(n=>({...n,status:"idle",stream:null}))},[o.stream]);u.useEffect(()=>((async()=>{if(!navigator.mediaDevices?.enumerateDevices){k(!1);return}try{const v=(await navigator.mediaDevices.enumerateDevices()).some(M=>M.kind==="videoinput");k(v)}catch{k(!1)}})(),()=>{o.stream&&o.stream.getTracks().forEach(l=>l.stop())}),[]);const y=u.useCallback(async()=>{f(),x(n=>({...n,facingMode:n.facingMode==="environment"?"user":"environment"})),setTimeout(()=>p(),100)},[p,f]),S=u.useCallback(async()=>{if(!r.current||!d.current||a.images.length>=z)return;h(!0);const n=r.current,l=d.current,v=l.getContext("2d");if(!v){h(!1);return}l.width=n.videoWidth,l.height=n.videoHeight,v.drawImage(n,0,0),l.toBlob(M=>{if(!M){h(!1);return}const E=new File([M],`photo_${Date.now()}.jpg`,{type:"image/jpeg",lastModified:Date.now()}),$={id:ne(),file:E,previewUrl:URL.createObjectURL(M),capturedAt:new Date};t({images:[...a.images,$]}),h(!1),a.images.length+1>=z&&f()},"image/jpeg",.85)},[a.images,t,f]),I=u.useCallback(n=>{const l=a.images.find(v=>v.id===n);l&&URL.revokeObjectURL(l.previewUrl),t({images:a.images.filter(v=>v.id!==n)}),o.status==="idle"&&a.images.length<=z&&p()},[a.images,o.status,t,p]),G=u.useCallback(n=>{I(n),o.status!=="active"&&p()},[I,o.status,p]),C=u.useCallback(async n=>{const l=n.target.files;if(!l||l.length===0)return;const v=z-a.images.length,M=Array.from(l).slice(0,v);let E=0,$=0;for(const F of M)if(F.type.startsWith("image/"))try{const P=await Sa(F,{maxWidth:1920,maxHeight:1920,quality:.75});E+=P.originalSize,$+=P.compressedSize;const ie=new File([P.blob],F.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()}),Ge={id:ne(),file:ie,previewUrl:URL.createObjectURL(P.blob),capturedAt:new Date};t({images:[...a.images,Ge]})}catch(P){console.error("Failed to compress image:",P);const ie={id:ne(),file:F,previewUrl:URL.createObjectURL(F),capturedAt:new Date};t({images:[...a.images,ie]})}if(E>0&&$<E){const F=E-$,P=Math.round(F/E*100);H.success(`Imagem otimizada: ${Ce(E)} → ${Ce($)} (-${P}%)`)}c.current&&(c.current.value="")},[a.images,t]),V=u.useCallback(()=>{c.current?.click()},[]);return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(se,{title:"Adicione até 3 fotos",subtitle:"Tire fotos agora ou escolha da galeria",helpTitle:"Dicas para boas fotos",helpContent:["Fotografe de perto para mostrar detalhes do problema.","Inclua uma foto do contexto (rua, número, ponto de referência).","Evite fotos muito escuras ou desfocadas."]}),e.jsx("input",{ref:c,type:"file",accept:"image/*",multiple:!0,onChange:C,className:"hidden"}),e.jsx("input",{ref:m,type:"file",accept:"image/*",capture:"environment",onChange:C,className:"hidden"}),e.jsx(w,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(Q,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-2 text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium",children:"Dicas para boas fotos:"}),e.jsxs("ul",{className:"space-y-1 text-blue-600 dark:text-blue-400",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto de perto do problema"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(fa,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto mostrando o contexto da rua"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Evite se colocar em risco"})]})]})]})]})}),e.jsxs("div",{className:"relative",children:[o.status==="idle"&&a.images.length<z&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10",children:e.jsx(q,{className:"h-10 w-10 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Adicione fotos do problema"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Fotos ajudam a identificar e resolver o problema mais rápido"})]}),!D&&e.jsx("div",{className:"w-full p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-400",children:[e.jsx(de,{className:"h-4 w-4 shrink-0"}),e.jsx("p",{className:"text-xs text-left",children:"Câmera exige HTTPS. Use a galeria para adicionar fotos."})]})}),e.jsxs("div",{className:"w-full space-y-2",children:[D&&b!==!1&&e.jsxs(N,{onClick:()=>m.current?.click(),className:"w-full",size:"lg",disabled:b===null,children:[b===null?e.jsx(R,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(q,{className:"h-4 w-4 mr-2"}),"Tirar Foto"]}),e.jsxs(N,{variant:D&&b!==!1?"outline":"default",onClick:V,className:"w-full",size:"lg",children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Escolher da Galeria"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Você pode pular e continuar sem fotos"})]})})}),o.status==="active"&&a.images.length<z&&e.jsxs(j.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative rounded-2xl overflow-hidden bg-muted aspect-[4/3]",children:[e.jsx("video",{ref:r,autoPlay:!0,playsInline:!0,muted:!0,"webkit-playsinline":"true","x-webkit-airplay":"allow",style:{backgroundColor:"transparent"},className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-4 left-0 right-0 flex items-center justify-center gap-4",children:[e.jsx(j.button,{whileTap:{scale:.9},onClick:y,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Trocar câmera",children:e.jsx(ba,{className:"h-5 w-5"})}),e.jsx(j.button,{whileTap:{scale:.9},onClick:S,disabled:g,className:A("p-1 rounded-full bg-white",g&&"opacity-50"),"aria-label":"Capturar foto",children:e.jsx("div",{className:"h-16 w-16 rounded-full border-4 border-primary flex items-center justify-center",children:g?e.jsx(R,{className:"h-6 w-6 text-primary animate-spin"}):e.jsx(q,{className:"h-6 w-6 text-primary"})})}),e.jsx(j.button,{whileTap:{scale:.9},onClick:V,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Escolher da galeria",children:e.jsx(ce,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"absolute top-4 right-4 px-3 py-1.5 rounded-full bg-black/50 text-white text-sm backdrop-blur-sm flex items-center gap-1",children:[e.jsx(q,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[a.images.length,"/",z]})]})]}),o.status==="requesting"&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"rounded-2xl bg-muted aspect-[4/3] flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(R,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:"Iniciando câmera..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),o.status==="denied"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(de,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Câmera bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(w,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado ou câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Câmera" para "Permitir"'})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"4."}),e.jsx("span",{children:"Recarregue a página ou toque no botão abaixo"})]})]})]}),e.jsxs(N,{variant:"outline",className:"mt-4 w-full",onClick:p,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),o.status==="error"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(w,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(W,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Problema com a câmera"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(w,{className:"w-full p-4 bg-white dark:bg-background border-red-200 dark:border-red-700",children:[e.jsx("p",{className:"font-medium text-sm mb-3",children:"O que você pode fazer:"}),e.jsxs("ul",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Verifique se seu dispositivo tem câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Feche outros aplicativos que usam a câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Tente acessar pelo celular em vez do computador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Você pode continuar sem foto (opcional)"})]})]})]}),e.jsxs(N,{variant:"outline",className:"mt-4 w-full",onClick:p,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),e.jsx("canvas",{ref:d,className:"hidden"})]}),a.images.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-green-500"}),"Fotos capturadas (",a.images.length,"/",z,")"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(te,{mode:"popLayout",children:a.images.map((n,l)=>e.jsxs(j.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},layout:!0,className:"relative aspect-square",children:[e.jsx("img",{src:n.previewUrl,alt:`Foto ${l+1}`,className:"w-full h-full object-cover rounded-xl"}),e.jsx("div",{className:"absolute top-2 left-2 h-6 w-6 rounded-full bg-primary text-primary-foreground text-xs font-bold flex items-center justify-center",children:l+1}),e.jsx("button",{type:"button",onClick:()=>I(n.id),className:"absolute -top-2 -right-2 h-7 w-7 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg hover:bg-red-600 transition-colors z-10","aria-label":"Remover foto",children:e.jsx(ve,{className:"h-4 w-4"})}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/70 to-transparent rounded-b-xl",children:e.jsxs("button",{type:"button",onClick:()=>G(n.id),className:"w-full px-2 py-1 text-xs bg-white/20 text-white rounded-md backdrop-blur-sm flex items-center justify-center gap-1",children:[e.jsx(_,{className:"h-3 w-3"}),"Refazer"]})})]},n.id))}),Array.from({length:z-a.images.length}).map((n,l)=>e.jsxs("button",{type:"button",onClick:()=>m.current?.click(),className:"aspect-square rounded-xl border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-1 hover:border-primary/50 hover:bg-primary/5 transition-colors cursor-pointer",children:[e.jsx(ce,{className:"h-5 w-5 text-muted-foreground/50"}),e.jsx("span",{className:"text-xs text-muted-foreground/50",children:"Adicionar"})]},`empty-${l}`))]})]}),a.images.length>=z&&e.jsx(w,{className:"p-4 text-center bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(L,{className:"h-5 w-5"}),e.jsxs("span",{className:"font-medium",children:["Você tirou ",z," fotos. Pronto para continuar!"]})]})}),a.images.length===0&&(o.status==="error"||o.status==="denied")&&e.jsx(w,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-amber-600 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800 dark:text-amber-300",children:"Continuar sem foto?"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-1",children:"Fotos ajudam muito a identificar o problema, mas você pode continuar sem elas."})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(N,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:()=>{f(),i()},children:"Voltar"}),e.jsxs(N,{size:"lg",className:"h-14 rounded-2xl flex-[2] text-base font-semibold",onClick:()=>{f(),s()},children:["Continuar",a.images.length===0&&e.jsx("span",{className:"text-xs ml-2 opacity-70",children:"(sem foto)"})]})]})})]})}function Ia({draft:a,onUpdate:t,onBack:s,onGoToStep:i,onSubmit:r}){const[d,c]=u.useState(!1),{categories:m}=Be(),o=m.find(h=>h.id===a.categoryId),x=!!a.categoryId&&!!a.location&&a.confirmed&&!!a.title?.trim(),g=async()=>{if(x){c(!0);try{await r()}catch(h){console.error("Submit error:",h)}finally{c(!1)}}};return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(se,{title:"Revisar e enviar",subtitle:"Adicione um título e confira as informações",helpTitle:"Última etapa!",helpContent:["Adicione um título curto que descreva o problema.","Revise todas as informações antes de enviar.","Após enviar, você receberá um número de protocolo."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(oa,{className:"h-4 w-4 text-muted-foreground"}),"Título da denúncia *"]}),e.jsx(fe,{placeholder:"Ex: Buraco grande na Rua Principal",value:a.title||"",onChange:h=>t({title:h.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Descreva o problema em poucas palavras (obrigatório)"})]}),e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl text-2xl",style:{backgroundColor:o?.color+"20"},children:o?.icon||"❓"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Categoria"}),e.jsx("p",{className:"font-semibold",children:o?.name||"Não selecionada"})]})]}),e.jsxs(N,{variant:"ghost",size:"sm",onClick:()=>i(1),className:"text-primary",children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(K,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-semibold",children:a.location?.address||"Localização capturada"}),a.location?.quality&&e.jsx(sa,{variant:"secondary",className:"mt-1 text-xs capitalize",children:a.location.quality})]})]}),e.jsxs(N,{variant:"ghost",size:"sm",onClick:()=>i(2),className:"text-primary",children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsxs(w,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(q,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Fotos"}),e.jsxs("p",{className:"font-semibold",children:[a.images.length," ",a.images.length===1?"foto anexada":"fotos anexadas"]})]})]}),e.jsxs(N,{variant:"ghost",size:"sm",onClick:()=>i(3),className:"text-primary",children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"Editar"]})]}),a.images.length>0?e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:a.images.map((h,b)=>e.jsx("img",{src:h.previewUrl,alt:`Foto ${b+1}`,className:"h-20 w-20 rounded-lg object-cover shrink-0"},h.id))}):e.jsxs("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("p",{className:"text-sm",children:"Nenhuma foto anexada (opcional)"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4 text-muted-foreground"}),"Descrição adicional (opcional)"]}),e.jsx(ia,{placeholder:"Algum detalhe importante? (máx. 500 caracteres)",maxLength:500,value:a.description,onChange:h=>t({description:h.target.value}),className:"min-h-[100px] rounded-xl resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[a.description.length,"/500"]})]}),e.jsx(w,{className:A("p-4 transition-all border-2",a.confirmed?"border-green-400 bg-green-50 dark:bg-green-950/20 dark:border-green-700":"border-amber-400 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-700"),children:e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[e.jsx(ra,{checked:a.confirmed,onCheckedChange:h=>t({confirmed:!!h}),className:"mt-0.5 h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:A("font-medium",a.confirmed?"text-green-700 dark:text-green-300":"text-amber-700 dark:text-amber-300"),children:a.confirmed?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"Confirmado!"]}):"Confirmo que as informações são verdadeiras"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:a.confirmed?"Você confirmou que as informações são verdadeiras":"Marque para poder enviar a denúncia"})]})]})}),!x&&e.jsx(w,{className:"p-4 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-red-600 dark:text-red-400 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 dark:text-red-300",children:"Não é possível enviar ainda"}),e.jsxs("ul",{className:"text-sm text-red-700 dark:text-red-400 mt-1 space-y-1",children:[!a.title?.trim()&&e.jsx("li",{children:"• Adicione um título"}),!a.categoryId&&e.jsx("li",{children:"• Selecione uma categoria"}),!a.location&&e.jsx("li",{children:"• Capture sua localização"}),!a.confirmed&&e.jsx("li",{children:"• Confirme que as informações são verdadeiras"})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(N,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:s,disabled:d,children:"Voltar"}),e.jsx(N,{size:"lg",className:A("h-14 rounded-2xl flex-[2] text-base font-semibold",x?"bg-green-600 hover:bg-green-700":"opacity-50"),disabled:!x||d,onClick:g,children:d?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"h-5 w-5 mr-2 animate-spin"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(na,{className:"h-5 w-5 mr-2"}),"Enviar denúncia"]})})]})})]})}function Aa({protocolNumber:a,onClose:t}){const{toast:s}=He(),i=u.useCallback(()=>{const m=Date.now()+3e3,o={startVelocity:30,spread:360,ticks:60,zIndex:100},x=(h,b)=>Math.random()*(b-h)+h,g=setInterval(()=>{const h=m-Date.now();if(h<=0)return clearInterval(g);const b=50*(h/3e3);X({...o,particleCount:b,origin:{x:x(.1,.3),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),X({...o,particleCount:b,origin:{x:x(.7,.9),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]})},250);return X({particleCount:100,spread:70,origin:{y:.6},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),()=>clearInterval(g)},[]);u.useEffect(()=>i(),[i]);const r=async()=>{try{await navigator.clipboard.writeText(a),s({title:"Protocolo copiado!",description:"Cole onde quiser para guardar."})}catch{s({title:"Erro ao copiar",description:"Tente copiar manualmente.",variant:"destructive"})}},d=async()=>{if(navigator.share)try{await navigator.share({title:"Denúncia Enviada - eTijucas",text:`Minha denúncia foi registrada com sucesso! Protocolo: ${a}`})}catch{console.log("Share cancelled")}else r()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-gradient-to-b from-green-50 to-background dark:from-green-950/30 dark:to-background flex flex-col items-center justify-center p-6 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(6)].map((c,m)=>e.jsx(j.div,{initial:{opacity:0,scale:0},animate:{opacity:[0,.3,0],scale:[0,1.5,2],x:Math.random()*100-50,y:Math.random()*100-50},transition:{duration:3,delay:m*.3,repeat:1/0,repeatDelay:2},className:"absolute rounded-full bg-green-400/20",style:{width:100+m*30,height:100+m*30,left:`${20+m*10}%`,top:`${15+m*12}%`}},m))}),e.jsxs(j.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},transition:{duration:.5},className:"relative z-10 w-full max-w-sm flex flex-col items-center text-center",children:[e.jsxs(j.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},className:"relative mb-6",children:[e.jsx("div",{className:"p-6 rounded-full bg-green-100 dark:bg-green-900/50 shadow-lg shadow-green-500/20",children:e.jsx(L,{className:"h-20 w-20 text-green-600 dark:text-green-400"})}),e.jsx(j.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(ca,{className:"h-8 w-8 text-yellow-500"})}),e.jsx(j.div,{animate:{rotate:-360},transition:{duration:4,repeat:1/0,ease:"linear"},className:"absolute -bottom-1 -left-3",children:e.jsx(ke,{className:"h-7 w-7 text-pink-500"})})]}),e.jsx(j.h1,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-3xl font-bold text-green-700 dark:text-green-400 mb-2",children:"Denúncia Enviada!"}),e.jsx(j.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"text-muted-foreground mb-6",children:"Obrigado por ajudar a melhorar nossa cidade!"}),e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"w-full",children:e.jsxs(w,{className:"p-6 bg-white dark:bg-card border-green-200 dark:border-green-800 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-3",children:[e.jsx(Le,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground font-medium",children:"Número do Protocolo"})]}),e.jsx(j.p,{className:"text-2xl font-bold font-mono text-primary mb-4",animate:{scale:[1,1.02,1]},transition:{duration:2,repeat:1/0},children:a}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{variant:"outline",size:"sm",className:"flex-1",onClick:r,children:[e.jsx(la,{className:"h-4 w-4 mr-2"}),"Copiar"]}),e.jsxs(N,{variant:"outline",size:"sm",className:"flex-1",onClick:d,children:[e.jsx(da,{className:"h-4 w-4 mr-2"}),"Compartilhar"]})]})]})}),e.jsx(j.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.7},className:"text-xs text-muted-foreground mt-4 max-w-xs",children:"Guarde este número para acompanhar o andamento da sua denúncia. Nossa equipe irá analisar e tomar as providências necessárias."}),e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.8},className:"w-full mt-8 space-y-3",children:[e.jsxs(N,{size:"lg",className:"w-full h-14 rounded-2xl text-base font-semibold bg-green-600 hover:bg-green-700",onClick:t,children:[e.jsx(_e,{className:"h-5 w-5 mr-2"}),"Voltar para o início"]}),e.jsxs(N,{variant:"ghost",size:"lg",className:"w-full h-12 rounded-2xl text-base",onClick:()=>{X({particleCount:100,spread:70,origin:{y:.6},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]})},children:[e.jsx(ke,{className:"h-5 w-5 mr-2"}),"Celebrar mais! 🎉"]})]})]})]})}const ge=(a,t)=>t.some(s=>a instanceof s);let Se,De;function Ma(){return Se||(Se=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function za(){return De||(De=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const be=new WeakMap,me=new WeakMap,re=new WeakMap;function Ea(a){const t=new Promise((s,i)=>{const r=()=>{a.removeEventListener("success",d),a.removeEventListener("error",c)},d=()=>{s(O(a.result)),r()},c=()=>{i(a.error),r()};a.addEventListener("success",d),a.addEventListener("error",c)});return re.set(t,a),t}function Ta(a){if(be.has(a))return;const t=new Promise((s,i)=>{const r=()=>{a.removeEventListener("complete",d),a.removeEventListener("error",c),a.removeEventListener("abort",c)},d=()=>{s(),r()},c=()=>{i(a.error||new DOMException("AbortError","AbortError")),r()};a.addEventListener("complete",d),a.addEventListener("error",c),a.addEventListener("abort",c)});be.set(a,t)}let je={get(a,t,s){if(a instanceof IDBTransaction){if(t==="done")return be.get(a);if(t==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return O(a[t])},set(a,t,s){return a[t]=s,!0},has(a,t){return a instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in a}};function Pe(a){je=a(je)}function La(a){return za().includes(a)?function(...t){return a.apply(ye(this),t),O(this.request)}:function(...t){return O(a.apply(ye(this),t))}}function Ra(a){return typeof a=="function"?La(a):(a instanceof IDBTransaction&&Ta(a),ge(a,Ma())?new Proxy(a,je):a)}function O(a){if(a instanceof IDBRequest)return Ea(a);if(me.has(a))return me.get(a);const t=Ra(a);return t!==a&&(me.set(a,t),re.set(t,a)),t}const ye=a=>re.get(a);function Ba(a,t,{blocked:s,upgrade:i,blocking:r,terminated:d}={}){const c=indexedDB.open(a,t),m=O(c);return i&&c.addEventListener("upgradeneeded",o=>{i(O(c.result),o.oldVersion,o.newVersion,O(c.transaction),o)}),s&&c.addEventListener("blocked",o=>s(o.oldVersion,o.newVersion,o)),m.then(o=>{d&&o.addEventListener("close",()=>d()),r&&o.addEventListener("versionchange",x=>r(x.oldVersion,x.newVersion,x))}).catch(()=>{}),m}const Pa=["get","getKey","getAll","getAllKeys","count"],Fa=["put","add","delete","clear"],ue=new Map;function Ie(a,t){if(!(a instanceof IDBDatabase&&!(t in a)&&typeof t=="string"))return;if(ue.get(t))return ue.get(t);const s=t.replace(/FromIndex$/,""),i=t!==s,r=Fa.includes(s);if(!(s in(i?IDBIndex:IDBObjectStore).prototype)||!(r||Pa.includes(s)))return;const d=async function(c,...m){const o=this.transaction(c,r?"readwrite":"readonly");let x=o.store;return i&&(x=x.index(m.shift())),(await Promise.all([x[s](...m),r&&o.done]))[0]};return ue.set(t,d),d}Pe(a=>({...a,get:(t,s,i)=>Ie(t,s)||a.get(t,s,i),has:(t,s)=>!!Ie(t,s)||a.has(t,s)}));const qa=["continue","continuePrimaryKey","advance"],Ae={},Ne=new WeakMap,Fe=new WeakMap,Oa={get(a,t){if(!qa.includes(t))return a[t];let s=Ae[t];return s||(s=Ae[t]=function(...i){Ne.set(this,Fe.get(this)[t](...i))}),s}};async function*Ua(...a){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...a)),!t)return;t=t;const s=new Proxy(t,Oa);for(Fe.set(s,t),re.set(s,ye(t));t;)yield s,t=await(Ne.get(s)||t.continue()),Ne.delete(s)}function Me(a,t){return t===Symbol.asyncIterator&&ge(a,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&ge(a,[IDBIndex,IDBObjectStore])}Pe(a=>({...a,get(t,s,i){return Me(t,s)?Ua:a.get(t,s,i)},has(t,s){return Me(t,s)||a.has(t,s)}}));const ze="etijucas-reports",Va=2;let T=null,J=!1;async function U(){if(T&&J)return T;try{return T=await Ba(ze,Va,{upgrade(a,t,s){if(console.log(`[reportDraftDB] Upgrading from v${t} to v${s}`),!a.objectStoreNames.contains("drafts")){const i=a.createObjectStore("drafts",{keyPath:"id"});i.createIndex("by-status","syncStatus"),i.createIndex("by-updated","updatedAt")}a.objectStoreNames.contains("images")||a.createObjectStore("images",{keyPath:"id"}).createIndex("by-draft","draftId")},blocked(){console.warn("[reportDraftDB] Database blocked - close other tabs")},blocking(){T?.close(),T=null,J=!1}}),J=!0,T}catch(a){if(console.error("[reportDraftDB] Failed to open database:",a),a instanceof Error&&a.name==="NotFoundError"){console.warn("[reportDraftDB] Corrupted database, deleting and recreating...");try{return T&&(T.close(),T=null),await new Promise((t,s)=>{const i=indexedDB.deleteDatabase(ze);i.onsuccess=()=>t(),i.onerror=()=>s(i.error),i.onblocked=()=>{console.warn("[reportDraftDB] Delete blocked"),t()}}),console.log("[reportDraftDB] Database deleted, recreating..."),J=!1,U()}catch(t){throw console.error("[reportDraftDB] Failed to delete database:",t),t}}throw a}}function qe(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async function Oe(a,t="draft"){const s=await U(),i=a.idempotencyKey||qe(),r=Date.now(),d={categoryId:a.categoryId,category:a.category,location:a.location,title:a.title,description:a.description,confirmed:a.confirmed,currentStep:a.currentStep,createdAt:a.createdAt.getTime(),updatedAt:r,idempotencyKey:a.idempotencyKey};await s.put("drafts",{id:i,draft:d,syncStatus:t,createdAt:r,updatedAt:r});const c=s.transaction("images","readwrite"),m=await s.getAllFromIndex("images","by-draft",i);for(const o of m)await c.store.delete(o.id);for(const o of a.images){const x=o.file;await c.store.put({id:o.id,draftId:i,blob:x,filename:o.file.name,capturedAt:o.capturedAt.getTime()})}return await c.done,i}async function $a(a){const t=await U(),s=await t.get("drafts",a);if(!s)return null;const r=(await t.getAllFromIndex("images","by-draft",a)).map(c=>{const m=new File([c.blob],c.filename,{type:c.blob.type});return{id:c.id,file:m,previewUrl:URL.createObjectURL(c.blob),capturedAt:new Date(c.capturedAt)}}),d=s.draft;return{categoryId:d.categoryId,category:d.category,location:d.location,title:d.title,description:d.description,confirmed:d.confirmed,currentStep:d.currentStep,createdAt:new Date(d.createdAt),updatedAt:new Date(d.updatedAt),idempotencyKey:d.idempotencyKey,images:r}}async function Ka(){const a=await U(),t=await a.getAll("drafts");return(await Promise.all(t.map(async i=>{const r=await a.getAllFromIndex("images","by-draft",i.id);return{id:i.id,draft:i.draft,syncStatus:i.syncStatus,imageCount:r.length,updatedAt:i.updatedAt}}))).sort((i,r)=>r.updatedAt-i.updatedAt)}async function Ue(a){return(await(await U()).getAllFromIndex("drafts","by-status",a)).map(i=>i.id)}async function Ga(a,t){const s=await U(),i=await s.get("drafts",a);i&&await s.put("drafts",{...i,syncStatus:t,updatedAt:Date.now()})}async function Ve(a){const t=await U(),s=await t.getAllFromIndex("images","by-draft",a),i=t.transaction("images","readwrite");for(const r of s)await i.store.delete(r.id);await i.done,await t.delete("drafts",a)}async function Ha(){const a=await Ue("sent");let t=0;for(const s of a)await Ve(s),t++;return t}function $e(a){for(const t of a)t.previewUrl?.startsWith("blob:")&&URL.revokeObjectURL(t.previewUrl)}const Ee="report_draft";async function Ke(){try{const a=localStorage.getItem(Ee);if(!a)return!1;const t=JSON.parse(a);if(!t)return!1;const s={categoryId:t.categoryId||null,category:t.category||null,location:t.location||null,title:t.title||"",description:t.description||"",confirmed:!1,currentStep:t.currentStep||1,createdAt:new Date,updatedAt:new Date,idempotencyKey:qe(),images:[]};return await Oe(s,"draft"),localStorage.removeItem(Ee),console.log("[reportDraftDB] Migrated draft from localStorage to IndexedDB"),!0}catch(a){return console.error("[reportDraftDB] Migration failed:",a),!1}}const Z={saveDraft:Oe,getDraft:$a,getAllDrafts:Ka,getDraftsByStatus:Ue,updateDraftStatus:Ga,deleteDraft:Ve,clearSentDrafts:Ha,revokeImageURLs:$e,migrateFromLocalStorage:Ke},ae=()=>`report-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,xe={categoryId:null,category:null,location:null,locationNote:"",images:[],title:"",description:"",confirmed:!1,currentStep:1,createdAt:new Date,updatedAt:new Date,idempotencyKey:ae()},Te="etijucas-report-draft",ee="active-report-draft";function _a(){const[a,t]=u.useState(()=>({...xe,idempotencyKey:ae()})),[s,i]=u.useState(!0),r=u.useRef(null),d=u.useRef(!0);u.useEffect(()=>{d.current=!0;async function p(){try{await Ke();const f=await Z.getDraft(ee);f&&d.current&&t(f)}catch(f){console.error("[useReportDraft] Error loading draft:",f);try{const y=localStorage.getItem(Te);if(y){const S=JSON.parse(y);d.current&&t({...xe,...S,createdAt:new Date(S.createdAt||Date.now()),updatedAt:new Date(S.updatedAt||Date.now()),images:[],idempotencyKey:S.idempotencyKey||ae()})}}catch(y){console.error("[useReportDraft] localStorage fallback failed:",y)}}finally{d.current&&i(!1)}}return p(),()=>{d.current=!1,r.current&&clearTimeout(r.current)}},[]);const c=u.useCallback(async p=>{r.current&&clearTimeout(r.current),r.current=setTimeout(async()=>{try{const f={...p,idempotencyKey:ee};await Z.saveDraft(f,"draft")}catch(f){console.error("[useReportDraft] Error saving draft:",f)}},500)},[]),m=u.useCallback(p=>{t(f=>{const y={...f,...p,updatedAt:new Date};return c(y),y})},[c]),o=u.useCallback(p=>{t(f=>{if(f.images.length>=3)return f;const y={...f,images:[...f.images,p],updatedAt:new Date};return c(y),y})},[c]),x=u.useCallback(p=>{t(f=>{const y=f.images.find(I=>I.id===p);y&&URL.revokeObjectURL(y.previewUrl);const S={...f,images:f.images.filter(I=>I.id!==p),updatedAt:new Date};return c(S),S})},[c]),g=u.useCallback(p=>{m({currentStep:p})},[m]),h=u.useCallback(()=>{t(p=>{if(p.currentStep<4){const f=p.currentStep+1,y={...p,currentStep:f,updatedAt:new Date};return c(y),y}return p})},[c]),b=u.useCallback(()=>{t(p=>{if(p.currentStep>1){const f=p.currentStep-1,y={...p,currentStep:f,updatedAt:new Date};return c(y),y}return p})},[c]),k=u.useCallback(async()=>{$e(a.images);try{await Z.deleteDraft(ee)}catch(p){console.error("[useReportDraft] Error deleting draft:",p)}localStorage.removeItem(Te),t({...xe,idempotencyKey:ae()})},[a.images]),D=u.useCallback(async()=>{r.current&&clearTimeout(r.current);try{const p={...a,idempotencyKey:ee};await Z.saveDraft(p,"draft")}catch(p){console.error("[useReportDraft] Error saving draft:",p)}},[a]);return{draft:a,isLoading:s,updateDraft:m,addImage:o,removeImage:x,goToStep:g,nextStep:h,prevStep:b,clearDraft:k,saveDraft:D}}const Wa=["Categoria","Localização","Fotos","Revisão"],Qa={enter:a=>({x:a>0?"100%":"-100%",opacity:0}),center:{x:0,opacity:1},exit:a=>({x:a<0?"100%":"-100%",opacity:0})};function Rt(){const a=We(),{isAuthenticated:t}=xa();if(!t)return e.jsx(ma,{title:"Cadastre-se ou entre",message:"Para enviar uma denúncia, você precisa estar cadastrado no aplicativo.",returnUrl:"/denuncia/nova"});const{draft:s,isLoading:i,updateDraft:r,nextStep:d,prevStep:c,clearDraft:m}=_a(),[o,x]=u.useState(0),[g,h]=u.useState(!1),[b,k]=u.useState(null),{createReport:D}=ua(),p=u.useCallback(C=>{x(C>s.currentStep?1:-1),r({currentStep:C})},[s.currentStep,r]),f=u.useCallback(()=>{x(1),d()},[d]),y=u.useCallback(()=>{x(-1),c()},[c]),S=u.useCallback(async()=>{if(!s.categoryId){H.error("Selecione uma categoria para a denúncia");return}if(!s.title||s.title.trim().length<5){H.error("O título deve ter pelo menos 5 caracteres");return}try{const C={categoryId:s.categoryId,title:s.title.trim(),description:s.description.trim(),images:s.images.map(n=>n.file)};s.location&&(C.addressText=s.location.address,C.addressSource=s.location.source,C.locationQuality=s.location.quality,C.latitude=s.location.latitude,C.longitude=s.location.longitude,C.locationAccuracyM=s.location.accuracy?Math.min(Math.round(s.location.accuracy),1e4):void 0);const V=await D({payload:C,idempotencyKey:s.idempotencyKey});k(V.protocol),h(!0),m(),H.success("Denúncia enviada com sucesso!")}catch(C){console.error("Error submitting report:",C),H.error("Erro ao enviar denúncia. Tente novamente.")}},[s,D,m]),I=()=>{s.categoryId||s.location||s.images.length>0?window.confirm("Tem certeza que deseja sair? Seu rascunho será salvo.")&&a(-1):a(-1)},G=()=>{a("/")};return i?e.jsx("div",{className:"fixed inset-0 z-50 bg-background flex items-center justify-center",children:e.jsx(R,{className:"h-8 w-8 animate-spin text-primary"})}):g&&b?e.jsx(Aa,{protocolNumber:b,onClose:G}):e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"shrink-0 bg-background/95 backdrop-blur-lg border-b safe-top",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:I,className:"rounded-full",children:e.jsx(pa,{className:"h-5 w-5"})}),e.jsx("h1",{className:"font-semibold text-lg",children:"Enviar Denúncia"}),e.jsx(N,{variant:"ghost",size:"icon",onClick:I,className:"rounded-full",children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"px-4 pb-4",children:e.jsx(Na,{currentStep:s.currentStep,totalSteps:4,labels:Wa})})]}),e.jsx("main",{className:"flex-1 overflow-hidden",children:e.jsx(te,{mode:"wait",custom:o,children:e.jsxs(j.div,{custom:o,variants:Qa,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},className:"h-full overflow-y-auto px-4 pt-4 pb-32",children:[s.currentStep===1&&e.jsx(ka,{draft:s,onUpdate:r,onNext:f}),s.currentStep===2&&e.jsx(Ca,{draft:s,onUpdate:r,onNext:f,onBack:y}),s.currentStep===3&&e.jsx(Da,{draft:s,onUpdate:r,onNext:f,onBack:y}),s.currentStep===4&&e.jsx(Ia,{draft:s,onUpdate:r,onBack:y,onGoToStep:p,onSubmit:S})]},s.currentStep)})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[60]",children:e.jsx(Qe,{activeTab:"reportar",onTabChange:C=>a(`/?tab=${C}`)})})]})}export{Rt as default};
