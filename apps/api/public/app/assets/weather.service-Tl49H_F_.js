import{x as g,b as T}from"./index-XZ5TDijG.js";import{aR as B,r as S,aQ as K}from"./vendor-app-CSqspwsb.js";const _="etijucas-weather-cache",j=1,m="weather-data",F={home:30*60*1e3,forecast:60*60*1e3,marine:60*60*1e3,insights:30*60*1e3};let w=null;function h(e){return e.trim().toLowerCase().replace(/\s+/g,"-")}function N(e){if(!e||e.length===0)return"none";const t=e.map(h).filter(Boolean);return t.sort(),t.join(",")}function C(e){const t=["weather",h(e.scope),h(e.tenantKey||"global")];if(typeof e.days=="number"&&t.push("days",String(e.days)),e.units&&t.push("units",h(e.units)),e.presetType&&t.push("preset",h(e.presetType)),e.sections&&e.sections.length>0&&t.push("sections",N(e.sections)),e.params){const n=Object.entries(e.params).filter(([,r])=>r!=null).map(([r,s])=>`${h(r)}=${h(String(s))}`).sort();n.length>0&&t.push("params",n.join("&"))}return t.push("v1"),t.join(":")}function O(){return w||(w=new Promise((e,t)=>{const n=indexedDB.open(_,j);n.onerror=()=>{console.error("IndexedDB open error:",n.error),t(n.error)},n.onsuccess=()=>{e(n.result)},n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(m)||s.createObjectStore(m,{keyPath:"key"}).createIndex("expiresAt","expiresAt",{unique:!1})}}),w)}async function x(e){try{const t=await O();return new Promise(n=>{const o=t.transaction(m,"readonly").objectStore(m).get(e);o.onsuccess=()=>{const i=o.result;if(!i){n(null);return}const c=Date.now()>i.expiresAt;n({...i,isStale:c})},o.onerror=()=>{console.error("Cache read error:",o.error),n(null)}})}catch(t){return console.error("getCached error:",t),null}}async function I(e,t,n="forecast"){try{const r=await O(),s=Date.now(),o=F[n],i={key:e,data:t,cachedAt:s,expiresAt:s+o,isStale:!1};return new Promise((l,c)=>{const a=r.transaction(m,"readwrite").objectStore(m).put(i);a.onsuccess=()=>l(),a.onerror=()=>{console.error("Cache write error:",a.error),c(a.error)}})}catch(r){console.error("setCached error:",r)}}function E(e,t,n){const{cacheKey:r,ttlType:s="forecast",...o}=n,i=B(),[l,c]=S.useState({isFromCache:!1,isStale:!1,cachedAt:null,isUpdating:!1});S.useEffect(()=>{(async()=>{try{const d=await x(r);d&&(i.setQueryData(e,d.data),c({isFromCache:!0,isStale:d.isStale,cachedAt:new Date(d.cachedAt),isUpdating:d.isStale}))}catch(d){console.error("[useOfflineQuery] Cache load error:",d)}})()},[r,e,i]);const u=K({queryKey:e,queryFn:async()=>{c(a=>({...a,isUpdating:!0}));try{const a=await t();return await I(r,a,s),c({isFromCache:!1,isStale:!1,cachedAt:new Date,isUpdating:!1}),a}catch(a){throw c(d=>({...d,isUpdating:!1})),a}},staleTime:1e3*60*5,gcTime:1e3*60*60,retry:2,retryDelay:1e3,...o}),y=S.useCallback(async()=>{c(a=>({...a,isUpdating:!0})),await u.refetch()},[u]);return{data:u.data,isLoading:u.isLoading&&!l.isFromCache,isError:u.isError,error:u.error,isFetching:u.isFetching,refetch:y,cacheStatus:l}}function H(){const[e,t]=S.useState(typeof navigator<"u"?navigator.onLine:!0);return S.useEffect(()=>{const n=()=>t(!0),r=()=>t(!1);return window.addEventListener("online",n),window.addEventListener("offline",r),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",r)}},[]),{isOnline:e,isOffline:!e}}function V(e){if(!e)return"";const n=new Date().getTime()-e.getTime(),r=Math.floor(n/6e4);if(r<1)return"agora mesmo";if(r===1)return"há 1 minuto";if(r<60)return`há ${r} minutos`;const s=Math.floor(r/60);return s===1?"há 1 hora":s<24?`há ${s} horas`:"há mais de um dia"}const D="/weather",$=7,A="metric",P=["current","hourly","daily","insights"],p={current:1,hourly:2,daily:3,marine:4,insights:5};function L(e,t){return e??t??"global"}function k(e){if(!e||e.length===0)return;const t=e.map(n=>n.trim()).filter(n=>n.length>0);if(t.length!==0)return Array.from(new Set(t)).sort()}function b(e){return k(e)?.join(",")??"default"}function U(e){const t=e&&e.length>0?e:P,n=Array.from(new Set(t)).filter(r=>r in p);return n.sort((r,s)=>p[r]-p[s]),n}function q(e){return U(e).join(",")}function v(e,t){const n=t.toString();return n?`${e}?${n}`:e}async function z(){return T.get(`${D}/insights`)}async function R(e){return T.get(`${D}/preset/${e}`)}async function W(e){const t=new URLSearchParams,n=U(e?.sections),r=e?.days??$,s=e?.units??A;return t.append("sections",n.join(",")),t.append("days",String(r)),t.append("units",s),T.get(v(`${D}/bundle`,t))}const f={all:["weather"],home:(e,t)=>[...f.all,"home",e,`hours:${t?.hours??"default"}`,`include:${b(t?.include)}`],forecast:(e,t)=>[...f.all,"forecast",e,`days:${t?.days??"default"}`,`hours:${t?.hours??"default"}`,`include:${b(t?.include)}`],marine:(e,t)=>[...f.all,"marine",e,`days:${t?.days??"default"}`,`hours:${t?.hours??"default"}`,`include:${b(t?.include)}`],insights:e=>[...f.all,"insights",e],preset:(e,t)=>[...f.all,"preset",e,t],bundle:(e,t)=>[...f.all,"bundle",e,`days:${t?.days??$}`,`units:${t?.units??A}`,`sections:${q(t?.sections)}`]};function Y(e){const t=g(o=>o.tenantKey),n=g(o=>o.city?.slug??null),r=L(t,n),s=C({scope:"insights",tenantKey:r});return E([...f.insights(r)],()=>z(),{cacheKey:s,ttlType:"insights",enabled:e?.enabled})}function G(e){const t=g(o=>o.tenantKey),n=g(o=>o.city?.slug??null),r=L(t,n),s=C({scope:"preset",tenantKey:r,presetType:e});return E([...f.preset(r,e)],()=>R(e),{cacheKey:s,ttlType:"insights"})}function J(e,t){const n=g(y=>y.tenantKey),r=g(y=>y.city?.slug??null),s=L(n,r),o=U(e?.sections),i=e?.days??$,l=e?.units??A,c=C({scope:"bundle",tenantKey:s,days:i,units:l,sections:o}),u=o.includes("marine")?"marine":o.length===1&&o[0]==="insights"?"insights":"forecast";return E([...f.bundle(s,{...e,sections:o,days:i,units:l})],()=>W({...e,sections:o,days:i,units:l}),{cacheKey:c,ttlType:u,enabled:t?.enabled})}export{G as a,H as b,J as c,V as f,Y as u};
