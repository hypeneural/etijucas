import{r as i,j as e,l as H,m as p,X as L,O as B,M as I,x as T,at as D,H as W,am as F,ah as G,E as M,u as R,aO as U,dl as z}from"./vendor-app-B8taUZN0.js";import{B as $}from"./BottomTabBar-Zu7ua6wn.js";import{u as Q}from"./useAppStore-C7KZ9Zro.js";import{u as P}from"./useAuthStore-By3YEH0U.js";import{a as q}from"./auth.service-2WiSOYkP.js";import{a as V,E as _}from"./client-BdVdTjkU.js";import{b as A}from"./localDatabase-BMbCKTE4.js";import"./middleware-WYGlAF-S.js";import"./bairros-Cf5Z_oCw.js";import"./uuid-BwYzP5ph.js";import"./index-Cay7c1rX.js";async function K(){(await A.getAll()).length}const X={async getAll(){await K();try{const r=await V.get(_.bairros.list);return r.data&&r.data.length>0&&(await A.clear(),await A.saveMany(r.data)),r.data}catch(r){return console.warn("[BairroService] API failed, using cache:",r),A.getAll()}}},J=100;function Y({isOpen:r,onClose:n,children:o,title:g,snapPoints:a=[.5,.9],initialSnap:l=0,className:c=""}){const[x,d]=i.useState(l),m=i.useRef(null);i.useRef(0);const h=`${a[x]*100}vh`,u=i.useCallback((y,s)=>{const{velocity:j,offset:b}=s;if(j.y>500||b.y>J){n();return}if(j.y<-500){d(a.length-1);return}const S=window.innerHeight,v=((m.current?.offsetHeight||0)-b.y)/S;let C=0,k=Math.abs(a[0]-v);a.forEach((E,w)=>{const t=Math.abs(E-v);t<k&&(k=t,C=w)}),d(C)},[n,a]);return e.jsx(H,{children:r&&e.jsxs(e.Fragment,{children:[e.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:n,className:"fixed inset-0 bg-black/50 z-40"}),e.jsxs(p.div,{ref:m,initial:{y:"100%"},animate:{y:0,height:h},exit:{y:"100%"},transition:{type:"spring",damping:30,stiffness:300},drag:"y",dragConstraints:{top:0,bottom:0},dragElastic:.2,onDragEnd:u,className:`fixed bottom-0 left-0 right-0 bg-background rounded-t-3xl z-50 overflow-hidden shadow-elevated ${c}`,children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-grab active:cursor-grabbing",children:e.jsx("div",{className:"w-10 h-1 rounded-full bg-muted-foreground/30"})}),g&&e.jsxs("div",{className:"flex items-center justify-between px-4 pb-3 border-b border-border",children:[e.jsx("h3",{className:"text-lg font-semibold",children:g}),e.jsx("button",{onClick:n,className:"p-2 rounded-full hover:bg-muted transition-colors",children:e.jsx(L,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"overflow-y-auto h-full pb-safe",children:o})]})]})})}function Z({isOpen:r,onComplete:n,bairros:o}){const{updateUser:g}=P(),[a,l]=i.useState("name"),[c,x]=i.useState(""),[d,m]=i.useState(),[h,u]=i.useState(!1),[y,s]=i.useState(!1),[j,b]=i.useState(!1),[S,f]=i.useState(null),N=c.trim().length>=2,v=a==="name"?N:a==="bairro"?!0:h,C=async()=>{if(!navigator.geolocation){f("GPS não suportado neste dispositivo");return}b(!0),f(null),navigator.geolocation.getCurrentPosition(async t=>{console.log("GPS:",t.coords.latitude,t.coords.longitude),o.length>0&&m(o[0].id),b(!1)},t=>{console.error("GPS error:",t),f("Não foi possível obter sua localização"),b(!1)},{enableHighAccuracy:!0,timeout:1e4})},k=async()=>{if(!(!N||!h)){s(!0),f(null);try{const t=await q.completeProfile({nome:c.trim(),bairroId:d,termsAccepted:!0});g(t.user),"vibrate"in navigator&&navigator.vibrate(50),n()}catch(t){f(t.message||"Erro ao salvar perfil")}finally{s(!1)}}},E=()=>{a==="name"&&N?l("bairro"):a==="bairro"?l("terms"):a==="terms"&&h&&k()};i.useEffect(()=>{r||(l("name"),x(""),m(void 0),u(!1),f(null))},[r]);const w={initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20}};return e.jsx(Y,{isOpen:r,onClose:()=>{},title:"Bem-vindo ao eTijucas!",snapPoints:[.6,.9],initialSnap:0,children:e.jsxs("div",{className:"px-6 py-4",children:[e.jsx("div",{className:"flex gap-2 mb-6",children:["name","bairro","terms"].map((t,O)=>e.jsx("div",{className:`h-1 flex-1 rounded-full transition-colors ${t===a?"bg-primary":O<["name","bairro","terms"].indexOf(a)?"bg-primary/50":"bg-muted"}`},t))}),e.jsxs(H,{mode:"wait",children:[a==="name"&&e.jsxs(p.div,{variants:w,initial:"initial",animate:"animate",exit:"exit",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(B,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Como podemos te chamar?"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Seu nome será exibido nas suas publicações"})]})]}),e.jsx("input",{type:"text",value:c,onChange:t=>x(t.target.value),placeholder:"Seu nome",autoFocus:!0,className:"w-full px-4 py-3 rounded-xl border border-border bg-muted/50 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-lg"}),c.length>0&&!N&&e.jsx("p",{className:"text-sm text-destructive",children:"Nome deve ter pelo menos 2 caracteres"})]},"name"),a==="bairro"&&e.jsxs(p.div,{variants:w,initial:"initial",animate:"animate",exit:"exit",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(I,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Qual seu bairro? (opcional)"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Para mostrar notícias e eventos perto de você"})]})]}),e.jsxs("button",{onClick:C,disabled:j,className:"w-full flex items-center gap-3 px-4 py-3 rounded-xl border border-primary/30 bg-primary/5 hover:bg-primary/10 transition-all text-primary",children:[j?e.jsx(T,{className:"w-5 h-5 animate-spin"}):e.jsx(D,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Usar minha localização"})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto space-y-1",children:o.map(t=>e.jsxs("button",{onClick:()=>m(t.id),className:`w-full flex items-center justify-between px-4 py-3 rounded-lg transition-all ${d===t.id?"bg-primary text-primary-foreground":"hover:bg-muted"}`,children:[e.jsx("span",{children:t.nome}),d===t.id&&e.jsx(W,{className:"w-5 h-5"})]},t.id))})]},"bairro"),a==="terms"&&e.jsxs(p.div,{variants:w,initial:"initial",animate:"animate",exit:"exit",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(F,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Termos de Uso"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Quase pronto! Aceite os termos para continuar"})]})]}),e.jsx("div",{className:"p-4 rounded-xl bg-muted/50 border border-border",children:e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:"Ao usar o eTijucas, você concorda em respeitar outros usuários, não publicar conteúdo ofensivo e usar o app de forma responsável. Seus dados são protegidos conforme nossa política de privacidade."})}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-4 rounded-xl border border-border hover:border-primary/50 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:h,onChange:t=>u(t.target.checked),className:"w-5 h-5 rounded border-border text-primary focus:ring-primary"}),e.jsxs("span",{className:"text-sm",children:["Li e aceito os ",e.jsx("span",{className:"text-primary font-medium",children:"Termos de Uso"})," e a"," ",e.jsx("span",{className:"text-primary font-medium",children:"Política de Privacidade"})]})]})]},"terms")]}),S&&e.jsx(p.p,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"text-sm text-destructive mt-4 text-center",children:S}),e.jsx(p.button,{onClick:E,disabled:!v||y,className:`w-full mt-6 py-4 rounded-2xl font-semibold text-lg flex items-center justify-center gap-2 transition-all ${v?"bg-primary text-primary-foreground hover:bg-primary/90":"bg-muted text-muted-foreground cursor-not-allowed"}`,whileTap:v?{scale:.98}:void 0,children:y?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"w-5 h-5 animate-spin"}),"Salvando..."]}):a==="terms"?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"w-5 h-5"}),"Concluir"]}):e.jsxs(e.Fragment,{children:["Continuar",e.jsx(G,{className:"w-5 h-5"})]})}),a==="bairro"&&e.jsx("button",{onClick:()=>l("terms"),className:"w-full mt-3 py-2 text-sm text-muted-foreground hover:text-foreground transition-colors",children:"Pular por agora"})]})})}function me(){const r=M(),n=R(),{setActiveTab:o}=Q(),{isAuthenticated:g,user:a,needsOnboarding:l}=P(),[c,x]=i.useState(!1),{data:d=[]}=U({queryKey:["bairros"],queryFn:X.getAll,staleTime:1e3*60*60});i.useEffect(()=>{l()&&x(!0)},[g,a]);const m=()=>{x(!1)},u=(s=>s==="/"?"home":s.startsWith("/denuncia")||s.startsWith("/minhas-denuncias")?"reportar":s.startsWith("/forum")||s.startsWith("/topico")?"forum":s.startsWith("/agenda")||s.startsWith("/evento")?"agenda":s.startsWith("/telefones")||s.startsWith("/coleta-lixo")||s.startsWith("/pontos-turisticos")||s.startsWith("/ponto-turistico")||s.startsWith("/missas")||s.startsWith("/votacoes")||s.startsWith("/vereadores")||s.startsWith("/perfil")?"mais":"home")(r.pathname);i.useEffect(()=>{o(u)},[u,o]);const y=s=>{switch(s){case"home":n("/");break;case"reportar":n("/denuncias");break;case"forum":n("/forum");break;case"agenda":n("/agenda");break;case"mais":n("/mais");break}};return e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-muted/50",children:e.jsxs("div",{className:"relative w-full max-w-[420px] h-full bg-background overflow-hidden shadow-elevated",children:[e.jsx("div",{className:"absolute inset-0 overflow-y-auto scrollbar-hide pb-20",children:e.jsx(z,{})}),e.jsx($,{activeTab:u,onTabChange:y}),e.jsx(Z,{isOpen:c,onComplete:m,bairros:d})]})})}export{me as default};
