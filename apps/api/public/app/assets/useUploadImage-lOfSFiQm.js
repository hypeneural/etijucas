const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D-aY3LRG.js","assets/vendor-app-B8nTTOoa.js","assets/index-C4XNE47A.css"])))=>i.map(i=>d[i]);
import{r as A,aS as $}from"./vendor-app-B8nTTOoa.js";import{_ as B,E as c,d as m,F as f,C as i,D as g,h as I}from"./index-D-aY3LRG.js";function T(e,o=1,t=10){const a=(o-1)*t,n=a+t;return{data:e.slice(a,n),meta:{total:e.length,page:o,perPage:t,lastPage:Math.ceil(e.length/t),from:a+1,to:Math.min(n,e.length)}}}function D(e,o){if(!e||typeof e!="object")throw new Error(`Invalid API response: ${JSON.stringify(e)}`);const t=e;if("data"in t&&t.data)return t.data;if(o&&o in t&&t[o])return t[o];if("topic"in t&&t.topic)return t.topic;if("comment"in t&&t.comment)return t.comment;if("id"in t)return t;throw new Error(`Could not extract data from response: ${JSON.stringify(e)}`)}let E=!1;async function C(){E||(E=!0,(await i.getAll()).length)}const M={async getAll(e){await C();try{const o=await m.get(c.forum.topics,e);return o.data.length>0&&await i.saveMany(o.data),o}catch{let o=await i.getAll();if(e?.bairroId&&(o=o.filter(t=>t.bairroId===e.bairroId)),e?.categoria&&(o=o.filter(t=>t.categoria===e.categoria)),e?.search){const t=e.search.toLowerCase();o=o.filter(a=>a.titulo.toLowerCase().includes(t)||a.texto.toLowerCase().includes(t))}if(e?.comFoto&&(o=o.filter(t=>t.fotoUrl)),e?.orderBy){const t=e.order==="asc"?1:-1;o.sort((a,n)=>e.orderBy==="createdAt"?t*(new Date(n.createdAt).getTime()-new Date(a.createdAt).getTime()):e.orderBy==="likesCount"?t*(n.likesCount-a.likesCount):e.orderBy==="commentsCount"?t*(n.commentsCount-a.commentsCount):0)}return T(o,e?.page,e?.perPage)}},async getById(e){await C();try{const o=await m.get(c.forum.topic(e));return await i.save(o.data),o.data}catch{return i.getById(e)}},async create(e){await C();const o=`topic-${JSON.stringify(e)}-${Date.now()}`;try{console.log("[TopicService] Creating topic:",e);const t=await m.post(c.forum.createTopic,e);console.log("[TopicService] API response:",t);const a=D(t,"topic");return console.log("[TopicService] âœ… Topic created successfully:",a.id),await i.save(a),a}catch(t){console.error("[TopicService] âŒ Failed to create topic:",t);const a={...e,id:`topic-local-${Date.now()}`,createdAt:new Date,likesCount:0,commentsCount:0,liked:!1,isSaved:!1,isAnon:e.isAnon??!1,syncStatus:"pending"};throw await i.save(a),await g.exists(o)||await g.add({type:"topic",data:{...e,localId:a.id},idempotencyKey:o}),t}},async update(e,o){const t=await m.put(c.forum.updateTopic(e),o);return await i.save(t.data),t.data},async delete(e){await m.delete(c.forum.deleteTopic(e)),await i.delete(e)},async toggleLike(e){await C();const o=`like-${e}-${Date.now()}`;try{const t=await m.post(c.forum.likeTopic(e));return await i.getById(e)&&await i.update(e,{liked:t.liked,likesCount:t.likesCount}),t}catch{const t=await i.getById(e),a=!t?.liked,n=(t?.likesCount??0)+(a?1:-1);return t&&await i.update(e,{liked:a,likesCount:Math.max(0,n)}),await g.exists(o)||await g.add({type:"like",data:{topicId:e},idempotencyKey:o}),{liked:a,likesCount:Math.max(0,n)}}},async toggleSave(e){const o=await m.post(c.forum.saveTopic(e));return await i.getById(e)&&await i.update(e,{isSaved:o.saved}),o},async getSaved(e){return m.get(c.forum.savedTopics,e)},async report(e,o){return m.post(c.forum.reportTopic(e),o)},async getComments(e,o){try{const t=await m.get(c.forum.comments(e),o);for(const a of t.data)await f.save(a);return t}catch{const t=await f.getByTopicId(e);return T(t,o?.page,o?.perPage)}},async addComment(e,o){const t=`comment-${e}-${JSON.stringify(o)}-${Date.now()}`;try{console.log("[TopicService] Adding comment to topic:",e,o);const a=await m.post(c.forum.comments(e),o);console.log("[TopicService] Comment API response:",a);const n=D(a,"comment");console.log("[TopicService] âœ… Comment added successfully:",n.id),await f.save(n);const u=await i.getById(e);return u&&await i.update(e,{commentsCount:u.commentsCount+1}),n}catch(a){console.error("[TopicService] âŒ Failed to add comment:",a);const n={id:`comment-local-${Date.now()}`,topicId:e,parentId:o.parentId,texto:o.texto,imageUrl:o.imageUrl,isAnon:o.isAnon??!1,likesCount:0,liked:!1,depth:o.parentId?1:0,createdAt:new Date,autor:{id:null,nome:o.isAnon?"AnÃ´nimo":"VocÃª",avatarUrl:null}};await f.save(n);const u=await i.getById(e);throw u&&await i.update(e,{commentsCount:u.commentsCount+1}),await g.exists(t)||await g.add({type:"comment",data:{topicId:e,...o,localId:n.id},idempotencyKey:t}),a}},async deleteComment(e,o){await m.delete(c.forum.deleteComment(e,o)),await f.delete(o);const t=await i.getById(e);t&&await i.update(e,{commentsCount:Math.max(0,t.commentsCount-1)})},async toggleCommentLike(e){return m.post(c.forum.likeComment(e))},async reportComment(e,o){return m.post(c.forum.reportComment(e),o)},async uploadImage(e){const o=new FormData;o.append("file",e);const{getAuthToken:t}=await B(async()=>{const{getAuthToken:d}=await import("./index-D-aY3LRG.js").then(p=>p.T);return{getAuthToken:d}},__vite__mapDeps([0,1,2])),a=t();if(!a)throw new Error("VocÃª precisa estar logado para enviar imagens");const{API_CONFIG:n}=await B(async()=>{const{API_CONFIG:d}=await import("./index-D-aY3LRG.js").then(p=>p.S);return{API_CONFIG:d}},__vite__mapDeps([0,1,2])),r=`${n.baseURL.endsWith("/")?n.baseURL.slice(0,-1):n.baseURL}${c.forum.upload}`;console.log("[topicService.uploadImage] Uploading to:",r),console.log("[topicService.uploadImage] Token present:",!!a);const s=await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${a}`,Accept:"application/json"},body:o});if(console.log("[topicService.uploadImage] Response status:",s.status),!s.ok){if(s.status===413)throw new Error("Imagem muito grande. MÃ¡ximo 5MB.");if(s.status===401)throw new Error("SessÃ£o expirada. FaÃ§a login novamente.");const d=await s.json().catch(()=>({}));throw new Error(d.message||"Falha no upload da imagem")}const l=await s.json();return console.log("[topicService.uploadImage] Success:",l),l},async like(e){await this.toggleLike(e)},async unlike(e){await this.toggleLike(e)}};function _(e={}){const{maxSizeMB:o=5}=e,[t,a]=A.useState(0),[n,u]=A.useState(!1),r=$({mutationFn:async s=>{a(0);const l=s.size/(1024*1024);if(l>o)throw new Error(`Imagem muito grande (${l.toFixed(1)}MB). MÃ¡ximo: ${o}MB`);if(!s.type.startsWith("image/"))throw new Error("Arquivo deve ser uma imagem (JPEG, PNG ou WebP)");let d=s;if(l>1){u(!0);try{d=await F(s)}finally{u(!1)}}a(30);const p=await M.uploadImage(d);return a(100),p},onSuccess:s=>{I.success("ðŸ“· Imagem enviada!"),e.onSuccess?.(s)},onError:s=>{const l=s instanceof Error?s.message:"Erro ao enviar imagem";l.includes("413")||l.includes("too large")?I.error("âŒ Imagem muito grande. MÃ¡ximo 5MB."):I.error(`âŒ ${l}`),e.onError?.(s instanceof Error?s:new Error(l))}});return{upload:r.mutate,uploadAsync:r.mutateAsync,isUploading:r.isPending,isCompressing:n,progress:t,error:r.error,reset:()=>{r.reset(),a(0)}}}async function F(e,o=2e3){return new Promise((t,a)=>{const n=new FileReader;n.onload=u=>{const r=new Image;r.onload=async()=>{const s=e.size/1048576;let l=s>3?.6:s>2?.7:.8,d=s>3?1024:1280;const p=document.createElement("canvas");let w=r.width,y=r.height;w>d&&(y=y*d/w,w=d),p.width=w,p.height=y;const k=p.getContext("2d");if(!k){t(e);return}k.drawImage(r,0,0,w,y);const S=h=>{p.toBlob(v=>{if(!v){t(e);return}if(v.size/1024>o&&h>.3){S(h-.1);return}const x=new File([v],e.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()});console.log(`[useUploadImage] Compressed: ${(e.size/1024).toFixed(0)}KB â†’ ${(x.size/1024).toFixed(0)}KB (quality: ${h.toFixed(1)})`),t(x)},"image/jpeg",h)};S(l)},r.onerror=a,r.src=u.target?.result},n.onerror=a,n.readAsDataURL(e)})}export{M as t,_ as u};
