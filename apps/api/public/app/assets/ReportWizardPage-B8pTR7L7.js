import{j as e,bc as be,M as $,ak as U,bd as ke,m as p,$ as Ce,r as s,be as H,l as J,X as ce,x as O,a6 as Se,bf as De,z as le,bg as fe,o as _,y as Q,ar as W,n as F,al as Z,N as me,bh as ze,bi as Re,bj as ee,am as ae,bk as Te,b1 as je,bl as se,bm as Ne,b4 as Ee,a2 as Ie,bn as Ae,bo as Le,ay as Me,H as qe,bp as Pe,w as Fe}from"./vendor-app-D_TKIhWN.js";import{c as E,B as f,r as ue,j as xe,k as te,h as V,l as pe,f as Oe,u as ve,m as re,n as oe,o as K,p as G,q as Be,R as he,s as Ue,t as Ve,a as Ge,v as $e,w as Ke}from"./index-KGDh_xv5.js";import{u as _e}from"./useMyReports-mqKbIrVz.js";import{C}from"./card-DBjLedxx.js";import{C as ye}from"./CategoryIcon-B26cxN_r.js";import{u as we,L as He}from"./LoginRequired-ljvrDhrS.js";import{I as ne}from"./input-C4C56Jtk.js";import{L as We}from"./LocationMap-CNBbc4_u.js";import{h as X}from"./useHaptic-D9J3ZOOx.js";import{B as Qe}from"./badge-D12OaDKQ.js";import{C as Xe}from"./checkbox-DN7NqU-l.js";import{T as Je}from"./textarea-BwKBquRU.js";import{c as ie}from"./confetti.module-B5JVzsfH.js";import{B as Ye}from"./BottomTabBar-DJ2Q9MTN.js";import"./iconify-Bl2-U9FG.js";import"./vendor-maps-Bc_6AxBa.js";import"./skeleton-BUt0teDN.js";import"./useCityName-Dn0-60g4.js";const Ze=[{icon:be,label:"Categoria"},{icon:$,label:"Localização"},{icon:U,label:"Fotos"},{icon:ke,label:"Revisão"}];function ea({currentStep:a,totalSteps:n,labels:t}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:Ze.slice(0,n).map((y,r)=>{const h=r+1,u=h<a,d=h===a,i=y.icon;return e.jsxs("div",{className:"flex flex-col items-center flex-1",children:[r>0&&e.jsx("div",{className:E("absolute h-0.5 -translate-y-4",u||d?"bg-primary":"bg-muted"),style:{width:`calc(100% / ${n} - 2rem)`,left:`calc((100% / ${n}) * ${r} + 1rem)`}}),e.jsx(p.div,{initial:{scale:.8},animate:{scale:d?1.1:1},className:E("relative z-10 h-10 w-10 rounded-full flex items-center justify-center transition-all",u&&"bg-primary text-primary-foreground",d&&"bg-primary text-primary-foreground ring-4 ring-primary/20",!u&&!d&&"bg-muted text-muted-foreground"),children:u?e.jsx(Ce,{className:"h-5 w-5"}):e.jsx(i,{className:"h-5 w-5"})}),e.jsx("span",{className:E("text-xs mt-1.5 font-medium text-center",d&&"text-primary",u&&"text-foreground",!u&&!d&&"text-muted-foreground"),children:t?.[r]||y.label})]},h)})}),e.jsx("div",{className:"relative -mt-[3.2rem] mx-5 h-0.5 bg-muted rounded-full",children:e.jsx(p.div,{className:"h-full bg-primary rounded-full",initial:{width:0},animate:{width:`${(a-1)/(n-1)*100}%`},transition:{type:"spring",stiffness:300,damping:30}})})]})}function aa({title:a,content:n,className:t}){const[y,r]=s.useState(!1),h=Array.isArray(n)?n:[n];return e.jsxs("div",{className:E("inline-flex items-center gap-1",t),children:[e.jsx(p.button,{type:"button",whileTap:{scale:.9},onClick:()=>r(!0),className:"flex h-5 w-5 items-center justify-center rounded-full bg-muted hover:bg-muted/80 transition-colors","aria-label":`Ajuda sobre ${a}`,children:e.jsx(H,{className:"h-3 w-3 text-muted-foreground"})}),e.jsx(J,{children:y&&e.jsxs(e.Fragment,{children:[e.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>r(!1)}),e.jsxs(p.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 safe-bottom",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"flex items-start justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(H,{className:"h-4 w-4 text-primary"})}),e.jsx("h3",{className:"font-semibold text-lg",children:a})]}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full",onClick:()=>r(!1),children:e.jsx(ce,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-4 space-y-2",children:h.map((u,d)=>e.jsxs("p",{className:"text-sm text-muted-foreground flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"•"}),e.jsx("span",{children:u})]},d))}),e.jsx(f,{className:"w-full mt-6",onClick:()=>r(!1),children:"Entendi"})]})]})})]})}function Y({title:a,subtitle:n,helpTitle:t,helpContent:y}){return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-2xl font-bold",children:a}),y&&e.jsx(aa,{title:t||a,content:y})]}),n&&e.jsx("p",{className:"text-sm text-muted-foreground",children:n})]})}function sa({draft:a,onUpdate:n,onNext:t}){const{categories:y,isLoading:r,error:h,refetch:u}=we(),d=y.find(x=>x.id===a.categoryId),i=x=>{n({categoryId:x.id,category:x})},N=!!a.categoryId;return r?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando categorias..."})]}):h?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(Se,{className:"h-12 w-12 text-destructive"}),e.jsx("p",{className:"text-muted-foreground text-center",children:"Erro ao carregar categorias."}),e.jsx(f,{onClick:()=>u(),variant:"outline",children:"Tentar novamente"})]}):e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(Y,{title:"O que aconteceu?",subtitle:"Escolha a categoria que melhor descreve o problema",helpTitle:"Como escolher a categoria",helpContent:["Escolha a categoria que mais combina com o problema que você quer reportar.","Se tiver dúvida, escolha 'Outros' e descreva com suas palavras.","Não se preocupe em acertar perfeitamente, nossa equipe vai analisar."]}),e.jsx(C,{className:E("p-4 border-2 transition-colors",d?"border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800":"border-blue-200 bg-blue-50 dark:bg-blue-950/30 dark:border-blue-800"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:E("p-2 rounded-lg",d?"bg-amber-100 dark:bg-amber-900/50":"bg-blue-100 dark:bg-blue-900/50"),children:d?e.jsx(De,{className:"h-4 w-4 text-amber-600 dark:text-amber-400"}):e.jsx(H,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsx("div",{className:"flex-1",children:d?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm font-medium text-amber-800 dark:text-amber-300",children:['Dicas para "',d.name,'"']}),d.tips.length>0&&e.jsx("ul",{className:"mt-2 space-y-1",children:d.tips.map((x,v)=>e.jsxs("li",{className:"text-sm text-amber-700 dark:text-amber-400 flex gap-2",children:[e.jsx("span",{className:"shrink-0",children:"•"}),e.jsx("span",{children:x})]},v))})]}):e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("span",{className:"font-medium",children:"Toque em uma categoria"})," para selecioná-la. Depois você pode detalhar melhor o problema."]})})]})}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:y.map((x,v)=>{const w=a.categoryId===x.id;return e.jsxs(p.button,{type:"button",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:v*.03},whileTap:{scale:.95},onClick:()=>i(x),className:E("relative flex flex-col items-center gap-2 rounded-2xl border-2 p-3 text-center transition-all",w?"border-primary bg-primary/10 shadow-lg":"border-border bg-card hover:bg-muted/50 hover:border-muted-foreground/30"),style:{borderColor:w?x.color:void 0,backgroundColor:w?`${x.color}10`:void 0},children:[e.jsx(ye,{icon:x.icon,color:x.color,size:"lg",withBackground:!0}),e.jsx("span",{className:E("text-[11px] leading-tight font-semibold line-clamp-2",w?"text-primary":"text-slate-700 dark:text-slate-300"),style:{color:w?x.color:void 0},children:x.name}),w&&e.jsx(p.div,{initial:{scale:0},animate:{scale:1},className:"absolute -top-1 -right-1 h-5 w-5 rounded-full flex items-center justify-center",style:{backgroundColor:x.color},children:e.jsx(le,{className:"h-3 w-3 text-white"})})]},x.id)})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx(f,{size:"lg",className:E("w-full h-9 text-base font-semibold rounded-xl transition-all",!N&&"opacity-50"),disabled:!N,onClick:t,children:N?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(le,{className:"h-5 w-5 ml-2"})]}):"Selecione uma categoria"})})})]})}function ta({draft:a,onUpdate:n,onNext:t,onBack:y}){const[r,h]=s.useState({status:"idle"}),[u,d]=s.useState(!1),[i,N]=s.useState(""),[x,v]=s.useState([]),[w,R]=s.useState(!1),[M,m]=s.useState(!1),[g,j]=s.useState(!1),D=s.useCallback(async(c,b)=>{try{m(!0);const k=await ue.geocodeReverse(c,b),T=k?.address||k?.displayName;return j(!T),T||void 0}catch(k){console.warn("[StepLocation] Reverse geocode failed:",k),j(!0);return}finally{m(!1)}},[]),z=s.useCallback(async()=>{if(!navigator.geolocation){h({status:"error",errorMessage:"Seu navegador não suporta geolocalização. Tente usar Chrome, Safari ou Firefox."});return}h({status:"requesting"}),navigator.geolocation.getCurrentPosition(async c=>{const b=c.coords.latitude,k=c.coords.longitude,T=await D(b,k);j(!T);const A={latitude:b,longitude:k,accuracy:c.coords.accuracy,address:T||"Tijucas, SC",source:"gps",quality:c.coords.accuracy<=50?"precisa":"aproximada"};n({location:A}),h({status:"success"}),X("success")},c=>{let b="Não conseguimos acessar sua localização.";c.code===c.PERMISSION_DENIED?(b="Você não permitiu o acesso à sua localização.",h({status:"denied",errorMessage:b})):c.code===c.POSITION_UNAVAILABLE?(b="Não foi possível determinar sua localização. Verifique se o GPS está ativado.",h({status:"error",errorMessage:b})):c.code===c.TIMEOUT&&(b="Demorou muito para obter sua localização. Verifique sua conexão e tente novamente.",h({status:"error",errorMessage:b})),X("warning")},{enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4})},[n,D]),q=s.useRef(null),B=s.useCallback(async c=>{if(c.length<3){v([]);return}q.current&&q.current.abort(),q.current=new AbortController,R(!0);try{const b=a.location?.latitude,k=a.location?.longitude,T=await ue.geocodeAutocomplete(c,b,k);v(T)}catch(b){b.name!=="AbortError"&&console.warn("[StepLocation] Search failed:",b),v([])}finally{R(!1)}},[a.location?.latitude,a.location?.longitude]);s.useEffect(()=>{const c=setTimeout(()=>{i&&B(i)},300);return()=>{clearTimeout(c),q.current&&q.current.abort()}},[i,B]);const S=c=>{const b={latitude:c.latitude,longitude:c.longitude,accuracy:100,address:c.address||c.displayName,source:"manual",quality:"manual"};n({location:b}),h({status:"success"}),j(!1),N(""),v([]),d(!1),X("selection")};s.useEffect(()=>{!a.location&&r.status==="idle"&&z()},[a.location,r.status,z]);const l=s.useCallback(()=>{a.location&&(X("success"),t())},[a.location,t]),o=!!a.location,I=({quality:c})=>{const b={precisa:{color:"text-green-600 bg-green-100",icon:ze,label:"Precisa"},aproximada:{color:"text-amber-600 bg-amber-100",icon:$,label:"Aproximada"},manual:{color:"text-blue-600 bg-blue-100",icon:Z,label:"Informada"}}[c]||{color:"text-gray-600 bg-gray-100",icon:$,label:"Desconhecida"},k=b.icon;return e.jsxs("span",{className:E("inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",b.color),children:[e.jsx(k,{className:"h-3 w-3"}),b.label]})};return e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(Y,{title:"Onde foi?",subtitle:"Precisamos saber o local do problema",helpTitle:"Por que precisamos da localização?",helpContent:["A localização ajuda nossa equipe a encontrar o problema rapidamente.","Usamos o GPS do seu celular para maior precisão.","Sua localização não é compartilhada publicamente, apenas com a equipe responsável."]}),e.jsx(C,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(H,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"Como funciona:"}),e.jsx("p",{children:"Usamos o GPS para marcar o local, ou você pode buscar o endereço manualmente."})]})]})}),e.jsxs("div",{className:"space-y-4",children:[r.status==="requesting"&&e.jsxs(p.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(O,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:M?"Buscando endereço...":"Buscando sua localização..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),r.status==="denied"&&e.jsx(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx($,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Localização bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:r.errorMessage}),e.jsxs(C,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700 text-left",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Localização" para "Permitir"'})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4 w-full",children:[e.jsxs(f,{variant:"outline",className:"flex-1",onClick:z,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(f,{variant:"secondary",className:"flex-1",onClick:()=>d(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),r.status==="error"&&e.jsx(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(W,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Erro ao obter localização"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:r.errorMessage}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(f,{variant:"outline",className:"flex-1",onClick:z,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(f,{variant:"secondary",className:"flex-1",onClick:()=>d(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),a.location&&e.jsxs(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-4",children:[e.jsx(C,{className:"p-4 bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100 dark:bg-green-900/50",children:e.jsx(F,{className:"h-5 w-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-green-800 dark:text-green-300",children:"Localização capturada!"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(I,{quality:a.location.quality}),a.location.accuracy&&a.location.source==="gps"&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["±",Math.round(a.location.accuracy),"m"]})]})]})]})}),e.jsx(We,{latitude:a.location.latitude,longitude:a.location.longitude,hasGPS:a.location.source==="gps",onLocationChange:async(c,b)=>{const k=await D(c,b);n({location:{...a.location,latitude:c,longitude:b,address:k||a.location.address,source:"mapa",quality:"precisa"}})},onCenterGPS:a.location.source==="gps"?z:void 0,onConfirmLocation:l}),e.jsx(C,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[M?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4 animate-spin text-primary"}),e.jsx("span",{className:"text-muted-foreground",children:"Buscando endereço..."})]}):e.jsx("p",{className:"font-medium",children:a.location.address||"Localização capturada"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Coordenadas: ",a.location.latitude.toFixed(4),", ",a.location.longitude.toFixed(4)]})]}),e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>d(!0),children:[e.jsx(Z,{className:"h-3.5 w-3.5 mr-1"}),"Buscar"]})]})}),g&&e.jsx(C,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800 dark:text-amber-300",children:"Endereco indisponivel no momento"}),e.jsx("p",{className:"text-xs text-amber-700 dark:text-amber-400 mt-1",children:"Nao conseguimos converter as coordenadas em endereco. Voce pode seguir com o ponto no mapa."})]}),e.jsx(f,{size:"sm",variant:"secondary",onClick:l,className:"shrink-0",children:"Enviar mesmo assim"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4 text-muted-foreground"}),"Ponto de referência (opcional)"]}),e.jsx(ne,{placeholder:"Ex: Próximo ao Supermercado X",value:a.locationNote||"",onChange:c=>n({locationNote:c.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ajude a localizar o problema com uma referência"})]})]}),r.status==="idle"&&!a.location&&e.jsxs(p.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center py-8 gap-4",children:[e.jsxs(f,{size:"lg",onClick:z,className:"h-12 px-8 rounded-xl",children:[e.jsx(me,{className:"h-5 w-5 mr-2"}),"Usar minha localização"]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"ou"}),e.jsxs(f,{variant:"outline",onClick:()=>d(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço manualmente"]})]})]}),e.jsx(J,{children:u&&e.jsxs(e.Fragment,{children:[e.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>d(!1)}),e.jsxs(p.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 pb-8 max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsx("h3",{className:"font-semibold text-lg mt-4",children:"Buscar endereço"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Digite o nome da rua ou local"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ne,{placeholder:"Ex: Rua Principal, Centro, Tijucas",value:i,onChange:c=>N(c.target.value),className:"pl-10 h-12 rounded-xl",autoFocus:!0}),w&&e.jsx(O,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground"})]}),x.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:x.map((c,b)=>e.jsx(p.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:b*.05},onClick:()=>S(c),className:"w-full text-left p-3 rounded-xl border hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx($,{className:"h-5 w-5 text-primary shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:c.address}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:c.displayName})]})]})},c.placeId||b))}),i.length>=3&&x.length===0&&!w&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Nenhum resultado encontrado. Tente outro endereço."}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(f,{variant:"outline",className:"flex-1",onClick:()=>d(!1),children:"Cancelar"}),e.jsxs(f,{className:"flex-1",onClick:z,children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Usar GPS"]})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(f,{variant:"outline",size:"lg",className:"h-9 rounded-xl flex-1 text-base",onClick:y,children:"Voltar"}),e.jsx(f,{size:"lg",className:E("h-9 rounded-xl flex-[2] text-base font-semibold",!o&&"opacity-50"),disabled:!o,onClick:l,children:o?e.jsxs(e.Fragment,{children:[g?"Enviar mesmo assim":"Continuar",e.jsx(le,{className:"h-5 w-5 ml-2"})]}):"Aguardando localização..."})]})})]})}const L=3;function ra({draft:a,onUpdate:n,onNext:t,onBack:y}){const r=s.useRef(null),h=s.useRef(null),u=s.useRef(null),d=s.useRef(null),[i,N]=s.useState({status:"idle",facingMode:"environment",stream:null}),[x,v]=s.useState(!1),[w,R]=s.useState(null),M=typeof window<"u"&&window.isSecureContext,m=s.useCallback(async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){N(l=>({...l,status:"error",errorMessage:"Seu navegador não suporta acesso à câmera. Tente usar Chrome, Safari ou Firefox."}));return}N(l=>({...l,status:"requesting"}));try{const l=await navigator.mediaDevices.getUserMedia({video:{facingMode:i.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:!1});r.current&&(r.current.srcObject=l,await r.current.play()),N(o=>({...o,status:"active",stream:l,errorMessage:void 0}))}catch(l){if(console.error("Camera error:",l),l instanceof DOMException)if(l.name==="NotAllowedError")N(o=>({...o,status:"denied",errorMessage:"Você não permitiu o acesso à câmera."}));else if(l.name==="NotFoundError")N(o=>({...o,status:"error",errorMessage:"Nenhuma câmera foi encontrada no seu dispositivo."}));else if(l.name==="NotReadableError")N(o=>({...o,status:"error",errorMessage:"A câmera está sendo usada por outro aplicativo. Feche outros apps e tente novamente."}));else if(l.name==="OverconstrainedError"){N(o=>({...o,status:"error",errorMessage:"Sua câmera não atende aos requisitos. Tentando configuração alternativa..."}));try{const o=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});r.current&&(r.current.srcObject=o,await r.current.play()),N(I=>({...I,status:"active",stream:o,errorMessage:void 0}))}catch{N(o=>({...o,status:"error",errorMessage:"Não foi possível acessar sua câmera."}))}}else N(o=>({...o,status:"error",errorMessage:"Ocorreu um erro ao acessar a câmera. Tente novamente."}));else N(o=>({...o,status:"error",errorMessage:"Erro desconhecido ao acessar a câmera."}))}},[i.facingMode]),g=s.useCallback(()=>{i.stream&&i.stream.getTracks().forEach(l=>l.stop()),r.current&&(r.current.srcObject=null),N(l=>({...l,status:"idle",stream:null}))},[i.stream]);s.useEffect(()=>((async()=>{if(!navigator.mediaDevices?.enumerateDevices){R(!1);return}try{const I=(await navigator.mediaDevices.enumerateDevices()).some(c=>c.kind==="videoinput");R(I)}catch{R(!1)}})(),()=>{i.stream&&i.stream.getTracks().forEach(o=>o.stop())}),[]);const j=s.useCallback(async()=>{g(),N(l=>({...l,facingMode:l.facingMode==="environment"?"user":"environment"})),setTimeout(()=>m(),100)},[m,g]),D=s.useCallback(async()=>{if(!(!r.current||!h.current||a.images.length>=L)){v(!0);try{const l=r.current,o=h.current,I=o.getContext("2d");if(!I)throw new Error("Canvas context not available");o.width=l.videoWidth,o.height=l.videoHeight,I.drawImage(l,0,0);const c=await new Promise((A,P)=>{o.toBlob(de=>de?A(de):P(new Error("Failed to capture image from camera")),"image/jpeg",.92)}),b=new File([c],`photo_${Date.now()}.jpg`,{type:"image/jpeg",lastModified:Date.now()}),k=await xe(b),T={id:te(),file:k,previewUrl:URL.createObjectURL(k),capturedAt:new Date};n({images:[...a.images,T]}),a.images.length+1>=L&&g()}catch(l){console.error("Failed to capture image:",l),V.error("Nao foi possivel processar a foto. Tente novamente.")}finally{v(!1)}}},[a.images,n,g]),z=s.useCallback(l=>{const o=a.images.find(I=>I.id===l);o&&URL.revokeObjectURL(o.previewUrl),n({images:a.images.filter(I=>I.id!==l)}),i.status==="idle"&&a.images.length<=L&&m()},[a.images,i.status,n,m]),q=s.useCallback(l=>{z(l),i.status!=="active"&&m()},[z,i.status,m]),B=s.useCallback(async l=>{const o=l.target.files;if(!o||o.length===0)return;const I=L-a.images.length,c=Array.from(o).slice(0,I),b=[];let k=0,T=0;for(const A of c)if(A.type.startsWith("image/")){k+=A.size;try{const P=await xe(A);T+=P.size,b.push({id:te(),file:P,previewUrl:URL.createObjectURL(P),capturedAt:new Date})}catch(P){console.error("Failed to compress image:",P),T+=A.size,b.push({id:te(),file:A,previewUrl:URL.createObjectURL(A),capturedAt:new Date})}}if(b.length>0&&n({images:[...a.images,...b]}),k>0&&T<k){const A=k-T,P=Math.round(A/k*100);V.success(`Imagem otimizada: ${pe(k)} -> ${pe(T)} (-${P}%)`)}u.current&&(u.current.value="")},[a.images,n]),S=s.useCallback(()=>{u.current?.click()},[]);return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(Y,{title:"Adicione até 3 fotos",subtitle:"Tire fotos agora ou escolha da galeria",helpTitle:"Dicas para boas fotos",helpContent:["Fotografe de perto para mostrar detalhes do problema.","Inclua uma foto do contexto (rua, número, ponto de referência).","Evite fotos muito escuras ou desfocadas."]}),e.jsx("input",{ref:u,type:"file",accept:"image/*",multiple:!0,onChange:B,className:"hidden"}),e.jsx("input",{ref:d,type:"file",accept:"image/*",capture:"environment",onChange:B,className:"hidden"}),e.jsx(C,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(H,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-2 text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium",children:"Dicas para boas fotos:"}),e.jsxs("ul",{className:"space-y-1 text-blue-600 dark:text-blue-400",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto de perto do problema"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto mostrando o contexto da rua"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Evite se colocar em risco"})]})]})]})]})}),e.jsxs("div",{className:"relative",children:[i.status==="idle"&&a.images.length<L&&e.jsx(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10",children:e.jsx(U,{className:"h-10 w-10 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Adicione fotos do problema"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Fotos ajudam a identificar e resolver o problema mais rápido"})]}),!M&&e.jsx("div",{className:"w-full p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-400",children:[e.jsx(ee,{className:"h-4 w-4 shrink-0"}),e.jsx("p",{className:"text-xs text-left",children:"Câmera exige HTTPS. Use a galeria para adicionar fotos."})]})}),e.jsxs("div",{className:"w-full space-y-2",children:[M&&w!==!1&&e.jsxs(f,{onClick:()=>d.current?.click(),className:"w-full",size:"lg",disabled:w===null,children:[w===null?e.jsx(O,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(U,{className:"h-4 w-4 mr-2"}),"Tirar Foto"]}),e.jsxs(f,{variant:M&&w!==!1?"outline":"default",onClick:S,className:"w-full",size:"lg",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Escolher da Galeria"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Você pode pular e continuar sem fotos"})]})})}),i.status==="active"&&a.images.length<L&&e.jsxs(p.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative rounded-2xl overflow-hidden bg-muted aspect-[4/3]",children:[e.jsx("video",{ref:r,autoPlay:!0,playsInline:!0,muted:!0,"webkit-playsinline":"true","x-webkit-airplay":"allow",style:{backgroundColor:"transparent"},className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-4 left-0 right-0 flex items-center justify-center gap-4",children:[e.jsx(p.button,{whileTap:{scale:.9},onClick:j,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Trocar câmera",children:e.jsx(Te,{className:"h-5 w-5"})}),e.jsx(p.button,{whileTap:{scale:.9},onClick:D,disabled:x,className:E("p-1 rounded-full bg-white",x&&"opacity-50"),"aria-label":"Capturar foto",children:e.jsx("div",{className:"h-16 w-16 rounded-full border-4 border-primary flex items-center justify-center",children:x?e.jsx(O,{className:"h-6 w-6 text-primary animate-spin"}):e.jsx(U,{className:"h-6 w-6 text-primary"})})}),e.jsx(p.button,{whileTap:{scale:.9},onClick:S,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Escolher da galeria",children:e.jsx(ae,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"absolute top-4 right-4 px-3 py-1.5 rounded-full bg-black/50 text-white text-sm backdrop-blur-sm flex items-center gap-1",children:[e.jsx(U,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[a.images.length,"/",L]})]})]}),i.status==="requesting"&&e.jsxs(p.div,{initial:{opacity:0},animate:{opacity:1},className:"rounded-2xl bg-muted aspect-[4/3] flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(O,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:"Iniciando câmera..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),i.status==="denied"&&e.jsx(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(ee,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Câmera bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:i.errorMessage}),e.jsxs(C,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado ou câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Câmera" para "Permitir"'})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"4."}),e.jsx("span",{children:"Recarregue a página ou toque no botão abaixo"})]})]})]}),e.jsxs(f,{variant:"outline",className:"mt-4 w-full",onClick:m,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),i.status==="error"&&e.jsx(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(W,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Problema com a câmera"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:i.errorMessage}),e.jsxs(C,{className:"w-full p-4 bg-white dark:bg-background border-red-200 dark:border-red-700",children:[e.jsx("p",{className:"font-medium text-sm mb-3",children:"O que você pode fazer:"}),e.jsxs("ul",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(F,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Verifique se seu dispositivo tem câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(F,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Feche outros aplicativos que usam a câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(F,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Tente acessar pelo celular em vez do computador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(F,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Você pode continuar sem foto (opcional)"})]})]})]}),e.jsxs(f,{variant:"outline",className:"mt-4 w-full",onClick:m,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),e.jsx("canvas",{ref:h,className:"hidden"})]}),a.images.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4 text-green-500"}),"Fotos capturadas (",a.images.length,"/",L,")"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(J,{mode:"popLayout",children:a.images.map((l,o)=>e.jsxs(p.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},layout:!0,className:"relative aspect-square",children:[e.jsx("img",{src:l.previewUrl,alt:`Foto ${o+1}`,className:"w-full h-full object-cover rounded-xl"}),e.jsx("div",{className:"absolute top-2 left-2 h-6 w-6 rounded-full bg-primary text-primary-foreground text-xs font-bold flex items-center justify-center",children:o+1}),e.jsx("button",{type:"button",onClick:()=>z(l.id),className:"absolute -top-2 -right-2 h-7 w-7 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg hover:bg-red-600 transition-colors z-10","aria-label":"Remover foto",children:e.jsx(ce,{className:"h-4 w-4"})}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/70 to-transparent rounded-b-xl",children:e.jsxs("button",{type:"button",onClick:()=>q(l.id),className:"w-full px-2 py-1 text-xs bg-white/20 text-white rounded-md backdrop-blur-sm flex items-center justify-center gap-1",children:[e.jsx(_,{className:"h-3 w-3"}),"Refazer"]})})]},l.id))}),Array.from({length:L-a.images.length}).map((l,o)=>e.jsxs("button",{type:"button",onClick:()=>d.current?.click(),className:"aspect-square rounded-xl border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-1 hover:border-primary/50 hover:bg-primary/5 transition-colors cursor-pointer",children:[e.jsx(ae,{className:"h-5 w-5 text-muted-foreground/50"}),e.jsx("span",{className:"text-xs text-muted-foreground/50",children:"Adicionar"})]},`empty-${o}`))]})]}),a.images.length>=L&&e.jsx(C,{className:"p-4 text-center bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(F,{className:"h-5 w-5"}),e.jsxs("span",{className:"font-medium",children:["Você tirou ",L," fotos. Pronto para continuar!"]})]})}),a.images.length===0&&(i.status==="error"||i.status==="denied")&&e.jsx(C,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-amber-600 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800 dark:text-amber-300",children:"Continuar sem foto?"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-1",children:"Fotos ajudam muito a identificar o problema, mas você pode continuar sem elas."})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(f,{variant:"outline",size:"lg",className:"h-9 rounded-xl flex-1 text-base",onClick:()=>{g(),y()},children:"Voltar"}),e.jsxs(f,{size:"lg",className:"h-9 rounded-xl flex-[2] text-base font-semibold",onClick:()=>{g(),t()},children:["Continuar",a.images.length===0&&e.jsx("span",{className:"text-xs ml-2 opacity-70",children:"(sem foto)"})]})]})})]})}function ia({draft:a,onUpdate:n,onBack:t,onGoToStep:y,onSubmit:r}){const[h,u]=s.useState(!1),{categories:d}=we(),i=d.find(v=>v.id===a.categoryId),N=!!a.categoryId&&!!a.location&&a.confirmed&&!!a.title?.trim(),x=async()=>{if(N){u(!0);try{await r()}catch(v){console.error("Submit error:",v)}finally{u(!1)}}};return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(Y,{title:"Revisar e enviar",subtitle:"Adicione um título e confira as informações",helpTitle:"Última etapa!",helpContent:["Adicione um título curto que descreva o problema.","Revise todas as informações antes de enviar.","Após enviar, você receberá um número de protocolo."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(je,{className:"h-4 w-4 text-muted-foreground"}),"Título da denúncia *"]}),e.jsx(ne,{placeholder:"Ex: Buraco grande na Rua Principal",value:a.title||"",onChange:v=>n({title:v.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Descreva o problema em poucas palavras (obrigatório)"})]}),e.jsx(C,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[i?e.jsx(ye,{icon:i.icon,color:i.color,size:"lg",withBackground:!0}):e.jsx("div",{className:"p-3 rounded-xl bg-muted",children:"❓"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Categoria"}),e.jsx("p",{className:"font-semibold",children:i?.name||"Não selecionada"})]})]}),e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>y(1),className:"text-primary",children:[e.jsx(se,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsx(C,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx($,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-semibold",children:a.location?.address||"Localização capturada"}),a.location?.quality&&e.jsx(Qe,{variant:"secondary",className:"mt-1 text-xs capitalize",children:a.location.quality})]})]}),e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>y(2),className:"text-primary",children:[e.jsx(se,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsxs(C,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(U,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Fotos"}),e.jsxs("p",{className:"font-semibold",children:[a.images.length," ",a.images.length===1?"foto anexada":"fotos anexadas"]})]})]}),e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>y(3),className:"text-primary",children:[e.jsx(se,{className:"h-4 w-4 mr-1"}),"Editar"]})]}),a.images.length>0?e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:a.images.map((v,w)=>e.jsx("img",{src:v.previewUrl,alt:`Foto ${w+1}`,className:"h-20 w-20 rounded-lg object-cover shrink-0"},v.id))}):e.jsxs("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("p",{className:"text-sm",children:"Nenhuma foto anexada (opcional)"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"}),"Descrição adicional (opcional)"]}),e.jsx(Je,{placeholder:"Algum detalhe importante? (máx. 500 caracteres)",maxLength:500,value:a.description,onChange:v=>n({description:v.target.value}),className:"min-h-[100px] rounded-xl resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[a.description.length,"/500"]})]}),e.jsx(C,{className:E("p-4 transition-all border-2",a.confirmed?"border-green-400 bg-green-50 dark:bg-green-950/20 dark:border-green-700":"border-amber-400 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-700"),children:e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[e.jsx(Xe,{checked:a.confirmed,onCheckedChange:v=>n({confirmed:!!v}),className:"mt-0.5 h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:E("font-medium",a.confirmed?"text-green-700 dark:text-green-300":"text-amber-700 dark:text-amber-300"),children:a.confirmed?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),"Confirmado!"]}):"Confirmo que as informações são verdadeiras"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:a.confirmed?"Você confirmou que as informações são verdadeiras":"Marque para poder enviar a denúncia"})]})]})}),!N&&e.jsx(C,{className:"p-4 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-red-600 dark:text-red-400 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 dark:text-red-300",children:"Não é possível enviar ainda"}),e.jsxs("ul",{className:"text-sm text-red-700 dark:text-red-400 mt-1 space-y-1",children:[!a.title?.trim()&&e.jsx("li",{children:"• Adicione um título"}),!a.categoryId&&e.jsx("li",{children:"• Selecione uma categoria"}),!a.location&&e.jsx("li",{children:"• Capture sua localização"}),!a.confirmed&&e.jsx("li",{children:"• Confirme que as informações são verdadeiras"})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(f,{variant:"outline",size:"lg",className:"h-9 rounded-xl flex-1 text-base",onClick:t,disabled:h,children:"Voltar"}),e.jsx(f,{size:"lg",className:E("h-9 rounded-xl flex-[2] text-base font-semibold",N?"bg-green-600 hover:bg-green-700":"opacity-50"),disabled:!N||h,onClick:x,children:h?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"h-5 w-5 mr-2 animate-spin"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"h-5 w-5 mr-2"}),"Enviar denúncia"]})})]})})]})}function la({protocolNumber:a,onClose:n}){const{toast:t}=Oe(),y=ve(),r=s.useCallback(()=>{const i=Date.now()+3e3,N={startVelocity:30,spread:360,ticks:60,zIndex:100},x=(w,R)=>Math.random()*(R-w)+w,v=setInterval(()=>{const w=i-Date.now();if(w<=0)return clearInterval(v);const R=50*(w/3e3);ie({...N,particleCount:R,origin:{x:x(.1,.3),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),ie({...N,particleCount:R,origin:{x:x(.7,.9),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]})},250);return ie({particleCount:100,spread:70,origin:{y:.6},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),()=>clearInterval(v)},[]);s.useEffect(()=>r(),[r]);const h=async()=>{try{await navigator.clipboard.writeText(a),t({title:"Protocolo copiado!",description:"Cole onde quiser para guardar."})}catch{t({title:"Erro ao copiar",description:"Tente copiar manualmente.",variant:"destructive"})}},u=async()=>{if(navigator.share)try{await navigator.share({title:"Denúncia Enviada - eTijucas",text:`Minha denúncia foi registrada com sucesso! Protocolo: ${a}`})}catch{console.log("Share cancelled")}else h()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-gradient-to-b from-green-50 to-background dark:from-green-950/30 dark:to-background flex flex-col items-center justify-center p-6 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(6)].map((d,i)=>e.jsx(p.div,{initial:{opacity:0,scale:0},animate:{opacity:[0,.3,0],scale:[0,1.5,2],x:Math.random()*100-50,y:Math.random()*100-50},transition:{duration:3,delay:i*.3,repeat:1/0,repeatDelay:2},className:"absolute rounded-full bg-green-400/20",style:{width:100+i*30,height:100+i*30,left:`${20+i*10}%`,top:`${15+i*12}%`}},i))}),e.jsxs(p.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},transition:{duration:.5},className:"relative z-10 w-full max-w-sm flex flex-col items-center text-center",children:[e.jsxs(p.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},className:"relative mb-6",children:[e.jsx("div",{className:"p-6 rounded-full bg-green-100 dark:bg-green-900/50 shadow-lg shadow-green-500/20",children:e.jsx(F,{className:"h-20 w-20 text-green-600 dark:text-green-400"})}),e.jsx(p.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(Ie,{className:"h-8 w-8 text-yellow-500"})}),e.jsx(p.div,{animate:{rotate:-360},transition:{duration:4,repeat:1/0,ease:"linear"},className:"absolute -bottom-1 -left-3",children:e.jsx(Ae,{className:"h-7 w-7 text-pink-500"})})]}),e.jsx(p.h1,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-3xl font-bold text-green-700 dark:text-green-400 mb-2",children:"Denúncia Enviada!"}),e.jsx(p.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"text-muted-foreground mb-6",children:"Obrigado por ajudar a melhorar nossa cidade!"}),e.jsx(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"w-full",children:e.jsxs(C,{className:"p-6 bg-white dark:bg-card border-green-200 dark:border-green-800 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-3",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground font-medium",children:"Número do Protocolo"})]}),e.jsx(p.p,{className:"text-2xl font-bold font-mono text-primary mb-4",animate:{scale:[1,1.02,1]},transition:{duration:2,repeat:1/0},children:a}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(f,{variant:"outline",size:"sm",className:"flex-1",onClick:h,children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Copiar"]}),e.jsxs(f,{variant:"outline",size:"sm",className:"flex-1",onClick:u,children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Compartilhar"]})]})]})}),e.jsx(p.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.7},className:"text-xs text-muted-foreground mt-4 max-w-xs",children:"Guarde este número para acompanhar o andamento da sua denúncia. Nossa equipe irá analisar e tomar as providências necessárias."}),e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.8},className:"w-full mt-8 space-y-3",children:[e.jsxs(f,{size:"lg",className:"w-full h-14 rounded-2xl text-base font-semibold bg-green-600 hover:bg-green-700",onClick:n,children:[e.jsx(qe,{className:"h-5 w-5 mr-2"}),"Início do App"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(f,{variant:"outline",size:"lg",className:"h-12 rounded-2xl text-sm",onClick:()=>y("/minhas-denuncias"),children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Minhas Denúncias"]}),e.jsxs(f,{variant:"outline",size:"lg",className:"h-12 rounded-2xl text-sm",onClick:()=>y("/denuncias/mapa"),children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Mapa"]})]}),e.jsxs(f,{variant:"ghost",size:"lg",className:"w-full h-12 rounded-2xl text-base",onClick:()=>y("/denuncias"),children:[e.jsx(je,{className:"h-5 w-5 mr-2"}),"Todas as Denúncias"]})]})]})]})}function ge(a){return a&&Ve(a)?a:oe()}function oa(){const[a,n]=s.useState(()=>({...re,idempotencyKey:oe()})),[t,y]=s.useState(!0),r=s.useRef(null),h=s.useRef(!0);s.useEffect(()=>{h.current=!0;async function m(){try{await Ue();const g=await K.getDraft(G);if(g&&h.current){const j={...g,idempotencyKey:ge(g.idempotencyKey)};n(j),j.idempotencyKey!==g.idempotencyKey&&await K.saveDraft(j,"draft",G)}}catch(g){console.error("[useReportDraft] Error loading draft:",g);try{const j=localStorage.getItem(he);if(j){const D=JSON.parse(j);h.current&&n({...re,...D,createdAt:new Date(D.createdAt||Date.now()),updatedAt:new Date(D.updatedAt||Date.now()),images:[],idempotencyKey:ge(D.idempotencyKey)})}}catch(j){console.error("[useReportDraft] localStorage fallback failed:",j)}}finally{h.current&&y(!1)}}return m(),()=>{h.current=!1,r.current&&clearTimeout(r.current)}},[]);const u=s.useCallback(async m=>{r.current&&clearTimeout(r.current),r.current=setTimeout(async()=>{try{await K.saveDraft(m,"draft",G)}catch(g){console.error("[useReportDraft] Error saving draft:",g)}},500)},[]),d=s.useCallback(m=>{n(g=>{const j={...g,...m,updatedAt:new Date};return u(j),j})},[u]),i=s.useCallback(m=>{n(g=>{if(g.images.length>=3)return g;const j={...g,images:[...g.images,m],updatedAt:new Date};return u(j),j})},[u]),N=s.useCallback(m=>{n(g=>{const j=g.images.find(z=>z.id===m);j&&URL.revokeObjectURL(j.previewUrl);const D={...g,images:g.images.filter(z=>z.id!==m),updatedAt:new Date};return u(D),D})},[u]),x=s.useCallback(m=>{d({currentStep:m})},[d]),v=s.useCallback(()=>{n(m=>{if(m.currentStep<4){const g=m.currentStep+1,j={...m,currentStep:g,updatedAt:new Date};return u(j),j}return m})},[u]),w=s.useCallback(()=>{n(m=>{if(m.currentStep>1){const g=m.currentStep-1,j={...m,currentStep:g,updatedAt:new Date};return u(j),j}return m})},[u]),R=s.useCallback(async()=>{Be(a.images);try{await K.deleteDraft(G)}catch(m){console.error("[useReportDraft] Error deleting draft:",m)}localStorage.removeItem(he),n({...re,idempotencyKey:oe()})},[a.images]),M=s.useCallback(async()=>{r.current&&clearTimeout(r.current);try{await K.saveDraft(a,"draft",G)}catch(m){console.error("[useReportDraft] Error saving draft:",m)}},[a]);return{draft:a,isLoading:t,updateDraft:d,addImage:i,removeImage:N,goToStep:x,nextStep:v,prevStep:w,clearDraft:R,saveDraft:M}}const na=["Tipo","Local","Fotos","Resumo"],ca={enter:a=>({x:a>0?"100%":"-100%",opacity:0}),center:{x:0,opacity:1},exit:a=>({x:a<0?"100%":"-100%",opacity:0})};function za(){const a=ve(),{isAuthenticated:n}=Ge(),{draft:t,isLoading:y,updateDraft:r,nextStep:h,prevStep:u,clearDraft:d,saveDraft:i}=oa(),[N,x]=s.useState(0),[v,w]=s.useState(!1),[R,M]=s.useState(null),{createReport:m}=_e(),g=s.useCallback(S=>{x(S>t.currentStep?1:-1),r({currentStep:S})},[t.currentStep,r]),j=s.useCallback(()=>{x(1),h()},[h]),D=s.useCallback(()=>{x(-1),u()},[u]),z=s.useCallback(async()=>{if(!t.categoryId){V.error("Escolha um tipo de observação");return}if(!t.title||t.title.trim().length<5){V.error("Dê um título curto (mín. 5 caracteres)");return}try{const S={categoryId:t.categoryId,title:t.title.trim(),description:t.description.trim(),images:t.images.map(o=>o.file)};t.location&&(S.addressText=t.location.address,S.addressSource=t.location.source,S.locationQuality=t.location.quality,S.latitude=t.location.latitude,S.longitude=t.location.longitude,S.locationAccuracyM=t.location.accuracy?Math.min(Math.round(t.location.accuracy),1e4):void 0);const l=await m({payload:S,idempotencyKey:t.idempotencyKey});M(l.protocol),w(!0),d(),V.success("Observação publicada!")}catch(S){if(console.error("Error submitting report:",S),$e(S))try{await i(),await Ke(G),V.info("Observação salva no rascunho. Enviamos quando a conexão voltar."),a("/minhas-denuncias");return}catch(l){console.error("Error queueing report draft for sync:",l)}V.error("Não foi possível publicar agora. Tente novamente.")}},[t,m,d,i,a]),q=()=>{t.categoryId||t.location||t.images.length>0?window.confirm("Tem certeza que deseja sair? Seu rascunho será salvo.")&&a(-1):a(-1)},B=()=>{a("/")};return n?y?e.jsx("div",{className:"fixed inset-0 z-50 bg-background flex items-center justify-center",children:e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"})}):v&&R?e.jsx(la,{protocolNumber:R,onClose:B}):e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"shrink-0 bg-background/95 backdrop-blur-lg safe-top",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:q,className:"rounded-full",children:e.jsx(Fe,{className:"h-5 w-5"})}),e.jsx("h1",{className:"font-semibold text-lg",children:"Nova observação"}),e.jsx(f,{variant:"ghost",size:"icon",onClick:q,className:"rounded-full",children:e.jsx(ce,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"px-4 pb-2",children:e.jsx(ea,{currentStep:t.currentStep,totalSteps:4,labels:na})})]}),e.jsx("main",{className:"flex-1 overflow-hidden",children:e.jsx(J,{mode:"wait",custom:N,children:e.jsxs(p.div,{custom:N,variants:ca,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},className:"h-full overflow-y-auto px-4 pt-4 pb-32",children:[t.currentStep===1&&e.jsx(sa,{draft:t,onUpdate:r,onNext:j}),t.currentStep===2&&e.jsx(ta,{draft:t,onUpdate:r,onNext:j,onBack:D}),t.currentStep===3&&e.jsx(ra,{draft:t,onUpdate:r,onNext:j,onBack:D}),t.currentStep===4&&e.jsx(ia,{draft:t,onUpdate:r,onBack:D,onGoToStep:g,onSubmit:z})]},t.currentStep)})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[60]",children:e.jsx(Ye,{activeTab:"reportar",onTabChange:S=>a(`/?tab=${S}`)})})]}):e.jsx(He,{actionLabel:"Entrar para publicar",message:"É rápido: confirme seu número de WhatsApp e participe como Observador.",returnUrl:"/denuncia/nova"})}export{za as default};
