import{r as T,aR as M}from"./vendor-app-Pv0Z4osg.js";import{_ as D,a as k}from"./index-C5loSG7w.js";import{E as l,a as d}from"./client-BdVdTjkU.js";import{c as f,t as i,s as w}from"./localDatabase-nb4m5EJD.js";function x(e,o=1,t=10){const a=(o-1)*t,n=a+t;return{data:e.slice(a,n),meta:{total:e.length,page:o,perPage:t,lastPage:Math.ceil(e.length/t),from:a+1,to:Math.min(n,e.length)}}}function B(e,o){if(!e||typeof e!="object")throw new Error(`Invalid API response: ${JSON.stringify(e)}`);const t=e;if("data"in t&&t.data)return t.data;if(o&&o in t&&t[o])return t[o];if("topic"in t&&t.topic)return t.topic;if("comment"in t&&t.comment)return t.comment;if("id"in t)return t;throw new Error(`Could not extract data from response: ${JSON.stringify(e)}`)}let $=!1;async function C(){$||($=!0,(await i.getAll()).length)}const E={async getAll(e){await C();try{const o=await d.get(l.forum.topics,e);return o.data.length>0&&await i.saveMany(o.data),o}catch{let o=await i.getAll();if(e?.bairroId&&(o=o.filter(t=>t.bairroId===e.bairroId)),e?.categoria&&(o=o.filter(t=>t.categoria===e.categoria)),e?.search){const t=e.search.toLowerCase();o=o.filter(a=>a.titulo.toLowerCase().includes(t)||a.texto.toLowerCase().includes(t))}if(e?.comFoto&&(o=o.filter(t=>t.fotoUrl)),e?.orderBy){const t=e.order==="asc"?1:-1;o.sort((a,n)=>e.orderBy==="createdAt"?t*(new Date(n.createdAt).getTime()-new Date(a.createdAt).getTime()):e.orderBy==="likesCount"?t*(n.likesCount-a.likesCount):e.orderBy==="commentsCount"?t*(n.commentsCount-a.commentsCount):0)}return x(o,e?.page,e?.perPage)}},async getById(e){await C();try{const o=await d.get(l.forum.topic(e));return await i.save(o.data),o.data}catch{return i.getById(e)}},async create(e){await C();const o=`topic-${JSON.stringify(e)}-${Date.now()}`;try{console.log("[TopicService] Creating topic:",e);const t=await d.post(l.forum.createTopic,e);console.log("[TopicService] API response:",t);const a=B(t,"topic");return console.log("[TopicService] âœ… Topic created successfully:",a.id),await i.save(a),a}catch(t){console.error("[TopicService] âŒ Failed to create topic:",t);const a={...e,id:`topic-local-${Date.now()}`,createdAt:new Date,likesCount:0,commentsCount:0,liked:!1,isSaved:!1,isAnon:e.isAnon??!1,syncStatus:"pending"};throw await i.save(a),await w.exists(o)||await w.add({type:"topic",data:{...e,localId:a.id},idempotencyKey:o}),t}},async update(e,o){const t=await d.put(l.forum.updateTopic(e),o);return await i.save(t.data),t.data},async delete(e){await d.delete(l.forum.deleteTopic(e)),await i.delete(e)},async toggleLike(e){await C();const o=`like-${e}-${Date.now()}`;try{const t=await d.post(l.forum.likeTopic(e));return await i.getById(e)&&await i.update(e,{liked:t.liked,likesCount:t.likesCount}),t}catch{const t=await i.getById(e),a=!t?.liked,n=(t?.likesCount??0)+(a?1:-1);return t&&await i.update(e,{liked:a,likesCount:Math.max(0,n)}),await w.exists(o)||await w.add({type:"like",data:{topicId:e},idempotencyKey:o}),{liked:a,likesCount:Math.max(0,n)}}},async toggleSave(e){const o=await d.post(l.forum.saveTopic(e));return await i.getById(e)&&await i.update(e,{isSaved:o.saved}),o},async getSaved(e){return d.get(l.forum.savedTopics,e)},async report(e,o){return d.post(l.forum.reportTopic(e),o)},async getComments(e,o){try{const t=await d.get(l.forum.comments(e),o);for(const a of t.data)await f.save(a);return t}catch{const t=await f.getByTopicId(e);return x(t,o?.page,o?.perPage)}},async addComment(e,o){const t=`comment-${e}-${JSON.stringify(o)}-${Date.now()}`;try{console.log("[TopicService] Adding comment to topic:",e,o);const a=await d.post(l.forum.comments(e),o);console.log("[TopicService] Comment API response:",a);const n=B(a,"comment");console.log("[TopicService] âœ… Comment added successfully:",n.id),await f.save(n);const c=await i.getById(e);return c&&await i.update(e,{commentsCount:c.commentsCount+1}),n}catch(a){console.error("[TopicService] âŒ Failed to add comment:",a);const n={id:`comment-local-${Date.now()}`,topicId:e,parentId:o.parentId,texto:o.texto,imageUrl:o.imageUrl,isAnon:o.isAnon??!1,likesCount:0,liked:!1,depth:o.parentId?1:0,createdAt:new Date,autor:{id:null,nome:o.isAnon?"AnÃ´nimo":"VocÃª",avatarUrl:null}};await f.save(n);const c=await i.getById(e);throw c&&await i.update(e,{commentsCount:c.commentsCount+1}),await w.exists(t)||await w.add({type:"comment",data:{topicId:e,...o,localId:n.id},idempotencyKey:t}),a}},async deleteComment(e,o){await d.delete(l.forum.deleteComment(e,o)),await f.delete(o);const t=await i.getById(e);t&&await i.update(e,{commentsCount:Math.max(0,t.commentsCount-1)})},async toggleCommentLike(e){return d.post(l.forum.likeComment(e))},async reportComment(e,o){return d.post(l.forum.reportComment(e),o)},async uploadImage(e){const o=new FormData;o.append("file",e);const{getAuthToken:t}=await D(async()=>{const{getAuthToken:u}=await import("./client-BdVdTjkU.js").then(g=>g.e);return{getAuthToken:u}},[]),a=t();if(!a)throw new Error("VocÃª precisa estar logado para enviar imagens");const{API_CONFIG:n}=await D(async()=>{const{API_CONFIG:u}=await import("./client-BdVdTjkU.js").then(g=>g.d);return{API_CONFIG:u}},[]),r=`${n.baseURL.endsWith("/")?n.baseURL.slice(0,-1):n.baseURL}${l.forum.upload}`;console.log("[topicService.uploadImage] Uploading to:",r),console.log("[topicService.uploadImage] Token present:",!!a);const s=await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${a}`,Accept:"application/json"},body:o});if(console.log("[topicService.uploadImage] Response status:",s.status),!s.ok){if(s.status===413)throw new Error("Imagem muito grande. MÃ¡ximo 5MB.");if(s.status===401)throw new Error("SessÃ£o expirada. FaÃ§a login novamente.");const u=await s.json().catch(()=>({}));throw new Error(u.message||"Falha no upload da imagem")}const m=await s.json();return console.log("[topicService.uploadImage] Success:",m),m},async like(e){await this.toggleLike(e)},async unlike(e){await this.toggleLike(e)}};function R(e){const o=new Date,t=new Date(e),a=o.getTime()-t.getTime(),n=Math.floor(a/1e3),c=Math.floor(n/60),r=Math.floor(c/60),s=Math.floor(r/24);if(c<1)return"agora";if(c<60)return`hÃ¡ ${c} min`;if(r<24)return`hÃ¡ ${r}h`;if(s===1)return"ontem";if(s<7)return`hÃ¡ ${s} dias`;if(s<30){const p=Math.floor(s/7);return p===1?"hÃ¡ 1 semana":`hÃ¡ ${p} semanas`}const m=["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"],u=t.getDate(),g=m[t.getMonth()];return t.getFullYear()===o.getFullYear()?`${u} ${g}`:`${u} ${g} ${t.getFullYear()}`}function O(e){return new Date(e).toLocaleDateString("pt-BR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function N(e,o,t){const a=(Date.now()-new Date(t).getTime())/36e5;return(e+o*2)/Math.pow(a+2,1.8)}function j(e={}){const{maxSizeMB:o=5}=e,[t,a]=T.useState(0),[n,c]=T.useState(!1),r=M({mutationFn:async s=>{a(0);const m=s.size/(1024*1024);if(m>o)throw new Error(`Imagem muito grande (${m.toFixed(1)}MB). MÃ¡ximo: ${o}MB`);if(!s.type.startsWith("image/"))throw new Error("Arquivo deve ser uma imagem (JPEG, PNG ou WebP)");let u=s;if(m>1){c(!0);try{u=await F(s)}finally{c(!1)}}a(30);const g=await E.uploadImage(u);return a(100),g},onSuccess:s=>{k.success("ðŸ“· Imagem enviada!"),e.onSuccess?.(s)},onError:s=>{const m=s instanceof Error?s.message:"Erro ao enviar imagem";m.includes("413")||m.includes("too large")?k.error("âŒ Imagem muito grande. MÃ¡ximo 5MB."):k.error(`âŒ ${m}`),e.onError?.(s instanceof Error?s:new Error(m))}});return{upload:r.mutate,uploadAsync:r.mutateAsync,isUploading:r.isPending,isCompressing:n,progress:t,error:r.error,reset:()=>{r.reset(),a(0)}}}async function F(e,o=2e3){return new Promise((t,a)=>{const n=new FileReader;n.onload=c=>{const r=new Image;r.onload=async()=>{const s=e.size/1048576;let m=s>3?.6:s>2?.7:.8,u=s>3?1024:1280;const g=document.createElement("canvas");let p=r.width,h=r.height;p>u&&(h=h*u/p,p=u),g.width=p,g.height=h;const I=g.getContext("2d");if(!I){t(e);return}I.drawImage(r,0,0,p,h);const S=y=>{g.toBlob(v=>{if(!v){t(e);return}if(v.size/1024>o&&y>.3){S(y-.1);return}const A=new File([v],e.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()});console.log(`[useUploadImage] Compressed: ${(e.size/1024).toFixed(0)}KB â†’ ${(A.size/1024).toFixed(0)}KB (quality: ${y.toFixed(1)})`),t(A)},"image/jpeg",y)};S(m)},r.onerror=a,r.src=c.target?.result},n.onerror=a,n.readAsDataURL(e)})}export{O as a,N as c,R as f,E as t,j as u};
