import{J as xe,r as a,j as e,m as r,M as pe,l as ue,K as F,w as T,o as he,O as V,U as fe,s as ge,Y as ye,Z as be,_ as B,$ as je,a0 as ve,a1 as Ne}from"./vendor-app-CSqspwsb.js";import{v as we,c as q,a as v}from"./auth.service-CA73SS8J.js";import{u as ke,a as Ce,c as N,B as z}from"./index-B2P9V3TS.js";import{u as Se,a as Pe}from"./useCityName-YFSRWDJG.js";import{C as Ee}from"./card-Du3XPzf3.js";import{I as Ie}from"./input-BzJrVKZ8.js";import{C as Te}from"./checkbox-Cv977JmW.js";import{P as Ae}from"./PhoneInput-ChFR9zyv.js";import"./label-B4Klhbtf.js";import"./slider-DCszy3xl.js";import{u as Le}from"./useClipboardOTP-BhKJQs-T.js";const w=[{key:"phone",label:"Telefone"},{key:"otp",label:"Código"},{key:"profile",label:"Perfil"},{key:"success",label:"Pronto"}];function Ke(){const k=ke(),[A]=xe(),{setAuth:L,updateUser:K}=Ce(),D=Se(),{name:W}=Pe(),[c,d]=a.useState("phone"),[p,X]=a.useState(""),[M,J]=a.useState(null),[Q,De]=a.useState(null),[u,h]=a.useState(""),[C,O]=a.useState(300),[m,S]=a.useState(0),[Y,R]=a.useState(!1),[g,Z]=a.useState(""),[_,G]=a.useState(!1),[f,l]=a.useState(!1),[x,n]=a.useState(null),y=a.useRef([]),{detectedCode:b,showPasteChip:H,readClipboard:ee,clearDetectedCode:te}=Le(),P=we(q(p)),U=g.trim().length>=2,E=U&&_,se=w.findIndex(t=>t.key===c),ae=Y?w:w.filter(t=>t.key!=="profile");a.useEffect(()=>{const t=A.get("token");t&&re(t)},[A]),a.useEffect(()=>{b&&c==="otp"&&(h(b),l(!0),setTimeout(()=>j(b),300))},[b]),a.useEffect(()=>{if(m<=0)return;const t=setInterval(()=>{S(s=>Math.max(0,s-1))},1e3);return()=>clearInterval(t)},[m]),a.useEffect(()=>{if(c!=="otp"||C<=0)return;const t=setInterval(()=>{O(s=>s<=1?(n("Código expirado. Solicite novo código."),0):s-1)},1e3);return()=>clearInterval(t)},[c,C]);const re=async t=>{l(!0),n(null);try{const s=await v.verifyMagicLink(t);L(s.user,s.token,s.refreshToken),"vibrate"in navigator&&navigator.vibrate([50,50,100]),s.user.profile_completed?(d("success"),setTimeout(()=>k("/",{replace:!0}),1500)):(R(!0),d("profile"))}catch(s){s.status===410||s.status===404?n("Link expirado ou inválido. Digite seu telefone para receber novo código."):n("Erro ao processar link. Tente novamente.")}finally{l(!1)}},$=async t=>{if(t?.preventDefault(),!!P){l(!0),n(null);try{const s=await v.requestOtpLogin(q(p));J(s.sid),O(s.expiresIn||300),S(s.cooldown||60),d("otp")}catch(s){s.data?.code==="RATE_LIMITED"?(n(`Aguarde ${s.data.retryAfter}s para solicitar novo código.`),S(s.data.retryAfter)):n(s.message||"Erro ao enviar código")}finally{l(!1)}}},j=async t=>{const s=t||u;if(!(s.length!==6||!M)){l(!0),n(null);try{const i=await v.verifyOtpLogin(M,s);"vibrate"in navigator&&navigator.vibrate([50,50,100]),L(i.user,i.token,i.refreshToken),te();const o=i.is_new_user||!i.user.profile_completed;R(o),o?d("profile"):(d("success"),setTimeout(()=>k("/",{replace:!0}),1500))}catch(i){const o=i.data?.code;o==="OTP_INVALID"?(n("Código incorreto. Tente novamente."),h(""),y.current[0]?.focus()):o==="OTP_EXPIRED"||o==="SID_EXPIRED"?(n("Código expirado. Solicite novo código."),d("phone")):n(i.message||"Erro ao verificar código")}finally{l(!1)}}},ie=async()=>{if(E){l(!0),n(null);try{const t=await v.completeProfile({nome:g.trim(),termsAccepted:!0});K(t.user),"vibrate"in navigator&&navigator.vibrate(50),d("success"),setTimeout(()=>k("/",{replace:!0}),1500)}catch(t){n(t.message||"Erro ao salvar perfil")}finally{l(!1)}}},ne=(t,s)=>{if(!/^\d*$/.test(s))return;const i=u.split("");i[t]=s.slice(-1);const o=i.join("").slice(0,6);h(o),s&&t<5&&y.current[t+1]?.focus(),o.length===6&&(l(!0),j(o))},oe=t=>{t.preventDefault();const s=t.clipboardData.getData("text").replace(/\D/g,"").slice(0,6);s.length===6&&(h(s),l(!0),j(s))},le=async()=>{const t=await ee();t&&(h(t),j(t))},ce=t=>{const s=Math.floor(t/60),i=t%60;return`${s}:${i.toString().padStart(2,"0")}`},I={initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20}};return e.jsxs("div",{className:"min-h-screen flex flex-col bg-gradient-to-br from-primary/5 via-background to-primary/10",children:[e.jsxs(r.div,{initial:{opacity:0,y:-30},animate:{opacity:1,y:0},transition:{duration:.6},className:"pt-12 pb-6 px-6 text-center",children:[e.jsx(r.div,{initial:{scale:.8},animate:{scale:1},transition:{type:"spring",bounce:.5,delay:.2},className:"inline-flex p-4 rounded-3xl bg-gradient-to-br from-primary to-primary/70 shadow-xl shadow-primary/30 mb-4",children:e.jsx(pe,{className:"h-10 w-10 text-white"})}),e.jsx(r.h1,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"text-2xl font-bold bg-gradient-to-r from-primary to-primary/70 bg-clip-text text-transparent",children:D}),e.jsxs(r.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.4},className:"text-muted-foreground text-sm mt-1",children:["Seu dia a dia em ",W]})]}),e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"px-6 mb-4",children:e.jsx("div",{className:"flex justify-center gap-2",children:ae.map((t,s)=>{const i=w.findIndex(me=>me.key===t.key),o=t.key===c,de=i<se;return e.jsx("div",{className:N("h-1.5 rounded-full transition-all duration-300",o?"w-8 bg-primary":de?"w-6 bg-primary/50":"w-6 bg-muted")},t.key)})})}),e.jsx(r.div,{initial:{opacity:0,y:30},animate:{opacity:1,y:0},transition:{duration:.5,delay:.3},className:"flex-1 px-6",children:e.jsx(Ee,{className:"p-6 shadow-xl border-0 bg-background/80 backdrop-blur-xl",children:e.jsxs(ue,{mode:"wait",children:[c==="phone"&&e.jsxs(r.form,{variants:I,initial:"initial",animate:"animate",exit:"exit",onSubmit:$,className:"space-y-5",children:[e.jsxs("div",{className:"text-center mb-2",children:[e.jsx("div",{className:"inline-flex p-3 rounded-2xl bg-green-500/10 mb-3",children:e.jsx(F,{className:"h-6 w-6 text-green-600"})}),e.jsx("h2",{className:"text-lg font-semibold",children:"Entre com WhatsApp"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Enviaremos um código de 6 dígitos"})]}),e.jsx(Ae,{value:p,onChange:X,error:void 0,autoFocus:!0}),x&&e.jsx(r.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 rounded-xl bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 text-center",children:x})}),e.jsx(z,{type:"submit",size:"lg",disabled:!P||f||m>0,className:N("w-full h-13 text-base font-semibold rounded-2xl","bg-gradient-to-r from-green-500 to-green-600","shadow-lg shadow-green-500/30",P&&"hover:shadow-xl hover:shadow-green-500/40"),children:f?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-5 w-5 mr-2 animate-spin"}),"Enviando..."]}):m>0?e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"h-5 w-5 mr-2"}),"Aguarde ",m,"s"]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"h-5 w-5 mr-2"}),"Receber código"]})}),e.jsxs("p",{className:"text-xs text-center text-muted-foreground",children:["Ao continuar, você concorda com nossos"," ",e.jsx(V,{to:"/termos",className:"text-primary hover:underline",children:"Termos de Uso"})]})]},"phone"),c==="otp"&&e.jsxs(r.div,{variants:I,initial:"initial",animate:"animate",exit:"exit",className:"space-y-5",children:[e.jsxs("div",{className:"text-center mb-2",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Verifique seu WhatsApp"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Código enviado para ",Q||`(${p.slice(0,2)}) •••••-${p.slice(-4)}`]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Expira em ",ce(C)]})]}),H&&e.jsxs(r.button,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},onClick:le,className:"w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-green-500/10 border border-green-500/30 text-green-600 hover:bg-green-500/20 transition-all",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Colar código"})]}),e.jsx("div",{className:"flex justify-center gap-2",onPaste:oe,children:[0,1,2,3,4,5].map(t=>e.jsx("input",{ref:s=>y.current[t]=s,type:"text",inputMode:"numeric",maxLength:1,value:u[t]||"",onChange:s=>ne(t,s.target.value),onKeyDown:s=>{s.key==="Backspace"&&!u[t]&&t>0&&y.current[t-1]?.focus()},className:N("w-11 h-13 text-center text-xl font-bold rounded-xl border-2 transition-all","focus:border-primary focus:ring-2 focus:ring-primary/20",u[t]?"border-primary bg-primary/5":"border-border bg-muted/50")},t))}),x&&e.jsx(r.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 rounded-xl bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 text-center",children:x})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>d("phone"),className:"text-sm text-muted-foreground hover:text-foreground flex items-center gap-1",children:[e.jsx(ge,{className:"h-4 w-4"}),"Trocar número"]}),e.jsx("button",{onClick:()=>$(),disabled:m>0||f,className:"text-sm text-primary hover:underline disabled:text-muted-foreground disabled:no-underline",children:m>0?`Reenviar em ${m}s`:"Reenviar código"})]})]},"otp"),c==="profile"&&e.jsxs(r.div,{variants:I,initial:"initial",animate:"animate",exit:"exit",className:"space-y-5",children:[e.jsxs("div",{className:"text-center mb-2",children:[e.jsx("div",{className:"inline-flex p-3 rounded-2xl bg-primary/10 mb-3",children:e.jsx(ye,{className:"h-6 w-6 text-primary"})}),e.jsx("h2",{className:"text-lg font-semibold",children:"Quase lá!"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Como podemos te chamar?"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Ie,{value:g,onChange:t=>Z(t.target.value),placeholder:"Seu nome",className:"h-12 text-base rounded-xl",autoFocus:!0}),g&&!U&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 ml-1",children:"Mínimo 2 caracteres"})]}),e.jsxs("label",{className:"flex items-start gap-3 p-4 rounded-xl border border-border bg-muted/30 cursor-pointer hover:bg-muted/50 transition-colors",children:[e.jsx(Te,{checked:_,onCheckedChange:t=>G(t),className:"mt-0.5"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"text-foreground",children:["Li e aceito os"," ",e.jsxs(V,{to:"/termos",target:"_blank",className:"text-primary hover:underline inline-flex items-center gap-1",children:["Termos de Uso",e.jsx(be,{className:"h-3 w-3"})]})]}),e.jsx("p",{className:"text-muted-foreground mt-0.5",children:"Inclui política de privacidade"})]})]})]}),x&&e.jsx(r.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 rounded-xl bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 text-center",children:x})}),e.jsx(z,{onClick:ie,size:"lg",disabled:!E||f,className:N("w-full h-13 text-base font-semibold rounded-2xl","bg-gradient-to-r from-primary to-primary/80","shadow-lg shadow-primary/30",E&&"hover:shadow-xl hover:shadow-primary/40"),children:f?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-5 w-5 mr-2 animate-spin"}),"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-5 w-5 mr-2"}),"Concluir"]})})]},"profile"),c==="success"&&e.jsxs(r.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"py-8 text-center",children:[e.jsx(r.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",bounce:.5},className:"inline-flex p-5 rounded-full bg-green-500 mb-5",children:e.jsx(B,{className:"h-10 w-10 text-white"})}),e.jsx("h2",{className:"text-xl font-bold text-green-600",children:"Bem-vindo!"}),e.jsxs("p",{className:"text-muted-foreground mt-2",children:["Entrando no ",D,"..."]}),e.jsx("div",{className:"mt-4",children:e.jsx(T,{className:"h-5 w-5 animate-spin mx-auto text-muted-foreground"})})]},"success")]})})}),e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},className:"py-6 px-6",children:e.jsxs("div",{className:"flex items-center justify-center gap-5 text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"text-xs font-medium",children:"Seguro"})]}),e.jsx("div",{className:"w-px h-3 bg-border"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-xs font-medium",children:"+1.000 moradores"})]}),e.jsx("div",{className:"w-px h-3 bg-border"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"text-xs font-medium",children:"Oficial"})]})]})})]})}export{Ke as default};
