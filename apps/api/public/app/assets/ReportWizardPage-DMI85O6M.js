import{j as e,r as u}from"./vendor-radix-CQkmBfGK.js";import{B as y}from"./button-D71ISVRV.js";import{f as B,M as K,d as A,C as Qe,X as Ne,b as L,m as pe,R as _,T as W,i as R,N as ve,w as ie,r as H,o as Xe,u as Te,H as Je,a as Ye,B as Ze}from"./index-a72PoV5F.js";import{C as q}from"./camera-DpvdKmst.js";import{m as j,A as ae}from"./vendor-motion-3m9Rluu3.js";import{C as k}from"./card-Crw0dXBq.js";import{I as Q}from"./info-MiLfFVkH.js";import{C as Re}from"./CategoryIcon-B46uYJ7Q.js";import{u as Le,L as ea}from"./LoginRequired-DSnBj1ej.js";import{C as aa}from"./circle-alert-C3gl-P4W.js";import{L as ta}from"./lightbulb-D4qf8iae.js";import{C as sa}from"./circle-help-DGUsq1V2.js";import{I as he}from"./input-ual-E_pR.js";import{L as ra}from"./LocationMap-B7uscgNh.js";import{r as we}from"./report.service-Ced2GUh1.js";import{S as X}from"./search-wY3jy6EW.js";import{P as ne,I as oe}from"./pen-line-D6FwUDQD.js";import{B as ia}from"./badge-mWdio-bF.js";import{C as na}from"./checkbox-D9VLhA-O.js";import{T as oa}from"./textarea-U4-cYbgS.js";import{F as Be}from"./file-text-Bhq_xLXH.js";import{S as ca}from"./send-UNHf_QCh.js";import{c as ce,P as la}from"./confetti.module-BUscXrNm.js";import{S as da}from"./sparkles-BmM1ajHA.js";import{C as ma}from"./copy-CshDKstp.js";import{S as ua}from"./share-2-CR6XsXWr.js";import{M as xa}from"./map-C1U3wcXC.js";import{u as pa}from"./useMyReports-DWes-UvR.js";import{A as ha}from"./arrow-left-917UdkBP.js";import"./vendor-utils-YRYEdvK0.js";import"./vendor-query-BnSlUk-m.js";import"./iconify-B9cQn18X.js";import"./log-in-BR0jIyEf.js";import"./user-plus-DkqM6N9g.js";import"./TileLayer-DNyvcmGV.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=B("FileCheck",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ga=B("FileSearch",[["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M4.268 21a2 2 0 0 0 1.727 1H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3",key:"ms7g94"}],["path",{d:"m9 18-1.5-1.5",key:"1j6qii"}],["circle",{cx:"5",cy:"14",r:"3",key:"ufru5t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fa=B("ImageOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M10.41 10.41a2 2 0 1 1-2.83-2.83",key:"1bzlo9"}],["line",{x1:"13.5",x2:"6",y1:"13.5",y2:"21",key:"1q0aeu"}],["line",{x1:"18",x2:"21",y1:"12",y2:"15",key:"5mozeu"}],["path",{d:"M3.59 3.59A1.99 1.99 0 0 0 3 5v14a2 2 0 0 0 2 2h14c.55 0 1.052-.22 1.41-.59",key:"mmje98"}],["path",{d:"M21 15V5a2 2 0 0 0-2-2H9",key:"43el77"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=B("List",[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=B("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=B("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=B("ShieldAlert",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ba=B("SwitchCamera",[["path",{d:"M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5",key:"mtk2lu"}],["path",{d:"M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5",key:"120jsl"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"m18 22-3-3 3-3",key:"kgdoj7"}],["path",{d:"m6 2 3 3-3 3",key:"1fnbkv"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ja=B("Target",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]),ya=[{icon:Fe,label:"Categoria"},{icon:K,label:"Localização"},{icon:q,label:"Fotos"},{icon:ga,label:"Revisão"}];function Na({currentStep:a,totalSteps:t,labels:s}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:ya.slice(0,t).map((r,i)=>{const d=i+1,l=d<a,m=d===a,o=r.icon;return e.jsxs("div",{className:"flex flex-col items-center flex-1",children:[i>0&&e.jsx("div",{className:A("absolute h-0.5 -translate-y-4",l||m?"bg-primary":"bg-muted"),style:{width:`calc(100% / ${t} - 2rem)`,left:`calc((100% / ${t}) * ${i} + 1rem)`}}),e.jsx(j.div,{initial:{scale:.8},animate:{scale:m?1.1:1},className:A("relative z-10 h-10 w-10 rounded-full flex items-center justify-center transition-all",l&&"bg-primary text-primary-foreground",m&&"bg-primary text-primary-foreground ring-4 ring-primary/20",!l&&!m&&"bg-muted text-muted-foreground"),children:l?e.jsx(Qe,{className:"h-5 w-5"}):e.jsx(o,{className:"h-5 w-5"})}),e.jsx("span",{className:A("text-xs mt-1.5 font-medium text-center",m&&"text-primary",l&&"text-foreground",!l&&!m&&"text-muted-foreground"),children:s?.[i]||r.label})]},d)})}),e.jsx("div",{className:"relative -mt-[3.2rem] mx-5 h-0.5 bg-muted rounded-full",children:e.jsx(j.div,{className:"h-full bg-primary rounded-full",initial:{width:0},animate:{width:`${(a-1)/(t-1)*100}%`},transition:{type:"spring",stiffness:300,damping:30}})}),e.jsx("div",{className:"h-4"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsxs("span",{className:"font-semibold text-primary",children:["Etapa ",a]}),e.jsxs("span",{className:"text-muted-foreground",children:["de ",t]})]})]})}function va({title:a,content:t,className:s}){const[r,i]=u.useState(!1),d=Array.isArray(t)?t:[t];return e.jsxs("div",{className:A("inline-flex items-center gap-1",s),children:[e.jsx(j.button,{type:"button",whileTap:{scale:.9},onClick:()=>i(!0),className:"flex h-5 w-5 items-center justify-center rounded-full bg-muted hover:bg-muted/80 transition-colors","aria-label":`Ajuda sobre ${a}`,children:e.jsx(Q,{className:"h-3 w-3 text-muted-foreground"})}),e.jsx(ae,{children:r&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>i(!1)}),e.jsxs(j.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 safe-bottom",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"flex items-start justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(Q,{className:"h-4 w-4 text-primary"})}),e.jsx("h3",{className:"font-semibold text-lg",children:a})]}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full",onClick:()=>i(!1),children:e.jsx(Ne,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-4 space-y-2",children:d.map((l,m)=>e.jsxs("p",{className:"text-sm text-muted-foreground flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"•"}),e.jsx("span",{children:l})]},m))}),e.jsx(y,{className:"w-full mt-6",onClick:()=>i(!1),children:"Entendi"})]})]})})]})}function te({title:a,subtitle:t,helpTitle:s,helpContent:r}){return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-2xl font-bold",children:a}),r&&e.jsx(va,{title:s||a,content:r})]}),t&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t})]})}function wa({draft:a,onUpdate:t,onNext:s}){const{categories:r,isLoading:i,error:d,refetch:l}=Le(),m=r.find(f=>f.id===a.categoryId),o=f=>{t({categoryId:f.id,category:f})},x=!!a.categoryId;return i?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(L,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando categorias..."})]}):d?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(aa,{className:"h-12 w-12 text-destructive"}),e.jsx("p",{className:"text-muted-foreground text-center",children:"Erro ao carregar categorias."}),e.jsx(y,{onClick:()=>l(),variant:"outline",children:"Tentar novamente"})]}):e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(te,{title:"O que aconteceu?",subtitle:"Escolha a categoria que melhor descreve o problema",helpTitle:"Como escolher a categoria",helpContent:["Escolha a categoria que mais combina com o problema que você quer reportar.","Se tiver dúvida, escolha 'Outros' e descreva com suas palavras.","Não se preocupe em acertar perfeitamente, nossa equipe vai analisar."]}),e.jsx(k,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(Q,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsx("div",{children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("span",{className:"font-medium",children:"Toque em uma categoria"})," para selecioná-la. Depois você pode detalhar melhor o problema."]})})]})}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:r.map((f,b)=>{const h=a.categoryId===f.id;return e.jsxs(j.button,{type:"button",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:b*.03},whileTap:{scale:.95},onClick:()=>o(f),className:A("relative flex flex-col items-center gap-2 rounded-2xl border-2 p-3 text-center transition-all",h?"border-primary bg-primary/10 shadow-lg":"border-border bg-card hover:bg-muted/50 hover:border-muted-foreground/30"),style:{borderColor:h?f.color:void 0,backgroundColor:h?`${f.color}10`:void 0},children:[e.jsx(Re,{icon:f.icon,color:f.color,size:"lg",withBackground:!0}),e.jsx("span",{className:A("text-[11px] leading-tight font-semibold line-clamp-2",h?"text-primary":"text-slate-700 dark:text-slate-300"),style:{color:h?f.color:void 0},children:f.name}),h&&e.jsx(j.div,{initial:{scale:0},animate:{scale:1},className:"absolute -top-1 -right-1 h-5 w-5 rounded-full flex items-center justify-center",style:{backgroundColor:f.color},children:e.jsx(pe,{className:"h-3 w-3 text-white"})})]},f.id)})}),m&&m.tips.length>0&&e.jsx(j.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"space-y-3",children:e.jsx(k,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-amber-100 dark:bg-amber-900/50",children:e.jsx(ta,{className:"h-4 w-4 text-amber-600 dark:text-amber-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-medium text-amber-800 dark:text-amber-300",children:['Dicas para "',m.name,'"']}),e.jsx("ul",{className:"mt-2 space-y-1",children:m.tips.map((f,b)=>e.jsxs("li",{className:"text-sm text-amber-700 dark:text-amber-400 flex gap-2",children:[e.jsx("span",{className:"shrink-0",children:"•"}),e.jsx("span",{children:f})]},b))})]})]})})}),!a.categoryId&&e.jsx(k,{className:"p-4 border-muted bg-muted/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-muted",children:e.jsx(sa,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione uma categoria acima para continuar"})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx(y,{size:"lg",className:A("w-full h-14 text-base font-semibold rounded-2xl transition-all",!x&&"opacity-50"),disabled:!x,onClick:s,children:x?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(pe,{className:"h-5 w-5 ml-2"})]}):"Selecione uma categoria"})})})]})}function ka({draft:a,onUpdate:t,onNext:s,onBack:r}){const[i,d]=u.useState({status:"idle"}),[l,m]=u.useState(!1),[o,x]=u.useState(""),[f,b]=u.useState([]),[h,v]=u.useState(!1),[D,p]=u.useState(!1),g=u.useCallback(async(n,c)=>{try{p(!0);const w=await we.geocodeReverse(n,c);return w?.address||w?.displayName}catch(w){console.warn("[StepLocation] Reverse geocode failed:",w);return}finally{p(!1)}},[]),N=u.useCallback(async()=>{if(!navigator.geolocation){d({status:"error",errorMessage:"Seu navegador não suporta geolocalização. Tente usar Chrome, Safari ou Firefox."});return}d({status:"requesting"}),navigator.geolocation.getCurrentPosition(async n=>{const c=n.coords.latitude,w=n.coords.longitude,M=await g(c,w),E={latitude:c,longitude:w,accuracy:n.coords.accuracy,address:M||"Tijucas, SC",source:"gps",quality:n.coords.accuracy<=50?"precisa":"aproximada"};t({location:E}),d({status:"success"})},n=>{let c="Não conseguimos acessar sua localização.";n.code===n.PERMISSION_DENIED?(c="Você não permitiu o acesso à sua localização.",d({status:"denied",errorMessage:c})):n.code===n.POSITION_UNAVAILABLE?(c="Não foi possível determinar sua localização. Verifique se o GPS está ativado.",d({status:"error",errorMessage:c})):n.code===n.TIMEOUT&&(c="Demorou muito para obter sua localização. Verifique sua conexão e tente novamente.",d({status:"error",errorMessage:c}))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4})},[t,g]),S=u.useRef(null),I=u.useCallback(async n=>{if(n.length<3){b([]);return}S.current&&S.current.abort(),S.current=new AbortController,v(!0);try{const c=a.location?.latitude,w=a.location?.longitude,M=await we.geocodeAutocomplete(n,c,w);b(M)}catch(c){c.name!=="AbortError"&&console.warn("[StepLocation] Search failed:",c),b([])}finally{v(!1)}},[a.location?.latitude,a.location?.longitude]);u.useEffect(()=>{const n=setTimeout(()=>{o&&I(o)},300);return()=>{clearTimeout(n),S.current&&S.current.abort()}},[o,I]);const G=n=>{const c={latitude:n.latitude,longitude:n.longitude,accuracy:100,address:n.address||n.displayName,source:"manual",quality:"manual"};t({location:c}),d({status:"success"}),x(""),b([]),m(!1)};u.useEffect(()=>{!a.location&&i.status==="idle"&&N()},[a.location,i.status,N]);const C=!!a.location,V=({quality:n})=>{const c={precisa:{color:"text-green-600 bg-green-100",icon:ja,label:"Precisa"},aproximada:{color:"text-amber-600 bg-amber-100",icon:K,label:"Aproximada"},manual:{color:"text-blue-600 bg-blue-100",icon:ne,label:"Informada"}}[n]||{color:"text-gray-600 bg-gray-100",icon:K,label:"Desconhecida"},w=c.icon;return e.jsxs("span",{className:A("inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",c.color),children:[e.jsx(w,{className:"h-3 w-3"}),c.label]})};return e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(te,{title:"Onde foi?",subtitle:"Precisamos saber o local do problema",helpTitle:"Por que precisamos da localização?",helpContent:["A localização ajuda nossa equipe a encontrar o problema rapidamente.","Usamos o GPS do seu celular para maior precisão.","Sua localização não é compartilhada publicamente, apenas com a equipe responsável."]}),e.jsx(k,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(Q,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"Como funciona:"}),e.jsx("p",{children:"Usamos o GPS para marcar o local, ou você pode buscar o endereço manualmente."})]})]})}),e.jsxs("div",{className:"space-y-4",children:[i.status==="requesting"&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(L,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:D?"Buscando endereço...":"Buscando sua localização..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),i.status==="denied"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(K,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Localização bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:i.errorMessage}),e.jsxs(k,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700 text-left",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Localização" para "Permitir"'})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4 w-full",children:[e.jsxs(y,{variant:"outline",className:"flex-1",onClick:N,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(y,{variant:"secondary",className:"flex-1",onClick:()=>m(!0),children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),i.status==="error"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(W,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Erro ao obter localização"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:i.errorMessage}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(y,{variant:"outline",className:"flex-1",onClick:N,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(y,{variant:"secondary",className:"flex-1",onClick:()=>m(!0),children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),a.location&&e.jsxs(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-4",children:[e.jsx(k,{className:"p-4 bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100 dark:bg-green-900/50",children:e.jsx(R,{className:"h-5 w-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-green-800 dark:text-green-300",children:"Localização capturada!"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(V,{quality:a.location.quality}),a.location.accuracy&&a.location.source==="gps"&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["±",Math.round(a.location.accuracy),"m"]})]})]})]})}),e.jsx(ra,{latitude:a.location.latitude,longitude:a.location.longitude,hasGPS:a.location.source==="gps",onLocationChange:async(n,c)=>{const w=await g(n,c);t({location:{...a.location,latitude:n,longitude:c,address:w||a.location.address,source:"mapa",quality:"precisa"}})},onCenterGPS:a.location.source==="gps"?N:void 0}),e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[D?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 animate-spin text-primary"}),e.jsx("span",{className:"text-muted-foreground",children:"Buscando endereço..."})]}):e.jsx("p",{className:"font-medium",children:a.location.address||"Localização capturada"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Coordenadas: ",a.location.latitude.toFixed(4),", ",a.location.longitude.toFixed(4)]})]}),e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>m(!0),children:[e.jsx(ne,{className:"h-3.5 w-3.5 mr-1"}),"Buscar"]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4 text-muted-foreground"}),"Ponto de referência (opcional)"]}),e.jsx(he,{placeholder:"Ex: Próximo ao Supermercado X",value:a.locationNote||"",onChange:n=>t({locationNote:n.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ajude a localizar o problema com uma referência"})]})]}),i.status==="idle"&&!a.location&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center py-8 gap-4",children:[e.jsxs(y,{size:"lg",onClick:N,className:"h-14 px-8 rounded-2xl",children:[e.jsx(ve,{className:"h-5 w-5 mr-2"}),"Usar minha localização"]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"ou"}),e.jsxs(y,{variant:"outline",onClick:()=>m(!0),children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Buscar endereço manualmente"]})]})]}),e.jsx(ae,{children:l&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>m(!1)}),e.jsxs(j.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 pb-8 max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsx("h3",{className:"font-semibold text-lg mt-4",children:"Buscar endereço"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Digite o nome da rua ou local"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(X,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(he,{placeholder:"Ex: Rua Principal, Centro, Tijucas",value:o,onChange:n=>x(n.target.value),className:"pl-10 h-12 rounded-xl",autoFocus:!0}),h&&e.jsx(L,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground"})]}),f.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:f.map((n,c)=>e.jsx(j.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:c*.05},onClick:()=>G(n),className:"w-full text-left p-3 rounded-xl border hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(K,{className:"h-5 w-5 text-primary shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:n.address}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:n.displayName})]})]})},n.placeId||c))}),o.length>=3&&f.length===0&&!h&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Nenhum resultado encontrado. Tente outro endereço."}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(y,{variant:"outline",className:"flex-1",onClick:()=>m(!1),children:"Cancelar"}),e.jsxs(y,{className:"flex-1",onClick:N,children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Usar GPS"]})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:r,children:"Voltar"}),e.jsx(y,{size:"lg",className:A("h-14 rounded-2xl flex-[2] text-base font-semibold",!C&&"opacity-50"),disabled:!C,onClick:s,children:C?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(pe,{className:"h-5 w-5 ml-2"})]}):"Aguardando localização..."})]})})]})}function ke(a){if(a===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],r=Math.floor(Math.log(a)/Math.log(t));return`${parseFloat((a/Math.pow(t,r)).toFixed(1))} ${s[r]}`}async function Ca(a,t={}){const{maxWidth:s=1200,maxHeight:r=1200,quality:i=.8,format:d="image/webp"}=t;return new Promise((l,m)=>{const o=new Image,x=document.createElement("canvas"),f=x.getContext("2d");if(!f){m(new Error("Canvas context not available"));return}o.onload=()=>{let{width:h,height:v}=o;h>s&&(v=v*s/h,h=s),v>r&&(h=h*r/v,v=r),h=Math.round(h),v=Math.round(v),x.width=h,x.height=v,f.imageSmoothingEnabled=!0,f.imageSmoothingQuality="high",f.drawImage(o,0,0,h,v);const D=x.toDataURL(d).startsWith("data:"+d)?d:"image/jpeg";x.toBlob(p=>{if(!p){m(new Error("Failed to compress image"));return}const g=x.toDataURL(D,i);l({blob:p,dataUrl:g,originalSize:a.size,compressedSize:p.size,compressionRatio:p.size/a.size,width:h,height:v})},D,i)},o.onerror=()=>{m(new Error("Failed to load image"))};const b=new FileReader;b.onload=h=>{o.src=h.target?.result},b.onerror=()=>{m(new Error("Failed to read file"))},b.readAsDataURL(a)})}const z=3;function Sa({draft:a,onUpdate:t,onNext:s,onBack:r}){const i=u.useRef(null),d=u.useRef(null),l=u.useRef(null),m=u.useRef(null),[o,x]=u.useState({status:"idle",facingMode:"environment",stream:null}),[f,b]=u.useState(!1),[h,v]=u.useState(null),D=typeof window<"u"&&window.isSecureContext,p=u.useCallback(async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){x(n=>({...n,status:"error",errorMessage:"Seu navegador não suporta acesso à câmera. Tente usar Chrome, Safari ou Firefox."}));return}x(n=>({...n,status:"requesting"}));try{const n=await navigator.mediaDevices.getUserMedia({video:{facingMode:o.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:!1});i.current&&(i.current.srcObject=n,await i.current.play()),x(c=>({...c,status:"active",stream:n,errorMessage:void 0}))}catch(n){if(console.error("Camera error:",n),n instanceof DOMException)if(n.name==="NotAllowedError")x(c=>({...c,status:"denied",errorMessage:"Você não permitiu o acesso à câmera."}));else if(n.name==="NotFoundError")x(c=>({...c,status:"error",errorMessage:"Nenhuma câmera foi encontrada no seu dispositivo."}));else if(n.name==="NotReadableError")x(c=>({...c,status:"error",errorMessage:"A câmera está sendo usada por outro aplicativo. Feche outros apps e tente novamente."}));else if(n.name==="OverconstrainedError"){x(c=>({...c,status:"error",errorMessage:"Sua câmera não atende aos requisitos. Tentando configuração alternativa..."}));try{const c=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});i.current&&(i.current.srcObject=c,await i.current.play()),x(w=>({...w,status:"active",stream:c,errorMessage:void 0}))}catch{x(c=>({...c,status:"error",errorMessage:"Não foi possível acessar sua câmera."}))}}else x(c=>({...c,status:"error",errorMessage:"Ocorreu um erro ao acessar a câmera. Tente novamente."}));else x(c=>({...c,status:"error",errorMessage:"Erro desconhecido ao acessar a câmera."}))}},[o.facingMode]),g=u.useCallback(()=>{o.stream&&o.stream.getTracks().forEach(n=>n.stop()),i.current&&(i.current.srcObject=null),x(n=>({...n,status:"idle",stream:null}))},[o.stream]);u.useEffect(()=>((async()=>{if(!navigator.mediaDevices?.enumerateDevices){v(!1);return}try{const w=(await navigator.mediaDevices.enumerateDevices()).some(M=>M.kind==="videoinput");v(w)}catch{v(!1)}})(),()=>{o.stream&&o.stream.getTracks().forEach(c=>c.stop())}),[]);const N=u.useCallback(async()=>{g(),x(n=>({...n,facingMode:n.facingMode==="environment"?"user":"environment"})),setTimeout(()=>p(),100)},[p,g]),S=u.useCallback(async()=>{if(!i.current||!d.current||a.images.length>=z)return;b(!0);const n=i.current,c=d.current,w=c.getContext("2d");if(!w){b(!1);return}c.width=n.videoWidth,c.height=n.videoHeight,w.drawImage(n,0,0),c.toBlob(M=>{if(!M){b(!1);return}const E=new File([M],`photo_${Date.now()}.jpg`,{type:"image/jpeg",lastModified:Date.now()}),$={id:ie(),file:E,previewUrl:URL.createObjectURL(M),capturedAt:new Date};t({images:[...a.images,$]}),b(!1),a.images.length+1>=z&&g()},"image/jpeg",.85)},[a.images,t,g]),I=u.useCallback(n=>{const c=a.images.find(w=>w.id===n);c&&URL.revokeObjectURL(c.previewUrl),t({images:a.images.filter(w=>w.id!==n)}),o.status==="idle"&&a.images.length<=z&&p()},[a.images,o.status,t,p]),G=u.useCallback(n=>{I(n),o.status!=="active"&&p()},[I,o.status,p]),C=u.useCallback(async n=>{const c=n.target.files;if(!c||c.length===0)return;const w=z-a.images.length,M=Array.from(c).slice(0,w);let E=0,$=0;for(const F of M)if(F.type.startsWith("image/"))try{const P=await Ca(F,{maxWidth:1920,maxHeight:1920,quality:.75});E+=P.originalSize,$+=P.compressedSize;const re=new File([P.blob],F.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()}),We={id:ie(),file:re,previewUrl:URL.createObjectURL(P.blob),capturedAt:new Date};t({images:[...a.images,We]})}catch(P){console.error("Failed to compress image:",P);const re={id:ie(),file:F,previewUrl:URL.createObjectURL(F),capturedAt:new Date};t({images:[...a.images,re]})}if(E>0&&$<E){const F=E-$,P=Math.round(F/E*100);H.success(`Imagem otimizada: ${ke(E)} → ${ke($)} (-${P}%)`)}l.current&&(l.current.value="")},[a.images,t]),V=u.useCallback(()=>{l.current?.click()},[]);return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(te,{title:"Adicione até 3 fotos",subtitle:"Tire fotos agora ou escolha da galeria",helpTitle:"Dicas para boas fotos",helpContent:["Fotografe de perto para mostrar detalhes do problema.","Inclua uma foto do contexto (rua, número, ponto de referência).","Evite fotos muito escuras ou desfocadas."]}),e.jsx("input",{ref:l,type:"file",accept:"image/*",multiple:!0,onChange:C,className:"hidden"}),e.jsx("input",{ref:m,type:"file",accept:"image/*",capture:"environment",onChange:C,className:"hidden"}),e.jsx(k,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(Q,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-2 text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium",children:"Dicas para boas fotos:"}),e.jsxs("ul",{className:"space-y-1 text-blue-600 dark:text-blue-400",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto de perto do problema"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(fa,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto mostrando o contexto da rua"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Evite se colocar em risco"})]})]})]})]})}),e.jsxs("div",{className:"relative",children:[o.status==="idle"&&a.images.length<z&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10",children:e.jsx(q,{className:"h-10 w-10 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Adicione fotos do problema"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Fotos ajudam a identificar e resolver o problema mais rápido"})]}),!D&&e.jsx("div",{className:"w-full p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-400",children:[e.jsx(de,{className:"h-4 w-4 shrink-0"}),e.jsx("p",{className:"text-xs text-left",children:"Câmera exige HTTPS. Use a galeria para adicionar fotos."})]})}),e.jsxs("div",{className:"w-full space-y-2",children:[D&&h!==!1&&e.jsxs(y,{onClick:()=>m.current?.click(),className:"w-full",size:"lg",disabled:h===null,children:[h===null?e.jsx(L,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(q,{className:"h-4 w-4 mr-2"}),"Tirar Foto"]}),e.jsxs(y,{variant:D&&h!==!1?"outline":"default",onClick:V,className:"w-full",size:"lg",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Escolher da Galeria"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Você pode pular e continuar sem fotos"})]})})}),o.status==="active"&&a.images.length<z&&e.jsxs(j.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative rounded-2xl overflow-hidden bg-muted aspect-[4/3]",children:[e.jsx("video",{ref:i,autoPlay:!0,playsInline:!0,muted:!0,"webkit-playsinline":"true","x-webkit-airplay":"allow",style:{backgroundColor:"transparent"},className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-4 left-0 right-0 flex items-center justify-center gap-4",children:[e.jsx(j.button,{whileTap:{scale:.9},onClick:N,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Trocar câmera",children:e.jsx(ba,{className:"h-5 w-5"})}),e.jsx(j.button,{whileTap:{scale:.9},onClick:S,disabled:f,className:A("p-1 rounded-full bg-white",f&&"opacity-50"),"aria-label":"Capturar foto",children:e.jsx("div",{className:"h-16 w-16 rounded-full border-4 border-primary flex items-center justify-center",children:f?e.jsx(L,{className:"h-6 w-6 text-primary animate-spin"}):e.jsx(q,{className:"h-6 w-6 text-primary"})})}),e.jsx(j.button,{whileTap:{scale:.9},onClick:V,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Escolher da galeria",children:e.jsx(oe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"absolute top-4 right-4 px-3 py-1.5 rounded-full bg-black/50 text-white text-sm backdrop-blur-sm flex items-center gap-1",children:[e.jsx(q,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[a.images.length,"/",z]})]})]}),o.status==="requesting"&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"rounded-2xl bg-muted aspect-[4/3] flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(L,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:"Iniciando câmera..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),o.status==="denied"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(de,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Câmera bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(k,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado ou câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Câmera" para "Permitir"'})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"4."}),e.jsx("span",{children:"Recarregue a página ou toque no botão abaixo"})]})]})]}),e.jsxs(y,{variant:"outline",className:"mt-4 w-full",onClick:p,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),o.status==="error"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(W,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Problema com a câmera"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(k,{className:"w-full p-4 bg-white dark:bg-background border-red-200 dark:border-red-700",children:[e.jsx("p",{className:"font-medium text-sm mb-3",children:"O que você pode fazer:"}),e.jsxs("ul",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Verifique se seu dispositivo tem câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Feche outros aplicativos que usam a câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Tente acessar pelo celular em vez do computador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Você pode continuar sem foto (opcional)"})]})]})]}),e.jsxs(y,{variant:"outline",className:"mt-4 w-full",onClick:p,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),e.jsx("canvas",{ref:d,className:"hidden"})]}),a.images.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500"}),"Fotos capturadas (",a.images.length,"/",z,")"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(ae,{mode:"popLayout",children:a.images.map((n,c)=>e.jsxs(j.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},layout:!0,className:"relative aspect-square",children:[e.jsx("img",{src:n.previewUrl,alt:`Foto ${c+1}`,className:"w-full h-full object-cover rounded-xl"}),e.jsx("div",{className:"absolute top-2 left-2 h-6 w-6 rounded-full bg-primary text-primary-foreground text-xs font-bold flex items-center justify-center",children:c+1}),e.jsx("button",{type:"button",onClick:()=>I(n.id),className:"absolute -top-2 -right-2 h-7 w-7 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg hover:bg-red-600 transition-colors z-10","aria-label":"Remover foto",children:e.jsx(Ne,{className:"h-4 w-4"})}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/70 to-transparent rounded-b-xl",children:e.jsxs("button",{type:"button",onClick:()=>G(n.id),className:"w-full px-2 py-1 text-xs bg-white/20 text-white rounded-md backdrop-blur-sm flex items-center justify-center gap-1",children:[e.jsx(_,{className:"h-3 w-3"}),"Refazer"]})})]},n.id))}),Array.from({length:z-a.images.length}).map((n,c)=>e.jsxs("button",{type:"button",onClick:()=>m.current?.click(),className:"aspect-square rounded-xl border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-1 hover:border-primary/50 hover:bg-primary/5 transition-colors cursor-pointer",children:[e.jsx(oe,{className:"h-5 w-5 text-muted-foreground/50"}),e.jsx("span",{className:"text-xs text-muted-foreground/50",children:"Adicionar"})]},`empty-${c}`))]})]}),a.images.length>=z&&e.jsx(k,{className:"p-4 text-center bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(R,{className:"h-5 w-5"}),e.jsxs("span",{className:"font-medium",children:["Você tirou ",z," fotos. Pronto para continuar!"]})]})}),a.images.length===0&&(o.status==="error"||o.status==="denied")&&e.jsx(k,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-amber-600 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800 dark:text-amber-300",children:"Continuar sem foto?"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-1",children:"Fotos ajudam muito a identificar o problema, mas você pode continuar sem elas."})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:()=>{g(),r()},children:"Voltar"}),e.jsxs(y,{size:"lg",className:"h-14 rounded-2xl flex-[2] text-base font-semibold",onClick:()=>{g(),s()},children:["Continuar",a.images.length===0&&e.jsx("span",{className:"text-xs ml-2 opacity-70",children:"(sem foto)"})]})]})})]})}function Da({draft:a,onUpdate:t,onBack:s,onGoToStep:r,onSubmit:i}){const[d,l]=u.useState(!1),{categories:m}=Le(),o=m.find(b=>b.id===a.categoryId),x=!!a.categoryId&&!!a.location&&a.confirmed&&!!a.title?.trim(),f=async()=>{if(x){l(!0);try{await i()}catch(b){console.error("Submit error:",b)}finally{l(!1)}}};return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(te,{title:"Revisar e enviar",subtitle:"Adicione um título e confira as informações",helpTitle:"Última etapa!",helpContent:["Adicione um título curto que descreva o problema.","Revise todas as informações antes de enviar.","Após enviar, você receberá um número de protocolo."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4 text-muted-foreground"}),"Título da denúncia *"]}),e.jsx(he,{placeholder:"Ex: Buraco grande na Rua Principal",value:a.title||"",onChange:b=>t({title:b.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Descreva o problema em poucas palavras (obrigatório)"})]}),e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[o?e.jsx(Re,{icon:o.icon,color:o.color,size:"lg",withBackground:!0}):e.jsx("div",{className:"p-3 rounded-xl bg-muted",children:"❓"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Categoria"}),e.jsx("p",{className:"font-semibold",children:o?.name||"Não selecionada"})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(1),className:"text-primary",children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(K,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-semibold",children:a.location?.address||"Localização capturada"}),a.location?.quality&&e.jsx(ia,{variant:"secondary",className:"mt-1 text-xs capitalize",children:a.location.quality})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(2),className:"text-primary",children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsxs(k,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(q,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Fotos"}),e.jsxs("p",{className:"font-semibold",children:[a.images.length," ",a.images.length===1?"foto anexada":"fotos anexadas"]})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(3),className:"text-primary",children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"Editar"]})]}),a.images.length>0?e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:a.images.map((b,h)=>e.jsx("img",{src:b.previewUrl,alt:`Foto ${h+1}`,className:"h-20 w-20 rounded-lg object-cover shrink-0"},b.id))}):e.jsxs("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("p",{className:"text-sm",children:"Nenhuma foto anexada (opcional)"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4 text-muted-foreground"}),"Descrição adicional (opcional)"]}),e.jsx(oa,{placeholder:"Algum detalhe importante? (máx. 500 caracteres)",maxLength:500,value:a.description,onChange:b=>t({description:b.target.value}),className:"min-h-[100px] rounded-xl resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[a.description.length,"/500"]})]}),e.jsx(k,{className:A("p-4 transition-all border-2",a.confirmed?"border-green-400 bg-green-50 dark:bg-green-950/20 dark:border-green-700":"border-amber-400 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-700"),children:e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[e.jsx(na,{checked:a.confirmed,onCheckedChange:b=>t({confirmed:!!b}),className:"mt-0.5 h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:A("font-medium",a.confirmed?"text-green-700 dark:text-green-300":"text-amber-700 dark:text-amber-300"),children:a.confirmed?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4"}),"Confirmado!"]}):"Confirmo que as informações são verdadeiras"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:a.confirmed?"Você confirmou que as informações são verdadeiras":"Marque para poder enviar a denúncia"})]})]})}),!x&&e.jsx(k,{className:"p-4 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-red-600 dark:text-red-400 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 dark:text-red-300",children:"Não é possível enviar ainda"}),e.jsxs("ul",{className:"text-sm text-red-700 dark:text-red-400 mt-1 space-y-1",children:[!a.title?.trim()&&e.jsx("li",{children:"• Adicione um título"}),!a.categoryId&&e.jsx("li",{children:"• Selecione uma categoria"}),!a.location&&e.jsx("li",{children:"• Capture sua localização"}),!a.confirmed&&e.jsx("li",{children:"• Confirme que as informações são verdadeiras"})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:s,disabled:d,children:"Voltar"}),e.jsx(y,{size:"lg",className:A("h-14 rounded-2xl flex-[2] text-base font-semibold",x?"bg-green-600 hover:bg-green-700":"opacity-50"),disabled:!x||d,onClick:f,children:d?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-5 w-5 mr-2 animate-spin"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ca,{className:"h-5 w-5 mr-2"}),"Enviar denúncia"]})})]})})]})}function Ia({protocolNumber:a,onClose:t}){const{toast:s}=Xe(),r=Te(),i=u.useCallback(()=>{const o=Date.now()+3e3,x={startVelocity:30,spread:360,ticks:60,zIndex:100},f=(h,v)=>Math.random()*(v-h)+h,b=setInterval(()=>{const h=o-Date.now();if(h<=0)return clearInterval(b);const v=50*(h/3e3);ce({...x,particleCount:v,origin:{x:f(.1,.3),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),ce({...x,particleCount:v,origin:{x:f(.7,.9),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]})},250);return ce({particleCount:100,spread:70,origin:{y:.6},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),()=>clearInterval(b)},[]);u.useEffect(()=>i(),[i]);const d=async()=>{try{await navigator.clipboard.writeText(a),s({title:"Protocolo copiado!",description:"Cole onde quiser para guardar."})}catch{s({title:"Erro ao copiar",description:"Tente copiar manualmente.",variant:"destructive"})}},l=async()=>{if(navigator.share)try{await navigator.share({title:"Denúncia Enviada - eTijucas",text:`Minha denúncia foi registrada com sucesso! Protocolo: ${a}`})}catch{console.log("Share cancelled")}else d()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-gradient-to-b from-green-50 to-background dark:from-green-950/30 dark:to-background flex flex-col items-center justify-center p-6 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(6)].map((m,o)=>e.jsx(j.div,{initial:{opacity:0,scale:0},animate:{opacity:[0,.3,0],scale:[0,1.5,2],x:Math.random()*100-50,y:Math.random()*100-50},transition:{duration:3,delay:o*.3,repeat:1/0,repeatDelay:2},className:"absolute rounded-full bg-green-400/20",style:{width:100+o*30,height:100+o*30,left:`${20+o*10}%`,top:`${15+o*12}%`}},o))}),e.jsxs(j.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},transition:{duration:.5},className:"relative z-10 w-full max-w-sm flex flex-col items-center text-center",children:[e.jsxs(j.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},className:"relative mb-6",children:[e.jsx("div",{className:"p-6 rounded-full bg-green-100 dark:bg-green-900/50 shadow-lg shadow-green-500/20",children:e.jsx(R,{className:"h-20 w-20 text-green-600 dark:text-green-400"})}),e.jsx(j.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(da,{className:"h-8 w-8 text-yellow-500"})}),e.jsx(j.div,{animate:{rotate:-360},transition:{duration:4,repeat:1/0,ease:"linear"},className:"absolute -bottom-1 -left-3",children:e.jsx(la,{className:"h-7 w-7 text-pink-500"})})]}),e.jsx(j.h1,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-3xl font-bold text-green-700 dark:text-green-400 mb-2",children:"Denúncia Enviada!"}),e.jsx(j.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"text-muted-foreground mb-6",children:"Obrigado por ajudar a melhorar nossa cidade!"}),e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"w-full",children:e.jsxs(k,{className:"p-6 bg-white dark:bg-card border-green-200 dark:border-green-800 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-3",children:[e.jsx(Pe,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground font-medium",children:"Número do Protocolo"})]}),e.jsx(j.p,{className:"text-2xl font-bold font-mono text-primary mb-4",animate:{scale:[1,1.02,1]},transition:{duration:2,repeat:1/0},children:a}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",size:"sm",className:"flex-1",onClick:d,children:[e.jsx(ma,{className:"h-4 w-4 mr-2"}),"Copiar"]}),e.jsxs(y,{variant:"outline",size:"sm",className:"flex-1",onClick:l,children:[e.jsx(ua,{className:"h-4 w-4 mr-2"}),"Compartilhar"]})]})]})}),e.jsx(j.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.7},className:"text-xs text-muted-foreground mt-4 max-w-xs",children:"Guarde este número para acompanhar o andamento da sua denúncia. Nossa equipe irá analisar e tomar as providências necessárias."}),e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.8},className:"w-full mt-8 space-y-3",children:[e.jsxs(y,{size:"lg",className:"w-full h-14 rounded-2xl text-base font-semibold bg-green-600 hover:bg-green-700",onClick:t,children:[e.jsx(Je,{className:"h-5 w-5 mr-2"}),"Início do App"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(y,{variant:"outline",size:"lg",className:"h-12 rounded-2xl text-sm",onClick:()=>r("/minhas-denuncias"),children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Minhas Denúncias"]}),e.jsxs(y,{variant:"outline",size:"lg",className:"h-12 rounded-2xl text-sm",onClick:()=>r("/denuncias/mapa"),children:[e.jsx(xa,{className:"h-4 w-4 mr-2"}),"Mapa"]})]}),e.jsxs(y,{variant:"ghost",size:"lg",className:"w-full h-12 rounded-2xl text-base",onClick:()=>r("/denuncias"),children:[e.jsx(Be,{className:"h-5 w-5 mr-2"}),"Todas as Denúncias"]})]})]})]})}const ge=(a,t)=>t.some(s=>a instanceof s);let Ce,Se;function Aa(){return Ce||(Ce=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ma(){return Se||(Se=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const fe=new WeakMap,me=new WeakMap,se=new WeakMap;function za(a){const t=new Promise((s,r)=>{const i=()=>{a.removeEventListener("success",d),a.removeEventListener("error",l)},d=()=>{s(O(a.result)),i()},l=()=>{r(a.error),i()};a.addEventListener("success",d),a.addEventListener("error",l)});return se.set(t,a),t}function Ea(a){if(fe.has(a))return;const t=new Promise((s,r)=>{const i=()=>{a.removeEventListener("complete",d),a.removeEventListener("error",l),a.removeEventListener("abort",l)},d=()=>{s(),i()},l=()=>{r(a.error||new DOMException("AbortError","AbortError")),i()};a.addEventListener("complete",d),a.addEventListener("error",l),a.addEventListener("abort",l)});fe.set(a,t)}let be={get(a,t,s){if(a instanceof IDBTransaction){if(t==="done")return fe.get(a);if(t==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return O(a[t])},set(a,t,s){return a[t]=s,!0},has(a,t){return a instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in a}};function Oe(a){be=a(be)}function Ta(a){return Ma().includes(a)?function(...t){return a.apply(je(this),t),O(this.request)}:function(...t){return O(a.apply(je(this),t))}}function Ra(a){return typeof a=="function"?Ta(a):(a instanceof IDBTransaction&&Ea(a),ge(a,Aa())?new Proxy(a,be):a)}function O(a){if(a instanceof IDBRequest)return za(a);if(me.has(a))return me.get(a);const t=Ra(a);return t!==a&&(me.set(a,t),se.set(t,a)),t}const je=a=>se.get(a);function La(a,t,{blocked:s,upgrade:r,blocking:i,terminated:d}={}){const l=indexedDB.open(a,t),m=O(l);return r&&l.addEventListener("upgradeneeded",o=>{r(O(l.result),o.oldVersion,o.newVersion,O(l.transaction),o)}),s&&l.addEventListener("blocked",o=>s(o.oldVersion,o.newVersion,o)),m.then(o=>{d&&o.addEventListener("close",()=>d()),i&&o.addEventListener("versionchange",x=>i(x.oldVersion,x.newVersion,x))}).catch(()=>{}),m}const Ba=["get","getKey","getAll","getAllKeys","count"],Pa=["put","add","delete","clear"],ue=new Map;function De(a,t){if(!(a instanceof IDBDatabase&&!(t in a)&&typeof t=="string"))return;if(ue.get(t))return ue.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,i=Pa.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!(i||Ba.includes(s)))return;const d=async function(l,...m){const o=this.transaction(l,i?"readwrite":"readonly");let x=o.store;return r&&(x=x.index(m.shift())),(await Promise.all([x[s](...m),i&&o.done]))[0]};return ue.set(t,d),d}Oe(a=>({...a,get:(t,s,r)=>De(t,s)||a.get(t,s,r),has:(t,s)=>!!De(t,s)||a.has(t,s)}));const Fa=["continue","continuePrimaryKey","advance"],Ie={},ye=new WeakMap,Ue=new WeakMap,qa={get(a,t){if(!Fa.includes(t))return a[t];let s=Ie[t];return s||(s=Ie[t]=function(...r){ye.set(this,Ue.get(this)[t](...r))}),s}};async function*Oa(...a){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...a)),!t)return;t=t;const s=new Proxy(t,qa);for(Ue.set(s,t),se.set(s,je(t));t;)yield s,t=await(ye.get(s)||t.continue()),ye.delete(s)}function Ae(a,t){return t===Symbol.asyncIterator&&ge(a,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&ge(a,[IDBIndex,IDBObjectStore])}Oe(a=>({...a,get(t,s,r){return Ae(t,s)?Oa:a.get(t,s,r)},has(t,s){return Ae(t,s)||a.has(t,s)}}));const Me="etijucas-reports",Ua=2;let T=null,J=!1;async function U(){if(T&&J)return T;try{return T=await La(Me,Ua,{upgrade(a,t,s){if(console.log(`[reportDraftDB] Upgrading from v${t} to v${s}`),!a.objectStoreNames.contains("drafts")){const r=a.createObjectStore("drafts",{keyPath:"id"});r.createIndex("by-status","syncStatus"),r.createIndex("by-updated","updatedAt")}a.objectStoreNames.contains("images")||a.createObjectStore("images",{keyPath:"id"}).createIndex("by-draft","draftId")},blocked(){console.warn("[reportDraftDB] Database blocked - close other tabs")},blocking(){T?.close(),T=null,J=!1}}),J=!0,T}catch(a){if(console.error("[reportDraftDB] Failed to open database:",a),a instanceof Error&&a.name==="NotFoundError"){console.warn("[reportDraftDB] Corrupted database, deleting and recreating...");try{return T&&(T.close(),T=null),await new Promise((t,s)=>{const r=indexedDB.deleteDatabase(Me);r.onsuccess=()=>t(),r.onerror=()=>s(r.error),r.onblocked=()=>{console.warn("[reportDraftDB] Delete blocked"),t()}}),console.log("[reportDraftDB] Database deleted, recreating..."),J=!1,U()}catch(t){throw console.error("[reportDraftDB] Failed to delete database:",t),t}}throw a}}function Ve(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async function $e(a,t="draft"){const s=await U(),r=a.idempotencyKey||Ve(),i=Date.now(),d={categoryId:a.categoryId,category:a.category,location:a.location,title:a.title,description:a.description,confirmed:a.confirmed,currentStep:a.currentStep,createdAt:a.createdAt.getTime(),updatedAt:i,idempotencyKey:a.idempotencyKey};await s.put("drafts",{id:r,draft:d,syncStatus:t,createdAt:i,updatedAt:i});const l=s.transaction("images","readwrite"),m=await s.getAllFromIndex("images","by-draft",r);for(const o of m)await l.store.delete(o.id);for(const o of a.images){const x=o.file;await l.store.put({id:o.id,draftId:r,blob:x,filename:o.file.name,capturedAt:o.capturedAt.getTime()})}return await l.done,r}async function Va(a){const t=await U(),s=await t.get("drafts",a);if(!s)return null;const i=(await t.getAllFromIndex("images","by-draft",a)).map(l=>{const m=new File([l.blob],l.filename,{type:l.blob.type});return{id:l.id,file:m,previewUrl:URL.createObjectURL(l.blob),capturedAt:new Date(l.capturedAt)}}),d=s.draft;return{categoryId:d.categoryId,category:d.category,location:d.location,title:d.title,description:d.description,confirmed:d.confirmed,currentStep:d.currentStep,createdAt:new Date(d.createdAt),updatedAt:new Date(d.updatedAt),idempotencyKey:d.idempotencyKey,images:i}}async function $a(){const a=await U(),t=await a.getAll("drafts");return(await Promise.all(t.map(async r=>{const i=await a.getAllFromIndex("images","by-draft",r.id);return{id:r.id,draft:r.draft,syncStatus:r.syncStatus,imageCount:i.length,updatedAt:r.updatedAt}}))).sort((r,i)=>i.updatedAt-r.updatedAt)}async function Ke(a){return(await(await U()).getAllFromIndex("drafts","by-status",a)).map(r=>r.id)}async function Ka(a,t){const s=await U(),r=await s.get("drafts",a);r&&await s.put("drafts",{...r,syncStatus:t,updatedAt:Date.now()})}async function Ge(a){const t=await U(),s=await t.getAllFromIndex("images","by-draft",a),r=t.transaction("images","readwrite");for(const i of s)await r.store.delete(i.id);await r.done,await t.delete("drafts",a)}async function Ga(){const a=await Ke("sent");let t=0;for(const s of a)await Ge(s),t++;return t}function He(a){for(const t of a)t.previewUrl?.startsWith("blob:")&&URL.revokeObjectURL(t.previewUrl)}const ze="report_draft";async function _e(){try{const a=localStorage.getItem(ze);if(!a)return!1;const t=JSON.parse(a);if(!t)return!1;const s={categoryId:t.categoryId||null,category:t.category||null,location:t.location||null,title:t.title||"",description:t.description||"",confirmed:!1,currentStep:t.currentStep||1,createdAt:new Date,updatedAt:new Date,idempotencyKey:Ve(),images:[]};return await $e(s,"draft"),localStorage.removeItem(ze),console.log("[reportDraftDB] Migrated draft from localStorage to IndexedDB"),!0}catch(a){return console.error("[reportDraftDB] Migration failed:",a),!1}}const Y={saveDraft:$e,getDraft:Va,getAllDrafts:$a,getDraftsByStatus:Ke,updateDraftStatus:Ka,deleteDraft:Ge,clearSentDrafts:Ga,revokeImageURLs:He,migrateFromLocalStorage:_e},ee=()=>`report-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,xe={categoryId:null,category:null,location:null,locationNote:"",images:[],title:"",description:"",confirmed:!1,currentStep:1,createdAt:new Date,updatedAt:new Date,idempotencyKey:ee()},Ee="etijucas-report-draft",Z="active-report-draft";function Ha(){const[a,t]=u.useState(()=>({...xe,idempotencyKey:ee()})),[s,r]=u.useState(!0),i=u.useRef(null),d=u.useRef(!0);u.useEffect(()=>{d.current=!0;async function p(){try{await _e();const g=await Y.getDraft(Z);g&&d.current&&t(g)}catch(g){console.error("[useReportDraft] Error loading draft:",g);try{const N=localStorage.getItem(Ee);if(N){const S=JSON.parse(N);d.current&&t({...xe,...S,createdAt:new Date(S.createdAt||Date.now()),updatedAt:new Date(S.updatedAt||Date.now()),images:[],idempotencyKey:S.idempotencyKey||ee()})}}catch(N){console.error("[useReportDraft] localStorage fallback failed:",N)}}finally{d.current&&r(!1)}}return p(),()=>{d.current=!1,i.current&&clearTimeout(i.current)}},[]);const l=u.useCallback(async p=>{i.current&&clearTimeout(i.current),i.current=setTimeout(async()=>{try{const g={...p,idempotencyKey:Z};await Y.saveDraft(g,"draft")}catch(g){console.error("[useReportDraft] Error saving draft:",g)}},500)},[]),m=u.useCallback(p=>{t(g=>{const N={...g,...p,updatedAt:new Date};return l(N),N})},[l]),o=u.useCallback(p=>{t(g=>{if(g.images.length>=3)return g;const N={...g,images:[...g.images,p],updatedAt:new Date};return l(N),N})},[l]),x=u.useCallback(p=>{t(g=>{const N=g.images.find(I=>I.id===p);N&&URL.revokeObjectURL(N.previewUrl);const S={...g,images:g.images.filter(I=>I.id!==p),updatedAt:new Date};return l(S),S})},[l]),f=u.useCallback(p=>{m({currentStep:p})},[m]),b=u.useCallback(()=>{t(p=>{if(p.currentStep<4){const g=p.currentStep+1,N={...p,currentStep:g,updatedAt:new Date};return l(N),N}return p})},[l]),h=u.useCallback(()=>{t(p=>{if(p.currentStep>1){const g=p.currentStep-1,N={...p,currentStep:g,updatedAt:new Date};return l(N),N}return p})},[l]),v=u.useCallback(async()=>{He(a.images);try{await Y.deleteDraft(Z)}catch(p){console.error("[useReportDraft] Error deleting draft:",p)}localStorage.removeItem(Ee),t({...xe,idempotencyKey:ee()})},[a.images]),D=u.useCallback(async()=>{i.current&&clearTimeout(i.current);try{const p={...a,idempotencyKey:Z};await Y.saveDraft(p,"draft")}catch(p){console.error("[useReportDraft] Error saving draft:",p)}},[a]);return{draft:a,isLoading:s,updateDraft:m,addImage:o,removeImage:x,goToStep:f,nextStep:b,prevStep:h,clearDraft:v,saveDraft:D}}const _a=["Categoria","Localização","Fotos","Revisão"],Wa={enter:a=>({x:a>0?"100%":"-100%",opacity:0}),center:{x:0,opacity:1},exit:a=>({x:a<0?"100%":"-100%",opacity:0})};function Mt(){const a=Te(),{isAuthenticated:t}=Ye();if(!t)return e.jsx(ea,{title:"Cadastre-se ou entre",message:"Para enviar uma denúncia, você precisa estar cadastrado no aplicativo.",returnUrl:"/denuncia/nova"});const{draft:s,isLoading:r,updateDraft:i,nextStep:d,prevStep:l,clearDraft:m}=Ha(),[o,x]=u.useState(0),[f,b]=u.useState(!1),[h,v]=u.useState(null),{createReport:D}=pa(),p=u.useCallback(C=>{x(C>s.currentStep?1:-1),i({currentStep:C})},[s.currentStep,i]),g=u.useCallback(()=>{x(1),d()},[d]),N=u.useCallback(()=>{x(-1),l()},[l]),S=u.useCallback(async()=>{if(!s.categoryId){H.error("Selecione uma categoria para a denúncia");return}if(!s.title||s.title.trim().length<5){H.error("O título deve ter pelo menos 5 caracteres");return}try{const C={categoryId:s.categoryId,title:s.title.trim(),description:s.description.trim(),images:s.images.map(n=>n.file)};s.location&&(C.addressText=s.location.address,C.addressSource=s.location.source,C.locationQuality=s.location.quality,C.latitude=s.location.latitude,C.longitude=s.location.longitude,C.locationAccuracyM=s.location.accuracy?Math.min(Math.round(s.location.accuracy),1e4):void 0);const V=await D({payload:C,idempotencyKey:s.idempotencyKey});v(V.protocol),b(!0),m(),H.success("Denúncia enviada com sucesso!")}catch(C){console.error("Error submitting report:",C),H.error("Erro ao enviar denúncia. Tente novamente.")}},[s,D,m]),I=()=>{s.categoryId||s.location||s.images.length>0?window.confirm("Tem certeza que deseja sair? Seu rascunho será salvo.")&&a(-1):a(-1)},G=()=>{a("/")};return r?e.jsx("div",{className:"fixed inset-0 z-50 bg-background flex items-center justify-center",children:e.jsx(L,{className:"h-8 w-8 animate-spin text-primary"})}):f&&h?e.jsx(Ia,{protocolNumber:h,onClose:G}):e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"shrink-0 bg-background/95 backdrop-blur-lg border-b safe-top",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsx(y,{variant:"ghost",size:"icon",onClick:I,className:"rounded-full",children:e.jsx(ha,{className:"h-5 w-5"})}),e.jsx("h1",{className:"font-semibold text-lg",children:"Enviar Denúncia"}),e.jsx(y,{variant:"ghost",size:"icon",onClick:I,className:"rounded-full",children:e.jsx(Ne,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"px-4 pb-4",children:e.jsx(Na,{currentStep:s.currentStep,totalSteps:4,labels:_a})})]}),e.jsx("main",{className:"flex-1 overflow-hidden",children:e.jsx(ae,{mode:"wait",custom:o,children:e.jsxs(j.div,{custom:o,variants:Wa,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},className:"h-full overflow-y-auto px-4 pt-4 pb-32",children:[s.currentStep===1&&e.jsx(wa,{draft:s,onUpdate:i,onNext:g}),s.currentStep===2&&e.jsx(ka,{draft:s,onUpdate:i,onNext:g,onBack:N}),s.currentStep===3&&e.jsx(Sa,{draft:s,onUpdate:i,onNext:g,onBack:N}),s.currentStep===4&&e.jsx(Da,{draft:s,onUpdate:i,onBack:N,onGoToStep:p,onSubmit:S})]},s.currentStep)})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[60]",children:e.jsx(Ze,{activeTab:"reportar",onTabChange:C=>a(`/?tab=${C}`)})})]})}export{Mt as default};
