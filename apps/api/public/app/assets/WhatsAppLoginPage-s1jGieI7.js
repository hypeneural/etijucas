import{r as a,u as K,E as J,F as Q,j as e,m as r,z as R,l as Y,x as Z,o as ee,G as te,H as se,U as ae,S as re}from"./vendor-app-B8taUZN0.js";import{B as ne}from"./button-CjHDq6e1.js";import{C as ie}from"./card-CQBU6rkv.js";import{P as oe}from"./PhoneInput-zk9j3WGH.js";import{c as O}from"./index-7lqVfN1E.js";import"./input-BQyquuqq.js";import"./label-BnSrh78J.js";import"./slider-BNCctWOT.js";import{v as q,c as ce,a as D}from"./auth.service-2WiSOYkP.js";import{u as le}from"./useAuthStore-By3YEH0U.js";import"./useHaptics-BLro82Ls.js";import"./client-BdVdTjkU.js";import"./middleware-WYGlAF-S.js";function de(x){const u=x.match(/\b(\d{6})\b/);return u?u[1]:null}function me(){const[x,u]=a.useState(null),[v,h]=a.useState(!1),l=typeof navigator<"u"&&"clipboard"in navigator&&typeof navigator.clipboard.readText=="function",o=a.useCallback(async()=>{if(!l)return null;try{const n=await navigator.clipboard.readText(),f=de(n);if(f)return u(f),h(!1),f}catch(n){console.debug("Clipboard read failed:",n)}return null},[l]),g=a.useCallback(()=>{u(null),h(!1)},[]);return a.useEffect(()=>{if(!l)return;const n=()=>{document.visibilityState==="visible"&&(h(!0),setTimeout(()=>{h(!1)},1e4))};return document.addEventListener("visibilitychange",n),()=>{document.removeEventListener("visibilitychange",n)}},[l]),{detectedCode:x,showPasteChip:v,readClipboard:o,clearDetectedCode:g,isSupported:l}}function Se(){const x=K(),u=J(),[v]=Q(),h=le(t=>t.setAuth),l=u.state?.phone,[o,g]=a.useState("phone"),[n,f]=a.useState(l||""),[k,T]=a.useState(null),[M,V]=a.useState(null),[b,y]=a.useState(""),[P,E]=a.useState(300),[m,j]=a.useState(0),[W,$]=a.useState(!1),[A,d]=a.useState(!1),[N,c]=a.useState(null),C=a.useRef([]),{detectedCode:w,showPasteChip:F,readClipboard:_,clearDetectedCode:B}=me(),I=q(ce(n));a.useEffect(()=>{const t=v.get("sid");t&&z(t)},[v]),a.useEffect(()=>{l&&q(l)&&!W&&!k&&($(!0),L())},[l]),a.useEffect(()=>{w&&o==="otp"&&(y(w),d(!0),setTimeout(()=>{S(w)},300))},[w]),a.useEffect(()=>{if(m<=0)return;const t=setInterval(()=>{j(s=>Math.max(0,s-1))},1e3);return()=>clearInterval(t)},[m]),a.useEffect(()=>{if(o!=="otp"||P<=0)return;const t=setInterval(()=>{E(s=>s<=1?(c("Código expirado. Solicite novo código."),0):s-1)},1e3);return()=>clearInterval(t)},[o,P]);const z=async t=>{d(!0),c(null);try{const s=await D.getOtpSession(t);T(t),V(s.maskedPhone),E(s.expiresIn),j(s.cooldown),g("otp")}catch(s){s.status===410?c("Link expirado. Digite seu telefone para receber novo código."):c("Link inválido.")}finally{d(!1)}},L=async t=>{if(t?.preventDefault(),!!I){d(!0),c(null);try{const s=await D.requestOtpLogin(n);T(s.sid),E(s.expiresIn),j(s.cooldown),g("otp")}catch(s){s.data?.code==="RATE_LIMITED"?(c(`Aguarde ${s.data.retryAfter}s para solicitar novo código.`),j(s.data.retryAfter)):c(s.message||"Erro ao enviar código")}finally{d(!1)}}},S=async t=>{const s=t||b;if(!(s.length!==6||!k)){d(!0),c(null);try{const i=await D.verifyOtpLogin(k,s);"vibrate"in navigator&&navigator.vibrate([50,50,100]),h(i.user,i.token,i.refreshToken),g("success"),B(),setTimeout(()=>{i.next_step==="onboarding"?x("/",{replace:!0}):x("/",{replace:!0})},1500)}catch(i){const p=i.data?.code;p==="OTP_INVALID"?(c("Código incorreto. Tente novamente."),y(""),C.current[0]?.focus()):p==="OTP_EXPIRED"||p==="SID_EXPIRED"?(c("Código expirado. Solicite novo código."),g("phone")):c(i.message||"Erro ao verificar código")}finally{d(!1)}}},U=(t,s)=>{if(!/^\d*$/.test(s))return;const i=b.split("");i[t]=s.slice(-1);const p=i.join("").slice(0,6);y(p),s&&t<5&&C.current[t+1]?.focus(),p.length===6&&(d(!0),S(p))},X=t=>{t.preventDefault();const s=t.clipboardData.getData("text").replace(/\D/g,"").slice(0,6);s.length===6&&(y(s),d(!0),S(s))},G=async()=>{const t=await _();t&&(y(t),S(t))},H=t=>{const s=Math.floor(t/60),i=t%60;return`${s}:${i.toString().padStart(2,"0")}`};return e.jsxs("div",{className:"min-h-screen flex flex-col bg-gradient-to-br from-green-500/5 via-background to-green-600/10",children:[e.jsxs(r.div,{initial:{opacity:0,y:-30},animate:{opacity:1,y:0},transition:{duration:.6},className:"pt-12 pb-8 px-6 text-center",children:[e.jsx(r.div,{initial:{scale:.8},animate:{scale:1},transition:{type:"spring",bounce:.5,delay:.2},className:"inline-flex p-4 rounded-3xl bg-gradient-to-br from-green-500 to-green-600 shadow-xl shadow-green-500/30 mb-4",children:e.jsx(R,{className:"h-12 w-12 text-white"})}),e.jsx(r.h1,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"text-3xl font-bold bg-gradient-to-r from-green-600 to-green-500 bg-clip-text text-transparent",children:"eTijucas"}),e.jsxs(r.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.4},className:"text-muted-foreground mt-1",children:[o==="phone"&&"Login rápido via WhatsApp",o==="otp"&&"Digite o código recebido",o==="success"&&"Bem-vindo!"]})]}),e.jsx(r.div,{initial:{opacity:0,y:30},animate:{opacity:1,y:0},transition:{duration:.5,delay:.3},className:"flex-1 px-6",children:e.jsx(ie,{className:"p-6 shadow-xl border-0 bg-background/80 backdrop-blur-xl",children:e.jsxs(Y,{mode:"wait",children:[o==="phone"&&e.jsxs(r.form,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},onSubmit:L,className:"space-y-6",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Seu número WhatsApp"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Enviaremos um código de 6 dígitos"})]}),e.jsx(oe,{value:n,onChange:f,error:void 0,autoFocus:!0}),N&&e.jsx(r.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 rounded-xl bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 text-center",children:N})}),e.jsx(ne,{type:"submit",size:"lg",disabled:!I||A||m>0,className:O("w-full h-14 text-lg font-semibold rounded-2xl","bg-gradient-to-r from-green-500 to-green-600","shadow-lg shadow-green-500/30",I&&"hover:shadow-xl hover:shadow-green-500/40"),children:A?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-5 w-5 mr-2 animate-spin"}),"Enviando..."]}):m>0?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"h-5 w-5 mr-2"}),"Aguarde ",m,"s"]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"h-5 w-5 mr-2"}),"Receber código via WhatsApp"]})})]},"phone"),o==="otp"&&e.jsxs(r.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"space-y-6",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Verifique seu WhatsApp"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Código enviado para ",M||`(${n.slice(0,2)}) *****-${n.slice(-4)}`]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Expira em ",H(P)]})]}),F&&e.jsxs(r.button,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},onClick:G,className:"w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-green-500/10 border border-green-500/30 text-green-600 hover:bg-green-500/20 transition-all",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Colar código do WhatsApp"})]}),e.jsx("div",{className:"flex justify-center gap-3",onPaste:X,children:[0,1,2,3,4,5].map(t=>e.jsx("input",{ref:s=>C.current[t]=s,type:"text",inputMode:"numeric",maxLength:1,value:b[t]||"",onChange:s=>U(t,s.target.value),onKeyDown:s=>{s.key==="Backspace"&&!b[t]&&t>0&&C.current[t-1]?.focus()},className:O("w-12 h-14 text-center text-2xl font-bold rounded-xl border-2 transition-all","focus:border-green-500 focus:ring-2 focus:ring-green-500/20",b[t]?"border-green-500 bg-green-50 dark:bg-green-950/30":"border-border bg-muted/50")},t))}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["1. Vá ao WhatsApp e toque em ",e.jsx("span",{className:"font-medium text-green-600",children:'"Copiar código"'})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["2. Volte aqui e toque em ",e.jsx("span",{className:"font-medium text-green-600",children:'"Colar código"'})]})]}),N&&e.jsx(r.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 rounded-xl bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 text-center",children:N})}),e.jsx("div",{className:"text-center",children:e.jsx("button",{onClick:()=>L(),disabled:m>0||A,className:"text-sm text-primary hover:underline disabled:text-muted-foreground disabled:no-underline",children:m>0?`Reenviar em ${m}s`:"Reenviar código"})})]},"otp"),o==="success"&&e.jsxs(r.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"py-8 text-center",children:[e.jsx(r.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",bounce:.5},className:"inline-flex p-6 rounded-full bg-green-500 mb-6",children:e.jsx(se,{className:"h-12 w-12 text-white"})}),e.jsx("h2",{className:"text-2xl font-bold text-green-600",children:"Login realizado!"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Redirecionando..."})]},"success")]})})}),e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},className:"py-8 px-6",children:e.jsxs("div",{className:"flex items-center justify-center gap-6 text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"text-sm font-medium",children:"1.234 moradores"})]}),e.jsx("div",{className:"w-px h-4 bg-border"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5 text-amber-500"}),e.jsx("span",{className:"text-sm font-medium",children:"App oficial"})]})]})})]})}export{Se as default};
