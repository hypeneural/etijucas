import{_ as h}from"./index-DnCE2Tlu.js";import{E as r,a as c}from"./client-BTgelhMB.js";import{c as g,t as i,s as p}from"./localDatabase-CsFe4LOc.js";function C(t,o=1,e=10){const a=(o-1)*e,n=a+e;return{data:t.slice(a,n),meta:{total:t.length,page:o,perPage:e,lastPage:Math.ceil(t.length/e),from:a+1,to:Math.min(n,t.length)}}}function v(t,o){if(!t||typeof t!="object")throw new Error(`Invalid API response: ${JSON.stringify(t)}`);const e=t;if("data"in e&&e.data)return e.data;if(o&&o in e&&e[o])return e[o];if("topic"in e&&e.topic)return e.topic;if("comment"in e&&e.comment)return e.comment;if("id"in e)return e;throw new Error(`Could not extract data from response: ${JSON.stringify(t)}`)}let k=!1;async function f(){k||(k=!0,(await i.getAll()).length)}const A={async getAll(t){await f();try{const o=await c.get(r.forum.topics,t);return o.data.length>0&&await i.saveMany(o.data),o}catch{let o=await i.getAll();if(t?.bairroId&&(o=o.filter(e=>e.bairroId===t.bairroId)),t?.categoria&&(o=o.filter(e=>e.categoria===t.categoria)),t?.search){const e=t.search.toLowerCase();o=o.filter(a=>a.titulo.toLowerCase().includes(e)||a.texto.toLowerCase().includes(e))}if(t?.comFoto&&(o=o.filter(e=>e.fotoUrl)),t?.orderBy){const e=t.order==="asc"?1:-1;o.sort((a,n)=>t.orderBy==="createdAt"?e*(new Date(n.createdAt).getTime()-new Date(a.createdAt).getTime()):t.orderBy==="likesCount"?e*(n.likesCount-a.likesCount):t.orderBy==="commentsCount"?e*(n.commentsCount-a.commentsCount):0)}return C(o,t?.page,t?.perPage)}},async getById(t){await f();try{const o=await c.get(r.forum.topic(t));return await i.save(o.data),o.data}catch{return i.getById(t)}},async create(t){await f();const o=`topic-${JSON.stringify(t)}-${Date.now()}`;try{console.log("[TopicService] Creating topic:",t);const e=await c.post(r.forum.createTopic,t);console.log("[TopicService] API response:",e);const a=v(e,"topic");return console.log("[TopicService] ✅ Topic created successfully:",a.id),await i.save(a),a}catch(e){console.error("[TopicService] ❌ Failed to create topic:",e);const a={...t,id:`topic-local-${Date.now()}`,createdAt:new Date,likesCount:0,commentsCount:0,liked:!1,isSaved:!1,isAnon:t.isAnon??!1,syncStatus:"pending"};throw await i.save(a),await p.exists(o)||await p.add({type:"topic",data:{...t,localId:a.id},idempotencyKey:o}),e}},async update(t,o){const e=await c.put(r.forum.updateTopic(t),o);return await i.save(e.data),e.data},async delete(t){await c.delete(r.forum.deleteTopic(t)),await i.delete(t)},async toggleLike(t){await f();const o=`like-${t}-${Date.now()}`;try{const e=await c.post(r.forum.likeTopic(t));return await i.getById(t)&&await i.update(t,{liked:e.liked,likesCount:e.likesCount}),e}catch{const e=await i.getById(t),a=!e?.liked,n=(e?.likesCount??0)+(a?1:-1);return e&&await i.update(t,{liked:a,likesCount:Math.max(0,n)}),await p.exists(o)||await p.add({type:"like",data:{topicId:t},idempotencyKey:o}),{liked:a,likesCount:Math.max(0,n)}}},async toggleSave(t){const o=await c.post(r.forum.saveTopic(t));return await i.getById(t)&&await i.update(t,{isSaved:o.saved}),o},async getSaved(t){return c.get(r.forum.savedTopics,t)},async report(t,o){return c.post(r.forum.reportTopic(t),o)},async getComments(t,o){try{const e=await c.get(r.forum.comments(t),o);for(const a of e.data)await g.save(a);return e}catch{const e=await g.getByTopicId(t);return C(e,o?.page,o?.perPage)}},async addComment(t,o){const e=`comment-${t}-${JSON.stringify(o)}-${Date.now()}`;try{console.log("[TopicService] Adding comment to topic:",t,o);const a=await c.post(r.forum.comments(t),o);console.log("[TopicService] Comment API response:",a);const n=v(a,"comment");console.log("[TopicService] ✅ Comment added successfully:",n.id),await g.save(n);const s=await i.getById(t);return s&&await i.update(t,{commentsCount:s.commentsCount+1}),n}catch(a){console.error("[TopicService] ❌ Failed to add comment:",a);const n={id:`comment-local-${Date.now()}`,topicId:t,parentId:o.parentId,texto:o.texto,imageUrl:o.imageUrl,isAnon:o.isAnon??!1,likesCount:0,liked:!1,depth:o.parentId?1:0,createdAt:new Date,autor:{id:null,nome:o.isAnon?"Anônimo":"Você",avatarUrl:null}};await g.save(n);const s=await i.getById(t);throw s&&await i.update(t,{commentsCount:s.commentsCount+1}),await p.exists(e)||await p.add({type:"comment",data:{topicId:t,...o,localId:n.id},idempotencyKey:e}),a}},async deleteComment(t,o){await c.delete(r.forum.deleteComment(t,o)),await g.delete(o);const e=await i.getById(t);e&&await i.update(t,{commentsCount:Math.max(0,e.commentsCount-1)})},async toggleCommentLike(t){return c.post(r.forum.likeComment(t))},async reportComment(t,o){return c.post(r.forum.reportComment(t),o)},async uploadImage(t){const o=new FormData;o.append("file",t);const{getAuthToken:e}=await h(async()=>{const{getAuthToken:l}=await import("./client-BTgelhMB.js").then(d=>d.d);return{getAuthToken:l}},[]),a=e();if(!a)throw new Error("Você precisa estar logado para enviar imagens");const{API_CONFIG:n}=await h(async()=>{const{API_CONFIG:l}=await import("./client-BTgelhMB.js").then(d=>d.b);return{API_CONFIG:l}},[]),u=`${n.baseURL.endsWith("/")?n.baseURL.slice(0,-1):n.baseURL}${r.forum.upload}`;console.log("[topicService.uploadImage] Uploading to:",u),console.log("[topicService.uploadImage] Token present:",!!a);const m=await fetch(u,{method:"POST",headers:{Authorization:`Bearer ${a}`,Accept:"application/json"},body:o});if(console.log("[topicService.uploadImage] Response status:",m.status),!m.ok){if(m.status===413)throw new Error("Imagem muito grande. Máximo 5MB.");if(m.status===401)throw new Error("Sessão expirada. Faça login novamente.");const l=await m.json().catch(()=>({}));throw new Error(l.message||"Falha no upload da imagem")}const w=await m.json();return console.log("[topicService.uploadImage] Success:",w),w},async like(t){await this.toggleLike(t)},async unlike(t){await this.toggleLike(t)}};function I(t){const o=new Date,e=new Date(t),a=o.getTime()-e.getTime(),n=Math.floor(a/1e3),s=Math.floor(n/60),u=Math.floor(s/60),m=Math.floor(u/24);if(s<1)return"agora";if(s<60)return`há ${s} min`;if(u<24)return`há ${u}h`;if(m===1)return"ontem";if(m<7)return`há ${m} dias`;if(m<30){const y=Math.floor(m/7);return y===1?"há 1 semana":`há ${y} semanas`}const w=["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"],l=e.getDate(),d=w[e.getMonth()];return e.getFullYear()===o.getFullYear()?`${l} ${d}`:`${l} ${d} ${e.getFullYear()}`}function $(t){return new Date(t).toLocaleDateString("pt-BR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function x(t,o,e){const a=(Date.now()-new Date(e).getTime())/36e5;return(t+o*2)/Math.pow(a+2,1.8)}export{$ as a,x as c,I as f,A as t};
