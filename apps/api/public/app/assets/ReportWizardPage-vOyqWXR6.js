import{j as e,ba as ze,M as V,ad as F,bb as He,m as j,H as Qe,r as u,bc as W,l as ee,X as ye,x as L,a5 as Xe,ah as xe,bd as Ye,be as Je,bf as Te,o as _,aA as Q,ak as H,n as R,ae as re,at as Ne,bg as Ze,bh as ea,bi as ne,af as ie,bj as aa,a$ as Re,bk as oe,bl as Le,b2 as ta,u as Be,S as sa,_ as ra,bm as na,au as ia,$ as oa,bn as ca,Y as la}from"./vendor-app-DyDkrbNW.js";import{B as y}from"./button-rd3rBob2.js";import{c as A,a as G,u as da}from"./index-CQVPWHim.js";import{C as k}from"./card-CcrU79oJ.js";import{C as Pe,r as ve}from"./CategoryIcon-BZ9Ak2Ey.js";import{u as Fe,L as ma}from"./LoginRequired-D--UmI7b.js";import{I as pe}from"./input-CqBQDI_M.js";import{L as ua}from"./LocationMap-BCNaNgYB.js";import{g as ce}from"./uuid-BwYzP5ph.js";import{B as xa}from"./badge-DgC2oxnQ.js";import{C as pa}from"./checkbox-dJwkxWCh.js";import{T as ha}from"./textarea-C0nX8su5.js";import{c as le}from"./confetti.module-B5JVzsfH.js";import{u as ga}from"./useMyReports-DL3Jp-2Q.js";import{u as fa}from"./useAuthStore-dcnsAM5M.js";import{B as ba}from"./BottomTabBar-K0G579oo.js";import"./useHaptics-UcE4g0r2.js";import"./client-w4Cmw8pS.js";import"./localDatabase-B2l5vAIX.js";import"./iconify-DDzaKV6Z.js";import"./vendor-maps-BwQvLl0K.js";import"./middleware-WYGlAF-S.js";const ja=[{icon:ze,label:"Categoria"},{icon:V,label:"Localização"},{icon:F,label:"Fotos"},{icon:He,label:"Revisão"}];function ya({currentStep:a,totalSteps:t,labels:s}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:ja.slice(0,t).map((r,n)=>{const d=n+1,l=d<a,m=d===a,o=r.icon;return e.jsxs("div",{className:"flex flex-col items-center flex-1",children:[n>0&&e.jsx("div",{className:A("absolute h-0.5 -translate-y-4",l||m?"bg-primary":"bg-muted"),style:{width:`calc(100% / ${t} - 2rem)`,left:`calc((100% / ${t}) * ${n} + 1rem)`}}),e.jsx(j.div,{initial:{scale:.8},animate:{scale:m?1.1:1},className:A("relative z-10 h-10 w-10 rounded-full flex items-center justify-center transition-all",l&&"bg-primary text-primary-foreground",m&&"bg-primary text-primary-foreground ring-4 ring-primary/20",!l&&!m&&"bg-muted text-muted-foreground"),children:l?e.jsx(Qe,{className:"h-5 w-5"}):e.jsx(o,{className:"h-5 w-5"})}),e.jsx("span",{className:A("text-xs mt-1.5 font-medium text-center",m&&"text-primary",l&&"text-foreground",!l&&!m&&"text-muted-foreground"),children:s?.[n]||r.label})]},d)})}),e.jsx("div",{className:"relative -mt-[3.2rem] mx-5 h-0.5 bg-muted rounded-full",children:e.jsx(j.div,{className:"h-full bg-primary rounded-full",initial:{width:0},animate:{width:`${(a-1)/(t-1)*100}%`},transition:{type:"spring",stiffness:300,damping:30}})}),e.jsx("div",{className:"h-4"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsxs("span",{className:"font-semibold text-primary",children:["Etapa ",a]}),e.jsxs("span",{className:"text-muted-foreground",children:["de ",t]})]})]})}function Na({title:a,content:t,className:s}){const[r,n]=u.useState(!1),d=Array.isArray(t)?t:[t];return e.jsxs("div",{className:A("inline-flex items-center gap-1",s),children:[e.jsx(j.button,{type:"button",whileTap:{scale:.9},onClick:()=>n(!0),className:"flex h-5 w-5 items-center justify-center rounded-full bg-muted hover:bg-muted/80 transition-colors","aria-label":`Ajuda sobre ${a}`,children:e.jsx(W,{className:"h-3 w-3 text-muted-foreground"})}),e.jsx(ee,{children:r&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>n(!1)}),e.jsxs(j.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 safe-bottom",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"flex items-start justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(W,{className:"h-4 w-4 text-primary"})}),e.jsx("h3",{className:"font-semibold text-lg",children:a})]}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full",onClick:()=>n(!1),children:e.jsx(ye,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-4 space-y-2",children:d.map((l,m)=>e.jsxs("p",{className:"text-sm text-muted-foreground flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"•"}),e.jsx("span",{children:l})]},m))}),e.jsx(y,{className:"w-full mt-6",onClick:()=>n(!1),children:"Entendi"})]})]})})]})}function ae({title:a,subtitle:t,helpTitle:s,helpContent:r}){return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-2xl font-bold",children:a}),r&&e.jsx(Na,{title:s||a,content:r})]}),t&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t})]})}function va({draft:a,onUpdate:t,onNext:s}){const{categories:r,isLoading:n,error:d,refetch:l}=Fe(),m=r.find(f=>f.id===a.categoryId),o=f=>{t({categoryId:f.id,category:f})},x=!!a.categoryId;return n?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(L,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando categorias..."})]}):d?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(Xe,{className:"h-12 w-12 text-destructive"}),e.jsx("p",{className:"text-muted-foreground text-center",children:"Erro ao carregar categorias."}),e.jsx(y,{onClick:()=>l(),variant:"outline",children:"Tentar novamente"})]}):e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(ae,{title:"O que aconteceu?",subtitle:"Escolha a categoria que melhor descreve o problema",helpTitle:"Como escolher a categoria",helpContent:["Escolha a categoria que mais combina com o problema que você quer reportar.","Se tiver dúvida, escolha 'Outros' e descreva com suas palavras.","Não se preocupe em acertar perfeitamente, nossa equipe vai analisar."]}),e.jsx(k,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsx("div",{children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("span",{className:"font-medium",children:"Toque em uma categoria"})," para selecioná-la. Depois você pode detalhar melhor o problema."]})})]})}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:r.map((f,b)=>{const h=a.categoryId===f.id;return e.jsxs(j.button,{type:"button",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:b*.03},whileTap:{scale:.95},onClick:()=>o(f),className:A("relative flex flex-col items-center gap-2 rounded-2xl border-2 p-3 text-center transition-all",h?"border-primary bg-primary/10 shadow-lg":"border-border bg-card hover:bg-muted/50 hover:border-muted-foreground/30"),style:{borderColor:h?f.color:void 0,backgroundColor:h?`${f.color}10`:void 0},children:[e.jsx(Pe,{icon:f.icon,color:f.color,size:"lg",withBackground:!0}),e.jsx("span",{className:A("text-[11px] leading-tight font-semibold line-clamp-2",h?"text-primary":"text-slate-700 dark:text-slate-300"),style:{color:h?f.color:void 0},children:f.name}),h&&e.jsx(j.div,{initial:{scale:0},animate:{scale:1},className:"absolute -top-1 -right-1 h-5 w-5 rounded-full flex items-center justify-center",style:{backgroundColor:f.color},children:e.jsx(xe,{className:"h-3 w-3 text-white"})})]},f.id)})}),m&&m.tips.length>0&&e.jsx(j.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"space-y-3",children:e.jsx(k,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-amber-100 dark:bg-amber-900/50",children:e.jsx(Ye,{className:"h-4 w-4 text-amber-600 dark:text-amber-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-medium text-amber-800 dark:text-amber-300",children:['Dicas para "',m.name,'"']}),e.jsx("ul",{className:"mt-2 space-y-1",children:m.tips.map((f,b)=>e.jsxs("li",{className:"text-sm text-amber-700 dark:text-amber-400 flex gap-2",children:[e.jsx("span",{className:"shrink-0",children:"•"}),e.jsx("span",{children:f})]},b))})]})]})})}),!a.categoryId&&e.jsx(k,{className:"p-4 border-muted bg-muted/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-muted",children:e.jsx(Je,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione uma categoria acima para continuar"})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx(y,{size:"lg",className:A("w-full h-14 text-base font-semibold rounded-2xl transition-all",!x&&"opacity-50"),disabled:!x,onClick:s,children:x?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(xe,{className:"h-5 w-5 ml-2"})]}):"Selecione uma categoria"})})})]})}function wa({draft:a,onUpdate:t,onNext:s,onBack:r}){const[n,d]=u.useState({status:"idle"}),[l,m]=u.useState(!1),[o,x]=u.useState(""),[f,b]=u.useState([]),[h,v]=u.useState(!1),[D,p]=u.useState(!1),g=u.useCallback(async(i,c)=>{try{p(!0);const w=await ve.geocodeReverse(i,c);return w?.address||w?.displayName}catch(w){console.warn("[StepLocation] Reverse geocode failed:",w);return}finally{p(!1)}},[]),N=u.useCallback(async()=>{if(!navigator.geolocation){d({status:"error",errorMessage:"Seu navegador não suporta geolocalização. Tente usar Chrome, Safari ou Firefox."});return}d({status:"requesting"}),navigator.geolocation.getCurrentPosition(async i=>{const c=i.coords.latitude,w=i.coords.longitude,E=await g(c,w),z={latitude:c,longitude:w,accuracy:i.coords.accuracy,address:E||"Tijucas, SC",source:"gps",quality:i.coords.accuracy<=50?"precisa":"aproximada"};t({location:z}),d({status:"success"})},i=>{let c="Não conseguimos acessar sua localização.";i.code===i.PERMISSION_DENIED?(c="Você não permitiu o acesso à sua localização.",d({status:"denied",errorMessage:c})):i.code===i.POSITION_UNAVAILABLE?(c="Não foi possível determinar sua localização. Verifique se o GPS está ativado.",d({status:"error",errorMessage:c})):i.code===i.TIMEOUT&&(c="Demorou muito para obter sua localização. Verifique sua conexão e tente novamente.",d({status:"error",errorMessage:c}))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4})},[t,g]),S=u.useRef(null),I=u.useCallback(async i=>{if(i.length<3){b([]);return}S.current&&S.current.abort(),S.current=new AbortController,v(!0);try{const c=a.location?.latitude,w=a.location?.longitude,E=await ve.geocodeAutocomplete(i,c,w);b(E)}catch(c){c.name!=="AbortError"&&console.warn("[StepLocation] Search failed:",c),b([])}finally{v(!1)}},[a.location?.latitude,a.location?.longitude]);u.useEffect(()=>{const i=setTimeout(()=>{o&&I(o)},300);return()=>{clearTimeout(i),S.current&&S.current.abort()}},[o,I]);const K=i=>{const c={latitude:i.latitude,longitude:i.longitude,accuracy:100,address:i.address||i.displayName,source:"manual",quality:"manual"};t({location:c}),d({status:"success"}),x(""),b([]),m(!1)};u.useEffect(()=>{!a.location&&n.status==="idle"&&N()},[a.location,n.status,N]);const C=!!a.location,U=({quality:i})=>{const c={precisa:{color:"text-green-600 bg-green-100",icon:Ze,label:"Precisa"},aproximada:{color:"text-amber-600 bg-amber-100",icon:V,label:"Aproximada"},manual:{color:"text-blue-600 bg-blue-100",icon:re,label:"Informada"}}[i]||{color:"text-gray-600 bg-gray-100",icon:V,label:"Desconhecida"},w=c.icon;return e.jsxs("span",{className:A("inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",c.color),children:[e.jsx(w,{className:"h-3 w-3"}),c.label]})};return e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(ae,{title:"Onde foi?",subtitle:"Precisamos saber o local do problema",helpTitle:"Por que precisamos da localização?",helpContent:["A localização ajuda nossa equipe a encontrar o problema rapidamente.","Usamos o GPS do seu celular para maior precisão.","Sua localização não é compartilhada publicamente, apenas com a equipe responsável."]}),e.jsx(k,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"Como funciona:"}),e.jsx("p",{children:"Usamos o GPS para marcar o local, ou você pode buscar o endereço manualmente."})]})]})}),e.jsxs("div",{className:"space-y-4",children:[n.status==="requesting"&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(L,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:D?"Buscando endereço...":"Buscando sua localização..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),n.status==="denied"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(V,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Localização bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:n.errorMessage}),e.jsxs(k,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700 text-left",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(Te,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Localização" para "Permitir"'})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4 w-full",children:[e.jsxs(y,{variant:"outline",className:"flex-1",onClick:N,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(y,{variant:"secondary",className:"flex-1",onClick:()=>m(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),n.status==="error"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(H,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Erro ao obter localização"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:n.errorMessage}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(y,{variant:"outline",className:"flex-1",onClick:N,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(y,{variant:"secondary",className:"flex-1",onClick:()=>m(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),a.location&&e.jsxs(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-4",children:[e.jsx(k,{className:"p-4 bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100 dark:bg-green-900/50",children:e.jsx(R,{className:"h-5 w-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-green-800 dark:text-green-300",children:"Localização capturada!"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(U,{quality:a.location.quality}),a.location.accuracy&&a.location.source==="gps"&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["±",Math.round(a.location.accuracy),"m"]})]})]})]})}),e.jsx(ua,{latitude:a.location.latitude,longitude:a.location.longitude,hasGPS:a.location.source==="gps",onLocationChange:async(i,c)=>{const w=await g(i,c);t({location:{...a.location,latitude:i,longitude:c,address:w||a.location.address,source:"mapa",quality:"precisa"}})},onCenterGPS:a.location.source==="gps"?N:void 0}),e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[D?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 animate-spin text-primary"}),e.jsx("span",{className:"text-muted-foreground",children:"Buscando endereço..."})]}):e.jsx("p",{className:"font-medium",children:a.location.address||"Localização capturada"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Coordenadas: ",a.location.latitude.toFixed(4),", ",a.location.longitude.toFixed(4)]})]}),e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>m(!0),children:[e.jsx(re,{className:"h-3.5 w-3.5 mr-1"}),"Buscar"]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4 text-muted-foreground"}),"Ponto de referência (opcional)"]}),e.jsx(pe,{placeholder:"Ex: Próximo ao Supermercado X",value:a.locationNote||"",onChange:i=>t({locationNote:i.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ajude a localizar o problema com uma referência"})]})]}),n.status==="idle"&&!a.location&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center py-8 gap-4",children:[e.jsxs(y,{size:"lg",onClick:N,className:"h-14 px-8 rounded-2xl",children:[e.jsx(Ne,{className:"h-5 w-5 mr-2"}),"Usar minha localização"]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"ou"}),e.jsxs(y,{variant:"outline",onClick:()=>m(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço manualmente"]})]})]}),e.jsx(ee,{children:l&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>m(!1)}),e.jsxs(j.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 pb-8 max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsx("h3",{className:"font-semibold text-lg mt-4",children:"Buscar endereço"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Digite o nome da rua ou local"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(pe,{placeholder:"Ex: Rua Principal, Centro, Tijucas",value:o,onChange:i=>x(i.target.value),className:"pl-10 h-12 rounded-xl",autoFocus:!0}),h&&e.jsx(L,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground"})]}),f.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:f.map((i,c)=>e.jsx(j.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:c*.05},onClick:()=>K(i),className:"w-full text-left p-3 rounded-xl border hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(V,{className:"h-5 w-5 text-primary shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:i.address}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:i.displayName})]})]})},i.placeId||c))}),o.length>=3&&f.length===0&&!h&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Nenhum resultado encontrado. Tente outro endereço."}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(y,{variant:"outline",className:"flex-1",onClick:()=>m(!1),children:"Cancelar"}),e.jsxs(y,{className:"flex-1",onClick:N,children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Usar GPS"]})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:r,children:"Voltar"}),e.jsx(y,{size:"lg",className:A("h-14 rounded-2xl flex-[2] text-base font-semibold",!C&&"opacity-50"),disabled:!C,onClick:s,children:C?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(xe,{className:"h-5 w-5 ml-2"})]}):"Aguardando localização..."})]})})]})}function we(a){if(a===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],r=Math.floor(Math.log(a)/Math.log(t));return`${parseFloat((a/Math.pow(t,r)).toFixed(1))} ${s[r]}`}async function ka(a,t={}){const{maxWidth:s=1200,maxHeight:r=1200,quality:n=.8,format:d="image/webp"}=t;return new Promise((l,m)=>{const o=new Image,x=document.createElement("canvas"),f=x.getContext("2d");if(!f){m(new Error("Canvas context not available"));return}o.onload=()=>{let{width:h,height:v}=o;h>s&&(v=v*s/h,h=s),v>r&&(h=h*r/v,v=r),h=Math.round(h),v=Math.round(v),x.width=h,x.height=v,f.imageSmoothingEnabled=!0,f.imageSmoothingQuality="high",f.drawImage(o,0,0,h,v);const D=x.toDataURL(d).startsWith("data:"+d)?d:"image/jpeg";x.toBlob(p=>{if(!p){m(new Error("Failed to compress image"));return}const g=x.toDataURL(D,n);l({blob:p,dataUrl:g,originalSize:a.size,compressedSize:p.size,compressionRatio:p.size/a.size,width:h,height:v})},D,n)},o.onerror=()=>{m(new Error("Failed to load image"))};const b=new FileReader;b.onload=h=>{o.src=h.target?.result},b.onerror=()=>{m(new Error("Failed to read file"))},b.readAsDataURL(a)})}const M=3;function Ca({draft:a,onUpdate:t,onNext:s,onBack:r}){const n=u.useRef(null),d=u.useRef(null),l=u.useRef(null),m=u.useRef(null),[o,x]=u.useState({status:"idle",facingMode:"environment",stream:null}),[f,b]=u.useState(!1),[h,v]=u.useState(null),D=typeof window<"u"&&window.isSecureContext,p=u.useCallback(async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){x(i=>({...i,status:"error",errorMessage:"Seu navegador não suporta acesso à câmera. Tente usar Chrome, Safari ou Firefox."}));return}x(i=>({...i,status:"requesting"}));try{const i=await navigator.mediaDevices.getUserMedia({video:{facingMode:o.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:!1});n.current&&(n.current.srcObject=i,await n.current.play()),x(c=>({...c,status:"active",stream:i,errorMessage:void 0}))}catch(i){if(console.error("Camera error:",i),i instanceof DOMException)if(i.name==="NotAllowedError")x(c=>({...c,status:"denied",errorMessage:"Você não permitiu o acesso à câmera."}));else if(i.name==="NotFoundError")x(c=>({...c,status:"error",errorMessage:"Nenhuma câmera foi encontrada no seu dispositivo."}));else if(i.name==="NotReadableError")x(c=>({...c,status:"error",errorMessage:"A câmera está sendo usada por outro aplicativo. Feche outros apps e tente novamente."}));else if(i.name==="OverconstrainedError"){x(c=>({...c,status:"error",errorMessage:"Sua câmera não atende aos requisitos. Tentando configuração alternativa..."}));try{const c=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});n.current&&(n.current.srcObject=c,await n.current.play()),x(w=>({...w,status:"active",stream:c,errorMessage:void 0}))}catch{x(c=>({...c,status:"error",errorMessage:"Não foi possível acessar sua câmera."}))}}else x(c=>({...c,status:"error",errorMessage:"Ocorreu um erro ao acessar a câmera. Tente novamente."}));else x(c=>({...c,status:"error",errorMessage:"Erro desconhecido ao acessar a câmera."}))}},[o.facingMode]),g=u.useCallback(()=>{o.stream&&o.stream.getTracks().forEach(i=>i.stop()),n.current&&(n.current.srcObject=null),x(i=>({...i,status:"idle",stream:null}))},[o.stream]);u.useEffect(()=>((async()=>{if(!navigator.mediaDevices?.enumerateDevices){v(!1);return}try{const w=(await navigator.mediaDevices.enumerateDevices()).some(E=>E.kind==="videoinput");v(w)}catch{v(!1)}})(),()=>{o.stream&&o.stream.getTracks().forEach(c=>c.stop())}),[]);const N=u.useCallback(async()=>{g(),x(i=>({...i,facingMode:i.facingMode==="environment"?"user":"environment"})),setTimeout(()=>p(),100)},[p,g]),S=u.useCallback(async()=>{if(!n.current||!d.current||a.images.length>=M)return;b(!0);const i=n.current,c=d.current,w=c.getContext("2d");if(!w){b(!1);return}c.width=i.videoWidth,c.height=i.videoHeight,w.drawImage(i,0,0),c.toBlob(E=>{if(!E){b(!1);return}const z=new File([E],`photo_${Date.now()}.jpg`,{type:"image/jpeg",lastModified:Date.now()}),$={id:ce(),file:z,previewUrl:URL.createObjectURL(E),capturedAt:new Date};t({images:[...a.images,$]}),b(!1),a.images.length+1>=M&&g()},"image/jpeg",.85)},[a.images,t,g]),I=u.useCallback(i=>{const c=a.images.find(w=>w.id===i);c&&URL.revokeObjectURL(c.previewUrl),t({images:a.images.filter(w=>w.id!==i)}),o.status==="idle"&&a.images.length<=M&&p()},[a.images,o.status,t,p]),K=u.useCallback(i=>{I(i),o.status!=="active"&&p()},[I,o.status,p]),C=u.useCallback(async i=>{const c=i.target.files;if(!c||c.length===0)return;const w=M-a.images.length,E=Array.from(c).slice(0,w);let z=0,$=0;for(const P of E)if(P.type.startsWith("image/"))try{const B=await ka(P,{maxWidth:1920,maxHeight:1920,quality:.75});z+=B.originalSize,$+=B.compressedSize;const se=new File([B.blob],P.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()}),We={id:ce(),file:se,previewUrl:URL.createObjectURL(B.blob),capturedAt:new Date};t({images:[...a.images,We]})}catch(B){console.error("Failed to compress image:",B);const se={id:ce(),file:P,previewUrl:URL.createObjectURL(P),capturedAt:new Date};t({images:[...a.images,se]})}if(z>0&&$<z){const P=z-$,B=Math.round(P/z*100);G.success(`Imagem otimizada: ${we(z)} → ${we($)} (-${B}%)`)}l.current&&(l.current.value="")},[a.images,t]),U=u.useCallback(()=>{l.current?.click()},[]);return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(ae,{title:"Adicione até 3 fotos",subtitle:"Tire fotos agora ou escolha da galeria",helpTitle:"Dicas para boas fotos",helpContent:["Fotografe de perto para mostrar detalhes do problema.","Inclua uma foto do contexto (rua, número, ponto de referência).","Evite fotos muito escuras ou desfocadas."]}),e.jsx("input",{ref:l,type:"file",accept:"image/*",multiple:!0,onChange:C,className:"hidden"}),e.jsx("input",{ref:m,type:"file",accept:"image/*",capture:"environment",onChange:C,className:"hidden"}),e.jsx(k,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-2 text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium",children:"Dicas para boas fotos:"}),e.jsxs("ul",{className:"space-y-1 text-blue-600 dark:text-blue-400",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto de perto do problema"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(ea,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto mostrando o contexto da rua"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Evite se colocar em risco"})]})]})]})]})}),e.jsxs("div",{className:"relative",children:[o.status==="idle"&&a.images.length<M&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10",children:e.jsx(F,{className:"h-10 w-10 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Adicione fotos do problema"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Fotos ajudam a identificar e resolver o problema mais rápido"})]}),!D&&e.jsx("div",{className:"w-full p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-400",children:[e.jsx(ne,{className:"h-4 w-4 shrink-0"}),e.jsx("p",{className:"text-xs text-left",children:"Câmera exige HTTPS. Use a galeria para adicionar fotos."})]})}),e.jsxs("div",{className:"w-full space-y-2",children:[D&&h!==!1&&e.jsxs(y,{onClick:()=>m.current?.click(),className:"w-full",size:"lg",disabled:h===null,children:[h===null?e.jsx(L,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(F,{className:"h-4 w-4 mr-2"}),"Tirar Foto"]}),e.jsxs(y,{variant:D&&h!==!1?"outline":"default",onClick:U,className:"w-full",size:"lg",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Escolher da Galeria"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Você pode pular e continuar sem fotos"})]})})}),o.status==="active"&&a.images.length<M&&e.jsxs(j.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative rounded-2xl overflow-hidden bg-muted aspect-[4/3]",children:[e.jsx("video",{ref:n,autoPlay:!0,playsInline:!0,muted:!0,"webkit-playsinline":"true","x-webkit-airplay":"allow",style:{backgroundColor:"transparent"},className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-4 left-0 right-0 flex items-center justify-center gap-4",children:[e.jsx(j.button,{whileTap:{scale:.9},onClick:N,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Trocar câmera",children:e.jsx(aa,{className:"h-5 w-5"})}),e.jsx(j.button,{whileTap:{scale:.9},onClick:S,disabled:f,className:A("p-1 rounded-full bg-white",f&&"opacity-50"),"aria-label":"Capturar foto",children:e.jsx("div",{className:"h-16 w-16 rounded-full border-4 border-primary flex items-center justify-center",children:f?e.jsx(L,{className:"h-6 w-6 text-primary animate-spin"}):e.jsx(F,{className:"h-6 w-6 text-primary"})})}),e.jsx(j.button,{whileTap:{scale:.9},onClick:U,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Escolher da galeria",children:e.jsx(ie,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"absolute top-4 right-4 px-3 py-1.5 rounded-full bg-black/50 text-white text-sm backdrop-blur-sm flex items-center gap-1",children:[e.jsx(F,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[a.images.length,"/",M]})]})]}),o.status==="requesting"&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"rounded-2xl bg-muted aspect-[4/3] flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(L,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:"Iniciando câmera..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),o.status==="denied"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(ne,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Câmera bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(k,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(Te,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado ou câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Câmera" para "Permitir"'})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"4."}),e.jsx("span",{children:"Recarregue a página ou toque no botão abaixo"})]})]})]}),e.jsxs(y,{variant:"outline",className:"mt-4 w-full",onClick:p,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),o.status==="error"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(k,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(H,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Problema com a câmera"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(k,{className:"w-full p-4 bg-white dark:bg-background border-red-200 dark:border-red-700",children:[e.jsx("p",{className:"font-medium text-sm mb-3",children:"O que você pode fazer:"}),e.jsxs("ul",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Verifique se seu dispositivo tem câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Feche outros aplicativos que usam a câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Tente acessar pelo celular em vez do computador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Você pode continuar sem foto (opcional)"})]})]})]}),e.jsxs(y,{variant:"outline",className:"mt-4 w-full",onClick:p,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),e.jsx("canvas",{ref:d,className:"hidden"})]}),a.images.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500"}),"Fotos capturadas (",a.images.length,"/",M,")"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(ee,{mode:"popLayout",children:a.images.map((i,c)=>e.jsxs(j.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},layout:!0,className:"relative aspect-square",children:[e.jsx("img",{src:i.previewUrl,alt:`Foto ${c+1}`,className:"w-full h-full object-cover rounded-xl"}),e.jsx("div",{className:"absolute top-2 left-2 h-6 w-6 rounded-full bg-primary text-primary-foreground text-xs font-bold flex items-center justify-center",children:c+1}),e.jsx("button",{type:"button",onClick:()=>I(i.id),className:"absolute -top-2 -right-2 h-7 w-7 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg hover:bg-red-600 transition-colors z-10","aria-label":"Remover foto",children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/70 to-transparent rounded-b-xl",children:e.jsxs("button",{type:"button",onClick:()=>K(i.id),className:"w-full px-2 py-1 text-xs bg-white/20 text-white rounded-md backdrop-blur-sm flex items-center justify-center gap-1",children:[e.jsx(_,{className:"h-3 w-3"}),"Refazer"]})})]},i.id))}),Array.from({length:M-a.images.length}).map((i,c)=>e.jsxs("button",{type:"button",onClick:()=>m.current?.click(),className:"aspect-square rounded-xl border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-1 hover:border-primary/50 hover:bg-primary/5 transition-colors cursor-pointer",children:[e.jsx(ie,{className:"h-5 w-5 text-muted-foreground/50"}),e.jsx("span",{className:"text-xs text-muted-foreground/50",children:"Adicionar"})]},`empty-${c}`))]})]}),a.images.length>=M&&e.jsx(k,{className:"p-4 text-center bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(R,{className:"h-5 w-5"}),e.jsxs("span",{className:"font-medium",children:["Você tirou ",M," fotos. Pronto para continuar!"]})]})}),a.images.length===0&&(o.status==="error"||o.status==="denied")&&e.jsx(k,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(H,{className:"h-5 w-5 text-amber-600 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800 dark:text-amber-300",children:"Continuar sem foto?"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-1",children:"Fotos ajudam muito a identificar o problema, mas você pode continuar sem elas."})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:()=>{g(),r()},children:"Voltar"}),e.jsxs(y,{size:"lg",className:"h-14 rounded-2xl flex-[2] text-base font-semibold",onClick:()=>{g(),s()},children:["Continuar",a.images.length===0&&e.jsx("span",{className:"text-xs ml-2 opacity-70",children:"(sem foto)"})]})]})})]})}function Sa({draft:a,onUpdate:t,onBack:s,onGoToStep:r,onSubmit:n}){const[d,l]=u.useState(!1),{categories:m}=Fe(),o=m.find(b=>b.id===a.categoryId),x=!!a.categoryId&&!!a.location&&a.confirmed&&!!a.title?.trim(),f=async()=>{if(x){l(!0);try{await n()}catch(b){console.error("Submit error:",b)}finally{l(!1)}}};return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(ae,{title:"Revisar e enviar",subtitle:"Adicione um título e confira as informações",helpTitle:"Última etapa!",helpContent:["Adicione um título curto que descreva o problema.","Revise todas as informações antes de enviar.","Após enviar, você receberá um número de protocolo."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4 text-muted-foreground"}),"Título da denúncia *"]}),e.jsx(pe,{placeholder:"Ex: Buraco grande na Rua Principal",value:a.title||"",onChange:b=>t({title:b.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Descreva o problema em poucas palavras (obrigatório)"})]}),e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[o?e.jsx(Pe,{icon:o.icon,color:o.color,size:"lg",withBackground:!0}):e.jsx("div",{className:"p-3 rounded-xl bg-muted",children:"❓"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Categoria"}),e.jsx("p",{className:"font-semibold",children:o?.name||"Não selecionada"})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(1),className:"text-primary",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(V,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-semibold",children:a.location?.address||"Localização capturada"}),a.location?.quality&&e.jsx(xa,{variant:"secondary",className:"mt-1 text-xs capitalize",children:a.location.quality})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(2),className:"text-primary",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsxs(k,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(F,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Fotos"}),e.jsxs("p",{className:"font-semibold",children:[a.images.length," ",a.images.length===1?"foto anexada":"fotos anexadas"]})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(3),className:"text-primary",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Editar"]})]}),a.images.length>0?e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:a.images.map((b,h)=>e.jsx("img",{src:b.previewUrl,alt:`Foto ${h+1}`,className:"h-20 w-20 rounded-lg object-cover shrink-0"},b.id))}):e.jsxs("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("p",{className:"text-sm",children:"Nenhuma foto anexada (opcional)"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4 text-muted-foreground"}),"Descrição adicional (opcional)"]}),e.jsx(ha,{placeholder:"Algum detalhe importante? (máx. 500 caracteres)",maxLength:500,value:a.description,onChange:b=>t({description:b.target.value}),className:"min-h-[100px] rounded-xl resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[a.description.length,"/500"]})]}),e.jsx(k,{className:A("p-4 transition-all border-2",a.confirmed?"border-green-400 bg-green-50 dark:bg-green-950/20 dark:border-green-700":"border-amber-400 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-700"),children:e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[e.jsx(pa,{checked:a.confirmed,onCheckedChange:b=>t({confirmed:!!b}),className:"mt-0.5 h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:A("font-medium",a.confirmed?"text-green-700 dark:text-green-300":"text-amber-700 dark:text-amber-300"),children:a.confirmed?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4"}),"Confirmado!"]}):"Confirmo que as informações são verdadeiras"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:a.confirmed?"Você confirmou que as informações são verdadeiras":"Marque para poder enviar a denúncia"})]})]})}),!x&&e.jsx(k,{className:"p-4 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(H,{className:"h-5 w-5 text-red-600 dark:text-red-400 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 dark:text-red-300",children:"Não é possível enviar ainda"}),e.jsxs("ul",{className:"text-sm text-red-700 dark:text-red-400 mt-1 space-y-1",children:[!a.title?.trim()&&e.jsx("li",{children:"• Adicione um título"}),!a.categoryId&&e.jsx("li",{children:"• Selecione uma categoria"}),!a.location&&e.jsx("li",{children:"• Capture sua localização"}),!a.confirmed&&e.jsx("li",{children:"• Confirme que as informações são verdadeiras"})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-14 rounded-2xl flex-1 text-base",onClick:s,disabled:d,children:"Voltar"}),e.jsx(y,{size:"lg",className:A("h-14 rounded-2xl flex-[2] text-base font-semibold",x?"bg-green-600 hover:bg-green-700":"opacity-50"),disabled:!x||d,onClick:f,children:d?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-5 w-5 mr-2 animate-spin"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ta,{className:"h-5 w-5 mr-2"}),"Enviar denúncia"]})})]})})]})}function Da({protocolNumber:a,onClose:t}){const{toast:s}=da(),r=Be(),n=u.useCallback(()=>{const o=Date.now()+3e3,x={startVelocity:30,spread:360,ticks:60,zIndex:100},f=(h,v)=>Math.random()*(v-h)+h,b=setInterval(()=>{const h=o-Date.now();if(h<=0)return clearInterval(b);const v=50*(h/3e3);le({...x,particleCount:v,origin:{x:f(.1,.3),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),le({...x,particleCount:v,origin:{x:f(.7,.9),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]})},250);return le({particleCount:100,spread:70,origin:{y:.6},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),()=>clearInterval(b)},[]);u.useEffect(()=>n(),[n]);const d=async()=>{try{await navigator.clipboard.writeText(a),s({title:"Protocolo copiado!",description:"Cole onde quiser para guardar."})}catch{s({title:"Erro ao copiar",description:"Tente copiar manualmente.",variant:"destructive"})}},l=async()=>{if(navigator.share)try{await navigator.share({title:"Denúncia Enviada - eTijucas",text:`Minha denúncia foi registrada com sucesso! Protocolo: ${a}`})}catch{console.log("Share cancelled")}else d()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-gradient-to-b from-green-50 to-background dark:from-green-950/30 dark:to-background flex flex-col items-center justify-center p-6 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(6)].map((m,o)=>e.jsx(j.div,{initial:{opacity:0,scale:0},animate:{opacity:[0,.3,0],scale:[0,1.5,2],x:Math.random()*100-50,y:Math.random()*100-50},transition:{duration:3,delay:o*.3,repeat:1/0,repeatDelay:2},className:"absolute rounded-full bg-green-400/20",style:{width:100+o*30,height:100+o*30,left:`${20+o*10}%`,top:`${15+o*12}%`}},o))}),e.jsxs(j.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},transition:{duration:.5},className:"relative z-10 w-full max-w-sm flex flex-col items-center text-center",children:[e.jsxs(j.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},className:"relative mb-6",children:[e.jsx("div",{className:"p-6 rounded-full bg-green-100 dark:bg-green-900/50 shadow-lg shadow-green-500/20",children:e.jsx(R,{className:"h-20 w-20 text-green-600 dark:text-green-400"})}),e.jsx(j.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(sa,{className:"h-8 w-8 text-yellow-500"})}),e.jsx(j.div,{animate:{rotate:-360},transition:{duration:4,repeat:1/0,ease:"linear"},className:"absolute -bottom-1 -left-3",children:e.jsx(ra,{className:"h-7 w-7 text-pink-500"})})]}),e.jsx(j.h1,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-3xl font-bold text-green-700 dark:text-green-400 mb-2",children:"Denúncia Enviada!"}),e.jsx(j.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"text-muted-foreground mb-6",children:"Obrigado por ajudar a melhorar nossa cidade!"}),e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"w-full",children:e.jsxs(k,{className:"p-6 bg-white dark:bg-card border-green-200 dark:border-green-800 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-3",children:[e.jsx(Le,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground font-medium",children:"Número do Protocolo"})]}),e.jsx(j.p,{className:"text-2xl font-bold font-mono text-primary mb-4",animate:{scale:[1,1.02,1]},transition:{duration:2,repeat:1/0},children:a}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",size:"sm",className:"flex-1",onClick:d,children:[e.jsx(na,{className:"h-4 w-4 mr-2"}),"Copiar"]}),e.jsxs(y,{variant:"outline",size:"sm",className:"flex-1",onClick:l,children:[e.jsx(ia,{className:"h-4 w-4 mr-2"}),"Compartilhar"]})]})]})}),e.jsx(j.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.7},className:"text-xs text-muted-foreground mt-4 max-w-xs",children:"Guarde este número para acompanhar o andamento da sua denúncia. Nossa equipe irá analisar e tomar as providências necessárias."}),e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.8},className:"w-full mt-8 space-y-3",children:[e.jsxs(y,{size:"lg",className:"w-full h-14 rounded-2xl text-base font-semibold bg-green-600 hover:bg-green-700",onClick:t,children:[e.jsx(oa,{className:"h-5 w-5 mr-2"}),"Início do App"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(y,{variant:"outline",size:"lg",className:"h-12 rounded-2xl text-sm",onClick:()=>r("/minhas-denuncias"),children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Minhas Denúncias"]}),e.jsxs(y,{variant:"outline",size:"lg",className:"h-12 rounded-2xl text-sm",onClick:()=>r("/denuncias/mapa"),children:[e.jsx(ca,{className:"h-4 w-4 mr-2"}),"Mapa"]})]}),e.jsxs(y,{variant:"ghost",size:"lg",className:"w-full h-12 rounded-2xl text-base",onClick:()=>r("/denuncias"),children:[e.jsx(Re,{className:"h-5 w-5 mr-2"}),"Todas as Denúncias"]})]})]})]})}const he=(a,t)=>t.some(s=>a instanceof s);let ke,Ce;function Ia(){return ke||(ke=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Aa(){return Ce||(Ce=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ge=new WeakMap,de=new WeakMap,te=new WeakMap;function Ea(a){const t=new Promise((s,r)=>{const n=()=>{a.removeEventListener("success",d),a.removeEventListener("error",l)},d=()=>{s(q(a.result)),n()},l=()=>{r(a.error),n()};a.addEventListener("success",d),a.addEventListener("error",l)});return te.set(t,a),t}function Ma(a){if(ge.has(a))return;const t=new Promise((s,r)=>{const n=()=>{a.removeEventListener("complete",d),a.removeEventListener("error",l),a.removeEventListener("abort",l)},d=()=>{s(),n()},l=()=>{r(a.error||new DOMException("AbortError","AbortError")),n()};a.addEventListener("complete",d),a.addEventListener("error",l),a.addEventListener("abort",l)});ge.set(a,t)}let fe={get(a,t,s){if(a instanceof IDBTransaction){if(t==="done")return ge.get(a);if(t==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return q(a[t])},set(a,t,s){return a[t]=s,!0},has(a,t){return a instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in a}};function qe(a){fe=a(fe)}function za(a){return Aa().includes(a)?function(...t){return a.apply(be(this),t),q(this.request)}:function(...t){return q(a.apply(be(this),t))}}function Ta(a){return typeof a=="function"?za(a):(a instanceof IDBTransaction&&Ma(a),he(a,Ia())?new Proxy(a,fe):a)}function q(a){if(a instanceof IDBRequest)return Ea(a);if(de.has(a))return de.get(a);const t=Ta(a);return t!==a&&(de.set(a,t),te.set(t,a)),t}const be=a=>te.get(a);function Ra(a,t,{blocked:s,upgrade:r,blocking:n,terminated:d}={}){const l=indexedDB.open(a,t),m=q(l);return r&&l.addEventListener("upgradeneeded",o=>{r(q(l.result),o.oldVersion,o.newVersion,q(l.transaction),o)}),s&&l.addEventListener("blocked",o=>s(o.oldVersion,o.newVersion,o)),m.then(o=>{d&&o.addEventListener("close",()=>d()),n&&o.addEventListener("versionchange",x=>n(x.oldVersion,x.newVersion,x))}).catch(()=>{}),m}const La=["get","getKey","getAll","getAllKeys","count"],Ba=["put","add","delete","clear"],me=new Map;function Se(a,t){if(!(a instanceof IDBDatabase&&!(t in a)&&typeof t=="string"))return;if(me.get(t))return me.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,n=Ba.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!(n||La.includes(s)))return;const d=async function(l,...m){const o=this.transaction(l,n?"readwrite":"readonly");let x=o.store;return r&&(x=x.index(m.shift())),(await Promise.all([x[s](...m),n&&o.done]))[0]};return me.set(t,d),d}qe(a=>({...a,get:(t,s,r)=>Se(t,s)||a.get(t,s,r),has:(t,s)=>!!Se(t,s)||a.has(t,s)}));const Pa=["continue","continuePrimaryKey","advance"],De={},je=new WeakMap,Oe=new WeakMap,Fa={get(a,t){if(!Pa.includes(t))return a[t];let s=De[t];return s||(s=De[t]=function(...r){je.set(this,Oe.get(this)[t](...r))}),s}};async function*qa(...a){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...a)),!t)return;t=t;const s=new Proxy(t,Fa);for(Oe.set(s,t),te.set(s,be(t));t;)yield s,t=await(je.get(s)||t.continue()),je.delete(s)}function Ie(a,t){return t===Symbol.asyncIterator&&he(a,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&he(a,[IDBIndex,IDBObjectStore])}qe(a=>({...a,get(t,s,r){return Ie(t,s)?qa:a.get(t,s,r)},has(t,s){return Ie(t,s)||a.has(t,s)}}));const Ae="etijucas-reports",Oa=2;let T=null,X=!1;async function O(){if(T&&X)return T;try{return T=await Ra(Ae,Oa,{upgrade(a,t,s){if(console.log(`[reportDraftDB] Upgrading from v${t} to v${s}`),!a.objectStoreNames.contains("drafts")){const r=a.createObjectStore("drafts",{keyPath:"id"});r.createIndex("by-status","syncStatus"),r.createIndex("by-updated","updatedAt")}a.objectStoreNames.contains("images")||a.createObjectStore("images",{keyPath:"id"}).createIndex("by-draft","draftId")},blocked(){console.warn("[reportDraftDB] Database blocked - close other tabs")},blocking(){T?.close(),T=null,X=!1}}),X=!0,T}catch(a){if(console.error("[reportDraftDB] Failed to open database:",a),a instanceof Error&&a.name==="NotFoundError"){console.warn("[reportDraftDB] Corrupted database, deleting and recreating...");try{return T&&(T.close(),T=null),await new Promise((t,s)=>{const r=indexedDB.deleteDatabase(Ae);r.onsuccess=()=>t(),r.onerror=()=>s(r.error),r.onblocked=()=>{console.warn("[reportDraftDB] Delete blocked"),t()}}),console.log("[reportDraftDB] Database deleted, recreating..."),X=!1,O()}catch(t){throw console.error("[reportDraftDB] Failed to delete database:",t),t}}throw a}}function Ue(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async function $e(a,t="draft"){const s=await O(),r=a.idempotencyKey||Ue(),n=Date.now(),d={categoryId:a.categoryId,category:a.category,location:a.location,title:a.title,description:a.description,confirmed:a.confirmed,currentStep:a.currentStep,createdAt:a.createdAt.getTime(),updatedAt:n,idempotencyKey:a.idempotencyKey};await s.put("drafts",{id:r,draft:d,syncStatus:t,createdAt:n,updatedAt:n});const l=s.transaction("images","readwrite"),m=await s.getAllFromIndex("images","by-draft",r);for(const o of m)await l.store.delete(o.id);for(const o of a.images){const x=o.file;await l.store.put({id:o.id,draftId:r,blob:x,filename:o.file.name,capturedAt:o.capturedAt.getTime()})}return await l.done,r}async function Ua(a){const t=await O(),s=await t.get("drafts",a);if(!s)return null;const n=(await t.getAllFromIndex("images","by-draft",a)).map(l=>{const m=new File([l.blob],l.filename,{type:l.blob.type});return{id:l.id,file:m,previewUrl:URL.createObjectURL(l.blob),capturedAt:new Date(l.capturedAt)}}),d=s.draft;return{categoryId:d.categoryId,category:d.category,location:d.location,title:d.title,description:d.description,confirmed:d.confirmed,currentStep:d.currentStep,createdAt:new Date(d.createdAt),updatedAt:new Date(d.updatedAt),idempotencyKey:d.idempotencyKey,images:n}}async function $a(){const a=await O(),t=await a.getAll("drafts");return(await Promise.all(t.map(async r=>{const n=await a.getAllFromIndex("images","by-draft",r.id);return{id:r.id,draft:r.draft,syncStatus:r.syncStatus,imageCount:n.length,updatedAt:r.updatedAt}}))).sort((r,n)=>n.updatedAt-r.updatedAt)}async function Ve(a){return(await(await O()).getAllFromIndex("drafts","by-status",a)).map(r=>r.id)}async function Va(a,t){const s=await O(),r=await s.get("drafts",a);r&&await s.put("drafts",{...r,syncStatus:t,updatedAt:Date.now()})}async function Ke(a){const t=await O(),s=await t.getAllFromIndex("images","by-draft",a),r=t.transaction("images","readwrite");for(const n of s)await r.store.delete(n.id);await r.done,await t.delete("drafts",a)}async function Ka(){const a=await Ve("sent");let t=0;for(const s of a)await Ke(s),t++;return t}function Ge(a){for(const t of a)t.previewUrl?.startsWith("blob:")&&URL.revokeObjectURL(t.previewUrl)}const Ee="report_draft";async function _e(){try{const a=localStorage.getItem(Ee);if(!a)return!1;const t=JSON.parse(a);if(!t)return!1;const s={categoryId:t.categoryId||null,category:t.category||null,location:t.location||null,title:t.title||"",description:t.description||"",confirmed:!1,currentStep:t.currentStep||1,createdAt:new Date,updatedAt:new Date,idempotencyKey:Ue(),images:[]};return await $e(s,"draft"),localStorage.removeItem(Ee),console.log("[reportDraftDB] Migrated draft from localStorage to IndexedDB"),!0}catch(a){return console.error("[reportDraftDB] Migration failed:",a),!1}}const Y={saveDraft:$e,getDraft:Ua,getAllDrafts:$a,getDraftsByStatus:Ve,updateDraftStatus:Va,deleteDraft:Ke,clearSentDrafts:Ka,revokeImageURLs:Ge,migrateFromLocalStorage:_e},Z=()=>`report-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,ue={categoryId:null,category:null,location:null,locationNote:"",images:[],title:"",description:"",confirmed:!1,currentStep:1,createdAt:new Date,updatedAt:new Date,idempotencyKey:Z()},Me="etijucas-report-draft",J="active-report-draft";function Ga(){const[a,t]=u.useState(()=>({...ue,idempotencyKey:Z()})),[s,r]=u.useState(!0),n=u.useRef(null),d=u.useRef(!0);u.useEffect(()=>{d.current=!0;async function p(){try{await _e();const g=await Y.getDraft(J);g&&d.current&&t(g)}catch(g){console.error("[useReportDraft] Error loading draft:",g);try{const N=localStorage.getItem(Me);if(N){const S=JSON.parse(N);d.current&&t({...ue,...S,createdAt:new Date(S.createdAt||Date.now()),updatedAt:new Date(S.updatedAt||Date.now()),images:[],idempotencyKey:S.idempotencyKey||Z()})}}catch(N){console.error("[useReportDraft] localStorage fallback failed:",N)}}finally{d.current&&r(!1)}}return p(),()=>{d.current=!1,n.current&&clearTimeout(n.current)}},[]);const l=u.useCallback(async p=>{n.current&&clearTimeout(n.current),n.current=setTimeout(async()=>{try{const g={...p,idempotencyKey:J};await Y.saveDraft(g,"draft")}catch(g){console.error("[useReportDraft] Error saving draft:",g)}},500)},[]),m=u.useCallback(p=>{t(g=>{const N={...g,...p,updatedAt:new Date};return l(N),N})},[l]),o=u.useCallback(p=>{t(g=>{if(g.images.length>=3)return g;const N={...g,images:[...g.images,p],updatedAt:new Date};return l(N),N})},[l]),x=u.useCallback(p=>{t(g=>{const N=g.images.find(I=>I.id===p);N&&URL.revokeObjectURL(N.previewUrl);const S={...g,images:g.images.filter(I=>I.id!==p),updatedAt:new Date};return l(S),S})},[l]),f=u.useCallback(p=>{m({currentStep:p})},[m]),b=u.useCallback(()=>{t(p=>{if(p.currentStep<4){const g=p.currentStep+1,N={...p,currentStep:g,updatedAt:new Date};return l(N),N}return p})},[l]),h=u.useCallback(()=>{t(p=>{if(p.currentStep>1){const g=p.currentStep-1,N={...p,currentStep:g,updatedAt:new Date};return l(N),N}return p})},[l]),v=u.useCallback(async()=>{Ge(a.images);try{await Y.deleteDraft(J)}catch(p){console.error("[useReportDraft] Error deleting draft:",p)}localStorage.removeItem(Me),t({...ue,idempotencyKey:Z()})},[a.images]),D=u.useCallback(async()=>{n.current&&clearTimeout(n.current);try{const p={...a,idempotencyKey:J};await Y.saveDraft(p,"draft")}catch(p){console.error("[useReportDraft] Error saving draft:",p)}},[a]);return{draft:a,isLoading:s,updateDraft:m,addImage:o,removeImage:x,goToStep:f,nextStep:b,prevStep:h,clearDraft:v,saveDraft:D}}const _a=["Categoria","Localização","Fotos","Revisão"],Wa={enter:a=>({x:a>0?"100%":"-100%",opacity:0}),center:{x:0,opacity:1},exit:a=>({x:a<0?"100%":"-100%",opacity:0})};function gt(){const a=Be(),{isAuthenticated:t}=fa();if(!t)return e.jsx(ma,{title:"Cadastre-se ou entre",message:"Para enviar uma denúncia, você precisa estar cadastrado no aplicativo.",returnUrl:"/denuncia/nova"});const{draft:s,isLoading:r,updateDraft:n,nextStep:d,prevStep:l,clearDraft:m}=Ga(),[o,x]=u.useState(0),[f,b]=u.useState(!1),[h,v]=u.useState(null),{createReport:D}=ga(),p=u.useCallback(C=>{x(C>s.currentStep?1:-1),n({currentStep:C})},[s.currentStep,n]),g=u.useCallback(()=>{x(1),d()},[d]),N=u.useCallback(()=>{x(-1),l()},[l]),S=u.useCallback(async()=>{if(!s.categoryId){G.error("Selecione uma categoria para a denúncia");return}if(!s.title||s.title.trim().length<5){G.error("O título deve ter pelo menos 5 caracteres");return}try{const C={categoryId:s.categoryId,title:s.title.trim(),description:s.description.trim(),images:s.images.map(i=>i.file)};s.location&&(C.addressText=s.location.address,C.addressSource=s.location.source,C.locationQuality=s.location.quality,C.latitude=s.location.latitude,C.longitude=s.location.longitude,C.locationAccuracyM=s.location.accuracy?Math.min(Math.round(s.location.accuracy),1e4):void 0);const U=await D({payload:C,idempotencyKey:s.idempotencyKey});v(U.protocol),b(!0),m(),G.success("Denúncia enviada com sucesso!")}catch(C){console.error("Error submitting report:",C),G.error("Erro ao enviar denúncia. Tente novamente.")}},[s,D,m]),I=()=>{s.categoryId||s.location||s.images.length>0?window.confirm("Tem certeza que deseja sair? Seu rascunho será salvo.")&&a(-1):a(-1)},K=()=>{a("/")};return r?e.jsx("div",{className:"fixed inset-0 z-50 bg-background flex items-center justify-center",children:e.jsx(L,{className:"h-8 w-8 animate-spin text-primary"})}):f&&h?e.jsx(Da,{protocolNumber:h,onClose:K}):e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"shrink-0 bg-background/95 backdrop-blur-lg border-b safe-top",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsx(y,{variant:"ghost",size:"icon",onClick:I,className:"rounded-full",children:e.jsx(la,{className:"h-5 w-5"})}),e.jsx("h1",{className:"font-semibold text-lg",children:"Enviar Denúncia"}),e.jsx(y,{variant:"ghost",size:"icon",onClick:I,className:"rounded-full",children:e.jsx(ye,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"px-4 pb-4",children:e.jsx(ya,{currentStep:s.currentStep,totalSteps:4,labels:_a})})]}),e.jsx("main",{className:"flex-1 overflow-hidden",children:e.jsx(ee,{mode:"wait",custom:o,children:e.jsxs(j.div,{custom:o,variants:Wa,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},className:"h-full overflow-y-auto px-4 pt-4 pb-32",children:[s.currentStep===1&&e.jsx(va,{draft:s,onUpdate:n,onNext:g}),s.currentStep===2&&e.jsx(wa,{draft:s,onUpdate:n,onNext:g,onBack:N}),s.currentStep===3&&e.jsx(Ca,{draft:s,onUpdate:n,onNext:g,onBack:N}),s.currentStep===4&&e.jsx(Sa,{draft:s,onUpdate:n,onBack:N,onGoToStep:p,onSubmit:S})]},s.currentStep)})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[60]",children:e.jsx(ba,{activeTab:"reportar",onTabChange:C=>a(`/?tab=${C}`)})})]})}export{gt as default};
