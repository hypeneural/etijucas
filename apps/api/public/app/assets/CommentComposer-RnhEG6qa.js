import{r as s,j as e,z as O,l as g,m as d,X as $,as as X,b1 as _,a_ as G,aa as z,x as B,b2 as K,W as J,a1 as Q,a2 as Y}from"./vendor-app-DyDkrbNW.js";import{u as W,f as Z}from"./useUploadImage-PCVOreq1.js";import{a as q,b as ee}from"./index-DXDXkkao.js";import{B as te}from"./button-BjnP8xXy.js";import{T as se}from"./textarea-DLsDrJ_K.js";function ae(t,x){return t.filter(n=>!n.parentId).sort((n,u)=>{if(x==="recentes")return new Date(u.createdAt).getTime()-new Date(n.createdAt).getTime();const r=(u.likesCount??0)-(n.likesCount??0);return r!==0?r:new Date(u.createdAt).getTime()-new Date(n.createdAt).getTime()})}function ce({comments:t,onLike:x,onReply:l}){const[n,u]=s.useState("relevantes"),r=s.useMemo(()=>{console.log("[CommentList] Processing comments:",t.length,"total");const i=ae(t,n);return console.log("[CommentList] Root comments:",i.length,"with replies:",i.map(o=>o.replies?.length??0)),i},[t,n]);return t.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx(O,{className:"w-10 h-10 mx-auto text-muted-foreground/50 mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhum comentário ainda."}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Seja o primeiro a comentar!"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border/50",children:[e.jsxs("span",{className:"text-sm font-medium text-foreground",children:[t.length," ",t.length===1?"comentário":"comentários"]}),e.jsx("div",{className:"flex gap-1",children:["relevantes","recentes"].map(i=>e.jsx("button",{onClick:()=>u(i),className:`px-3 py-1.5 text-xs font-medium rounded-full transition-colors ${n===i?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted"}`,children:i==="relevantes"?"Relevantes":"Recentes"},i))})]}),e.jsx("div",{className:"divide-y divide-border/50",children:e.jsx(g,{children:r.map((i,o)=>e.jsx(H,{comment:i,index:o,depth:0,onLike:x,onReply:l},i.id))})})]})}function H({comment:t,index:x,depth:l,onLike:n,onReply:u}){const[r,i]=s.useState(t.liked??!1),[o,F]=s.useState(t.likesCount??0),[N,w]=s.useState(l<2),[S,C]=s.useState(!1),[p,v]=s.useState(""),[R,A]=s.useState(!1),[I,f]=s.useState(null),[j,U]=s.useState(null),[D,b]=s.useState(!1),[T,k]=s.useState(!1),{uploadAsync:L}=W(),E=t.replies&&t.replies.length>0,c=3,m=()=>{i(!r),F(a=>r?Math.max(0,a-1):a+1),navigator.vibrate&&navigator.vibrate(10),n?.(t.id)},h=()=>t.isAnon?"Anônimo":t.autor?.nome?t.autor.nome:t.autorNome?t.autorNome:"Usuário",V=()=>t.isAnon?"?":(t.autor?.nome||t.autorNome||"U")[0]?.toUpperCase()||"U",M=async()=>{if(!(!p.trim()||!u)){b(!0);try{let a;if(j)try{a=(await L(j)).url}catch{q.error("Erro ao enviar imagem"),b(!1);return}await u(t.id,p.trim(),R,a),v(""),f(null),U(null),C(!1)}finally{b(!1)}}};return e.jsxs(d.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:x*.03},className:l>0?"border-l-2 border-muted":"",style:{marginLeft:l>0?`${Math.min(l,c)*16}px`:0},children:[e.jsx("div",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:`${l>0?"w-6 h-6 text-[10px]":"w-8 h-8 text-xs"} rounded-full bg-muted flex items-center justify-center font-medium text-muted-foreground flex-shrink-0`,children:t.autor?.avatarUrl?e.jsx("img",{src:t.autor.avatarUrl,alt:h(),className:"w-full h-full rounded-full object-cover"}):V()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:`${l>0?"text-xs":"text-sm"} font-medium text-foreground`,children:h()}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Z(t.createdAt)})]}),e.jsx("p",{className:`${l>0?"text-xs":"text-sm"} text-foreground mt-1 leading-relaxed whitespace-pre-wrap`,children:t.texto}),t.imageUrl&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:t.imageUrl,alt:"Imagem do comentário",className:"mt-2 rounded-lg max-h-48 object-cover cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>k(!0)}),e.jsx(g,{children:T&&e.jsxs(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4",onClick:()=>k(!1),children:[e.jsx("button",{className:"absolute top-4 right-4 p-2 text-white/80 hover:text-white bg-black/50 rounded-full",onClick:()=>k(!1),children:e.jsx($,{className:"w-6 h-6"})}),e.jsx(d.img,{initial:{scale:.9},animate:{scale:1},exit:{scale:.9},src:t.imageUrl,alt:"Imagem em tela cheia",className:"max-w-full max-h-full object-contain rounded-lg",onClick:a=>a.stopPropagation()})]})})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-2",children:[e.jsxs(d.button,{whileTap:{scale:.9},onClick:m,className:"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors min-h-[32px]",children:[e.jsx(X,{className:`w-4 h-4 transition-all ${r?"fill-red-500 text-red-500 scale-110":""}`}),e.jsx("span",{className:r?"text-red-500 font-medium":"",children:o>0?o:"Curtir"})]}),l<c&&e.jsxs("button",{onClick:()=>C(!S),className:"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors min-h-[32px]",children:[e.jsx(O,{className:"w-4 h-4"}),e.jsx("span",{children:"Responder"})]}),E&&e.jsx("button",{onClick:()=>w(!N),className:"flex items-center gap-1 text-xs text-primary font-medium min-h-[32px]",children:N?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4"}),e.jsxs("span",{children:["Ocultar ",t.replies.length," ",t.replies.length===1?"resposta":"respostas"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-4 h-4"}),e.jsxs("span",{children:["Ver ",t.replies.length," ",t.replies.length===1?"resposta":"respostas"]})]})})]}),e.jsx(g,{children:S&&e.jsx(d.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"mt-3 overflow-hidden",children:e.jsxs("div",{className:"flex flex-col gap-2 p-3 bg-muted/50 rounded-xl",children:[I&&e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:I,alt:"Preview",className:"h-24 rounded-lg object-cover"}),e.jsx("button",{onClick:()=>f(null),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white",children:e.jsx($,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",value:p,onChange:a=>v(a.target.value),placeholder:`Responder ${t.isAnon?"Anônimo":t.autorNome}...`,className:"w-full px-3 py-2 text-sm rounded-lg bg-background border border-border focus:outline-none focus:ring-2 focus:ring-primary",onKeyDown:a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),M())}})}),e.jsxs("label",{className:"p-2 rounded-lg hover:bg-muted cursor-pointer",children:[e.jsx(z,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:a=>{const y=a.target.files?.[0];if(y){U(y);const P=new FileReader;P.onload=()=>f(P.result),P.readAsDataURL(y)}}})]}),e.jsx("button",{onClick:M,disabled:!p.trim()||D,className:"p-2 rounded-lg bg-primary text-primary-foreground disabled:opacity-50",children:D?e.jsx(B,{className:"w-5 h-5 animate-spin"}):e.jsx(K,{className:"w-5 h-5"})})]})]})})})]})]})}),e.jsx(g,{children:E&&N&&e.jsx(d.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},children:t.replies.map((a,y)=>e.jsx(H,{comment:{...a,replies:a.replies||[]},index:y,depth:l+1,onLike:n,onReply:u},a.id))})})]})}function de({onSubmit:t,autoFocus:x=!1,placeholder:l="Escreva um comentário…",replyTo:n,isSubmitting:u=!1}){const[r,i]=s.useState(""),[o,F]=s.useState(!1),[N,w]=s.useState(!1),[S,C]=s.useState(!1),[p,v]=s.useState(null),[R,A]=s.useState(null),{isOnline:I}=ee(),f=s.useRef(null),j=s.useRef(null),{uploadAsync:U,isUploading:D}=W(),b=N||u||D;s.useEffect(()=>{x&&f.current&&f.current.focus()},[x]);const T=async()=>{if(!(!r.trim()||b)){w(!0);try{let c;if(R)try{c=(await U(R)).url}catch(m){const h=m instanceof Error?m.message:"Erro no upload";q.error(`Falha no upload: ${h}`),w(!1);return}await t(r.trim(),o,c),i(""),v(null),A(null),navigator.vibrate&&navigator.vibrate(10)}finally{w(!1)}}},k=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),T())},L=c=>{const m=c.target.files?.[0];if(m){A(m);const h=new FileReader;h.onload=()=>{v(h.result)},h.readAsDataURL(m)}},E=()=>{v(null),A(null),j.current&&(j.current.value="")};return e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-background border-t border-border safe-bottom z-40",children:[e.jsx(g,{children:!I&&e.jsxs(d.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"px-4 py-2 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 text-xs flex items-center gap-2",children:[e.jsx(J,{className:"w-3 h-3"}),e.jsx("span",{children:"Sem conexão. Comentário será enviado quando voltar."})]})}),e.jsx(g,{children:n&&e.jsxs(d.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"px-4 py-2 bg-muted text-sm text-muted-foreground border-l-4 border-primary",children:["Respondendo a ",e.jsx("strong",{children:n})]})}),e.jsx(g,{children:p&&e.jsx(d.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"px-4 pt-2",children:e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:p,alt:"Preview",className:"h-20 rounded-lg object-cover"}),e.jsx("button",{onClick:E,className:"absolute -top-1 -right-1 p-1 bg-destructive text-destructive-foreground rounded-full shadow-sm","aria-label":"Remover imagem",children:e.jsx($,{className:"w-3 h-3"})})]})})}),e.jsxs("div",{className:"px-4 py-3",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(d.button,{whileTap:{scale:.9},onClick:()=>F(!o),className:`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center transition-colors ${o?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"}`,"aria-label":o?"Postar com nome":"Postar anônimo","aria-pressed":o,children:o?e.jsx(Q,{className:"w-4 h-4"}):e.jsx(Y,{className:"w-4 h-4"})}),e.jsx(d.button,{whileTap:{scale:.9},onClick:()=>j.current?.click(),className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-muted text-muted-foreground transition-colors hover:bg-muted-foreground/10","aria-label":"Anexar imagem",children:e.jsx(z,{className:"w-4 h-4"})}),e.jsx("input",{ref:j,type:"file",accept:"image/*",onChange:L,className:"hidden"}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(se,{ref:f,value:r,onChange:c=>i(c.target.value),onFocus:()=>C(!0),onBlur:()=>C(!1),onKeyDown:k,placeholder:l,className:`min-h-[44px] max-h-[120px] py-3 pr-12 rounded-2xl resize-none text-base transition-all ${S?"ring-2 ring-primary":""}`,rows:1,maxLength:500}),r.length>400&&e.jsxs("span",{className:"absolute right-12 bottom-2 text-xs text-muted-foreground",children:[r.length,"/500"]})]}),e.jsx(d.div,{whileTap:{scale:.9},children:e.jsx(te,{onClick:T,disabled:!r.trim()||b,size:"icon",className:"w-10 h-10 rounded-full flex-shrink-0","aria-label":"Enviar comentário",children:b?e.jsx(B,{className:"w-4 h-4 animate-spin"}):e.jsx(K,{className:"w-4 h-4"})})})]}),e.jsx(g,{children:o&&e.jsx(d.p,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"text-xs text-muted-foreground mt-2 pl-12",children:"Seu nome não aparecerá no comentário"})})]})]})}export{ce as C,de as a};
