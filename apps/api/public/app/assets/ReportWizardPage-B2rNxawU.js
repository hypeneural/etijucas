import{j as e,bc as Me,M as V,af as F,bd as He,m as j,K as Qe,r as x,be as W,l as ee,X as ye,z as L,a7 as Xe,bf as Je,aj as xe,bg as Te,o as _,aC as Q,am as H,n as R,ag as re,av as Ne,bh as Ye,bi as Ze,bj as ne,ah as ie,bk as ea,b1 as Re,bl as oe,bm as Le,b4 as aa,x as Be,S as ta,a0 as sa,bn as ra,aw as na,a1 as ia,bo as oa,_ as ca}from"./vendor-app-DpJht6ER.js";import{B as y}from"./button-DpkLbl0v.js";import{c as D,a as G,u as la}from"./index-CQWz757N.js";import{C}from"./card-DPbvWsn0.js";import{C as Pe,r as ve}from"./CategoryIcon-BMi-mZwU.js";import{u as Fe,L as da}from"./LoginRequired-DYYdl9No.js";import{I as pe}from"./input-bnwWiakT.js";import{L as ma}from"./LocationMap-20l0dYoW.js";import{g as ce}from"./uuid-BwYzP5ph.js";import{B as ua}from"./badge-bLincPT_.js";import{C as xa}from"./checkbox-BJkvu_Fk.js";import{T as pa}from"./textarea-C1N6dYgi.js";import{c as le}from"./confetti.module-B5JVzsfH.js";import{u as ha}from"./useMyReports-Cr5euCtA.js";import{u as ga}from"./useAuthStore-Da1bSf70.js";import{B as fa}from"./BottomTabBar-BHjG1o7r.js";import"./useHaptics-BhbeTTfh.js";import"./client-BdVdTjkU.js";import"./localDatabase-BCLAvclD.js";import"./iconify-C8dm1vD2.js";import"./vendor-maps-OPCn2I-O.js";const ba=[{icon:Me,label:"Categoria"},{icon:V,label:"Localização"},{icon:F,label:"Fotos"},{icon:He,label:"Revisão"}];function ja({currentStep:a,totalSteps:t,labels:s}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:ba.slice(0,t).map((r,n)=>{const l=n+1,d=l<a,m=l===a,o=r.icon;return e.jsxs("div",{className:"flex flex-col items-center flex-1",children:[n>0&&e.jsx("div",{className:D("absolute h-0.5 -translate-y-4",d||m?"bg-primary":"bg-muted"),style:{width:`calc(100% / ${t} - 2rem)`,left:`calc((100% / ${t}) * ${n} + 1rem)`}}),e.jsx(j.div,{initial:{scale:.8},animate:{scale:m?1.1:1},className:D("relative z-10 h-10 w-10 rounded-full flex items-center justify-center transition-all",d&&"bg-primary text-primary-foreground",m&&"bg-primary text-primary-foreground ring-4 ring-primary/20",!d&&!m&&"bg-muted text-muted-foreground"),children:d?e.jsx(Qe,{className:"h-5 w-5"}):e.jsx(o,{className:"h-5 w-5"})}),e.jsx("span",{className:D("text-xs mt-1.5 font-medium text-center",m&&"text-primary",d&&"text-foreground",!d&&!m&&"text-muted-foreground"),children:s?.[n]||r.label})]},l)})}),e.jsx("div",{className:"relative -mt-[3.2rem] mx-5 h-0.5 bg-muted rounded-full",children:e.jsx(j.div,{className:"h-full bg-primary rounded-full",initial:{width:0},animate:{width:`${(a-1)/(t-1)*100}%`},transition:{type:"spring",stiffness:300,damping:30}})})]})}function ya({title:a,content:t,className:s}){const[r,n]=x.useState(!1),l=Array.isArray(t)?t:[t];return e.jsxs("div",{className:D("inline-flex items-center gap-1",s),children:[e.jsx(j.button,{type:"button",whileTap:{scale:.9},onClick:()=>n(!0),className:"flex h-5 w-5 items-center justify-center rounded-full bg-muted hover:bg-muted/80 transition-colors","aria-label":`Ajuda sobre ${a}`,children:e.jsx(W,{className:"h-3 w-3 text-muted-foreground"})}),e.jsx(ee,{children:r&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>n(!1)}),e.jsxs(j.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 safe-bottom",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"flex items-start justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(W,{className:"h-4 w-4 text-primary"})}),e.jsx("h3",{className:"font-semibold text-lg",children:a})]}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full",onClick:()=>n(!1),children:e.jsx(ye,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-4 space-y-2",children:l.map((d,m)=>e.jsxs("p",{className:"text-sm text-muted-foreground flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"•"}),e.jsx("span",{children:d})]},m))}),e.jsx(y,{className:"w-full mt-6",onClick:()=>n(!1),children:"Entendi"})]})]})})]})}function ae({title:a,subtitle:t,helpTitle:s,helpContent:r}){return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-2xl font-bold",children:a}),r&&e.jsx(ya,{title:s||a,content:r})]}),t&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t})]})}function Na({draft:a,onUpdate:t,onNext:s}){const{categories:r,isLoading:n,error:l,refetch:d}=Fe(),m=r.find(h=>h.id===a.categoryId),o=h=>{t({categoryId:h.id,category:h})},u=!!a.categoryId;return n?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(L,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando categorias..."})]}):l?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx(Xe,{className:"h-12 w-12 text-destructive"}),e.jsx("p",{className:"text-muted-foreground text-center",children:"Erro ao carregar categorias."}),e.jsx(y,{onClick:()=>d(),variant:"outline",children:"Tentar novamente"})]}):e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(ae,{title:"O que aconteceu?",subtitle:"Escolha a categoria que melhor descreve o problema",helpTitle:"Como escolher a categoria",helpContent:["Escolha a categoria que mais combina com o problema que você quer reportar.","Se tiver dúvida, escolha 'Outros' e descreva com suas palavras.","Não se preocupe em acertar perfeitamente, nossa equipe vai analisar."]}),e.jsx(C,{className:D("p-4 border-2 transition-colors",m?"border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800":"border-blue-200 bg-blue-50 dark:bg-blue-950/30 dark:border-blue-800"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:D("p-2 rounded-lg",m?"bg-amber-100 dark:bg-amber-900/50":"bg-blue-100 dark:bg-blue-900/50"),children:m?e.jsx(Je,{className:"h-4 w-4 text-amber-600 dark:text-amber-400"}):e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsx("div",{className:"flex-1",children:m?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm font-medium text-amber-800 dark:text-amber-300",children:['Dicas para "',m.name,'"']}),m.tips.length>0&&e.jsx("ul",{className:"mt-2 space-y-1",children:m.tips.map((h,b)=>e.jsxs("li",{className:"text-sm text-amber-700 dark:text-amber-400 flex gap-2",children:[e.jsx("span",{className:"shrink-0",children:"•"}),e.jsx("span",{children:h})]},b))})]}):e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("span",{className:"font-medium",children:"Toque em uma categoria"})," para selecioná-la. Depois você pode detalhar melhor o problema."]})})]})}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:r.map((h,b)=>{const g=a.categoryId===h.id;return e.jsxs(j.button,{type:"button",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:b*.03},whileTap:{scale:.95},onClick:()=>o(h),className:D("relative flex flex-col items-center gap-2 rounded-2xl border-2 p-3 text-center transition-all",g?"border-primary bg-primary/10 shadow-lg":"border-border bg-card hover:bg-muted/50 hover:border-muted-foreground/30"),style:{borderColor:g?h.color:void 0,backgroundColor:g?`${h.color}10`:void 0},children:[e.jsx(Pe,{icon:h.icon,color:h.color,size:"lg",withBackground:!0}),e.jsx("span",{className:D("text-[11px] leading-tight font-semibold line-clamp-2",g?"text-primary":"text-slate-700 dark:text-slate-300"),style:{color:g?h.color:void 0},children:h.name}),g&&e.jsx(j.div,{initial:{scale:0},animate:{scale:1},className:"absolute -top-1 -right-1 h-5 w-5 rounded-full flex items-center justify-center",style:{backgroundColor:h.color},children:e.jsx(xe,{className:"h-3 w-3 text-white"})})]},h.id)})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx(y,{size:"lg",className:D("w-full h-9 text-base font-semibold rounded-xl transition-all",!u&&"opacity-50"),disabled:!u,onClick:s,children:u?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(xe,{className:"h-5 w-5 ml-2"})]}):"Selecione uma categoria"})})})]})}function va({draft:a,onUpdate:t,onNext:s,onBack:r}){const[n,l]=x.useState({status:"idle"}),[d,m]=x.useState(!1),[o,u]=x.useState(""),[h,b]=x.useState([]),[g,v]=x.useState(!1),[I,p]=x.useState(!1),f=x.useCallback(async(i,c)=>{try{p(!0);const w=await ve.geocodeReverse(i,c);return w?.address||w?.displayName}catch(w){console.warn("[StepLocation] Reverse geocode failed:",w);return}finally{p(!1)}},[]),N=x.useCallback(async()=>{if(!navigator.geolocation){l({status:"error",errorMessage:"Seu navegador não suporta geolocalização. Tente usar Chrome, Safari ou Firefox."});return}l({status:"requesting"}),navigator.geolocation.getCurrentPosition(async i=>{const c=i.coords.latitude,w=i.coords.longitude,E=await f(c,w),M={latitude:c,longitude:w,accuracy:i.coords.accuracy,address:E||"Tijucas, SC",source:"gps",quality:i.coords.accuracy<=50?"precisa":"aproximada"};t({location:M}),l({status:"success"})},i=>{let c="Não conseguimos acessar sua localização.";i.code===i.PERMISSION_DENIED?(c="Você não permitiu o acesso à sua localização.",l({status:"denied",errorMessage:c})):i.code===i.POSITION_UNAVAILABLE?(c="Não foi possível determinar sua localização. Verifique se o GPS está ativado.",l({status:"error",errorMessage:c})):i.code===i.TIMEOUT&&(c="Demorou muito para obter sua localização. Verifique sua conexão e tente novamente.",l({status:"error",errorMessage:c}))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4})},[t,f]),S=x.useRef(null),A=x.useCallback(async i=>{if(i.length<3){b([]);return}S.current&&S.current.abort(),S.current=new AbortController,v(!0);try{const c=a.location?.latitude,w=a.location?.longitude,E=await ve.geocodeAutocomplete(i,c,w);b(E)}catch(c){c.name!=="AbortError"&&console.warn("[StepLocation] Search failed:",c),b([])}finally{v(!1)}},[a.location?.latitude,a.location?.longitude]);x.useEffect(()=>{const i=setTimeout(()=>{o&&A(o)},300);return()=>{clearTimeout(i),S.current&&S.current.abort()}},[o,A]);const K=i=>{const c={latitude:i.latitude,longitude:i.longitude,accuracy:100,address:i.address||i.displayName,source:"manual",quality:"manual"};t({location:c}),l({status:"success"}),u(""),b([]),m(!1)};x.useEffect(()=>{!a.location&&n.status==="idle"&&N()},[a.location,n.status,N]);const k=!!a.location,U=({quality:i})=>{const c={precisa:{color:"text-green-600 bg-green-100",icon:Ye,label:"Precisa"},aproximada:{color:"text-amber-600 bg-amber-100",icon:V,label:"Aproximada"},manual:{color:"text-blue-600 bg-blue-100",icon:re,label:"Informada"}}[i]||{color:"text-gray-600 bg-gray-100",icon:V,label:"Desconhecida"},w=c.icon;return e.jsxs("span",{className:D("inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",c.color),children:[e.jsx(w,{className:"h-3 w-3"}),c.label]})};return e.jsxs("div",{className:"space-y-6 pb-48",children:[e.jsx(ae,{title:"Onde foi?",subtitle:"Precisamos saber o local do problema",helpTitle:"Por que precisamos da localização?",helpContent:["A localização ajuda nossa equipe a encontrar o problema rapidamente.","Usamos o GPS do seu celular para maior precisão.","Sua localização não é compartilhada publicamente, apenas com a equipe responsável."]}),e.jsx(C,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"Como funciona:"}),e.jsx("p",{children:"Usamos o GPS para marcar o local, ou você pode buscar o endereço manualmente."})]})]})}),e.jsxs("div",{className:"space-y-4",children:[n.status==="requesting"&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(L,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:I?"Buscando endereço...":"Buscando sua localização..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),n.status==="denied"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(V,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Localização bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:n.errorMessage}),e.jsxs(C,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700 text-left",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(Te,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Localização" para "Permitir"'})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4 w-full",children:[e.jsxs(y,{variant:"outline",className:"flex-1",onClick:N,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(y,{variant:"secondary",className:"flex-1",onClick:()=>m(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),n.status==="error"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(H,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Erro ao obter localização"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:n.errorMessage}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(y,{variant:"outline",className:"flex-1",onClick:N,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar GPS"]}),e.jsxs(y,{variant:"secondary",className:"flex-1",onClick:()=>m(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço"]})]})]})})}),a.location&&e.jsxs(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-4",children:[e.jsx(C,{className:"p-4 bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100 dark:bg-green-900/50",children:e.jsx(R,{className:"h-5 w-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-green-800 dark:text-green-300",children:"Localização capturada!"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(U,{quality:a.location.quality}),a.location.accuracy&&a.location.source==="gps"&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["±",Math.round(a.location.accuracy),"m"]})]})]})]})}),e.jsx(ma,{latitude:a.location.latitude,longitude:a.location.longitude,hasGPS:a.location.source==="gps",onLocationChange:async(i,c)=>{const w=await f(i,c);t({location:{...a.location,latitude:i,longitude:c,address:w||a.location.address,source:"mapa",quality:"precisa"}})},onCenterGPS:a.location.source==="gps"?N:void 0}),e.jsx(C,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[I?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 animate-spin text-primary"}),e.jsx("span",{className:"text-muted-foreground",children:"Buscando endereço..."})]}):e.jsx("p",{className:"font-medium",children:a.location.address||"Localização capturada"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Coordenadas: ",a.location.latitude.toFixed(4),", ",a.location.longitude.toFixed(4)]})]}),e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>m(!0),children:[e.jsx(re,{className:"h-3.5 w-3.5 mr-1"}),"Buscar"]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4 text-muted-foreground"}),"Ponto de referência (opcional)"]}),e.jsx(pe,{placeholder:"Ex: Próximo ao Supermercado X",value:a.locationNote||"",onChange:i=>t({locationNote:i.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ajude a localizar o problema com uma referência"})]})]}),n.status==="idle"&&!a.location&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center py-8 gap-4",children:[e.jsxs(y,{size:"lg",onClick:N,className:"h-12 px-8 rounded-xl",children:[e.jsx(Ne,{className:"h-5 w-5 mr-2"}),"Usar minha localização"]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"ou"}),e.jsxs(y,{variant:"outline",onClick:()=>m(!0),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Buscar endereço manualmente"]})]})]}),e.jsx(ee,{children:d&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/40",onClick:()=>m(!1)}),e.jsxs(j.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:25,stiffness:300},className:"fixed bottom-0 left-0 right-0 z-50 rounded-t-3xl bg-background p-6 pb-8 max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"absolute top-3 left-1/2 -translate-x-1/2 h-1 w-10 rounded-full bg-muted"}),e.jsx("h3",{className:"font-semibold text-lg mt-4",children:"Buscar endereço"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Digite o nome da rua ou local"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(pe,{placeholder:"Ex: Rua Principal, Centro, Tijucas",value:o,onChange:i=>u(i.target.value),className:"pl-10 h-12 rounded-xl",autoFocus:!0}),g&&e.jsx(L,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground"})]}),h.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:h.map((i,c)=>e.jsx(j.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:c*.05},onClick:()=>K(i),className:"w-full text-left p-3 rounded-xl border hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(V,{className:"h-5 w-5 text-primary shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:i.address}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:i.displayName})]})]})},i.placeId||c))}),o.length>=3&&h.length===0&&!g&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Nenhum resultado encontrado. Tente outro endereço."}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(y,{variant:"outline",className:"flex-1",onClick:()=>m(!1),children:"Cancelar"}),e.jsxs(y,{className:"flex-1",onClick:N,children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Usar GPS"]})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-9 rounded-xl flex-1 text-base",onClick:r,children:"Voltar"}),e.jsx(y,{size:"lg",className:D("h-9 rounded-xl flex-[2] text-base font-semibold",!k&&"opacity-50"),disabled:!k,onClick:s,children:k?e.jsxs(e.Fragment,{children:["Continuar",e.jsx(xe,{className:"h-5 w-5 ml-2"})]}):"Aguardando localização..."})]})})]})}function we(a){if(a===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],r=Math.floor(Math.log(a)/Math.log(t));return`${parseFloat((a/Math.pow(t,r)).toFixed(1))} ${s[r]}`}async function wa(a,t={}){const{maxWidth:s=1200,maxHeight:r=1200,quality:n=.8,format:l="image/webp"}=t;return new Promise((d,m)=>{const o=new Image,u=document.createElement("canvas"),h=u.getContext("2d");if(!h){m(new Error("Canvas context not available"));return}o.onload=()=>{let{width:g,height:v}=o;g>s&&(v=v*s/g,g=s),v>r&&(g=g*r/v,v=r),g=Math.round(g),v=Math.round(v),u.width=g,u.height=v,h.imageSmoothingEnabled=!0,h.imageSmoothingQuality="high",h.drawImage(o,0,0,g,v);const I=u.toDataURL(l).startsWith("data:"+l)?l:"image/jpeg";u.toBlob(p=>{if(!p){m(new Error("Failed to compress image"));return}const f=u.toDataURL(I,n);d({blob:p,dataUrl:f,originalSize:a.size,compressedSize:p.size,compressionRatio:p.size/a.size,width:g,height:v})},I,n)},o.onerror=()=>{m(new Error("Failed to load image"))};const b=new FileReader;b.onload=g=>{o.src=g.target?.result},b.onerror=()=>{m(new Error("Failed to read file"))},b.readAsDataURL(a)})}const z=3;function ka({draft:a,onUpdate:t,onNext:s,onBack:r}){const n=x.useRef(null),l=x.useRef(null),d=x.useRef(null),m=x.useRef(null),[o,u]=x.useState({status:"idle",facingMode:"environment",stream:null}),[h,b]=x.useState(!1),[g,v]=x.useState(null),I=typeof window<"u"&&window.isSecureContext,p=x.useCallback(async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){u(i=>({...i,status:"error",errorMessage:"Seu navegador não suporta acesso à câmera. Tente usar Chrome, Safari ou Firefox."}));return}u(i=>({...i,status:"requesting"}));try{const i=await navigator.mediaDevices.getUserMedia({video:{facingMode:o.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:!1});n.current&&(n.current.srcObject=i,await n.current.play()),u(c=>({...c,status:"active",stream:i,errorMessage:void 0}))}catch(i){if(console.error("Camera error:",i),i instanceof DOMException)if(i.name==="NotAllowedError")u(c=>({...c,status:"denied",errorMessage:"Você não permitiu o acesso à câmera."}));else if(i.name==="NotFoundError")u(c=>({...c,status:"error",errorMessage:"Nenhuma câmera foi encontrada no seu dispositivo."}));else if(i.name==="NotReadableError")u(c=>({...c,status:"error",errorMessage:"A câmera está sendo usada por outro aplicativo. Feche outros apps e tente novamente."}));else if(i.name==="OverconstrainedError"){u(c=>({...c,status:"error",errorMessage:"Sua câmera não atende aos requisitos. Tentando configuração alternativa..."}));try{const c=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});n.current&&(n.current.srcObject=c,await n.current.play()),u(w=>({...w,status:"active",stream:c,errorMessage:void 0}))}catch{u(c=>({...c,status:"error",errorMessage:"Não foi possível acessar sua câmera."}))}}else u(c=>({...c,status:"error",errorMessage:"Ocorreu um erro ao acessar a câmera. Tente novamente."}));else u(c=>({...c,status:"error",errorMessage:"Erro desconhecido ao acessar a câmera."}))}},[o.facingMode]),f=x.useCallback(()=>{o.stream&&o.stream.getTracks().forEach(i=>i.stop()),n.current&&(n.current.srcObject=null),u(i=>({...i,status:"idle",stream:null}))},[o.stream]);x.useEffect(()=>((async()=>{if(!navigator.mediaDevices?.enumerateDevices){v(!1);return}try{const w=(await navigator.mediaDevices.enumerateDevices()).some(E=>E.kind==="videoinput");v(w)}catch{v(!1)}})(),()=>{o.stream&&o.stream.getTracks().forEach(c=>c.stop())}),[]);const N=x.useCallback(async()=>{f(),u(i=>({...i,facingMode:i.facingMode==="environment"?"user":"environment"})),setTimeout(()=>p(),100)},[p,f]),S=x.useCallback(async()=>{if(!n.current||!l.current||a.images.length>=z)return;b(!0);const i=n.current,c=l.current,w=c.getContext("2d");if(!w){b(!1);return}c.width=i.videoWidth,c.height=i.videoHeight,w.drawImage(i,0,0),c.toBlob(E=>{if(!E){b(!1);return}const M=new File([E],`photo_${Date.now()}.jpg`,{type:"image/jpeg",lastModified:Date.now()}),$={id:ce(),file:M,previewUrl:URL.createObjectURL(E),capturedAt:new Date};t({images:[...a.images,$]}),b(!1),a.images.length+1>=z&&f()},"image/jpeg",.85)},[a.images,t,f]),A=x.useCallback(i=>{const c=a.images.find(w=>w.id===i);c&&URL.revokeObjectURL(c.previewUrl),t({images:a.images.filter(w=>w.id!==i)}),o.status==="idle"&&a.images.length<=z&&p()},[a.images,o.status,t,p]),K=x.useCallback(i=>{A(i),o.status!=="active"&&p()},[A,o.status,p]),k=x.useCallback(async i=>{const c=i.target.files;if(!c||c.length===0)return;const w=z-a.images.length,E=Array.from(c).slice(0,w);let M=0,$=0;for(const P of E)if(P.type.startsWith("image/"))try{const B=await wa(P,{maxWidth:1920,maxHeight:1920,quality:.75});M+=B.originalSize,$+=B.compressedSize;const se=new File([B.blob],P.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()}),We={id:ce(),file:se,previewUrl:URL.createObjectURL(B.blob),capturedAt:new Date};t({images:[...a.images,We]})}catch(B){console.error("Failed to compress image:",B);const se={id:ce(),file:P,previewUrl:URL.createObjectURL(P),capturedAt:new Date};t({images:[...a.images,se]})}if(M>0&&$<M){const P=M-$,B=Math.round(P/M*100);G.success(`Imagem otimizada: ${we(M)} → ${we($)} (-${B}%)`)}d.current&&(d.current.value="")},[a.images,t]),U=x.useCallback(()=>{d.current?.click()},[]);return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(ae,{title:"Adicione até 3 fotos",subtitle:"Tire fotos agora ou escolha da galeria",helpTitle:"Dicas para boas fotos",helpContent:["Fotografe de perto para mostrar detalhes do problema.","Inclua uma foto do contexto (rua, número, ponto de referência).","Evite fotos muito escuras ou desfocadas."]}),e.jsx("input",{ref:d,type:"file",accept:"image/*",multiple:!0,onChange:k,className:"hidden"}),e.jsx("input",{ref:m,type:"file",accept:"image/*",capture:"environment",onChange:k,className:"hidden"}),e.jsx(C,{className:"p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100 dark:bg-blue-900/50",children:e.jsx(W,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-2 text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium",children:"Dicas para boas fotos:"}),e.jsxs("ul",{className:"space-y-1 text-blue-600 dark:text-blue-400",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto de perto do problema"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"1 foto mostrando o contexto da rua"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Evite se colocar em risco"})]})]})]})]})}),e.jsxs("div",{className:"relative",children:[o.status==="idle"&&a.images.length<z&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10",children:e.jsx(F,{className:"h-10 w-10 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Adicione fotos do problema"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Fotos ajudam a identificar e resolver o problema mais rápido"})]}),!I&&e.jsx("div",{className:"w-full p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-400",children:[e.jsx(ne,{className:"h-4 w-4 shrink-0"}),e.jsx("p",{className:"text-xs text-left",children:"Câmera exige HTTPS. Use a galeria para adicionar fotos."})]})}),e.jsxs("div",{className:"w-full space-y-2",children:[I&&g!==!1&&e.jsxs(y,{onClick:()=>m.current?.click(),className:"w-full",size:"lg",disabled:g===null,children:[g===null?e.jsx(L,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(F,{className:"h-4 w-4 mr-2"}),"Tirar Foto"]}),e.jsxs(y,{variant:I&&g!==!1?"outline":"default",onClick:U,className:"w-full",size:"lg",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Escolher da Galeria"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Você pode pular e continuar sem fotos"})]})})}),o.status==="active"&&a.images.length<z&&e.jsxs(j.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative rounded-2xl overflow-hidden bg-muted aspect-[4/3]",children:[e.jsx("video",{ref:n,autoPlay:!0,playsInline:!0,muted:!0,"webkit-playsinline":"true","x-webkit-airplay":"allow",style:{backgroundColor:"transparent"},className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-4 left-0 right-0 flex items-center justify-center gap-4",children:[e.jsx(j.button,{whileTap:{scale:.9},onClick:N,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Trocar câmera",children:e.jsx(ea,{className:"h-5 w-5"})}),e.jsx(j.button,{whileTap:{scale:.9},onClick:S,disabled:h,className:D("p-1 rounded-full bg-white",h&&"opacity-50"),"aria-label":"Capturar foto",children:e.jsx("div",{className:"h-16 w-16 rounded-full border-4 border-primary flex items-center justify-center",children:h?e.jsx(L,{className:"h-6 w-6 text-primary animate-spin"}):e.jsx(F,{className:"h-6 w-6 text-primary"})})}),e.jsx(j.button,{whileTap:{scale:.9},onClick:U,className:"p-3 rounded-full bg-black/50 text-white backdrop-blur-sm","aria-label":"Escolher da galeria",children:e.jsx(ie,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"absolute top-4 right-4 px-3 py-1.5 rounded-full bg-black/50 text-white text-sm backdrop-blur-sm flex items-center gap-1",children:[e.jsx(F,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[a.images.length,"/",z]})]})]}),o.status==="requesting"&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"rounded-2xl bg-muted aspect-[4/3] flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10 mb-4",children:e.jsx(L,{className:"h-8 w-8 text-primary animate-spin"})}),e.jsx("p",{className:"font-medium mb-1",children:"Iniciando câmera..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Se aparecer uma mensagem, toque em "Permitir"'})]}),o.status==="denied"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-amber-100 dark:bg-amber-900/30 mb-4",children:e.jsx(ne,{className:"h-8 w-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-amber-800 dark:text-amber-300",children:"Câmera bloqueada"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(C,{className:"w-full p-4 bg-white dark:bg-background border-amber-200 dark:border-amber-700",children:[e.jsxs("p",{className:"font-medium text-sm mb-3 flex items-center gap-2",children:[e.jsx(Te,{className:"h-4 w-4"}),"Como permitir o acesso:"]}),e.jsxs("ol",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"1."}),e.jsx("span",{children:"Olhe na barra de endereço do navegador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"2."}),e.jsx("span",{children:"Clique no ícone de cadeado ou câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"3."}),e.jsx("span",{children:'Mude "Câmera" para "Permitir"'})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"font-bold text-primary",children:"4."}),e.jsx("span",{children:"Recarregue a página ou toque no botão abaixo"})]})]})]}),e.jsxs(y,{variant:"outline",className:"mt-4 w-full",onClick:p,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),o.status==="error"&&e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsx(C,{className:"p-6 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"p-4 rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(H,{className:"h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h3",{className:"font-semibold text-lg text-red-800 dark:text-red-300",children:"Problema com a câmera"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400 mt-2 mb-4",children:o.errorMessage}),e.jsxs(C,{className:"w-full p-4 bg-white dark:bg-background border-red-200 dark:border-red-700",children:[e.jsx("p",{className:"font-medium text-sm mb-3",children:"O que você pode fazer:"}),e.jsxs("ul",{className:"text-left text-sm space-y-2 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Verifique se seu dispositivo tem câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Feche outros aplicativos que usam a câmera"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Tente acessar pelo celular em vez do computador"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500 shrink-0 mt-0.5"}),e.jsx("span",{children:"Você pode continuar sem foto (opcional)"})]})]})]}),e.jsxs(y,{variant:"outline",className:"mt-4 w-full",onClick:p,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Tentar novamente"]})]})})}),e.jsx("canvas",{ref:l,className:"hidden"})]}),a.images.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500"}),"Fotos capturadas (",a.images.length,"/",z,")"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(ee,{mode:"popLayout",children:a.images.map((i,c)=>e.jsxs(j.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},layout:!0,className:"relative aspect-square",children:[e.jsx("img",{src:i.previewUrl,alt:`Foto ${c+1}`,className:"w-full h-full object-cover rounded-xl"}),e.jsx("div",{className:"absolute top-2 left-2 h-6 w-6 rounded-full bg-primary text-primary-foreground text-xs font-bold flex items-center justify-center",children:c+1}),e.jsx("button",{type:"button",onClick:()=>A(i.id),className:"absolute -top-2 -right-2 h-7 w-7 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg hover:bg-red-600 transition-colors z-10","aria-label":"Remover foto",children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/70 to-transparent rounded-b-xl",children:e.jsxs("button",{type:"button",onClick:()=>K(i.id),className:"w-full px-2 py-1 text-xs bg-white/20 text-white rounded-md backdrop-blur-sm flex items-center justify-center gap-1",children:[e.jsx(_,{className:"h-3 w-3"}),"Refazer"]})})]},i.id))}),Array.from({length:z-a.images.length}).map((i,c)=>e.jsxs("button",{type:"button",onClick:()=>m.current?.click(),className:"aspect-square rounded-xl border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-1 hover:border-primary/50 hover:bg-primary/5 transition-colors cursor-pointer",children:[e.jsx(ie,{className:"h-5 w-5 text-muted-foreground/50"}),e.jsx("span",{className:"text-xs text-muted-foreground/50",children:"Adicionar"})]},`empty-${c}`))]})]}),a.images.length>=z&&e.jsx(C,{className:"p-4 text-center bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(R,{className:"h-5 w-5"}),e.jsxs("span",{className:"font-medium",children:["Você tirou ",z," fotos. Pronto para continuar!"]})]})}),a.images.length===0&&(o.status==="error"||o.status==="denied")&&e.jsx(C,{className:"p-4 border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(H,{className:"h-5 w-5 text-amber-600 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800 dark:text-amber-300",children:"Continuar sem foto?"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-1",children:"Fotos ajudam muito a identificar o problema, mas você pode continuar sem elas."})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-9 rounded-xl flex-1 text-base",onClick:()=>{f(),r()},children:"Voltar"}),e.jsxs(y,{size:"lg",className:"h-9 rounded-xl flex-[2] text-base font-semibold",onClick:()=>{f(),s()},children:["Continuar",a.images.length===0&&e.jsx("span",{className:"text-xs ml-2 opacity-70",children:"(sem foto)"})]})]})})]})}function Ca({draft:a,onUpdate:t,onBack:s,onGoToStep:r,onSubmit:n}){const[l,d]=x.useState(!1),{categories:m}=Fe(),o=m.find(b=>b.id===a.categoryId),u=!!a.categoryId&&!!a.location&&a.confirmed&&!!a.title?.trim(),h=async()=>{if(u){d(!0);try{await n()}catch(b){console.error("Submit error:",b)}finally{d(!1)}}};return e.jsxs("div",{className:"space-y-4 pb-48",children:[e.jsx(ae,{title:"Revisar e enviar",subtitle:"Adicione um título e confira as informações",helpTitle:"Última etapa!",helpContent:["Adicione um título curto que descreva o problema.","Revise todas as informações antes de enviar.","Após enviar, você receberá um número de protocolo."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4 text-muted-foreground"}),"Título da denúncia *"]}),e.jsx(pe,{placeholder:"Ex: Buraco grande na Rua Principal",value:a.title||"",onChange:b=>t({title:b.target.value}),className:"h-12 rounded-xl",maxLength:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Descreva o problema em poucas palavras (obrigatório)"})]}),e.jsx(C,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[o?e.jsx(Pe,{icon:o.icon,color:o.color,size:"lg",withBackground:!0}):e.jsx("div",{className:"p-3 rounded-xl bg-muted",children:"❓"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Categoria"}),e.jsx("p",{className:"font-semibold",children:o?.name||"Não selecionada"})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(1),className:"text-primary",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsx(C,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(V,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-semibold",children:a.location?.address||"Localização capturada"}),a.location?.quality&&e.jsx(ua,{variant:"secondary",className:"mt-1 text-xs capitalize",children:a.location.quality})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(2),className:"text-primary",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Editar"]})]})}),e.jsxs(C,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/10",children:e.jsx(F,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Fotos"}),e.jsxs("p",{className:"font-semibold",children:[a.images.length," ",a.images.length===1?"foto anexada":"fotos anexadas"]})]})]}),e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>r(3),className:"text-primary",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Editar"]})]}),a.images.length>0?e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:a.images.map((b,g)=>e.jsx("img",{src:b.previewUrl,alt:`Foto ${g+1}`,className:"h-20 w-20 rounded-lg object-cover shrink-0"},b.id))}):e.jsxs("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("p",{className:"text-sm",children:"Nenhuma foto anexada (opcional)"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4 text-muted-foreground"}),"Descrição adicional (opcional)"]}),e.jsx(pa,{placeholder:"Algum detalhe importante? (máx. 500 caracteres)",maxLength:500,value:a.description,onChange:b=>t({description:b.target.value}),className:"min-h-[100px] rounded-xl resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[a.description.length,"/500"]})]}),e.jsx(C,{className:D("p-4 transition-all border-2",a.confirmed?"border-green-400 bg-green-50 dark:bg-green-950/20 dark:border-green-700":"border-amber-400 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-700"),children:e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[e.jsx(xa,{checked:a.confirmed,onCheckedChange:b=>t({confirmed:!!b}),className:"mt-0.5 h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:D("font-medium",a.confirmed?"text-green-700 dark:text-green-300":"text-amber-700 dark:text-amber-300"),children:a.confirmed?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4"}),"Confirmado!"]}):"Confirmo que as informações são verdadeiras"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:a.confirmed?"Você confirmou que as informações são verdadeiras":"Marque para poder enviar a denúncia"})]})]})}),!u&&e.jsx(C,{className:"p-4 border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(H,{className:"h-5 w-5 text-red-600 dark:text-red-400 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 dark:text-red-300",children:"Não é possível enviar ainda"}),e.jsxs("ul",{className:"text-sm text-red-700 dark:text-red-400 mt-1 space-y-1",children:[!a.title?.trim()&&e.jsx("li",{children:"• Adicione um título"}),!a.categoryId&&e.jsx("li",{children:"• Selecione uma categoria"}),!a.location&&e.jsx("li",{children:"• Capture sua localização"}),!a.confirmed&&e.jsx("li",{children:"• Confirme que as informações são verdadeiras"})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 pb-24 bg-background/95 backdrop-blur-lg border-t z-10",children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx(y,{variant:"outline",size:"lg",className:"h-9 rounded-xl flex-1 text-base",onClick:s,disabled:l,children:"Voltar"}),e.jsx(y,{size:"lg",className:D("h-9 rounded-xl flex-[2] text-base font-semibold",u?"bg-green-600 hover:bg-green-700":"opacity-50"),disabled:!u||l,onClick:h,children:l?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-5 w-5 mr-2 animate-spin"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(aa,{className:"h-5 w-5 mr-2"}),"Enviar denúncia"]})})]})})]})}function Sa({protocolNumber:a,onClose:t}){const{toast:s}=la(),r=Be(),n=x.useCallback(()=>{const o=Date.now()+3e3,u={startVelocity:30,spread:360,ticks:60,zIndex:100},h=(g,v)=>Math.random()*(v-g)+g,b=setInterval(()=>{const g=o-Date.now();if(g<=0)return clearInterval(b);const v=50*(g/3e3);le({...u,particleCount:v,origin:{x:h(.1,.3),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),le({...u,particleCount:v,origin:{x:h(.7,.9),y:Math.random()-.2},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]})},250);return le({particleCount:100,spread:70,origin:{y:.6},colors:["#22c55e","#3b82f6","#f59e0b","#ec4899","#8b5cf6"]}),()=>clearInterval(b)},[]);x.useEffect(()=>n(),[n]);const l=async()=>{try{await navigator.clipboard.writeText(a),s({title:"Protocolo copiado!",description:"Cole onde quiser para guardar."})}catch{s({title:"Erro ao copiar",description:"Tente copiar manualmente.",variant:"destructive"})}},d=async()=>{if(navigator.share)try{await navigator.share({title:"Denúncia Enviada - eTijucas",text:`Minha denúncia foi registrada com sucesso! Protocolo: ${a}`})}catch{console.log("Share cancelled")}else l()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-gradient-to-b from-green-50 to-background dark:from-green-950/30 dark:to-background flex flex-col items-center justify-center p-6 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(6)].map((m,o)=>e.jsx(j.div,{initial:{opacity:0,scale:0},animate:{opacity:[0,.3,0],scale:[0,1.5,2],x:Math.random()*100-50,y:Math.random()*100-50},transition:{duration:3,delay:o*.3,repeat:1/0,repeatDelay:2},className:"absolute rounded-full bg-green-400/20",style:{width:100+o*30,height:100+o*30,left:`${20+o*10}%`,top:`${15+o*12}%`}},o))}),e.jsxs(j.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},transition:{duration:.5},className:"relative z-10 w-full max-w-sm flex flex-col items-center text-center",children:[e.jsxs(j.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},className:"relative mb-6",children:[e.jsx("div",{className:"p-6 rounded-full bg-green-100 dark:bg-green-900/50 shadow-lg shadow-green-500/20",children:e.jsx(R,{className:"h-20 w-20 text-green-600 dark:text-green-400"})}),e.jsx(j.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(ta,{className:"h-8 w-8 text-yellow-500"})}),e.jsx(j.div,{animate:{rotate:-360},transition:{duration:4,repeat:1/0,ease:"linear"},className:"absolute -bottom-1 -left-3",children:e.jsx(sa,{className:"h-7 w-7 text-pink-500"})})]}),e.jsx(j.h1,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-3xl font-bold text-green-700 dark:text-green-400 mb-2",children:"Denúncia Enviada!"}),e.jsx(j.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"text-muted-foreground mb-6",children:"Obrigado por ajudar a melhorar nossa cidade!"}),e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"w-full",children:e.jsxs(C,{className:"p-6 bg-white dark:bg-card border-green-200 dark:border-green-800 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-3",children:[e.jsx(Le,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground font-medium",children:"Número do Protocolo"})]}),e.jsx(j.p,{className:"text-2xl font-bold font-mono text-primary mb-4",animate:{scale:[1,1.02,1]},transition:{duration:2,repeat:1/0},children:a}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",size:"sm",className:"flex-1",onClick:l,children:[e.jsx(ra,{className:"h-4 w-4 mr-2"}),"Copiar"]}),e.jsxs(y,{variant:"outline",size:"sm",className:"flex-1",onClick:d,children:[e.jsx(na,{className:"h-4 w-4 mr-2"}),"Compartilhar"]})]})]})}),e.jsx(j.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.7},className:"text-xs text-muted-foreground mt-4 max-w-xs",children:"Guarde este número para acompanhar o andamento da sua denúncia. Nossa equipe irá analisar e tomar as providências necessárias."}),e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.8},className:"w-full mt-8 space-y-3",children:[e.jsxs(y,{size:"lg",className:"w-full h-14 rounded-2xl text-base font-semibold bg-green-600 hover:bg-green-700",onClick:t,children:[e.jsx(ia,{className:"h-5 w-5 mr-2"}),"Início do App"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(y,{variant:"outline",size:"lg",className:"h-12 rounded-2xl text-sm",onClick:()=>r("/minhas-denuncias"),children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Minhas Denúncias"]}),e.jsxs(y,{variant:"outline",size:"lg",className:"h-12 rounded-2xl text-sm",onClick:()=>r("/denuncias/mapa"),children:[e.jsx(oa,{className:"h-4 w-4 mr-2"}),"Mapa"]})]}),e.jsxs(y,{variant:"ghost",size:"lg",className:"w-full h-12 rounded-2xl text-base",onClick:()=>r("/denuncias"),children:[e.jsx(Re,{className:"h-5 w-5 mr-2"}),"Todas as Denúncias"]})]})]})]})}const he=(a,t)=>t.some(s=>a instanceof s);let ke,Ce;function Da(){return ke||(ke=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ia(){return Ce||(Ce=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ge=new WeakMap,de=new WeakMap,te=new WeakMap;function Aa(a){const t=new Promise((s,r)=>{const n=()=>{a.removeEventListener("success",l),a.removeEventListener("error",d)},l=()=>{s(q(a.result)),n()},d=()=>{r(a.error),n()};a.addEventListener("success",l),a.addEventListener("error",d)});return te.set(t,a),t}function Ea(a){if(ge.has(a))return;const t=new Promise((s,r)=>{const n=()=>{a.removeEventListener("complete",l),a.removeEventListener("error",d),a.removeEventListener("abort",d)},l=()=>{s(),n()},d=()=>{r(a.error||new DOMException("AbortError","AbortError")),n()};a.addEventListener("complete",l),a.addEventListener("error",d),a.addEventListener("abort",d)});ge.set(a,t)}let fe={get(a,t,s){if(a instanceof IDBTransaction){if(t==="done")return ge.get(a);if(t==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return q(a[t])},set(a,t,s){return a[t]=s,!0},has(a,t){return a instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in a}};function qe(a){fe=a(fe)}function za(a){return Ia().includes(a)?function(...t){return a.apply(be(this),t),q(this.request)}:function(...t){return q(a.apply(be(this),t))}}function Ma(a){return typeof a=="function"?za(a):(a instanceof IDBTransaction&&Ea(a),he(a,Da())?new Proxy(a,fe):a)}function q(a){if(a instanceof IDBRequest)return Aa(a);if(de.has(a))return de.get(a);const t=Ma(a);return t!==a&&(de.set(a,t),te.set(t,a)),t}const be=a=>te.get(a);function Ta(a,t,{blocked:s,upgrade:r,blocking:n,terminated:l}={}){const d=indexedDB.open(a,t),m=q(d);return r&&d.addEventListener("upgradeneeded",o=>{r(q(d.result),o.oldVersion,o.newVersion,q(d.transaction),o)}),s&&d.addEventListener("blocked",o=>s(o.oldVersion,o.newVersion,o)),m.then(o=>{l&&o.addEventListener("close",()=>l()),n&&o.addEventListener("versionchange",u=>n(u.oldVersion,u.newVersion,u))}).catch(()=>{}),m}const Ra=["get","getKey","getAll","getAllKeys","count"],La=["put","add","delete","clear"],me=new Map;function Se(a,t){if(!(a instanceof IDBDatabase&&!(t in a)&&typeof t=="string"))return;if(me.get(t))return me.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,n=La.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!(n||Ra.includes(s)))return;const l=async function(d,...m){const o=this.transaction(d,n?"readwrite":"readonly");let u=o.store;return r&&(u=u.index(m.shift())),(await Promise.all([u[s](...m),n&&o.done]))[0]};return me.set(t,l),l}qe(a=>({...a,get:(t,s,r)=>Se(t,s)||a.get(t,s,r),has:(t,s)=>!!Se(t,s)||a.has(t,s)}));const Ba=["continue","continuePrimaryKey","advance"],De={},je=new WeakMap,Oe=new WeakMap,Pa={get(a,t){if(!Ba.includes(t))return a[t];let s=De[t];return s||(s=De[t]=function(...r){je.set(this,Oe.get(this)[t](...r))}),s}};async function*Fa(...a){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...a)),!t)return;t=t;const s=new Proxy(t,Pa);for(Oe.set(s,t),te.set(s,be(t));t;)yield s,t=await(je.get(s)||t.continue()),je.delete(s)}function Ie(a,t){return t===Symbol.asyncIterator&&he(a,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&he(a,[IDBIndex,IDBObjectStore])}qe(a=>({...a,get(t,s,r){return Ie(t,s)?Fa:a.get(t,s,r)},has(t,s){return Ie(t,s)||a.has(t,s)}}));const Ae="etijucas-reports",qa=2;let T=null,X=!1;async function O(){if(T&&X)return T;try{return T=await Ta(Ae,qa,{upgrade(a,t,s){if(console.log(`[reportDraftDB] Upgrading from v${t} to v${s}`),!a.objectStoreNames.contains("drafts")){const r=a.createObjectStore("drafts",{keyPath:"id"});r.createIndex("by-status","syncStatus"),r.createIndex("by-updated","updatedAt")}a.objectStoreNames.contains("images")||a.createObjectStore("images",{keyPath:"id"}).createIndex("by-draft","draftId")},blocked(){console.warn("[reportDraftDB] Database blocked - close other tabs")},blocking(){T?.close(),T=null,X=!1}}),X=!0,T}catch(a){if(console.error("[reportDraftDB] Failed to open database:",a),a instanceof Error&&a.name==="NotFoundError"){console.warn("[reportDraftDB] Corrupted database, deleting and recreating...");try{return T&&(T.close(),T=null),await new Promise((t,s)=>{const r=indexedDB.deleteDatabase(Ae);r.onsuccess=()=>t(),r.onerror=()=>s(r.error),r.onblocked=()=>{console.warn("[reportDraftDB] Delete blocked"),t()}}),console.log("[reportDraftDB] Database deleted, recreating..."),X=!1,O()}catch(t){throw console.error("[reportDraftDB] Failed to delete database:",t),t}}throw a}}function Ue(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async function $e(a,t="draft"){const s=await O(),r=a.idempotencyKey||Ue(),n=Date.now(),l={categoryId:a.categoryId,category:a.category,location:a.location,locationNote:a.locationNote||null,title:a.title,description:a.description,confirmed:a.confirmed,currentStep:a.currentStep,createdAt:a.createdAt.getTime(),updatedAt:n,idempotencyKey:a.idempotencyKey};await s.put("drafts",{id:r,draft:l,syncStatus:t,createdAt:n,updatedAt:n});const d=s.transaction("images","readwrite"),m=d.objectStore("images"),o=await m.index("by-draft").getAll(r);for(const u of o)await m.delete(u.id);for(const u of a.images){const h=u.file;await m.put({id:u.id,draftId:r,blob:h,filename:u.file.name,capturedAt:u.capturedAt.getTime()})}return await d.done,r}async function Oa(a){const t=await O(),s=await t.get("drafts",a);if(!s)return null;const n=(await t.getAllFromIndex("images","by-draft",a)).map(d=>{const m=new File([d.blob],d.filename,{type:d.blob.type});return{id:d.id,file:m,previewUrl:URL.createObjectURL(d.blob),capturedAt:new Date(d.capturedAt)}}),l=s.draft;return{categoryId:l.categoryId,category:l.category,location:l.location,title:l.title,description:l.description,confirmed:l.confirmed,currentStep:l.currentStep,createdAt:new Date(l.createdAt),updatedAt:new Date(l.updatedAt),idempotencyKey:l.idempotencyKey,locationNote:l.locationNote||null,images:n}}async function Ua(){const a=await O(),t=await a.getAll("drafts");return(await Promise.all(t.map(async r=>{const n=await a.getAllFromIndex("images","by-draft",r.id);return{id:r.id,draft:r.draft,syncStatus:r.syncStatus,imageCount:n.length,updatedAt:r.updatedAt}}))).sort((r,n)=>n.updatedAt-r.updatedAt)}async function Ve(a){return(await(await O()).getAllFromIndex("drafts","by-status",a)).map(r=>r.id)}async function $a(a,t){const s=await O(),r=await s.get("drafts",a);r&&await s.put("drafts",{...r,syncStatus:t,updatedAt:Date.now()})}async function Ke(a){const t=await O(),s=await t.getAllFromIndex("images","by-draft",a),r=t.transaction("images","readwrite");for(const n of s)await r.store.delete(n.id);await r.done,await t.delete("drafts",a)}async function Va(){const a=await Ve("sent");let t=0;for(const s of a)await Ke(s),t++;return t}function Ge(a){for(const t of a)t.previewUrl?.startsWith("blob:")&&URL.revokeObjectURL(t.previewUrl)}const Ee="report_draft";async function _e(){try{const a=localStorage.getItem(Ee);if(!a)return!1;const t=JSON.parse(a);if(!t)return!1;const s={categoryId:t.categoryId||null,category:t.category||null,location:t.location||null,title:t.title||"",description:t.description||"",confirmed:!1,currentStep:t.currentStep||1,createdAt:new Date,updatedAt:new Date,idempotencyKey:Ue(),locationNote:t.locationNote||null,images:[]};return await $e(s,"draft"),localStorage.removeItem(Ee),console.log("[reportDraftDB] Migrated draft from localStorage to IndexedDB"),!0}catch(a){return console.error("[reportDraftDB] Migration failed:",a),!1}}const J={saveDraft:$e,getDraft:Oa,getAllDrafts:Ua,getDraftsByStatus:Ve,updateDraftStatus:$a,deleteDraft:Ke,clearSentDrafts:Va,revokeImageURLs:Ge,migrateFromLocalStorage:_e},Z=()=>`report-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,ue={categoryId:null,category:null,location:null,locationNote:"",images:[],title:"",description:"",confirmed:!1,currentStep:1,createdAt:new Date,updatedAt:new Date,idempotencyKey:Z()},ze="etijucas-report-draft",Y="active-report-draft";function Ka(){const[a,t]=x.useState(()=>({...ue,idempotencyKey:Z()})),[s,r]=x.useState(!0),n=x.useRef(null),l=x.useRef(!0);x.useEffect(()=>{l.current=!0;async function p(){try{await _e();const f=await J.getDraft(Y);f&&l.current&&t(f)}catch(f){console.error("[useReportDraft] Error loading draft:",f);try{const N=localStorage.getItem(ze);if(N){const S=JSON.parse(N);l.current&&t({...ue,...S,createdAt:new Date(S.createdAt||Date.now()),updatedAt:new Date(S.updatedAt||Date.now()),images:[],idempotencyKey:S.idempotencyKey||Z()})}}catch(N){console.error("[useReportDraft] localStorage fallback failed:",N)}}finally{l.current&&r(!1)}}return p(),()=>{l.current=!1,n.current&&clearTimeout(n.current)}},[]);const d=x.useCallback(async p=>{n.current&&clearTimeout(n.current),n.current=setTimeout(async()=>{try{const f={...p,idempotencyKey:Y};await J.saveDraft(f,"draft")}catch(f){console.error("[useReportDraft] Error saving draft:",f)}},500)},[]),m=x.useCallback(p=>{t(f=>{const N={...f,...p,updatedAt:new Date};return d(N),N})},[d]),o=x.useCallback(p=>{t(f=>{if(f.images.length>=3)return f;const N={...f,images:[...f.images,p],updatedAt:new Date};return d(N),N})},[d]),u=x.useCallback(p=>{t(f=>{const N=f.images.find(A=>A.id===p);N&&URL.revokeObjectURL(N.previewUrl);const S={...f,images:f.images.filter(A=>A.id!==p),updatedAt:new Date};return d(S),S})},[d]),h=x.useCallback(p=>{m({currentStep:p})},[m]),b=x.useCallback(()=>{t(p=>{if(p.currentStep<4){const f=p.currentStep+1,N={...p,currentStep:f,updatedAt:new Date};return d(N),N}return p})},[d]),g=x.useCallback(()=>{t(p=>{if(p.currentStep>1){const f=p.currentStep-1,N={...p,currentStep:f,updatedAt:new Date};return d(N),N}return p})},[d]),v=x.useCallback(async()=>{Ge(a.images);try{await J.deleteDraft(Y)}catch(p){console.error("[useReportDraft] Error deleting draft:",p)}localStorage.removeItem(ze),t({...ue,idempotencyKey:Z()})},[a.images]),I=x.useCallback(async()=>{n.current&&clearTimeout(n.current);try{const p={...a,idempotencyKey:Y};await J.saveDraft(p,"draft")}catch(p){console.error("[useReportDraft] Error saving draft:",p)}},[a]);return{draft:a,isLoading:s,updateDraft:m,addImage:o,removeImage:u,goToStep:h,nextStep:b,prevStep:g,clearDraft:v,saveDraft:I}}const Ga=["Categoria","Localização","Fotos","Revisão"],_a={enter:a=>({x:a>0?"100%":"-100%",opacity:0}),center:{x:0,opacity:1},exit:a=>({x:a<0?"100%":"-100%",opacity:0})};function pt(){const a=Be(),{isAuthenticated:t}=ga();if(!t)return e.jsx(da,{title:"Cadastre-se ou entre",message:"Para enviar uma denúncia, você precisa estar cadastrado no aplicativo.",returnUrl:"/denuncia/nova"});const{draft:s,isLoading:r,updateDraft:n,nextStep:l,prevStep:d,clearDraft:m}=Ka(),[o,u]=x.useState(0),[h,b]=x.useState(!1),[g,v]=x.useState(null),{createReport:I}=ha(),p=x.useCallback(k=>{u(k>s.currentStep?1:-1),n({currentStep:k})},[s.currentStep,n]),f=x.useCallback(()=>{u(1),l()},[l]),N=x.useCallback(()=>{u(-1),d()},[d]),S=x.useCallback(async()=>{if(!s.categoryId){G.error("Selecione uma categoria para a denúncia");return}if(!s.title||s.title.trim().length<5){G.error("O título deve ter pelo menos 5 caracteres");return}try{const k={categoryId:s.categoryId,title:s.title.trim(),description:s.description.trim(),images:s.images.map(i=>i.file)};s.location&&(k.addressText=s.location.address,k.addressSource=s.location.source,k.locationQuality=s.location.quality,k.latitude=s.location.latitude,k.longitude=s.location.longitude,k.locationAccuracyM=s.location.accuracy?Math.min(Math.round(s.location.accuracy),1e4):void 0);const U=await I({payload:k,idempotencyKey:s.idempotencyKey});v(U.protocol),b(!0),m(),G.success("Denúncia enviada com sucesso!")}catch(k){console.error("Error submitting report:",k),G.error("Erro ao enviar denúncia. Tente novamente.")}},[s,I,m]),A=()=>{s.categoryId||s.location||s.images.length>0?window.confirm("Tem certeza que deseja sair? Seu rascunho será salvo.")&&a(-1):a(-1)},K=()=>{a("/")};return r?e.jsx("div",{className:"fixed inset-0 z-50 bg-background flex items-center justify-center",children:e.jsx(L,{className:"h-8 w-8 animate-spin text-primary"})}):h&&g?e.jsx(Sa,{protocolNumber:g,onClose:K}):e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"shrink-0 bg-background/95 backdrop-blur-lg safe-top",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsx(y,{variant:"ghost",size:"icon",onClick:A,className:"rounded-full",children:e.jsx(ca,{className:"h-5 w-5"})}),e.jsx("h1",{className:"font-semibold text-lg",children:"Enviar Denúncia"}),e.jsx(y,{variant:"ghost",size:"icon",onClick:A,className:"rounded-full",children:e.jsx(ye,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"px-4 pb-2",children:e.jsx(ja,{currentStep:s.currentStep,totalSteps:4,labels:Ga})})]}),e.jsx("main",{className:"flex-1 overflow-hidden",children:e.jsx(ee,{mode:"wait",custom:o,children:e.jsxs(j.div,{custom:o,variants:_a,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},className:"h-full overflow-y-auto px-4 pt-4 pb-32",children:[s.currentStep===1&&e.jsx(Na,{draft:s,onUpdate:n,onNext:f}),s.currentStep===2&&e.jsx(va,{draft:s,onUpdate:n,onNext:f,onBack:N}),s.currentStep===3&&e.jsx(ka,{draft:s,onUpdate:n,onNext:f,onBack:N}),s.currentStep===4&&e.jsx(Ca,{draft:s,onUpdate:n,onBack:N,onGoToStep:p,onSubmit:S})]},s.currentStep)})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[60]",children:e.jsx(fa,{activeTab:"reportar",onTabChange:k=>a(`/?tab=${k}`)})})]})}export{pt as default};
