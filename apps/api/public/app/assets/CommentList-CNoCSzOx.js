import{r as a,j as e}from"./vendor-radix-CQkmBfGK.js";import{B as z}from"./button-CWq3JRf3.js";import{T as H}from"./textarea-C6SSVS__.js";import{s as W,W as q,X as P,b as $,r as V}from"./index-DaSWwAsO.js";import{u as X}from"./useUploadImage-BAruwY7R.js";import{A as h,m as c}from"./vendor-motion-3m9Rluu3.js";import{E as G,a as J}from"./eye-Ctuy8_fh.js";import{I as M}from"./image-BiZJyeXD.js";import{S as O}from"./send-Dc_UqkOc.js";import{f as Q}from"./formatTimeAgo-DgAHP5O3.js";import{M as B}from"./message-circle-CnDKUkQR.js";import{H as Y}from"./heart-DQyYi-fX.js";import{C as Z}from"./chevron-up-WqmLYA9i.js";import{C as _}from"./chevron-down-Bq7K2J8s.js";function pe({onSubmit:t,autoFocus:x=!1,placeholder:l="Escreva um comentário…",replyTo:n,isSubmitting:m=!1}){const[r,i]=a.useState(""),[o,T]=a.useState(!1),[y,v]=a.useState(!1),[k,N]=a.useState(!1),[p,b]=a.useState(null),[S,A]=a.useState(null),{isOnline:w}=W(),g=a.useRef(null),f=a.useRef(null),{uploadAsync:R,isUploading:E}=X(),j=y||m||E;a.useEffect(()=>{x&&g.current&&g.current.focus()},[x]);const C=async()=>{if(!(!r.trim()||j)){v(!0);try{let d;if(S)try{d=(await R(S)).url}catch(u){const s=u instanceof Error?u.message:"Erro no upload";V.error(`Falha no upload: ${s}`),v(!1);return}await t(r.trim(),o,d),i(""),b(null),A(null),navigator.vibrate&&navigator.vibrate(10)}finally{v(!1)}}},I=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),C())},L=d=>{const u=d.target.files?.[0];if(u){A(u);const s=new FileReader;s.onload=()=>{b(s.result)},s.readAsDataURL(u)}},U=()=>{b(null),A(null),f.current&&(f.current.value="")};return e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-background border-t border-border safe-bottom z-40",children:[e.jsx(h,{children:!w&&e.jsxs(c.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"px-4 py-2 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 text-xs flex items-center gap-2",children:[e.jsx(q,{className:"w-3 h-3"}),e.jsx("span",{children:"Sem conexão. Comentário será enviado quando voltar."})]})}),e.jsx(h,{children:n&&e.jsxs(c.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"px-4 py-2 bg-muted text-sm text-muted-foreground border-l-4 border-primary",children:["Respondendo a ",e.jsx("strong",{children:n})]})}),e.jsx(h,{children:p&&e.jsx(c.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"px-4 pt-2",children:e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:p,alt:"Preview",className:"h-20 rounded-lg object-cover"}),e.jsx("button",{onClick:U,className:"absolute -top-1 -right-1 p-1 bg-destructive text-destructive-foreground rounded-full shadow-sm","aria-label":"Remover imagem",children:e.jsx(P,{className:"w-3 h-3"})})]})})}),e.jsxs("div",{className:"px-4 py-3",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(c.button,{whileTap:{scale:.9},onClick:()=>T(!o),className:`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center transition-colors ${o?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"}`,"aria-label":o?"Postar com nome":"Postar anônimo","aria-pressed":o,children:o?e.jsx(G,{className:"w-4 h-4"}):e.jsx(J,{className:"w-4 h-4"})}),e.jsx(c.button,{whileTap:{scale:.9},onClick:()=>f.current?.click(),className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-muted text-muted-foreground transition-colors hover:bg-muted-foreground/10","aria-label":"Anexar imagem",children:e.jsx(M,{className:"w-4 h-4"})}),e.jsx("input",{ref:f,type:"file",accept:"image/*",onChange:L,className:"hidden"}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(H,{ref:g,value:r,onChange:d=>i(d.target.value),onFocus:()=>N(!0),onBlur:()=>N(!1),onKeyDown:I,placeholder:l,className:`min-h-[44px] max-h-[120px] py-3 pr-12 rounded-2xl resize-none text-base transition-all ${k?"ring-2 ring-primary":""}`,rows:1,maxLength:500}),r.length>400&&e.jsxs("span",{className:"absolute right-12 bottom-2 text-xs text-muted-foreground",children:[r.length,"/500"]})]}),e.jsx(c.div,{whileTap:{scale:.9},children:e.jsx(z,{onClick:C,disabled:!r.trim()||j,size:"icon",className:"w-10 h-10 rounded-full flex-shrink-0","aria-label":"Enviar comentário",children:j?e.jsx($,{className:"w-4 h-4 animate-spin"}):e.jsx(O,{className:"w-4 h-4"})})})]}),e.jsx(h,{children:o&&e.jsx(c.p,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"text-xs text-muted-foreground mt-2 pl-12",children:"Seu nome não aparecerá no comentário"})})]})]})}function ee(t,x){return t.filter(n=>!n.parentId).sort((n,m)=>{if(x==="recentes")return new Date(m.createdAt).getTime()-new Date(n.createdAt).getTime();const r=(m.likesCount??0)-(n.likesCount??0);return r!==0?r:new Date(m.createdAt).getTime()-new Date(n.createdAt).getTime()})}function ge({comments:t,onLike:x,onReply:l}){const[n,m]=a.useState("relevantes"),r=a.useMemo(()=>{console.log("[CommentList] Processing comments:",t.length,"total");const i=ee(t,n);return console.log("[CommentList] Root comments:",i.length,"with replies:",i.map(o=>o.replies?.length??0)),i},[t,n]);return t.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx(B,{className:"w-10 h-10 mx-auto text-muted-foreground/50 mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhum comentário ainda."}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Seja o primeiro a comentar!"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border/50",children:[e.jsxs("span",{className:"text-sm font-medium text-foreground",children:[t.length," ",t.length===1?"comentário":"comentários"]}),e.jsx("div",{className:"flex gap-1",children:["relevantes","recentes"].map(i=>e.jsx("button",{onClick:()=>m(i),className:`px-3 py-1.5 text-xs font-medium rounded-full transition-colors ${n===i?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-muted"}`,children:i==="relevantes"?"Relevantes":"Recentes"},i))})]}),e.jsx("div",{className:"divide-y divide-border/50",children:e.jsx(h,{children:r.map((i,o)=>e.jsx(K,{comment:i,index:o,depth:0,onLike:x,onReply:l},i.id))})})]})}function K({comment:t,index:x,depth:l,onLike:n,onReply:m}){const[r,i]=a.useState(t.liked??!1),[o,T]=a.useState(t.likesCount??0),[y,v]=a.useState(l<2),[k,N]=a.useState(!1),[p,b]=a.useState(""),[S,A]=a.useState(!1),[w,g]=a.useState(null),[f,R]=a.useState(!1),[E,j]=a.useState(!1),C=t.replies&&t.replies.length>0,I=3,L=()=>{i(!r),T(s=>r?Math.max(0,s-1):s+1),navigator.vibrate&&navigator.vibrate(10),n?.(t.id)},U=()=>t.isAnon?"Anônimo":t.autor?.nome?t.autor.nome:t.autorNome?t.autorNome:"Usuário",d=()=>t.isAnon?"?":(t.autor?.nome||t.autorNome||"U")[0]?.toUpperCase()||"U",u=async()=>{if(!(!p.trim()||!m)){R(!0);try{await m(t.id,p.trim(),S,w||void 0),b(""),g(null),N(!1)}finally{R(!1)}}};return e.jsxs(c.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:x*.03},className:l>0?"border-l-2 border-muted":"",style:{marginLeft:l>0?`${Math.min(l,I)*16}px`:0},children:[e.jsx("div",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:`${l>0?"w-6 h-6 text-[10px]":"w-8 h-8 text-xs"} rounded-full bg-muted flex items-center justify-center font-medium text-muted-foreground flex-shrink-0`,children:t.autor?.avatarUrl?e.jsx("img",{src:t.autor.avatarUrl,alt:U(),className:"w-full h-full rounded-full object-cover"}):d()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:`${l>0?"text-xs":"text-sm"} font-medium text-foreground`,children:U()}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Q(t.createdAt)})]}),e.jsx("p",{className:`${l>0?"text-xs":"text-sm"} text-foreground mt-1 leading-relaxed whitespace-pre-wrap`,children:t.texto}),t.imageUrl&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:t.imageUrl,alt:"Imagem do comentário",className:"mt-2 rounded-lg max-h-48 object-cover cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>j(!0)}),e.jsx(h,{children:E&&e.jsxs(c.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4",onClick:()=>j(!1),children:[e.jsx("button",{className:"absolute top-4 right-4 p-2 text-white/80 hover:text-white bg-black/50 rounded-full",onClick:()=>j(!1),children:e.jsx(P,{className:"w-6 h-6"})}),e.jsx(c.img,{initial:{scale:.9},animate:{scale:1},exit:{scale:.9},src:t.imageUrl,alt:"Imagem em tela cheia",className:"max-w-full max-h-full object-contain rounded-lg",onClick:s=>s.stopPropagation()})]})})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-2",children:[e.jsxs(c.button,{whileTap:{scale:.9},onClick:L,className:"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors min-h-[32px]",children:[e.jsx(Y,{className:`w-4 h-4 transition-all ${r?"fill-red-500 text-red-500 scale-110":""}`}),e.jsx("span",{className:r?"text-red-500 font-medium":"",children:o>0?o:"Curtir"})]}),l<I&&e.jsxs("button",{onClick:()=>N(!k),className:"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors min-h-[32px]",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsx("span",{children:"Responder"})]}),C&&e.jsx("button",{onClick:()=>v(!y),className:"flex items-center gap-1 text-xs text-primary font-medium min-h-[32px]",children:y?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsxs("span",{children:["Ocultar ",t.replies.length," ",t.replies.length===1?"resposta":"respostas"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4"}),e.jsxs("span",{children:["Ver ",t.replies.length," ",t.replies.length===1?"resposta":"respostas"]})]})})]}),e.jsx(h,{children:k&&e.jsx(c.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"mt-3 overflow-hidden",children:e.jsxs("div",{className:"flex flex-col gap-2 p-3 bg-muted/50 rounded-xl",children:[w&&e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:w,alt:"Preview",className:"h-24 rounded-lg object-cover"}),e.jsx("button",{onClick:()=>g(null),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white",children:e.jsx(P,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",value:p,onChange:s=>b(s.target.value),placeholder:`Responder ${t.isAnon?"Anônimo":t.autorNome}...`,className:"w-full px-3 py-2 text-sm rounded-lg bg-background border border-border focus:outline-none focus:ring-2 focus:ring-primary",onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),u())}})}),e.jsxs("label",{className:"p-2 rounded-lg hover:bg-muted cursor-pointer",children:[e.jsx(M,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:s=>{const D=s.target.files?.[0];if(D){const F=new FileReader;F.onload=()=>g(F.result),F.readAsDataURL(D)}}})]}),e.jsx("button",{onClick:u,disabled:!p.trim()||f,className:"p-2 rounded-lg bg-primary text-primary-foreground disabled:opacity-50",children:f?e.jsx($,{className:"w-5 h-5 animate-spin"}):e.jsx(O,{className:"w-5 h-5"})})]})]})})})]})]})}),e.jsx(h,{children:C&&y&&e.jsx(c.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},children:t.replies.map((s,D)=>e.jsx(K,{comment:{...s,replies:s.replies||[]},index:D,depth:l+1,onLike:n,onReply:m},s.id))})})]})}export{ge as C,pe as a};
